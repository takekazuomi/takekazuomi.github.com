
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Azure Virtual MachineのDISK性能 - Cloud Memo</title>
  <meta name="author" content="Takekazu Omi">

  
  <meta name="description" content="twitterで、「Azure VMのLinuxを21日以降作るか、更新手順を実施するとパフォーマンスが改善されるらしー」というのを読んで、以前DISK性能を調べ始めてそのまま放置していたのを思い出した。Azure Ubuntu 12.04 iozone 速報 2012/7/4 Azure &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://takekazuomi.github.com/blog/2012/12/23/azurevmfix1221/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Cloud Memo" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36911322-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cloud Memo</a></h1>
  
    <h2>もろもろの備忘録、C#とAzureがメインになるはず</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:takekazuomi.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Azure Virtual MachineのDISK性能</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-23T18:40:00+09:00" pubdate data-updated="true"> 12/23/2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>twitterで、「<a href="https://twitter.com/kamebuchi/status/282094138269261825">Azure VMのLinuxを21日以降作るか、更新手順を実施するとパフォーマンスが改善されるらしー</a>」というのを読んで、以前DISK性能を調べ始めてそのまま放置していたのを思い出した。<a href="http://www.slideshare.net/takekazuomi/azure-ubuntu-1204-iozone" title="Azure Ubuntu 12.04 iozone 速報 2012/7/4">Azure Ubuntu 12.04 iozone 速報 2012/7/4</a></p>

<p>Azure Storageの非同期と同期の比較をしようと始めたのだけど、なかなか手間取って進まない。ちょっと寄り道して速くなったというAzure VMを試してみることにした。</p>

<p>前のVMは消してしまったので、新たにインストールし直すところから始める。AzureのポータルからUbuntuをインストールして、DataDiskを接続するあたりまでは他に任せてubuntuが起動した後から書いていきます。</p>

<p><a href="http://www.flickr.com/photos/takekazuomi/7987640250/" title="Triangle by takekazu, on Flickr"><img src="http://farm9.staticflickr.com/8450/7987640250_b87fdcf1f1_c.jpg" width="800" height="534" alt="Triangle"></a></p>

<hr />

<h1>Ubuntu 環境の準備</h1>

<p>基本的には、前回と同じになるようにします。だたUbuntuを12.10にして、data diskのホストキャッシュの設定を変えて3つのDISKを接続して測定しました。<a href="http://www.slideshare.net/takekazuomi/azure-ubuntu-1204-iozone" title="Azure Ubuntu 12.04 iozone 速報 2012/7/4">以前の測定</a>の時は、ホストキャッシュの設定はポータルからはできずに、デフォルトでした。
その時(2012/7/4)は、ホストキャッシュ無しがデフォルトだったと思うのですが、ちょっとドキュメントが見つからないので前の結果は参考程度にしてください。</p>

<p>Azure iDC は、West USで、2 coreのインスタンス（M）を使いました。Sにするか少し考えたのですが、クラウドサービスについては、I/O パフォーマンスがXS、Sでは制限されている、参考：<a href="http://www.windowsazure.com/ja-jp/pricing/details/">Windows Azure の料金と、請求の計測単位の詳細</a>ようなのでMを使うことにしました。</p>

<p>正確には、今回試そうとしているVirtual Machine はまだ Previewで Cloud Serviceと同じような制限になるかは情報が公開されていない（私は知らないだけかもしれませんが）のですが、同じになってそうな気がしたのでMにしました。</p>

<p>ちょっと古いものでは、<a href="http://msdn.microsoft.com/ja-jp/library/windowsazure/ee814754.aspx">仮想マシンのサイズの構成方法</a> という情報もあります。</p>

<p>インスタンスの選択で考慮する必要があると思われるのは、Data Diskはネットワーク経由で接続される、ソフトウェアで処理する部分が多い＝CPUを使うということです。従ってネットワーク帯域制限やCore数の影響を無視できないはずです。XSやSのインスタンスだと何を測定しているのか不安になる気がしたのでMを選択しました。
実際どのインスタンスサイズの程度影響があるのかは興味ありますが未測定です。</p>

<p>ざっと流すと、以下のような手順踏んで用意をします。</p>

<ol>
<li>Ubuntu 12.10 を、azure portalから、virtual machineイメージをインストール</li>
<li>data disk を、256Gで3つ作成、/dev/sdc, sdd, sdeを確認、キャッシュをそれぞれ「なし、読み取り専用、読み取り/書き込み」と指定</li>
<li>fdiskして、/dev/sd[cde]1にext4でfilesystemを作成し/mnt/data, /mnt/data1, /mnt/data2へmount</li>
<li>apt-get update, upgrade して最新に更新</li>
<li>/etc/apt/sources.list で、multiverse を追加（コメントを外しただけ）</li>
<li>apt-get install iozone3 でインストール</li>
</ol>


<h3>ディスク構成</h3>

<table width="80%" border="1">
    <thead>
    <tr>
    <th>ディスク</th>
    <th>種類           </th>
    <th>ホスト キャッシュ </th>
    <th>サイズ</th>
    <th>備考</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>/dev/sda</td>
    <td>OS ディスク    </td>
    <td>読み取り/書き込み </td>
    <td>30GB  </td>
    <td></td>
    </tr>
    <tr>
    <td>/dev/sdc</td>
    <td>データ ディスク</td>
    <td>なし              </td>
    <td>256GB </td>
    <td></td>
    </tr>
    <tr>
    <td>/dev/sdd</td>
    <td>データ ディスク</td>
    <td>読み取り専用      </td>
    <td>256GB </td>
    <td></td>
    </tr>
    <tr>
    <td>/dev/sde</td>
    <td>データ ディスク</td>
    <td>読み取り/書き込み </td>
    <td>256GB </td>
    <td></td>
    </tr>
    </tbody>
</table>


<hr />

<h2>コマンドライン</h2>

<p>今後の再テストのためのメモも兼ねて、コマンドをラインに流したもの抜粋を挙げておきます。
(以下sudo省略)</p>

<ul>
<li>ポータルで256Gでdata diskを作成して接続を確認</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ dmesg | grep -e "\[sd[a-z]\]"
</span><span class='line'>sd 2:0:0:0: [sda] 62914560 512-byte logical blocks: (32.2 GB/30.0 GiB)
</span><span class='line'>sd 2:0:0:0: [sda] Write Protect is off
</span><span class='line'>sd 2:0:0:0: [sda] Mode Sense: 0f 00 10 00
</span><span class='line'>sd 2:0:0:0: [sda] Write cache: enabled, read cache: enabled, supports DPO and FUA
</span><span class='line'>sd 2:0:0:0: [sda] Attached SCSI disk
</span><span class='line'>sd 3:0:1:0: [sdb] 283115520 512-byte logical blocks: (144 GB/135 GiB)
</span><span class='line'>sd 3:0:1:0: [sdb] Write Protect is off
</span><span class='line'>sd 3:0:1:0: [sdb] Mode Sense: 0f 00 10 00
</span><span class='line'>sd 3:0:1:0: [sdb] Write cache: enabled, read cache: enabled, supports DPO and FUA
</span><span class='line'>sd 3:0:1:0: [sdb] Attached SCSI disk
</span><span class='line'>sd 6:0:0:0: [sdc] 536870912 512-byte logical blocks: (274 GB/256 GiB)
</span><span class='line'>sd 6:0:0:0: [sdc] Write Protect is off
</span><span class='line'>sd 6:0:0:0: [sdc] Mode Sense: 0f 00 10 00
</span><span class='line'>sd 6:0:0:0: [sdc] Write cache: enabled, read cache: enabled, supports DPO and FUA
</span><span class='line'>sd 6:0:0:0: [sdc] Attached SCSI disk
</span><span class='line'>sd 6:0:0:1: [sdd] 536870912 512-byte logical blocks: (274 GB/256 GiB)
</span><span class='line'>sd 6:0:0:1: [sdd] Write Protect is off
</span><span class='line'>sd 6:0:0:1: [sdd] Mode Sense: 0f 00 10 00
</span><span class='line'>sd 6:0:0:1: [sdd] Write cache: enabled, read cache: enabled, supports DPO and FUA
</span><span class='line'>sd 6:0:0:1: [sdd] Attached SCSI disk
</span><span class='line'>sd 6:0:0:2: [sde] 536870912 512-byte logical blocks: (274 GB/256 GiB)
</span><span class='line'>sd 6:0:0:2: [sde] Write Protect is off
</span><span class='line'>sd 6:0:0:2: [sde] Mode Sense: 0f 00 10 00
</span><span class='line'>sd 6:0:0:2: [sde] Write cache: enabled, read cache: enabled, supports DPO and FUA
</span><span class='line'>sd 6:0:0:2: [sde] Attached SCSI disk</span></code></pre></td></tr></table></div></figure>


<ul>
<li>parted で全セクタを使ってパーテーションを作成</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo parted /dev/sdc --script mklabel gpt
</span><span class='line'>$ sudo parted /dev/sdc --script 'mkpart disk1 ext4 1M -1'
</span><span class='line'>$ sudo parted /dev/sdc --script 'print'
</span><span class='line'>
</span><span class='line'>Model: Msft Virtual Disk (scsi)
</span><span class='line'>Disk /dev/sdc: 275GB
</span><span class='line'>Sector size (logical/physical): 512B/512B
</span><span class='line'>Partition Table: gpt
</span><span class='line'>
</span><span class='line'>Number  Start   End    Size   File system  Name   Flags
</span><span class='line'> 1      1049kB  275GB  275GB  ext4         disk1
</span><span class='line'>
</span><span class='line'>$ sudo parted /dev/sdd --script mklabel gpt
</span><span class='line'>$ sudo parted /dev/sdd --script 'mkpart disk2 ext4 1M -1'
</span><span class='line'>$ sudo parted /dev/sdd --script 'print'
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>$ sudo parted /dev/sde --script mklabel gpt
</span><span class='line'>$ sudo parted /dev/sde --script 'mkpart disk3 ext4 1M -1'
</span><span class='line'>$ sudo parted /dev/sde --script 'print'
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>$ sudo mkfs.ext4 /dev/sdc1
</span><span class='line'>... snip ...
</span><span class='line'>$ sudo mkfs.ext4 /dev/sdd1
</span><span class='line'>... snip ...
</span><span class='line'>$ sudo mkfs.ext4 /dev/sde1
</span><span class='line'>... snip ...</span></code></pre></td></tr></table></div></figure>


<ul>
<li>mount point 作って、/mnt/resouceとともにパーミッションを変更</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /mnt/data1 /mnt/data2 /mnt/data3
</span><span class='line'>$ chmod a+wrx /mnt/data*
</span><span class='line'>$ chmod a+wrx /mnt/resource
</span><span class='line'>$ ls -l /mnt/
</span><span class='line'>total 20
</span><span class='line'>drwx------ 3 root root 4096 Dec 21 15:56 cdrom
</span><span class='line'>drwxrwxrwx 2 root root 4096 Dec 22 21:04 data1
</span><span class='line'>drwxrwxrwx 2 root root 4096 Dec 22 21:04 data2
</span><span class='line'>drwxrwxrwx 2 root root 4096 Dec 22 22:47 data3
</span><span class='line'>drwxrwxrwx 4 root root 4096 Dec 21 22:14 resource
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>とりあえず、マウントして確認</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mount -t ext4 /dev/sdc1 /mnt/data1
</span><span class='line'>$ sudo mount -t ext4 /dev/sdd1 /mnt/data2
</span><span class='line'>$ sudo mount -t ext4 /dev/sde1 /mnt/data3
</span><span class='line'>
</span><span class='line'>$ df -T
</span><span class='line'>Filesystem     Type     1K-blocks    Used Available Use% Mounted on
</span><span class='line'>/dev/sda1      ext4      30953664 1142056  28539332   4% /
</span><span class='line'>udev           devtmpfs   1751196      12   1751184   1% /dev
</span><span class='line'>tmpfs          tmpfs       704872     280    704592   1% /run
</span><span class='line'>none           tmpfs         5120       0      5120   0% /run/lock
</span><span class='line'>none           tmpfs      1762172       0   1762172   0% /run/shm
</span><span class='line'>none           tmpfs       102400       0    102400   0% /run/user
</span><span class='line'>/dev/sdb1      ext4     139334632  192000 132064848   1% /mnt/resource
</span><span class='line'>/dev/sdc1      ext4     264221700  191576 250608456   1% /mnt/data1
</span><span class='line'>/dev/sdd1      ext4     264221700  191576 250608456   1% /mnt/data2
</span><span class='line'>/dev/sde1      ext4     264221700  191576 250608456   1% /mnt/data3</span></code></pre></td></tr></table></div></figure>


<ul>
<li>再起動してもマウントされるように、UUIDを確認して /etc/fstab に追加。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ blkid
</span><span class='line'>/dev/sda1: LABEL="cloudimg-rootfs" UUID="56d8a977-c1fe-461e-a328-b19fc47c743f" TYPE="ext4"
</span><span class='line'>/dev/sdb1: UUID="d063d8a2-32fc-486c-a9b4-e6bcf7e5deae" TYPE="ext4"
</span><span class='line'>/dev/sdd1: UUID="88f28b19-fdc6-46dc-a2d7-2daa1754754f" TYPE="ext4"
</span><span class='line'>/dev/sdc1: UUID="a1cb5045-178a-476e-9821-084f8f6d92a6" TYPE="ext4"
</span><span class='line'>/dev/sde1: UUID="15b8b45e-fbd0-4efc-9534-5e38b1877828" TYPE="ext4"
</span><span class='line'>
</span><span class='line'>$ vi /etc/fstab
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>$ cat /etc/fstab
</span><span class='line'>UUID=56d8a977-c1fe-461e-a328-b19fc47c743f       /        ext4   defaults        0 0
</span><span class='line'>UUID=a1cb5045-178a-476e-9821-084f8f6d92a6       /mnt/data1        ext4   defaults        0 0
</span><span class='line'>UUID=88f28b19-fdc6-46dc-a2d7-2daa1754754f       /mnt/data2        ext4   defaults        0 0
</span><span class='line'>UUID=15b8b45e-fbd0-4efc-9534-5e38b1877828       /mnt/data3        ext4   defaults        0 0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>最新にして再起動する</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt-get update
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>$ apt-get upgrade
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>$ shutdown -r now
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>iozone3 を入れる</li>
</ul>


<p>/etc/apt/sources.list を変更して、multiverse を追加（コメントを外しただけ）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /etc/apt/sources.list
</span><span class='line'>
</span><span class='line'>... snip ...
</span><span class='line'>
</span><span class='line'>$ apt-get update
</span><span class='line'>$ apt-get install iozone3 </span></code></pre></td></tr></table></div></figure>


<hr />

<h1>測定</h1>

<p>これで環境が出来たので測定します。基本的には、iozone 一発で細かいオプションの指定はしません。なんとなく、Excelファイルにしたのですが、面倒になるだけであまりメリットは無かったかもしれません。もし再試験してもらえるなら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iozone -Ra -f /mnt/resource/tmp/test -b sdb2-001.xls -s 1g
</span><span class='line'>iozone -Ra -f /mnt/data1/tmp/test -b sdc1-001hcnone.xls -s 1g
</span><span class='line'>iozone -Ra -f /mnt/data2/tmp/test -b sdd1-001hcro.xls -s 1g
</span><span class='line'>iozone -Ra -f /mnt/data3/tmp/test -b sde1-001hcrw.xls -s 1g</span></code></pre></td></tr></table></div></figure>


<p><a href="/files/2012_12/20121222-iozone-azurevm.zip">結果データ</a></p>

<h2>iozone の実行結果</h2>

<p>iozoneの測定結果をローカルドライブ、Data Diskの順で見ていく。それぞれの結果を図にした。</p>

<h3>ローカルディスクの性能</h3>

<p>まずは、ローカルドライブの実行結果から見る。読み込みはレコードサイズが8Kあたりから256KBまでは、2,500,000 KB/sec  - 3,000,000 KB/sec で、レコードサイズが増えていくとだんだん遅くなっていく。書き込み側は同じ軸ではとスケールが違い過ぎてよくわからない。</p>

<ul>
<li>図1 /dev/sdb2 ローカルドライブ 2012/12/22 測定
<img src="/images/2012_12/sdb2-rw.png" title="図1 /dev/sdb2 ローカルドライブ 2012/12/22 測定 " alt="図1 /dev/sdb2 ローカルドライブ 2012/12/22 測定" /></li>
</ul>


<p>そこで、書き込みの系統だけを表示させた。Record Rewriteの結果が桁外れに速い。これは<a href="http://www.iozone.org/docs/IOzone_msword_98.pdf" title="Iozone Filesystem Benchmark Download Documentation">ドキュメント</a>によると、同じ内容を繰り返し書き込むテストということなのでキャッシュの効果だろうと思われる。</p>

<ul>
<li>図1-1 /dev/sdb2 ローカルドライブ 書き込みのみ表示(1) 2012/12/22 測定
<img src="/images/2012_12/sdb2-note1-w.png" title="図1-1 /dev/sdb2 ローカルドライブ 書き込みのみ表示(1) 2012/12/22 測定" alt="図1-1 /dev/sdb2 ローカルドライブ 書き込みのみ表示(1) 2012/12/22 測定" /></li>
</ul>


<p>さらによく見ると、同じ再書き込みでも、Rewrite、Recoed Rewrite、Refwriteの違いがなかなか興味深い。Recoed Rewriteだけがリード並に桁外れに速い。Rewrite、Refwriteはファイル単位の再書き込みで、Recoed Rewriteは特定レコードの再書き込み（<a href="http://www.iozone.org/docs/IOzone_msword_98.pdf" title="Iozone Filesystem Benchmark Download Documentation">ドキュメント</a>から）ということなので、キャッシュが利く場合は限定されてるらしいことがわかる。
同じものを繰り返し書き込むというのは、現実にはあまり無いことなので、Rewriteをグラフから外して、書き込みのパフォーマンスを見やすくてみる。</p>

<ul>
<li>図2 /dev/sdb2 ローカルドライブ  書き込みのみ表示(2) 2012/12/22 測定
<img src="/images/2012_12/sdb2-w.png" title="図2 /dev/sdb2 ローカルドライブ  書き込みのみ表示(2) 2012/12/22 測定 " alt="図2 /dev/sdb2 ローカルドライブ  書き込みのみ表示(2) 2012/12/22 測定" /></li>
</ul>


<p>小さいブロックのランダム書き込みが苦手だということがわかる。これはHDDの一般的な傾向で納得できる。以降では書き込みの図は図2と同じデータ項目を表示する。</p>

<h3>Data Diskの性能</h3>

<p>話題のData Diskの性能に入る。ローカルドライ比較で、読み込みはほぼ同等な性能だったが、書き込みは半分程度の性能しか出ていない。
ホストキャッシュの設定で大きな違いが出ることを期待したが図を見る限りでは顕著な違いというほどには違いは無かった。</p>

<ul>
<li><p>図3 /dev/sdc1 ホストキャッシュなし 2012/12/22 測定
<img src="/images/2012_12/sdc1-rw.png" title="図3 /dev/sdc1 ホストキャッシュなし 2012/12/22 測定 " alt="図3 /dev/sdc1 ホストキャッシュなし 2012/12/22 測定 " /></p></li>
<li><p>図4 /dev/sdc1 ホストキャッシュなし 2012/12/22 書き込みのみ表示  測定
<img src="/images/2012_12/sdc1-w.png" title="図4 /dev/sdc1 ホストキャッシュなし 2012/12/22 書き込みのみ表示  測定" alt="図4 /dev/sdc1 ホストキャッシュなし 2012/12/22 書き込みのみ表示  測定 " /></p></li>
<li><p>図5 /dev/sdd1 ホストキャッシュ 読み取り専用 2012/12/22 測定
<img src="/images/2012_12/sdd1-rw.png" title="図5 /dev/sdd1 ホストキャッシュ 読み取り専用 2012/12/22 測定 " alt="図5 /dev/sdd1 ホストキャッシュ 読み取り専用 2012/12/22 測定 " /></p></li>
<li><p>図6 /dev/sdd1 ホストキャッシュ 読み取り専用 書き込みのみ表示 2012/12/22 測定
<img src="/images/2012_12/sdd1-w.png" title="図6 /dev/sdd1 ホストキャッシュ 読み取り専用 書き込みのみ表示 2012/12/22 測定 " alt="図6 /dev/sdd1 ホストキャッシュ 読み取り専用 書き込みのみ表示 2012/12/22 測定 " /></p></li>
<li><p>図7 /dev/sde1 ホストキャッシュ 読み取り/書き込み 2012/12/22 測定
<img src="/images/2012_12/sde1-rw.png" title="図7 /dev/sde1 ホストキャッシュ 読み取り/書き込み 2012/12/22 測定 " alt="図7 /dev/sde1 ホストキャッシュ 読み取り/書き込み 2012/12/22 測定 " /></p></li>
<li><p>図8 /dev/sde1 ホストキャッシュ 読み取り/書き込み 書き込みのみ表示 2012/12/22 測定
<img src="/images/2012_12/sde1-w.png" title=" 図8 /dev/sde1 ホストキャッシュ 読み取り/書き込み 書き込みのみ表示 2012/12/22 測定 " alt="図8 /dev/sde1 ホストキャッシュ 読み取り/書き込み 書き込みのみ表示 2012/12/22 測定 " /></p></li>
</ul>


<hr />

<h1>結論</h1>

<p>iozoneという選択肢がどうだったのかという気もしてるが、なかなか調子が良い。最初にパフォーマンス向上的な話ではなじめたが、7/4の結果に比べて劇的に変わっているという気はしない。
もう少しデータを精査する必要を感じるが、思ったより長くなりすぎたので、また別の方法を絡めて再考してみようと思う。</p>

<p>今回、テスト自体は一回しか走らせていないので再試験して結果を公開してもらえるとみんなの役に立つも思います。今まで、Azure Tableの性能評価をしたこともありましたが、何度か走らせると結果が違ったり、いつの間にかパフォーマンスが改善されたりなどすることがありました。
いろいろなパターンの性能情報があると設計が楽になり精度もあがりますし。</p>

<h1>Bookmarks</h1>

<ul>
<li><a href="http://www.iozone.org/" title="Iozone Filesystem Benchmark">Iozone Filesystem Benchmark</a></li>
<li><a href="http://www.iozone.org/docs/IOzone_msword_98.pdf" title="Iozone Filesystem Benchmark Download Documentation">Iozone Filesystem Benchmark Download Documentation</a></li>
<li><a href="http://sourceforge.jp/magazine/08/09/05/0759223" title="IOzoneによるファイルシステムのパフォーマンス測定">IOzoneによるファイルシステムのパフォーマンス測定</a></li>
<li><a href="http://www.slideshare.net/takekazuomi/azure-ubuntu-1204-iozone" title="Azure Ubuntu 12.04 iozone 速報 2012/7/4">Azure Ubuntu 12.04 iozone 速報 2012/7/4</a></li>
</ul>


<hr />
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Takekazu Omi</span></span>

      








  


<time datetime="2012-12-23T18:40:00+09:00" pubdate data-updated="true"> 12/23/2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/azure/'>Azure</a>, <a class='category' href='/blog/categories/cloud/'>Cloud</a>, <a class='category' href='/blog/categories/iaas/'>IaaS</a>, <a class='category' href='/blog/categories/linux/'>Linux</a>, <a class='category' href='/blog/categories/ubuntu/'>Ubuntu</a>, <a class='category' href='/blog/categories/vitualmachine/'>VitualMachine</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://takekazuomi.github.com/blog/2012/12/23/azurevmfix1221/" data-via="takekazuomi" data-counturl="http://takekazuomi.github.com/blog/2012/12/23/azurevmfix1221/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/12/08/blobasyncinside/" title="Previous Post: Windows Azure Storage 2.0 の Blob Upload">&laquo; Windows Azure Storage 2.0 の Blob Upload</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/12/26/asc2-dot-0asyncbug/" title="Next Post: Azure Storage Client 2.0 CompletedSynchronously FIX">Azure Storage Client 2.0 CompletedSynchronously FIX &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/26/asc2-dot-0asyncbug/">Azure Storage Client 2.0 CompletedSynchronously FIX</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/23/azurevmfix1221/">Azure Virtual MachineのDISK性能</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/08/blobasyncinside/">Windows Azure Storage 2.0 の Blob Upload</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/08/WAAC2012Day2/">Azure Storage Gen 2は速かった</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/takekazuomi">@takekazuomi</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'takekazuomi',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("takekazuomi", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/takekazuomi" class="twitter-follow-button" data-show-count="false">Follow @takekazuomi</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Takekazu Omi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cloudmemo';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://takekazuomi.github.com/blog/2012/12/23/azurevmfix1221/';
        var disqus_url = 'http://takekazuomi.github.com/blog/2012/12/23/azurevmfix1221/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/all.js#appId=493394520681616&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
