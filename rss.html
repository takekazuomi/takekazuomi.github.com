<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Kyrt Blog</title>
        <link>http://kyrt.in/</link>
        <description>もろもろの備忘録、C#とAzureなど</description>
        <language>en-us</language>
        <pubDate>Sat, 02 Dec 2017 00:00:00 +0900</pubDate>
        
        <item>
            <link>http://kyrt.in/2017/12/02/cross_subscription_deployment.html</link>
            <guid>http://kyrt.in/2017/12/02/cross_subscription_deployment.html</guid>
            <title><![CDATA[複数Subscriptionへのデプロイ]]></title>
            <description><![CDATA[<h1>複数Subscriptionへのデプロイ</h1>
<p>この記事は<a class="reference external" href="https://qiita.com/advent-calendar/2017/azure">Microsoft Azure Advent Calendar 2017</a>の2日目の記事です。</p>
<p>ちょっと便利な、ARM template の小技を紹介します。</p>
<p>以前から１つのテンプレートを使って、複数のリソースグループへデプロイすることができましたが<a class="footnote-reference" href="#ref1" id="id1">[1]</a>。さらに、<span class="docutils literal"><span class="pre">Microsoft.Resources/deployments</span></span>の<span class="docutils literal"><span class="pre">API</span> <span class="pre">Version:</span> <span class="pre">2017-05-10</span></span>から、別のサブスクリプションへもデプロイできるようになりました。<a class="footnote-reference" href="#ref2" id="id2">[2]</a></p>
<p>リソースを異なるサブスクリプションにデプロイするには、別のリソースグループへデプロイする時と同じように、nested template(<span class="docutils literal"><span class="pre">Microsoft.Resources/deployments</span></span>) を使います。 deployments リソースにsubscriptionId プロパティが追加され、そこに指定したサブスクリプションにnested templateで定義したリソースが展開されるってわけです、簡単ですね。</p>
<a data-flickr-embed="true" href="https://www.flickr.com/photos/takekazuomi/34268600011/in/dateposted-public/" title="IMG_3105"><img src="https://farm5.staticflickr.com/4185/34268600011_c2ec225de5_c.jpg" width="800" height="534" alt="IMG_3105"/></a><script async="" src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"/><p>ちょっとやってみましょう、下にテンプレートの抜粋を見て下さい。<a class="footnote-reference" href="#ref3" id="id3">[3]</a>テンプレートは、別のリソースグループへデプロイする時とほぼ同じで、8行目のsubscriptionId のところが違うぐらいなのがわかります。</p>
<script src="https://gist.github.com/takekazuomi/e8bdc99a8fa56f5875e753915001bdc6.js?file=deploystorage-chunk.json"/><p>これで上手くデプロイできるか確認しましょう。 local subscription (083c462a-7c24-4a16-8bfe-876cb0ab434b) を選択した状態でデプロイします。そうするとストレージアカウント(東日本)が作成され、同時に remote subscription (ff05d8ad-12ee-4c68-97bb-78baefa1c01a) にもストレージアカウント（西日本）も作成されます。</p>
<p>実行には事前に、リソースグループが必要です。サブスクリプションを切替ながら、リソースグループを両側に用意します。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ Select-AzureRmSubscription -SubscriptionId 083c462a-7c24-4a16-8bfe-876cb0ab434b
$ New-AzureRmResourceGroup -Name LocalRG -Location japaneast

$ Select-AzureRmSubscription -SubscriptionId ff05d8ad-12ee-4c68-97bb-78baefa1c01a
$ New-AzureRmResourceGroup -Name RemoteRG -Location japanwest
</pre></div>
</div>
<p>これでリソースグループが出来たので、local subscription を選択し直して、前記のテンプレートをデプロイします。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ Select-AzureRmSubscription -SubscriptionId 083c462a-7c24-4a16-8bfe-876cb0ab434b
$ New-AzureRmResourceGroupDeployment -TemplateFile .\deploystorage.json `
       -StorageAccountName kyrtlocal01 `
       -ResourceGroupName LocalRG `
       -RemoteResourceGroup RemoteRG `
       -RemoteSubscriptionId ff05d8ad-12ee-4c68-97bb-78baefa1c01a `
       -RemoteStorageAccountName kyrtremote01
</pre></div>
</div>
<p>思った通りに出来ているか確認しましょう。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ Select-AzureRmSubscription -SubscriptionId 083c462a-7c24-4a16-8bfe-876cb0ab434b
$ Get-AzureRmStorageAccount -ResourceGroupName RemoteRG | fl ResourceGroupName,Id, Location

ResourceGroupName : localrg
Id                : /subscriptions/08.../resourceGroups/localrg/providers/Microsoft.Storage/storageAccounts/kyrtlocal01
Location          : japaneast


$ Select-AzureRmSubscription -SubscriptionId ff05d8ad-12ee-4c68-97bb-78baefa1c01a
$ Get-AzureRmStorageAccount -ResourceGroupName RemoteRG | fl ResourceGroupName,Id, Location

ResourceGroupName : remoterg
Id                : /subscriptions/ff.../resourceGroups/remoterg/providers/Microsoft.Storage/storageAccounts/kyrtremote01
Location          : japanwest
</pre></div>
</div>
<p>ストレージアカウントが２つ作成され、それぞれ別のサブスクリプションに東日本と西日本に配置されているのが確認できました。複数サブスクリプションへの配置が必要なケースはあまり無い気もしますが、なかなか面白いですね。</p>
<div class="section" id="id4">
<h2>注意</h2>
<p>テンプレートの、<a class="reference external" href="https://gist.github.com/takekazuomi/e8bdc99a8fa56f5875e753915001bdc6#file-deploystorage-json-L38">38行目</a>で、location を西日本を直接指定しています。 ここを、<span class="docutils literal"><span class="pre">location":</span> <span class="pre">"[resourceGroup().location]</span></span>としたら、locationが東日本になってしました。<span class="docutils literal"><span class="pre">resourceGroup()</span></span>は、親のdeploymentsリソースを指すようです。ちょっと混乱しますが、「まあ納得できる範囲かな」という気はします。</p>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>今回の元ネタは、<a class="reference external" href="https://github.com/rjmax">@rjmax</a>の、<strong>Demos for Ignite US 2017 session BRK3167</strong><a class="footnote-reference" href="#ref4" id="id7">[4]</a>です。このレポジトリだけで無く彼のレポジトリはARM template を使う人には必見の情報満載です、素晴らしい。特に、<a class="reference external" href="https://github.com/rjmax/ArmExamples">rjmax/ArmExamples</a>はお勧めですよ、ここのテンプレートは短くて見やすいのも良い感じです。</p>
</div>
<div class="section" id="id8">
<h2>参照</h2>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/resource-manager-cross-resource-group-deployment">複数のリソース グループに Azure リソースをデプロイする</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://myignite.microsoft.com/sessions/53286">Tips and tricks with Azure Resource Manager - BRK3167, Ryan Jones</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://gist.github.com/takekazuomi/e8bdc99a8fa56f5875e753915001bdc6#file-deploystorage-json">完全なテンプレート deploystorage.json</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td><a class="reference external" href="https://github.com/rjmax/IgniteUS2017">Demos for Ignite US 2017 session BRK3167 - Tips and Tricks with Azure Resource Manager, @rjmax</a></td></tr>
</tbody>
</table>
</div>
]]></description>
             <pubDate>Sat, 02 Dec 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/07/02/2017_mvp.html</link>
            <guid>http://kyrt.in/2017/07/02/2017_mvp.html</guid>
            <title><![CDATA[2017 Microsoft MVP Award を受賞しました]]></title>
            <description><![CDATA[<h1>2017 Microsoft MVP Award を受賞しました</h1>
<p>2017年7月期、Microsoft Azure のカテゴリで、Microsoft MVP Award を受賞しました。</p>
<p>今年は、Cosmos DBの年ですね、楽しみな年になりそうです。</p>
<p>これからも、よろしくお願いいたします。</p>
<a class="reference external image-reference" href="https://flic.kr/p/vbP6io"><img alt="Stone" class="align-center" src="https://farm1.staticflickr.com/517/19156699324_42857a33b9_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
]]></description>
            <category><![CDATA[ MVP ]]></category>
             <pubDate>Sun, 02 Jul 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/06/03/az_login_device_flow.html</link>
            <guid>http://kyrt.in/2017/06/03/az_login_device_flow.html</guid>
            <title><![CDATA[Azure に OAuth 2.0 Device Flow でログインする]]></title>
            <description><![CDATA[<h1>Azure に OAuth 2.0 Device Flow でログインする</h1>
<p>この前<strong>az login</strong>でログイン出来なくなった時に、azure cli 2.0 のコードを見ていたら、Azureのドキュメントには出てこない（見慣れない）使い方をしてたので確認も兼ねて生REST、OAuth 2.0 Device Flow<a class="footnote-reference" href="#ref1" id="id1">[1]</a>でAzrueにloginして Beare Tokenを取得するコンソールプログラム<strong>azlogin</strong><a class="footnote-reference" href="#ref2" id="id2">[2]</a>を書いてみた。</p>
<a class="reference external image-reference" href="https://flic.kr/p/TPKV1d"><img alt="curry" class="align-center" src="https://c1.staticflickr.com/3/2871/34014638600_dbb3a232b1_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id3">
<h2>使い方</h2>
<p><strong>azlogin</strong>を実行すると、azure cli 2.0 と同じように、デバイスコードと入力用のURLが表示される。この画面のメッセージが<strong>azure cli 2.0</strong>と一文一句違わず同じなのは、AIPが返して来るメッセージをそのまま表示してるからだ。</p>
<p>ログインに成功すると、アカウントに紐づいたテナントを全部取得して、テナントのアクセストークンを取得し、それを使ってサブスクリプションの情報を取得。結果をJSONで出力する。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ .\azlogin
To sign in, use a web browser to open the page https://aka.ms/devicelogin and enter the code G9HFZ4NCY to authenticate.
....
[
   {
     "tenantId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionName": "Developer Program Benefit",
     "bearer": "********************************************a"
   },
   {
     "tenantId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionName": "foo",
     "bearer": "********************************************a"
   },
   {
     "tenantId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionId": "xxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxxxxx",
     "subscriptionName": "kinmugi",
     "bearer": "********************************************a"
   }
]
</pre></div>
</div>
<p>このJSONから、Bearer token を取得し変数に保存するして置き、APIの呼び出しをしてみよう。</p>
<p>まずは、jp (JMESPath) の式を用意する。短いのでコマンドラインにそのまま書きたいところだが、Windowsだとエスケープ関係が難しすぎる（cmd.exeや、powershellでは）ので、諦めてファイルに書く。</p>
<p>この例だと、subscriptionName が ‘kinmugi’のサブスクリプションのBearer tokenを取り出している。Windowsだと素直にPowerShellで書いたほうが楽な気がする。最近、JMESPath が気に入っているので、あえてjpを使う。</p>
<p>ここでは、本物の<strong>curl</strong>を使って、リソースグループの一覧を取得している。PowerShellだとcurlでaliasが切ってあるが使えないので、本物を入れてalias を切った方が良い。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ cat filter.jp
[?subscriptionName == 'kinmugi'].bearer|[0]

$ $bearer = (.\azlogin | jp -u -e filter.jp)

$ curl -H  "Authorization: Bearer $bearer" "https://management.azure.com/subscriptions/xxxxxxxx-.../resourcegroups?api-version=2017-05-10"
</pre></div>
</div>
<p>Bearer tokenさえ手に入れれば、こんな感じでサクッと管理APIが呼べる。</p>
</div>
<div class="section" id="id4">
<h2>最後に</h2>
<p>Azureのドキュメントだとごちゃごちゃしてて良くわからないが、認証は基本普通のOAuth 2.0 なのでそれほど難しくない。このあたりで困ったら、OAuth2.0 のドキュメント（Googleのとか 、翻訳もある<a class="footnote-reference" href="#ref3" id="id5">[3]</a>）を読むと良い。Azure固有の問題は、松崎さんのブログ<a class="footnote-reference" href="#ref4" id="id6">[4]</a>がお勧めだ。</p>
<p>今回は、生RESTだけで構築したが、認証だけならそれほど難しいことはない。本格的にAzureを触ろうと思うとモデルが欲しくなり。触っていくと大量のモデルが出てくるので自前で作るのはとてもメンドクサイ。その場合はAzureSDKを使うと既にモデルが用意去れているので便利だ。</p>
</div>
<div class="section" id="id7">
<h2>参考</h2>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://developers.google.com/identity/protocols/OAuth2">Using OAuth 2.0 to Access Google APIs</a>,<a class="reference external" href="https://developers.google.com/identity/protocols/OAuth2ForDevices">OAuth 2.0 for TV and Limited-Input Device Applications</a>,</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://github.com/takekazuomi/azlogin">Azure Login OAuth 2.0 Device Flow Console Program.</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td><a class="reference external" href="https://developers.google.com/youtube/v3/guides/auth/devices?hl=ja">OAuth 2.0 Flow: Devices</a>YouTube Data APIのドキュメントだが、翻訳されている。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td><a class="reference external" href="https://blogs.msdn.microsoft.com/tsmatsuz/2016/03/12/azure-ad-device-profile-oauth-flow/">Login UI が出せない Client の OAuth フロー (Azure AD)</a>この記事より松崎さんのブログを読んだほうが良いだろう。</td></tr>
</tbody>
</table>
<p>下記のコードも参考になる</p>
<ul class="simple">
<li><a class="reference external" href="https://azure.microsoft.com/en-us/resources/samples/active-directory-dotnet-deviceprofile/">Invoking an API protected by Azure AD from a text-only device</a></li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sat, 03 Jun 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/05/19/install_azure_powershell.html</link>
            <guid>http://kyrt.in/2017/05/19/install_azure_powershell.html</guid>
            <title><![CDATA[Azure PowerShellのインストール事情]]></title>
            <description><![CDATA[<h1>Azure PowerShellのインストール事情</h1>
<p>最近のAzure PowerShellのインストール事情が少々メンドクサイことになっているのでメモ代わりに書き留める。</p>
<p>基本は、Azure テクニカル サポート チームが<a class="reference external" href="https://blogs.technet.microsoft.com/jpaztech/2017/05/02/azure-powershell-3-8-0-install/">Azure PowerShell 最新版のインストール手順 (v3.8.0 現在)</a>に書いている状況だが、いろいろあるので書いた。</p>
<p><strong>更新： 2017/7/7、Azure PowerShell 4.1.0 時点の情報</strong></p>
<p>この問題を、VSのフィードバックに上げた所返事が来ました。</p>
<p><a class="reference external" href="https://developercommunity.visualstudio.com/solutions/67232/view.html">https://developercommunity.visualstudio.com/solutions/67232/view.html</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">To work around the issue please install the latest Azure PowerShell MSI from GitHub.</div>
<div class="line"><a class="reference external" href="https://github.com/Azure/azure-powershell/releases">https://github.com/Azure/azure-powershell/releases</a></div>
</div>
</div></blockquote>
<p>「VS 2017を入れている場合は、とりあえず MSI経由のインストールをして欲しい、最新版は、GitHubのリリースページにあるよ」ということで、色々あるけど当面はMSIで入れましょう。</p>
<p><strong>2017/5/19、Azure PowerShell 4.0.1 時点の情報です</strong></p>
<a class="reference external image-reference" href="https://flic.kr/p/T8kWHy"><img alt="sky" class="align-center" src="https://c1.staticflickr.com/5/4184/33557301834_6e7ab21ef7_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>推薦されるインストール方法</h2>
<p>以前は、WebPI経由でAzure PowerShellをインストールしていたが、現在では PowerShell Gallery 経由のインストールが推薦になっている。公式ドキュメント、<a class="reference external" href="https://docs.microsoft.com/ja-jp/powershell/azure/install-azurerm-ps">Install and configure Azure PowerShell</a>にも、下記のように書かれている。（ちょっと翻訳が追いついていないようで、サイトは英語のまま）</p>
<blockquote>
<div>Installing Azure PowerShell from the PowerShell Gallery is the preferred method of installation.</div></blockquote>
<p>Windows 10、Windows Server 2016より古いOSではデフォルトでPowerShellGetが使えないので、Windows Management Framework (WMF) 5.0 を入れる必要がある<a class="footnote-reference" href="#ref1" id="id2">[1]</a>。</p>
<p>PowerShellGetでPowerShell Galleryから方法は簡単だ。（以下、Install-Moduleで入れると記載）</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ Install-Module AzureRm
</pre></div>
</div>
</div>
<div class="section" id="msi">
<h2>MSIからのインストール</h2>
<p>Install-Moduleで入れる方法の他に。Web Platform Installer (WebPI) やVisual Studio 2017のVisual Studio Installer での、Azure「Azure development」の選択、GitHubからMSIファイルをダウンロード<a class="footnote-reference" href="#ref2" id="id3">[2]</a>などの方法で、MSIファイルからインストールすることができる。MSIファイルからインストールは推薦されていないが、VS経由の時にように選択の余地なくMSI経路でインストールされてしまうこともある。</p>
<p>また、ググって出てくる日本語の公式ページが<a class="reference external" href="https://docs.microsoft.com/ja-jp/powershell/azure/other-install">その他のインストール方法</a>で、その他の方法としてMSIでのインストール方法を紹介している。ここには推薦は、Install-Moduleを使うことだと書いてあるが、よく読まないで書いてある通りに操作するとMSIで入れてしまうという落とし穴もある。今のところVisual Studio 2017 で入るのは 2.1.0と大分古いバージョンだというのがいろいろな問題を面倒にしている。</p>
</div>
<div class="section" id="msi-install-module">
<h2>問題点：MSI -&gt; Install-Module でエラー</h2>
<p>PowerShell Gallery と、MSI 経由のインストールには互換性が無く、MSI経由でAzure PowerShellが入った環境に PowerShell Gallery で新しいものを入れたり<span class="docutils literal"><span class="pre">Install-Module</span> <span class="pre">AzureRM</span></span>、アップデート<span class="docutils literal"><span class="pre">Update-Module</span> <span class="pre">AzureRm</span></span>することはできない。</p>
<p>例えば、Visual Studio 2017のインストールで、Azure PowerShellが入っている状態で、<span class="docutils literal"><span class="pre">Install-Module</span> <span class="pre">AzureRM</span></span>を やると下記のようなエラーになる。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ install-module AzureRm

PackageManagement\Install-Package : The following commands are already available on this system:'Get-AzureStorageContainerAcl,Start-CopyAzureStorageBlob,Stop-CopyAzureStorageBlob'. This module 'Azure.Storage' may override the existing commands. If you still want to install this module 'Azure.Storage', use -AllowClobber parameter.
At C:\Program Files\WindowsPowerShell\Modules\PowerShellGet\1.0.0.1\PSModule.psm1:1809 char:21
+ ...          $null = PackageManagement\Install-Package @PSBoundParameters
+                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (Microsoft.Power....InstallPackage:InstallPackage) [Install-Package], Exception
    + FullyQualifiedErrorId : CommandAlreadyAvailable,Validate-ModuleCommandAlreadyAvailable,Microsoft.PowerShell.PackageManagement.Cmdlets.InstallPackage
</pre></div>
</div>
<p>つまり、MSIインストールとInstall-Moduleは互換性が無く、「混ぜるな危険」という状況だ。</p>
</div>
<div class="section" id="id5">
<h2>解決策</h2>
<p>もし混ざってしまったからどうするか。</p>
<p>MSIで入れたものを、設定画面の、「アプリと機能」、あるいはコントロールパネルの「プログラムのアンインストールまたは変更」からアンイストール後、再度 Install-Moduleで PowerShell Gallery からインストールする。</p>
<p>下記は、PowerShellからアンインストールする方法。実行には、Admin権限が必要。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ $app = Get-WmiObject -Class Win32_Product -Filter "Name like '%Azure PowerShell%'"
$ $app

IdentifyingNumber : {CB3F8A12-1570-4964-8206-17274AB9EF4D}
Name              : Microsoft Azure PowerShell - September 2016
Vendor            : Microsoft Corporation
Version           : 2.1.0
Caption           : Microsoft Azure PowerShell - September 2016

$ $app.Uninstall()
</pre></div>
</div>
<p>これで下記のように入れ直すと入る。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ Install-Module AzureRM
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>原因</h2>
<p>MSIで入れた場合とInstall-Moduleで入れた場合、モジュールは別の場所に入る。</p>
<p>MSIの場合は、下記のPSModulePathに入り</p>
<blockquote>
<div><div class="line-block">
<div class="line">C:Program Files (x86)Microsoft SDKsAzurePowerShellResourceManagerAzureResourceManager</div>
<div class="line">C:Program Files (x86)Microsoft SDKsAzurePowerShellServiceManagement</div>
<div class="line">C:Program Files (x86)Microsoft SDKsAzurePowerShellStorage</div>
</div>
</div></blockquote>
<p>Install-Moduleの場合は下記に入る</p>
<blockquote>
<div>C:Program FilesWindowsPowerShellModules</div></blockquote>
<p>MSIで入れた後にInstall-Moduleで入れた場合、MSIで入れたものを認識せずにインストールが進み、途中で別のバージョンのモジュールをロードして前記のエラーになる。Install-Moduleで入れた後に、MSIで入れると次のような問題が起きる。</p>
</div>
<div class="section" id="id7">
<h2>MSIインストールの問題点</h2>
<p>現在のMSIインストールで把握している問題点は3点ある（増えるかも）、そのうち深刻なのは1つ目の問題だ。</p>
<ol class="arabic simple">
<li>Install-Moduleのモジュールを無条件上書きする</li>
<li>Import-Module AzureRMでエラー</li>
<li>WebPIでのリリースが遅い</li>
</ol>
</div>
<div class="section" id="install-module">
<h2>1. Install-Moduleのモジュールを無条件上書</h2>
<p>現在のMSIインストールは、Install-Moduleで入れたModuleがあれば削除してから、モジュールのインストールを行う。そのとき既存のモジュールのバージョンは見ていないので、Install-Moduleで4.0.1などのあたらしいバージョンを入れていても、VS 2017 を入れると、2.1.0になってしまうなどの現象が起きる。削除処理は、<a class="reference external" href="https://github.com/Azure/azure-powershell/blob/preview/setup/Setup/RemoveGalleryModules.ps1">setup/Setup/RemoveGalleryModules.ps1</a>のあたり。 Scope CurrentUserで入れた場合は考慮されておらず、なかなか残念なコードだ。</p>
<p>MSIだけで、バージョンアップを重ねている場合は、Windowsのインストールの仕組みでバージョンチャックされて古いバージョンは入らないので問題がないが、Install-Module(psget)で入れたものとの共存は考えられておらず、いきなり古いバージョンで上書きされるというわけだ。<a class="footnote-reference" href="#ref3" id="id8">[3]</a></p>
<p>これは非常にメンドクサイ</p>
</div>
<div class="section" id="import-module-azurerm">
<h2>2. Import-Module AzureRMでエラー</h2>
<p>MSIで入れると、<span class="docutils literal"><span class="pre">Import-Module</span> <span class="pre">AzureRm</span></span>がエラーになる。これは、<span class="docutils literal"><span class="pre">AzureRM</span></span>というマニフェストモジュールが無いのが原因。Azure Poshの説明のあちこちで、<span class="docutils literal"><span class="pre">Import-Module</span> <span class="pre">AzureRM</span></span>が出て来るが、実はあまり意味がなく、モジュールはインストール時にModule Path配下に配置され、自動的にロードされるので、マニフェストモジュールが無くても動作上の不都合は無い。ただ、ドキュメントに書いてあるものがエラーになるのはちょと混乱する。ちなみに、<span class="docutils literal"><span class="pre">Install-Module</span></span>経由で入れてた場合は、AzureRM マニフェストモジュールが入り、<span class="docutils literal"><span class="pre">Import-Module</span> <span class="pre">AzureRM</span></span>も成功する。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ import-module azurerm
import-module : The specified module 'azurerm' was not loaded because no valid module file was found in any module directory.
At line:1 char:1
+ import-module azurerm
+ ~~~~~~~~~~~~~~~~~~~~~
   + CategoryInfo          : ResourceUnavailable: (azurerm:String) [Import-Module], FileNotFoundException
   + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand
</pre></div>
</div>
</div>
<div class="section" id="webpi">
<h2>3. WebPIでのリリースが遅い</h2>
<p>なかなか、WebPIにリリースされない。今回だと、Managed Diskの機能がサポートされたバージョンはしばらく放置され、5/10にやっとリリースされた。最新版を使いたい場合は、Install-Module経由で入れるしかない。WebPIに頼らずに、GitHubからMSIをダウンロードして入れるという方法もある。<a class="footnote-reference" href="#ref2" id="id9">[2]</a></p>
</div>
<div class="section" id="id10">
<h2>まとめ</h2>
<p>Azure PowerShell を使う場合、<span class="docutils literal"><span class="pre">Install-Module</span> <span class="pre">AzureRM</span></span>で入れる、VS 2017や以前WebPIで入れている場合は、一度コンパネからアンインストールしてから入れる。Windows 10より古い環境では、WMF 5.0を入れよう。</p>
<p>今のVS 2017は、リリースのたびにAzure PowerShellの古いバージョンを入れてくるが、挫けずにアンインストールしてから入れ直す。</p>
<p>現状だとGitHubからダウンロードして、MSIインストールで運用という手もあるが、推薦インストール方法が<span class="docutils literal"><span class="pre">Install-Module</span></span>経由なので、そちらを取った方が無難だろう。VS 2017が原因で面倒なことになっているのは残念だ。</p>
</div>
<div class="section" id="id11">
<h2>参考</h2>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="https://docs.microsoft.com/ja-jp/powershell/azure/install-azurerm-ps?view=azurermps-4.0.0#how-to-get-powershellget">How to get PowerShellGet</a>WMF 5.0 を入れようという話が書いてある</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id9">2</a>)</em> <a class="reference external" href="https://github.com/Azure/azure-powershell/releases/tag/v4.0.1--May2017">azure-powershell.4.0.1.msi</a>リリースのとこに、msiへのリンクがある。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[3]</a></td><td><a class="reference external" href="https://developercommunity.visualstudio.com/content/problem/41135/vs-installer-overwrite-with-old-version-azure-powe.html">VS Installer overwrite with old version Azure PowerShell.</a>すぐTriaged になったけど、その後の動きがない。</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Posh ]]></category>
            <category><![CDATA[ PowerShell ]]></category>
             <pubDate>Fri, 19 May 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/05/14/azure_cosmos_intro.html</link>
            <guid>http://kyrt.in/2017/05/14/azure_cosmos_intro.html</guid>
            <title><![CDATA[Azure Cosmos DB がやってきた]]></title>
            <description><![CDATA[<h1>Azure Cosmos DB がやってきた</h1>
<p>DocumentDB の記事を書いていたら<a class="footnote-reference" href="#ref15" id="id1">[15]</a>、//Build 2017で、Azure Cosmos DB が発表<a class="footnote-reference" href="#ref1" id="id2">[1]</a>された。 Cosmos DBは、Multi-model database and multi-APIのGlobally Distributed データベース・サービスだ。</p>
<div class="figure align-center" id="id30">
<img alt="Azure Cosmos DB in KeyNote" src="http://kyrt.in/_images/keynote01.png"/>
<p class="caption"><span class="caption-text">//Build 2017 Keynote より <a class="footnote-reference" href="#ref1" id="id3">[1]</a></span></p>
</div>
<p>「DocumentDB何処行った、名前が変わったの？」と思ったら、そんなに簡単な話では無かった、Azure Cosmos DBは、DocumentDB、MongoDB, Azure Table,Gremlin などの複数のAPIをサポートしたマルチモデルの分散データベース<a class="footnote-reference" href="#ref2" id="id4">[2]</a>で Document DBはそのAPIの一つという位置づけになった。従来の Document DBで使ってた分散データベース基盤の部分は、ある程度汎用的に出来ていてJSON以外のデータモデルも扱えるので、今回はKey-Value と GraphのデータモデルにAPIを付けてブランディングも新たにお披露目したよという話だ。素晴らしい。</p>
<p>ざっくりまとめると、下図のような感じになってる。Cosmos 分散データベース基盤に、データモデルが乗っていて、それぞれAPIを提供するといった感じだ。AzureTable(Key-Value), Gremlin(Graph) は、Preview(既に試すことができる)で、Splark は、アナウンスだけ、DocumentDBとMongoDB APIはGAのままだ。この２つがGAのままなのは、Cosmos DBになっても基本的な実装は同じだからだろう。</p>
<div class="figure align-center" id="id31">
<img alt="Azure Cosmos DB in KeyNote" src="http://kyrt.in/_images/pic01.png"/>
<p class="caption"><span class="caption-text">Azure Cosmos DB スタック</span></p>
</div>
<div class="section" id="breakout-session">
<h2>Breakout Session</h2>
<p>//Build 2017のCosmos DBの2つのBreakout Session、B8047<a class="footnote-reference" href="#ref3" id="id5">[3]</a>と、T6058<a class="footnote-reference" href="#ref4" id="id6">[4]</a>では、もう少し詳細に触れられている。</p>
<div class="figure align-center" id="id32">
<img alt="Table API in Azure Cosmos DB" src="http://kyrt.in/_images/B8047-02.png"/>
<p class="caption"><span class="caption-text">//Build 2017 B8047 より <a class="footnote-reference" href="#ref3" id="id7">[3]</a></span></p>
</div>
<p>その中でも興味深いのは、B8047 のTable APIの下りだ（動画だと35:50あたり<a class="footnote-reference" href="#ref5" id="id8">[5]</a>)。超訳すると。</p>
<blockquote>
<div>Cosmos DB に、既存のTable Storage（以下Standard Storage)互換のTable API（以下Premium Table）を実装した。もう、Premium Table SDK<a class="footnote-reference" href="#ref6" id="id9">[6]</a>をダウンロードして試せる。アプリケーションの変更は必要ない（SDKでを切り替えるだけ）で、ローレイテンシー、5つの一貫性、グローバルディストリビューション、セカンダリーインデックス等、数々のCosmos DBの特性が得られる。</div></blockquote>
<p>特に重要なのは、これに続く部分だ。</p>
<blockquote>
<div>現在「storage optimized offer」に向けて作業中、現在の Cosmos DB は、スループットの最適化、ローレイテンシーなどのpremium experience にフォーカスしているが、hot work load 以外の場合でも選択肢にできるように取り組んでいる。</div></blockquote>
<p>現在のCosmos DB（旧DocumentDB）の料金体系は、基本hot work load向けだ。アクセス頻度が低いデータが多くなってくるとAzure Storageとのコスト差がどんどん大きくなっていく。データ全体の中で一部だけのアクセス頻度が高く、殆どのデータはアクセス頻度が低い場合は、Cosmos DBだけでなく、なんからの外部データストアとの連繫を検討する必要がある。これは特に、Standard Table（これからは、Azure Table StorageのことはStandard Tableと呼ぼう）からの移行を考えた時に重要な検討課題だろう。それがうまく解決できるなら、かなり有り難い。</p>
</div>
<div class="section" id="blog">
<h2>同時に公開されたBlogから</h2>
<p>Cosmos DBも発表共に公開されたBlogもなかなか面白い。<strong>Azure Cosmos DB: The industry’s first globally-distributed, multi-model database service</strong><a class="footnote-reference" href="#ref7" id="id10">[7]</a>の A Brief History of Cosmosには簡単なCosmos DBの歴史が書いてあった。それによると、</p>
<blockquote>
<div>Azure Cosmos DBは、2010年に「Project Florence」で開始、グローバルディストリビューションの課題を解決するためにMSの社内で使っていたが、他の皆にも役に立つと思い、2015年にAzure DocumentDBの形でこのテクノロジの第1世代を利用できるようにした。</div></blockquote>
<p>云々だそうだ。世界中で展開するサービスの下りをみて連想したのは、AzurePortal。「最近ポータルが速くなってきてるのはエンドポイントを日本に持ってきたからかな、でもUSのリソースも普通に見れて操作できるしどうなっているのだろう」と思っていたが。Cosmos DBのようなグローバルディストリビューションの仕組みがあれば実装イメージが湧いてくる。実際のところはどうなっているかはわからないが。なかなか興味深い。</p>
<p>あと<strong>A technical overview of Azure Cosmos DB</strong><a class="footnote-reference" href="#ref8" id="id11">[8]</a>に、Leslie Lamport 博士が出てきて、Cosmos DBの一貫性の設計、実装にTLA+<a class="footnote-reference" href="#ref9" id="id12">[9]</a>のCosmosでの活用の話をしていたのが興味深かった。<a class="footnote-reference" href="#ref9" id="id13">[9]</a></p>
<p>「正しく動く分散システムを作るのはなかなか難しい、そんな中で形式手法が有効だ。Cosmos DBは設計、実装で、TLA+が複数の一貫性のサポートやSLAの提供に貢献した」的なことを言っている（超訳過ぎるので原文参照）。AWSでは、2011年からFormal Methodsを使って、重要な分散システムのアルゴリズム設計を行っている<a class="footnote-reference" href="#ref10" id="id14">[10]</a>と話題になったが、MSが分散システムの設計に使っている公言したのは初めてな気がする。利用者サイドからの一貫性の検証は難しいので設計、実装の取り組みがわかるのは有り難い。</p>
<p>この記事には、Azure Cosmos DBのデータベースエンジンの中身についても少し書いてあった。以下超訳</p>
<blockquote>
<div>Azure Cosmos DBのデータベースエンジンのコアタイプシステムは、汎用的にどのようなデータにも対応するatom-record-sequence (ARS)と呼ばれる構造となっている。Atomは、文字列、論理型、数値などのprimitive型、recordは構造体、sequence はatom、record、sequenceの配列である。また、Azure Cosmos DBのデータベースエンジンは、JSONなどのAPIが利用するデータモデルとARSベースのコアデータモデルの効率的な変換と投影を実装し、動的型付き言語（dynamically typed programming languages）からコアデータモデルへのネイティブアクセスをサポートする。このデータベースエンジンを使うことで、Cosmos DBのAPIは、battle-tested でフルマネージドな、グローバル分散型データベースシステムのすべての利点を得ることができる。</div></blockquote>
<p>ARSは、プリミティブ型を単純に並べただけの構造なのでJSONをそのまま保存するよりは効率は良いだろうし、別のデータモデルを実装し易いだろう。コアデータ・モデルを扱うデータベースとしての基本的な部分、整合性、リプリケーション、バックアップなどは共通の仕組みが使えるというわけだ。</p>
</div>
<div class="section" id="premium-table">
<h2>Premium Tableの現況</h2>
<p>大分長くなってしまったので、最後に、Premium Tableをちょっと動かしてみた感想を書いて終わりにする。</p>
<p>GitHubに、<strong>Getting started with Azure Cosmos DB: Table API</strong><a class="footnote-reference" href="#ref11" id="id15">[11]</a>というサンプルコードがある。Premium/Standard Table に繋いで簡単な速度を測るようなコードだ。それを動かしてみた。まずは結果から。※Premium Table の測定は、2000 RU/秒のパーテーション無しコレクションで行った。</p>
<table border="1" class="docutils" id="id33">
<caption><span class="caption-text">Premium/Standard Table のレイテンシー</span></caption>
<colgroup>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Title</th>
<th class="head">操作</th>
<th class="head">p0</th>
<th class="head">p50</th>
<th class="head">p90</th>
<th class="head">p99</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Premium</td>
<td>作成</td>
<td>5.2</td>
<td>7.2</td>
<td>9.0</td>
<td>13.0</td>
</tr>
<tr class="row-odd"><td>Standard</td>
<td>作成</td>
<td>4.2</td>
<td>11.9</td>
<td>20.7</td>
<td>26.2</td>
</tr>
<tr class="row-even"><td>S/P 比</td>
<td> </td>
<td>81%</td>
<td>164%</td>
<td>229%</td>
<td>201%</td>
</tr>
<tr class="row-odd"><td>Premium</td>
<td>ID検索</td>
<td>1.3</td>
<td>2.0</td>
<td>3.2</td>
<td>5.7</td>
</tr>
<tr class="row-even"><td>Standard</td>
<td>ID検索</td>
<td>2.4</td>
<td>3.4</td>
<td>5.2</td>
<td>11.2</td>
</tr>
<tr class="row-odd"><td>S/P 比</td>
<td> </td>
<td>184%</td>
<td>170%</td>
<td>162%</td>
<td>197%</td>
</tr>
<tr class="row-even"><td>Premium</td>
<td>プロパティ検索</td>
<td>2.9</td>
<td>4.8</td>
<td>6.9</td>
<td>10.8</td>
</tr>
<tr class="row-odd"><td>Standard</td>
<td>プロパティ検索</td>
<td>49.4</td>
<td>55.7</td>
<td>67.0</td>
<td>78.3</td>
</tr>
<tr class="row-even"><td>S/P 比</td>
<td> </td>
<td>1683%</td>
<td>1166%</td>
<td>965%</td>
<td>726%</td>
</tr>
<tr class="row-odd"><td>Premium</td>
<td>置換</td>
<td>5.0</td>
<td>7.6</td>
<td>9.3</td>
<td>13.2</td>
</tr>
<tr class="row-even"><td>Standard</td>
<td>置換</td>
<td>4.7</td>
<td>12.2</td>
<td>20.6</td>
<td>25.4</td>
</tr>
<tr class="row-odd"><td>S/P 比</td>
<td> </td>
<td>94%</td>
<td>161%</td>
<td>221%</td>
<td>192%</td>
</tr>
<tr class="row-even"><td>Premium</td>
<td>削除</td>
<td>4.5</td>
<td>6.0</td>
<td>7.2</td>
<td>9.4</td>
</tr>
<tr class="row-odd"><td>Standard</td>
<td>削除</td>
<td>2.8</td>
<td>3.6</td>
<td>4.9</td>
<td>10.0</td>
</tr>
<tr class="row-even"><td>S/P 比</td>
<td> </td>
<td>62%</td>
<td>60%</td>
<td>68%</td>
<td>106%</td>
</tr>
</tbody>
</table>
<p>１万エンティティで１度だけしか測っていないので、数値の絶対値は参考程度にしかならない。注意して欲しい。それでも傾向ぐらいはわかる。</p>
<p>ID検索の部分が、パーテーションキー、ローキーによる検索。プロパティ検索は、Standard Tableだとインデックスの効かずにフルスキャンになるが、Premium Tableでは全てのプロパティに自動的にインデックスが作成されるので、この場合もインデックスが利用される。</p>
<p>全体的な傾向を見ると、50パーセンタイルでは、プロパティ検索以外は、Premium が1.5から1.6倍程度Premiumが速い。プロパティ検索はセカンダリーインデックスの効果を見る項目で、Standardだとフルスキャン、Premiumだとインデックスが使われる。セカンダリーインデックスの効果は絶大で10倍以上Premiumが速くなる。データ件数が多くなればさらに差が出るだろう。</p>
<p>99パーセンタイルでは、2つの差は広がり、2倍程度の差になる。今回は件数が少ないので、この程度の差になったが、件数を増やして調査時間を長くすれば差は大きくなると思われる。</p>
<p>数字だけ見ると、Standard Tableが意外と奮戦している、前に調べて時より少し速くなっているようだ。Premium Tableはまだプレビューという点を差し引いても、一貫してレイテンシーが低いというのは魅力的だ。セカンダリーインデックスを更新する分、更新系は不利なはずだが、それでもStandardより速いのも今後が期待できる。</p>
<p>総じて、Premiumが速く、特にセカンダリーインデックスが効くと劇的に速くなる。全体的にPremiumのレイテンシーはバラツキが小さく一貫してレイテンシーが低いのは好印象だ。</p>
</div>
<div class="section" id="premium-table-sdk">
<h2>Premium Table SDK</h2>
<p>サンプルコードを見ると、PremiumとStandardの切替は接続文字列<a class="footnote-reference" href="#ref12" id="id16">[12]</a>の設定だけだ。Premium Tableには、DocumentDBと同じように、Consistencyや接続モードの設定がある、それをどうやってやるのかと言うと、現状では、AppSettings に書く<a class="footnote-reference" href="#ref13" id="id17">[13]</a>。 AppSettingsには下記の設定ができるようだ。基本的にはDocumentClient関連の設定だ。この方法だと、Standard Tableのコードを修正せずに動かしたいという目的は果たせるが、Premium Tableに最適化されたコードを書きたい場合には、あまり適さない。コードで変更できるようにして欲しい。</p>
<table border="1" class="docutils" id="id34">
<caption><span class="caption-text">AppSettings での設定項目</span></caption>
<colgroup>
<col width="100%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">設定名</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TableConnectionMode</td>
</tr>
<tr class="row-odd"><td>TableConnectionProtocol</td>
</tr>
<tr class="row-even"><td>TableConsistencyLevel</td>
</tr>
<tr class="row-odd"><td>TableDisableRUPerMinuteUsage</td>
</tr>
<tr class="row-even"><td>TableIndexingPolicy</td>
</tr>
<tr class="row-odd"><td>TableIsRUPerMinuteEnabled</td>
</tr>
<tr class="row-even"><td>TableMaxConnectionLimit</td>
</tr>
<tr class="row-odd"><td>TablePreferredLocations</td>
</tr>
<tr class="row-even"><td>TableQueryContinuationTokenLimitInKb</td>
</tr>
<tr class="row-odd"><td>TableQueryEnableScan</td>
</tr>
<tr class="row-even"><td>TableQueryMaxDegreeOfParallelism</td>
</tr>
<tr class="row-odd"><td>TableQueryMaxItemCount</td>
</tr>
<tr class="row-even"><td>TableThroughput</td>
</tr>
</tbody>
</table>
<p>現在のSDKだと、スロットリングがかかったときのリトライのハンドリングが怪しいようだ。それにサンプルコードではスロットリングエラーになった場合の処理が考慮されていない。そのため今回の測定ではスロットリングがかからないように2000RU/秒に設定した。</p>
<p>AppSetting設定やスロットリング対策からも言えることは、Premium Tableに最適化したコードが必要な場合は、そのためのコードが必要になるということだ。例えば、レスポンスヘッダーのRequestChargeを見てアプリケーションで消費RUを制御するなどのコードはスロットリングの仕組みが違うので、Standard TableとPremium Tableでは互換性が無い。ある程度SDKで吸収できるだろうが、プロダクションコードでは、ある程度アプリケーション側で対応する必要があるだろう。</p>
<p>Fidderで通信を覗いてみたところ、Premium Table SDKは、Premiumに繋ぐときは、x-ms-version: 2017-02-22 を、Standardのときは、x-ms-version: 2016-05-31 を使ってた。Premium の場合は、パーテーションマップの取得など、DocumentDBでお馴染みのやつが最初に入るなど、wired protocal としては全く互換性が無い別プロトコルだ。エンティティの作成も、今のStandardではレスポンスは空になるが、Premiumではしっかり中身が入っている。</p>
<p>リクエストとレスポンスはこんな感じだ</p>
<script src="https://gist.github.com/takekazuomi/f7ad2f152fb546113ba8114a9de19dcc.js">&amp;amp;nbsp;</script><p>ちょっと見 DocumentDBとウリ2つだ。Premium Table SDK が、DocumentDB Client SDK を参照していることからも、実際の通信はDocumentDBと同じプロトコルを使っていることが伺える。このままGAになるかどうかは分からないが、この仕組だとプロトコルレベルではStandardとPremiumは別物になるので、既存のStandard Table Storage向けのライブラリは作り直す必要がある。最初に聞いたときは、REST APIレベルで互換なのかと思ったので、ちょっと肩透かしだ。しかし、パフォーマンスを考えた場合、今のStandardのREST APIよりDocumentDB形式の方が将来性がある気もする。なかなか面白いアプローチではある。</p>
</div>
<div class="section" id="id18">
<h2>まとめ</h2>
<p>つらつらと書いていたら随分長くなってしまった。これで、Graph APIの話とかTLA＋の話も書きたかったが疲れたので、この辺で一旦終わる。最初、Premium Tableを聞いた時は、DocumentDB時代の価格体系だとちょと用途が限定される気がして、どうなのかとも思ったが、B8047<a class="footnote-reference" href="#ref5" id="id19">[5]</a>の話を聞いて、今はとても期待している。</p>
<p>今の気分は、「Cosmos DBはいいぞ」と言う感じだ。</p>
</div>
<div class="section" id="id20">
<h2>追記 (2017/5/15)</h2>
<p>現在のTable APIではパーテーション無しコレクションしか作成できず、コレクションの容量は10GBだ。これはプレビューの制限だと思われる。10GB以上のデータで評価したい場合は要注意だ。現時点でもスループットは、10万 RU/秒まで設定でき、Standardのストレージアカウント全体のパフォーマンスターゲット(1Kエンティティで毎秒20,000トランザクション)<a class="footnote-reference" href="#ref14" id="id21">[14]</a>を上回る。また、Table StorageのTableがCosmos DBのコレクションになるので、Table単位で課金される。Standardだと割りと気軽にTableを作れたのでこれも設計変更の要因になるだろう。</p>
</div>
<div class="section" id="id22">
<h2>脚注</h2>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> <a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/KEY01#time=1h22m26s">[1:22:26]</a>Azure Cosmos DB Introduction</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/KEY01#time=1h27m20s">[1:27:20]</a>Rimma Nehme, Azure Cosmos DB demonstration</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id5">1</a>, <a class="fn-backref" href="#id7">2</a>)</em> <a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/B8047">B8047 How to build globally-distributed, fast, billion-user applications with Azure Cosmos DB</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td><a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/T6058">T6058 Azure Cosmos DB: NoSQL capabilities everyone should know about</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><em>(<a class="fn-backref" href="#id8">1</a>, <a class="fn-backref" href="#id19">2</a>)</em> <a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/B8047#time=34m50s">[0:35:50]</a>B8047 のTable APIの部分</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[6]</a></td><td><a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage-PremiumTable/0.1.0-preview">Premium Table SDK</a>ソースは未公開</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[7]</a></td><td><a class="reference external" href="https://azure.microsoft.com/en-us/blog/azure-cosmos-db-microsofts-globally-distributed-multi-model-database-service/">Azure Cosmos DB: The industry’s first globally-distributed, multi-model database service</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref8" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[8]</a></td><td><a class="reference external" href="https://azure.microsoft.com/en-us/blog/a-technical-overview-of-azure-cosmos-db/">A technical overview of Azure Cosmos DB</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref9" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[9]</td><td><em>(<a class="fn-backref" href="#id12">1</a>, <a class="fn-backref" href="#id13">2</a>)</em> <a class="reference external" href="https://www.youtube.com/watch?v=L_PPKyAsR3w">Foundations of Azure Cosmos DB with Dr. Leslie Lamport, long</a>レスリー ランポート先生のインタビュー、お勧めです。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref10" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id14">[10]</a></td><td><a class="reference external" href="https://cacm.acm.org/magazines/2015/4/184701-how-amazon-web-services-uses-formal-methods/abstract">How Amazon Web Services Uses Formal Methods</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref11" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[11]</a></td><td><a class="reference external" href="https://github.com/Azure-Samples/azure-cosmos-db-table-dotnet-getting-started">Getting started with Azure Cosmos DB: Table API</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref12" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[12]</a></td><td><a class="reference external" href="https://github.com/Azure-Samples/azure-cosmos-db-table-dotnet-getting-started/blob/master/PremiumTableGetStarted/Program.cs#L24">接続文字列の切替部分</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref13" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id17">[13]</a></td><td><a class="reference external" href="https://github.com/Azure-Samples/azure-cosmos-db-table-dotnet-getting-started/blob/master/PremiumTableGetStarted/App.config#L14">AppSettingsでの設定箇所</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref14" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id21">[14]</a></td><td><a class="reference external" href="https://docs.microsoft.com/ja-jp/azure/storage/storage-scalability-targets#a-namescalability-targets-for-blobs-queues-tables-and-filesablobキューテーブルおよびファイルのスケーラビリティ-ターゲット">Blob、キュー、テーブル、およびファイルのスケーラビリティ ターゲット</a>サンプルコードでは、IDでの読込が1 RU/秒程度、エンティティ作成が10 RU/秒程度を消費していた。それをベースに試算すると、読込はStandard Tableのストレージアカウントの10倍、書込は同等のスループットということになる。ここでは、Read/Write混合を想定して「上回る」という表現にした。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref15" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[15]</a></td><td><a class="reference external" href="http://itpro.nikkeibp.co.jp/atclncf/service/00019/051500002/">日経クラウドファースト 2016年6月号</a>Azure DocumentDB 予約性能と実測値がほぼ一致　応答時間はデータストアーで最高レベル</td></tr>
</tbody>
</table>
</div>
<div class="section" id="id29">
<h2>その他の参考リンク</h2>
<ul class="simple">
<li><a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/B8118">B8118 How to run massively scaling mobile games on Microsoft Azure</a></li>
<li><a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/P4011">P4011 Azure Cosmos DB: API for MongoDB</a></li>
<li><a class="reference external" href="https://channel9.msdn.com/Events/Build/2017/P4012">P4012 Azure Cosmos DB: Build planet scale mobile apps in minutes</a></li>
<li><a class="reference external" href="http:/aka.ms/tla">TLA+</a>TLA+については、こちら。入門的な解説の動画から用意されてる。</li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Cosmos DB ]]></category>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure Table ]]></category>
             <pubDate>Sun, 14 May 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/02/13/psenv_tabexpansion.html</link>
            <guid>http://kyrt.in/2017/02/13/psenv_tabexpansion.html</guid>
            <title><![CDATA[PsEnv への TabExpansion の実装]]></title>
            <description><![CDATA[<h1>PsEnv への TabExpansion の実装</h1>
<p>git-poshのコードを見ていたら、PowerShell 3.0 から導入された TabExtentionを使ってタブ補完を実装していた。<a class="footnote-reference" href="#r1" id="id1">[1]</a>仕組みはシンプルで便利な機能だったので、いつも使っているPsEnv<a class="footnote-reference" href="#r2" id="id2">[2]</a>に実装してみた。<a class="footnote-reference" href="#r3" id="id3">[3]</a>簡単なコードだが知らないテクニックが使われていて面白かったので軽く紹介。</p>
<a class="reference external image-reference" href="https://flic.kr/p/tgGg8d"><img alt="Piccolo" class="align-center" src="https://c1.staticflickr.com/1/257/17899235534_5062afb52c_c.jpg"/></a>
<div class="section" id="tabextention">
<h2>TabExtentionの基本</h2>
<p>「コマンドラインで、タブを押したときに Function:TabExtention が呼ばれ、コマンドラインと最後のワードが渡される、TabExtention の関数で文字列の配列を返すとコマンドラインでは補完文字列として扱われる」</p>
<p>基本、これだけなので、非常にシンプルでわかり易い。<a class="footnote-reference" href="#r4" id="id4">[4]</a>git-poshのコードを見ながら実装してみたら、こんな感じになった。</p>
<script src="https://gist.github.com/takekazuomi/c601e9ff055c83652269d65cdd0b3140.js">&amp;amp;nbsp;</script></div>
<div class="section" id="id5">
<h2>コード解説</h2>
<p><a class="reference external" href="https://gist.github.com/takekazuomi/c601e9ff055c83652269d65cdd0b3140#file-psenvtabexpansion-ps1-L33">L33</a>で現在のTabExpansionの関数をリネームして保存しておく、補完処理が自分と関係無い場合は、このコードにフォールバックする。（関数名を変更できるのは知らなかった）コールバックチェーンの実装方法の一つらしい。TabExpansion は、Globalな名前空間にExportされてるが、TabExpansionBackup はExportされておらず、名前が衝突する心配は無い。タブが押されると、<a class="reference external" href="https://gist.github.com/takekazuomi/c601e9ff055c83652269d65cdd0b3140#file-psenvtabexpansion-ps1-L37">L37 TabExpansion</a>関数が呼ばれる。正規表現で引っ掛けて、補完処理対象のコマンドラインなら<cite>PsEnvTabExpansion</cite>へ、その他は<cite>TabExpansionBackup</cite>へフォールバックする。</p>
<p><a class="reference external" href="https://gist.github.com/takekazuomi/c601e9ff055c83652269d65cdd0b3140#file-psenvtabexpansion-ps1-L19">L19 PsEnvTabExpansion</a>は、コマンドラインのラストブロックを貰って、正規表現で引っ掛けて対象の補完文字列を返す。switch と正規表現を使うとスッキリ書けて気持ちいい。</p>
</div>
<div class="section" id="dynamicparam">
<h2>DynamicParamとの比較</h2>
<p>TabExtention では、仕組みがコマンドライン文字列のパターンマッチングなので PowerShell Cmdlet 以外のWin32 EXE などの補完も実装できる。PsEnvはCmdletなので、DynamicParamでも良かったかなという気もするが、実装を比べると.NETのクラス出まくりのDynamicParamに比べTabExtentionは綺麗に書ける。しかし、TabExpansion はGlobalなキー入力をフックするので下手に作るとキー入力のレスポンスが悪くなるという欠点がある。どっちも、デバックし辛いのは欠点。</p>
</div>
<div class="section" id="psevn">
<h2>PsEvnの紹介</h2>
<p>あまり知られていない気がするので、<a class="reference external" href="https://github.com/DuFace/PsEnv">PsEnv</a>の紹介を簡単に書いておく。Windowsでは環境変数の取り合いになって、うまく共存できない環境がママある。linuxや、Macだと、rubyや、pythonの仮想的に切り替える仕組みだけで足りたりするのだが、Windowsだと駄目だったり。cygwin, msys さらにそのバージョン違いでコンパイルされていたりして混ざって動かなくなったりすることがある。そのため、標準の環境変数はなるべくクリーンにしておいて環境によって必要な環境変数を設定するようにしている。PsEnvは環境変数を設定するのに便利なCmdletだ。</p>
<p>使い方は、<a class="reference external" href="https://github.com/DuFace/PsEnv">PsEnv</a>を見てもらうとして、使ってる設定ファイル<a class="reference external" href="https://gist.github.com/takekazuomi/b6d8fd537e1a16adc62884b2f84d5e38">psenv.json</a>を参考までに上げておく。ゴミが多くて少々長い申し訳無い。</p>
</div>
<div class="section" id="id7">
<h2>最後に</h2>
<p>これを書いている途中で、TabExtention++ が、PSReadlineと同時に WMF5の標準機能として取り込まれている<a class="footnote-reference" href="#r5" id="id8">[5]</a>のを知った。共存しても問題無いのだろうか。このあたり<a class="footnote-reference" href="#r6" id="id9">[6]</a>には、PowerTab（？）対応のコードが入ってるので余計気になる。</p>
</div>
<div class="section" id="id10">
<h2>参考</h2>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://github.com/dahlbyk/posh-git/blob/master/src/GitTabExpansion.ps1">posh-git/src/GitTabExpansion.ps1</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://winscript.jp/powershell/312">PsEnv A simple PowerShell module that allows specific tools to be added to the current environment by updating environment variables from a JSON file.</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://github.com/DuFace/PsEnv/pull/2">Tab completion support of Use and Use-Tool options.</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>公式ドキュメントが見つけられないかった。参考<a class="reference external" href="https://github.com/PowerShell/PowerShell-Docs/issues/747">Document TabExpansion and ArgumentCompleter #747</a>これかな？<a class="reference external" href="https://blogs.msdn.microsoft.com/powershell/2006/04/26/the-new-tabexpansion-feature/">The new TabExpansion feature…</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[5]</a></td><td><a class="reference external" href="http://winscript.jp/powershell/312">第6回 PowerShell 勉強会「PowerShell 5.0 新機能と関連OSSのご紹介」資料公開</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[6]</a></td><td><a class="reference external" href="https://github.com/dahlbyk/posh-git/blob/master/src/GitTabExpansion.ps1#L377">PowerTab対策コード</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ PowerShell ]]></category>
             <pubDate>Mon, 13 Feb 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2017/02/10/managed_disk_1.html</link>
            <guid>http://kyrt.in/2017/02/10/managed_disk_1.html</guid>
            <title><![CDATA[Azure Managed Disk が GA]]></title>
            <description><![CDATA[<div class="section" id="azure-managed-disk-ga">
<h1>Azure Managed Disk が GA</h1>
<p>PowerShellが出ないので、とりあえず ARM Template を使った Managed Disk の操作方法を書く。</p>
<p>そもそも、Managed Diskとは何かという話は、<a class="reference external" href="http://qiita.com/tsubasaxZZZ/items/7c0a15ce76d0b4d0b83f">Azure の Managed Disk のまとめ</a>に書いてあるので、そっちをどうぞ。</p>
<p>ざっくりと言うと、今ままでは Storage Account を作成して、Page Blobを置いて仮想ディスクとしてマウントするというのがAzureのブロックデバイスの扱いだったが、Managed Disk では Storage Account を意識することなくブロックデバイス（仮想ディスク）をリソースとして使えるようになりましたという話。</p>
<p>これでまた一つ普通になりましたという話で、Storage Accountとか、Page Blobとかを Azure 側で管理してくれる仕組みなので、Managed Disk（＝良さ気に管理されたディスク）と呼ばれている。従来のものは、ドキュメント上は Unmanaged Disk と呼ばれているようだ。いつものように、名前がベタすぎてかえってわかりづらい。</p>
<a class="reference external image-reference" href="https://flic.kr/p/PSUTJy"><img alt="Dried persimmon" class="align-center" src="https://c1.staticflickr.com/6/5616/31424912752_f00605ae0f_c.jpg"/></a>
</div>
<div class="section" id="id1">
<h1>改善点</h1>
<p>いろいろあるのが、特に注目すべき改善点をいくつか上げる</p>
<ol class="arabic simple">
<li>仮想マシンのディスクリソースの定義の簡易化</li>
<li>スナップショットの取得、仮想イメージの作成の容易性</li>
<li>Storage Account の制限を意識する必要が無く。パフォーマンス設計が簡略化</li>
<li>Storage Account KeyとPage BlobとしてのEndpointが無くなり運用設計が簡略化された</li>
</ol>
<p>今回は、仮想マシンのリソース定義がどれぐらい簡略化されたのか、スナップショット関連はどうかを見てみる</p>
</div>
<div class="section" id="id2">
<h1>概要</h1>
<p>従来の仮想マシンのリソース定義では、下記のように書いてた。<cite>storageProfile</cite>の<cite>imageReference</cite>には、元になるイメージの情報が、<cite>osDisk</cite>にはイメージから仮想ディスクを作成する旨とPage BlobのURLが定義される。<cite>storageProfile</cite>だけを引用するとこんな感じだ。</p>
<script src="https://gist.github.com/takekazuomi/583f0a3fc74a90ddbddb9c4febafea3f.js?file=storageProfile.json">&amp;amp;nbsp;</script><p>このテンプレートでは、Page Blob を置くストレージアカウントを定義して使っている。</p>
<p>Managed Disk では、StorageProfile の osDisk の部分を省略でき下記のようになる。osDisk の部分がざっくりと無くなった感じだ。</p>
<script src="https://gist.github.com/takekazuomi/915791900b1c35dc81c7bd9510ef2524.js?file=storageProfile.json">&amp;amp;nbsp;</script><p>このように省略した場合、暗黙のうちに Managed Disk リソースが作成され自動的に名前が付く。インスタンスがS付きの場合はPremium_LRS、それ以外はStandard_LRS、キャッシュはRead/WriteでDiskが作成される。DataDiskの場合はキャッシュのデフォルトはReadOnlyとなる。</p>
<p>※<a class="reference external" href="https://gist.github.com/takekazuomi/915791900b1c35dc81c7bd9510ef2524#file-azuredeploy-json">managed disk の場合のdeploy template 全文</a></p>
<p>省略した場合は、インスタンスのタイプでデフォルトが決まるが、ストレージの種別を指定したい場合、例えば、SでもStandard Storageを使う場合は、osDisk の managedDisk にstorageAccountTypeとして Standard_LRS を指定する。ストレージの定義も無くスッキリ書けるようになった。</p>
<script src="https://gist.github.com/takekazuomi/d6bcdc2108bc8fc7b43f839042e24eea.js?file=osDisk.json">&amp;amp;nbsp;</script><p>Managed DiskはARMリソースになるので、Diskを定義して、仮想マシンにアタッチすることもできる。下記ではDataDiskをDiskリソースとして定義しVMへの接続している。</p>
<script src="https://gist.github.com/takekazuomi/abf26310b979f7a1c3c47f1b0168a6e6.js?file=disks_vm.json">&amp;amp;nbsp;</script><p>スナップショットが簡単に取れるようになったので、スナップショットの取得、スナップショットからディスクの作成、仮想マシンの起動をテンプレートを使ってやってみた。</p>
</div>
<div class="section" id="snapshot">
<h1>Snapshotを取る</h1>
<p>このテンプレートでは、パラメータとしてDiskをもらって、<cite>Microsoft.Compute/snapshots</cite>のリソースを作成している。sourceUri の部分にソースとなるDiskのリソースIDを指定してスナップショットを作成するという流れだ。今回何度か実行した感じだと30GBのOsDiskのスナップショットで30秒程度という感じだった。基本仮想マシンを停止して取ることになると思うが、起動中でもスナップショットを取ることはできる。</p>
<script src="https://gist.github.com/takekazuomi/2d0ae27c2d18fd8eca59b674f5f29c01.js?file=snapshot.json">&amp;amp;nbsp;</script></div>
<div class="section" id="snapshot-managed-disk">
<h1>Snapshot からの Managed Diskの作成</h1>
<p>スナップショットの名前とリソースグループ名をパラメータでもらって、Managed Diskを作成する。accountType でStandard、Premiumを指定することができる。これも、ソースとなるリソースは、sourceUri で指定する。これも30秒程度だった。</p>
<script src="https://gist.github.com/takekazuomi/2d0ae27c2d18fd8eca59b674f5f29c01.js?file=createmd.json">&amp;amp;nbsp;</script></div>
<div class="section" id="managed-disk">
<h1>Managed Diskで仮想マシンを起動</h1>
<p>作成したOsDiskを使って、仮想マシンを起動する。これはちょっと長いので一部を引用する。イメージから起動するのと違って、<cite>osProfile</cite>と、<cite>storageProfile</cite>の<cite>imageReference</cite>が無い。既にあるDiskリソースを<cite>managedDisk</cite>の<cite>id</cite>で指定する。</p>
<script src="https://gist.github.com/takekazuomi/2d0ae27c2d18fd8eca59b674f5f29c01.js?file=azuredeploy-explicit-osdisk-vm.json">&amp;amp;nbsp;</script></div>
<div class="section" id="id3">
<h1>最後に</h1>
<p>これで、Azure 仮想マシンのDisk関連はだいぶ変わったことになるが、普通にリソースとしてディスクが使えるようになったので、全体的にはスッキリして分かりやすくなった。未だに、Azure PowerShellのManaged Disk 対応版 (3.5.0)が出てないのが気になるが、ブランチには<a class="reference external" href="https://github.com/Azure/azure-powershell/blob/release-3.5.0/src/ResourceManager/Compute/ChangeLog.md#version-260">release-3.5.0</a>居るので、そのうち出てくるでしょう。</p>
<p>ARM template でManaged Diskを操作するなら、<a class="reference external" href="https://github.com/chagarw/MDPP">https://github.com/chagarw/MDPP</a>を見るのがお勧めだ。ほとんどのパターンが網羅されている。</p>
<p>※ このエントリのためにPRを書いた<a class="reference external" href="https://github.com/shomah4a/sphinx-gist-embed/pull/3">support gist file option</a>よく見たら同じようなのが2つも既に出ていた orz…</p>
<div class="section" id="id4">
<h2>追記 2017/2/10</h2>
<p>PowerShellGallery には、3.5 が出ていると教えてもらいました。流石もっともHQに近い男と言われるしばやん。<a class="reference external" href="https://www.powershellgallery.com/packages/AzureRM/3.5.0">https://www.powershellgallery.com/packages/AzureRM/3.5.0</a></p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">Managed Disk 対応の Azure PowerShell は Web PI にないだけ</p>— しばやん (@shibayan) <a href="https://twitter.com/shibayan/status/829962830744989697">February 10, 2017</a></blockquote>
<script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"/></div>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Fri, 10 Feb 2017 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/12/03/adf_tips_rerun.html</link>
            <guid>http://kyrt.in/2016/12/03/adf_tips_rerun.html</guid>
            <title><![CDATA[Azure DataFactory Tips タイムスライスの再実行]]></title>
            <description><![CDATA[<div class="section" id="azure-datafactory-tips">
<h1>Azure DataFactory Tips タイムスライスの再実行</h1>
<p><a class="reference external" href="http://qiita.com/advent-calendar/2016/azure">Microsoft Azure Advent Calendar 2016 3日目</a>として書きました。</p>
<p><a class="reference external" href="https://docs.microsoft.com/ja-jp/azure/data-factory/data-factory-introduction">Azure DataFactory</a>(以下ADF)は、データの移動や変換を自動化するクラウドベースのデータインテグレーションサービスです。 ADFには、コピーアクティビティとデータ変換アクティビティの２種類があります。このうちコピーアクティビティは、単純なETLツールで優れたパフォーマンスとリーズナブルな価格で魅力的なサービスです。個人的にはコピーアクティビティはシンプルでなかなかよく出来ており、お気にいりました。データ変換アクティビティはクラスタを上げて変換処理をするのが利点でもあり難点でもあるって感じですね。</p>
<p>今回は、スクリプトからのエラーリカバリ、タイムスライスの再実行について記述します。ADFでは実行はタイムスライス単位で行われデータソースの問題で複数のタイムスライスが失敗した時などエラーの数が多くなり勝ちです。エラーが多くなるとポータルの画面から再実行をするのはポチポチが多くなってとても面倒になります。そんな時にはということで、Azure PowerShell から、失敗したタイムスライスを再実行してみます。</p>
<p>参照： この記事の基本は概ね、<a class="reference external" href="https://docs.microsoft.com/ja-jp/azure/data-factory/data-factory-monitor-manage-pipelines">Azure Data Factory のパイプラインの監視と管理</a>に書いてありますので、そちらもどうぞ。</p>
</div>
<div class="section" id="id1">
<h1>原因究明</h1>
<p>まずは、エラーの原因を確認します。エラーが大量に出ていると面倒なので、下記のようなスクリプトでエラーメッセージでサマります。やっていることは、 ログの<span class="docutils literal"><span class="pre">sort</span> <span class="pre">|</span><span class="pre">uniq</span> <span class="pre">-c</span></span>です。</p>
<script src="https://gist.github.com/takekazuomi/84aceb5aa49139dc115c8eace5f634df.js">&amp;amp;nbsp;</script></div>
<div class="section" id="id2">
<h1>エラーの確認を実行</h1>
<p>下記の様に実行すると、DatasetName, ErrorMessage でサマった数が表示されます。下記の例だとエラーメッセージが長過ぎて最後まで見れませんが、コマンド行に、<span class="docutils literal"><span class="pre">|</span> <span class="pre">Out-String</span> <span class="pre">-Width</span> <span class="pre">4096</span></span><a class="footnote-reference" href="#ref1" id="id3">[1]</a>を追加すると最後まで表示されます。（幅は随時変更してください）</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ .\adferror1.ps1 -ResourceGroupName "TestADF01" -DataFactoryName "APITutorial" -StartDateTime 2016-08-09T10:00:00 -EndDateTime 2016-08-09T11:00:00

Count DatasetName                ErrorMessage
----- -----------                ------------
    7 DatasetAzureSqlDestination Copy activity encountered a user error at Sink:tcp:kinmugisql01.database.windows.net,1433 s...
</pre></div>
</div>
<p>簡単にスクリプトの説明をします。Get-AzureRmDataFactorySlice でエラーになっているタイムスライスを取得して Get-AzureRmDataFactoryRun で、そのタイムスライスの詳細な情報を取得し、最後にエラーメッセージでグルーピングしてカウントしています。</p>
</div>
<div class="section" id="id4">
<h1>再実行</h1>
<p>これでエラーが分かるので問題を修正して、再実行します。</p>
<p>Azure DataFactoryのタイムスライスの再実行には、スライスの状態遷移を理解しなければなりません。そんなに複雑なことは無く、タイムスライスの状態遷移図は下記のようになっており、再実行は、Failed 状態から Waiting に変更することで行います。</p>
<a class="reference external image-reference" href="https://docs.microsoft.com/ja-jp/azure/data-factory/data-factory-monitor-manage-pipelines#パイプラインとアクティビティの状態の理解"><img alt="https://docs.microsoft.com/ja-jp/azure/data-factory/media/data-factory-monitor-manage-pipelines/state-diagram.png" src="https://docs.microsoft.com/ja-jp/azure/data-factory/media/data-factory-monitor-manage-pipelines/state-diagram.png"/></a>
<p>問題の修正が完了したら、下記のスクリプトで、失敗したタイムスライスを再実行します、スクリプトでは失敗したタイムスライスを古いものから順にWaitingにするだけです。タイムスライス毎に設定をしているので、pipelineで指定したバックフィルの順序が反映されません。タイムスライス間に依存関係がある場合は問題が出るかもしれませんので注意してください。</p>
<script src="https://gist.github.com/takekazuomi/64c969362ec122781f006ddad571f009.js">&amp;amp;nbsp;</script><p>実行には、上記で確認したエラーになったデータセットを指定します。再実行になったタイムスライスを表示します。</p>
<div class="code posh highlight-default"><div class="highlight"><pre><span/>$ .\\adfrerun.ps1 -ResourceGroupName "TestADF01" -DataFactoryName "APITutorial" -DatasetName "DatasetAzureSqlDestination" -StartDateTime 2016-08-09T10:00:00 -EndDateTime 2016-08-09T11:00:00

DatasetName                Start
-----------                -----
DatasetAzureSqlDestination 2016/08/09 9:00:00
DatasetAzureSqlDestination 2016/08/09 10:00:00
DatasetAzureSqlDestination 2016/08/09 11:00:00
DatasetAzureSqlDestination 2016/08/09 22:00:00
DatasetAzureSqlDestination 2016/08/09 23:00:00
</pre></div>
</div>
<p>下記のようなコマンドで、タイムスライスの状態を確認することができます。ここでは、Ready以外を表示しています。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ Get-AzureRmDataFactorySlice -ResourceGroupName <span class="s2">"TestADF01"</span> -DataFactoryName <span class="s2">"APITutorial"</span> -DatasetName <span class="s2">"DatasetAzureSqlDestination"</span> -StartDateTime <span class="m">2016</span>-08-09T10:00:00 -EndDateTime <span class="m">2016</span>-08-09T11:00:00 <span class="p">|</span> ? <span class="o">{</span><span class="nv">$_</span>.State -ne <span class="s1">'Ready'</span><span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h1>最後に</h1>
<p>Azure PowerShellを使っていると、PowerShellのオブジェクトパイプランが強力さを肌で感じます。パイプで繋いで、<span class="docutils literal"><span class="pre">%,</span> <span class="pre">?</span></span>とやるのが気に入ってしまいました。</p>
<p>今回ちょっと分かり辛らかったのは、 タイムスライスを返す<span class="docutils literal"><span class="pre">Get-AzureRmDataFactorySlice</span></span>と タイムスライス の実行結果を返す<span class="docutils literal"><span class="pre">Get-AzureRmDataFactoryRun</span></span>の関係でした。最初<span class="docutils literal"><span class="pre">Get-AzureRmDataFactoryRun</span></span>がデータセットの実行結果を取得するのかと勘違いしていたこともあり、どのようなパラメータを渡せば良いのかが分からず…　このコマンドが、タイムスライスの実行結果を返すもので、タイムスライス（slice）のIDとして開始時間を渡すということに大分時間を無駄にしました。後で、マニュアル<a class="footnote-reference" href="#ref2" id="id6">[2]</a>見たらちゃんと書いてあったんですが、、、、</p>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/azurerm.datafactories/set-azurermdatafactoryslicestatus">Set-AzureRmDataFactorySliceStatus</a>は、期間を渡せるので、個々のタイムスライスを指定するのではなく。期間をわたしてざっくり再実行でも良いかもしれません。その場合は、エラーになったタイムスライスを探して、その周辺の時間帯をざっくり再実行って感じですかね。それはそれで、実用性は高そうな気がしてきました。</p>
<p>締めは、<span class="docutils literal"><span class="pre">Azure</span> <span class="pre">DataFactory</span> <span class="pre">はいいぞ！</span></span>ということで。</p>
</div>
<div class="section" id="id7">
<h1>脚注</h1>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>poshのデフォルトではコンソール出力はコンソールバッファーの幅で省略されます。この仕様は余計なお世話な気がします。そのまま出してくれれば良いのに。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[2]</a></td><td><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.datafactories/v2.3.0/get-azurermdatafactoryrun">Get-AzureRmDataFactoryRun</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ DataFactory ]]></category>
             <pubDate>Sat, 03 Dec 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/10/04/net_fringe_japan_2016.html</link>
            <guid>http://kyrt.in/2016/10/04/net_fringe_japan_2016.html</guid>
            <title><![CDATA[.NET Fringe Japan 2016]]></title>
            <description><![CDATA[<h1>.NET Fringe Japan 2016</h1>
<p>「<a class="reference external" href="http://yfakariya.blogspot.jp/2016/10/talkedondotnetfringejapan2016.html">まさかの .NET じゃない話</a>」を、<a class="reference external" href="http://dotnetfringe-japan.connpass.com/event/35659/">.NET Fringe Japan 2016</a>で話してきました。 「<a class="reference external" href="http://pocketberserker.hatenablog.com/entry/2016/10/06/203735">Partitionの話とか、なかなか聞けないので面白かったです</a>」 と言っていただけるのは有難いです。</p>
<p>.NET Fringe なのに、.NET 成分、OSS成分ゼロで良いのかとは迷ったのですが、快く背中を押してもらい、Azure Storageの話をすることにしました。</p>
<p>Azure Storageは内部構造が公開されているのにも関わらず、日本ではその構造もあまり議論されることも無く、自分でも中に溜めているだけでなかなか外で話す機会も無いという状況で、。少々もったいない気がしていたので話が出来たのは良い機会でした。</p>
<p>最初は、Storageを構成する３層を全部話そうとしたのですが、細部に立ち入らないと面白い話にならず、細部に入ると話が長くなり全然時間に入らず。結局、一番面白そうなパーテーション周りにフォーカスして話しました。背景的な話や、他のレイヤーの話を飛ばして話したので少々わかり辛らかったかもしれません。</p>
<p>シャーディングをサポートしているシステムは世の中に諸々ありますが、負荷に応じてパーテーションマップを変更しロードバランシングするシステムで上手く動いている例は多くはなく、実装例として面白いのでは無いかと思います。今回は、話の焦点をパーテーションマップを動的に負荷に応じてどう構成するか、そのときに実データの移動を伴わない実装になっているかという当たりが一番盛り上がるところだったのですが、うまく説明するのはなかなか難しく資料の作成に苦心しました。</p>
<p>分割（パーテーショニング）が避けられなった時、一実装例として参考になればと思います。</p>
<p>.NET Fringe Japan 2016 資料です。「Azure Storage Partition Internals」</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/key/901iFCR13dImEd" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe>]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Tue, 04 Oct 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/07/01/2016_mvp.html</link>
            <guid>http://kyrt.in/2016/07/01/2016_mvp.html</guid>
            <title><![CDATA[2016 Microsoft MVP Award を受賞しました]]></title>
            <description><![CDATA[<h1>2016 Microsoft MVP Award を受賞しました</h1>
<p>2016年7月期、Microsoft Azure のカテゴリで、Microsoft MVP Award を受賞しました。</p>
<p>今後も、最近 Service Fabric に偏り気味ですが、Cloud Scale なサービス構築をテーマに情報発信をして行きたいと思います。</p>
<p>これからも、よろしくお願いいたします。</p>
]]></description>
            <category><![CDATA[ MVP ]]></category>
             <pubDate>Fri, 01 Jul 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/05/20/reliable_collection_lock.html</link>
            <guid>http://kyrt.in/2016/05/20/reliable_collection_lock.html</guid>
            <title><![CDATA[Reliable Collection の Lock の挙動]]></title>
            <description><![CDATA[<h1>Reliable Collection の Lock の挙動</h1>
<p>先日、5/18 に、<a class="reference external" href="https://jazug.doorkeeper.jp/events/44447">第1回Jazug Tokyo Night</a>で、Azure Fabric Service の Reliable Collection 話をしました。<a class="reference external" href="https://jazug.doorkeeper.jp/events/40440">Global Azure Boot Camp 2016 in Japan</a>でも話をしたのですが、1時間ぐらいだと概要も話し切れない感じでなかなか厳しい。4回ぐらいに分けても少し深いところ（そんなにDeepじゃないですが）をしたいなぁと思っていたところ、ちょうど良い機会が出来たので、早速時間を貰うことにしました。</p>
<p>今回は、その時の補足です。まずは、その時の資料です。<strong>Lock compatibility matrixの部分を更新しました</strong></p>
<iframe src="//www.slideshare.net/slideshow/embed_code/key/ruN7VgUvtARNlv" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="www.slideshare.net/takekazuomi/azure-fabric-service-reliable-collection">Azure Fabric Service Reliable Collection</a></p>
<p>勉強会の時に、下記の Lock compatibility matrix の赤枠の部分だけ、SQL Serverと違うという話をしました。「もしかしたら、ドキュメントが間違っているのかも」というようなことをその場では言いましたが、どきょメントが間違っているわけではなく、そこはSQL Serverと動きが違うとのことでした。そのあたりの話を説明します。（公式ドキュメントでは無いので、参考程度で）</p>
<img alt="Lock compatibility matrix" class="align-center" src="http://kyrt.in/_images/lock002.png"/>
<div class="section" id="lock-compatibility-matrix">
<h2>Lock compatibility matrix</h2>
<p>Reliable Collectionは、書込に最適化されていおり、matxi の赤枠の部分が、G(U)/R(S)時の動きが SQL Server とは異なっています。また、Reliable Collection では、update lockの期間は短くほとんどの場合、exclusive に昇格して終わることを前提としています。設計思想が違うという話のようです。</p>
<p>下図のような場合で動作を説明します。</p>
<img alt="tnx and lock" class="align-center" src="http://kyrt.in/_images/lock001.png"/>
<ul class="simple">
<li>上が、Reliable Collection,下がSQL Server</li>
<li>横軸が時間で、それぞれ、２つのtransactionがある</li>
<li>黄色線が、tnxid 2 が、shard lock を要求したタイミング</li>
</ul>
<p>TxnId1が、update lockを掛けている時、TxnId2がShard Lockを要求した場合(垂直黄線)、Reliable CollectionではUpdate Lock が、Exclusive Lock になって更新が終わりlockが開放されるまでshard lockは待機します。それに対して、SQL Serverでは、即時にshard lockは成功します。全てのshard lockが開放されてから、exclusive lock -&gt;更新という処理に流れになります。この違いはなかなか面白いですね。</p>
</div>
<div class="section" id="id1">
<h2>参考</h2>
<p>SQL Server の<a class="reference external" href="https://technet.microsoft.com/ja-jp/library/ms186396(v=sql.105).aspx">ロックの互換性 (データベース エンジン)</a></p>
</div>
<div class="section" id="id3">
<h2>最後に</h2>
<p>Reliable Collection は結構手堅くしっかり作っている感じを受けます。この手のものがあると、<strong>Data Locality</strong>を健全に保てるのでレイテンシー上は非常に有利になります、いいですね。</p>
<p>「上記２つに更に .NET の ReaderWriterLockSlim と、Jeffrey Richter の OneManyLock を入れて、永続化の有無がどう影響するのか考察したら面白いのかな？」と一瞬思ったのですが、今回はこの辺で。勉強会の前に明確にしておけば良かったのですが、ちょっと見逃してました。でも、SQL Serverと違って、lock やwait の状態が見えないのがちょっと不便ですね。これだと、ラッシュテストしないとデッドロックとかわからないです。</p>
</div>
]]></description>
            <category><![CDATA[ Service Fabric ]]></category>
             <pubDate>Fri, 20 May 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/04/04/build_2016_azure_cool_storage.html</link>
            <guid>http://kyrt.in/2016/04/04/build_2016_azure_cool_storage.html</guid>
            <title><![CDATA[BUILD/2016 Azure Cool Storage]]></title>
            <description><![CDATA[<h1>BUILD/2016 Azure Cool Storage</h1>
<p>BUILD 2016<a class="reference external" href="https://channel9.msdn.com/Events/Build/2016/B816">B816 Learn How to Store and Serve PBs of Object Data with Azure Block Blobs</a>で<strong>Cool Storage</strong>という、とても興味深い新機能が発表されていました。<a class="reference external" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2016/03/31/cross-post-build-2016-azure-storage-announcements/">Build 2016: Azure Storage announcements</a>に入ってなくて、見落としそうになります…</p>
<a class="reference internal image-reference" href="http://kyrt.in/_images/m001.PNG"><img alt="Cool Storage" class="align-center" src="http://kyrt.in/_images/m001.PNG" style="width: 800px;"/></a>
<p><strong>Cool Storage</strong>は、アクセス頻度の低いデータを安価に保存するための新機能で、Block Blob でサポートされます。</p>
<p>これで、Block Blob は、２の tier に別れます。</p>
<ol class="arabic simple">
<li>Hot - 通常利用のデータ向け (従来のBlob）</li>
<li>Cool - あまりアクセスしないデータ向け （あたらしいやつ）</li>
</ol>
<div class="section" id="id1">
<h2>概要</h2>
<ul class="simple">
<li>APIは、100% 互換で、同様のスループットとレイテンシーを実現（Coolでも性能が同じなのは設計しやすくなるので有り難いことです）</li>
<li>LRS, GRS, RA-GRSの信頼性オプションを提供（ 同じですね）</li>
<li>可用性は、Coolが 99% で、Hot が 99.9%（ちょっと、Coolが低くなります）</li>
</ul>
</div>
<div class="section" id="id2">
<h2>お値段関係</h2>
<p>Hotは、頻繁に使った場合に費用が抑えられ、Coolは、容量が大きい場合に安くなるという価格体系で構成されるようです。話の中ではちょっとはっきりしませんでしたが、トランザクションコストやデータ転送コストで差を付けるという感じなのかもしれません。</p>
<p>HotからCoolへの切替もできるようなので、履歴系のデータを保存するにはとても便利な気がします。next few weeks で、public preview に入るそうです。楽しみですね。</p>
<p>この話は、動画では、33分、パワポの資料では、30p 当たりで話が出来てますので、興味のある方はぜひ、chanel 9 をご覧ください。<a class="footnote-reference" href="#r1" id="id3">[1]</a></p>
</div>
<div class="section" id="id4">
<h2>最後に</h2>
<p>どうも、AWS の S3 Standard-IA とか、Google Nearline あたりと同じような領域をカバーするサービスのようです。S3 Standard-IA は、Google Nearline とは違って、レスポンスタイムが通常のBlob並ってところは良い感じです。価格の詳しい条件がわからないので、現時点でS3との比較は難しいですが、Cool Storageは、Hot/Coolの切替がアカウント単離っぽいので、実データのコピーは必要無さそうで、そのあたりで差がでてくるのでは無いかと言う気がします。</p>
<p>今回の、BUILDでは、 Server Siide Encription<a class="footnote-reference" href="#r2" id="id5">[2]</a>も発表されて、Storage Team に活気を感じました。これからが、楽しみです。</p>
</div>
<div class="section" id="id6">
<h2>参考</h2>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td><a class="reference external" href="https://channel9.msdn.com/Events/Build/2016/B816">BUILD  2016/B816 Learn How to Store and Serve PBs of Object Data with Azure Block Blobs</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[2]</a></td><td><a class="reference external" href="https://azure.microsoft.com/en-us/documentation/articles/storage-service-encryption/">Azure Storage Service Encryption for Data at Rest (Preview)</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Storage ]]></category>
            <category><![CDATA[ Azure Blob ]]></category>
             <pubDate>Mon, 04 Apr 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2016/02/05/how_to_get_current_running_guest_os_version.html</link>
            <guid>http://kyrt.in/2016/02/05/how_to_get_current_running_guest_os_version.html</guid>
            <title><![CDATA[現在 のGuest OS Version の確認方法]]></title>
            <description><![CDATA[<h1>現在 のGuest OS Version の確認方法</h1>
<p>.NET Framework 4.5, 4.5.1 のサポート終了に少し遅れましたが、Azure の Cloud　Service でも、Gest OS 4.28 から .NET 4.5.2 がサポートされるようになりました。<a class="reference external" href="https://azure.microsoft.com/en-us/documentation/articles/cloud-services-guestos-update-matrix">Azure Guest OS releases and SDK compatibility matrix</a></p>
<p>現在絶賛展開中ですが、手元のCloud Serviceには、すでに来ていました。</p>
<div class="section" id="visual-studio">
<h2>Visual Studio での確認</h2>
<p>現在の Guest OSのバージョンは、下記のように、Visual Studio で、Roleのプロパティを開くと確認することができます。</p>
<img alt="vsimage" class="align-center" src="http://kyrt.in/_images/vs001.PNG"/>
</div>
<div class="section" id="azure-powershell">
<h2>Azure PowerShell での確認</h2>
<p>Azure PowerShell は、1.1.0 では確認できなかったのですが、今回のように、GUEST OSのバージョンが重要な場合に確認出来ないのは不便なので、OSVersionが帰ってくるようなパッチを作って PR を出してみたら、さくっと翌日にはマージされ次のリリースで無事に現在のバージョンがわかるようになりました。（もともと、REST APIには存在するし簡単な修正だったので、なにかの拍子に漏れてしまっただけだと思います）</p>
<p><a class="reference external" href="https://github.com/Azure/azure-powershell/pull/1638">Fix to missing OS Version in Get-AzureRole #1638</a></p>
<img alt="../../../_images/git001.png" class="align-center" src="http://kyrt.in/_images/git001.png"/>
<p>Azure PowerShell Team オープンですね！<strong>素晴らしい</strong></p>
<p>こんな感じで確認することができます。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ Get-AzureRole -ServiceName kinmugics10 -Slot Staging

RoleName             : WorkerRole1
InstanceCount        : <span class="m">1</span>
DeploymentID         : c49d5437f1a84345b9739a79ff333056
OSVersion            : WA-GUEST-OS-4.28_201601-01
ServiceName          : kinmugics10
OperationDescription : Get-AzureRole
OperationId          : 0ffbd548-3b37-6c15-afa4-e091056e0849
OperationStatus      : Succeeded
</pre></div>
</div>
<p>現状だと、「新ポータル、旧ポータル」では、適応されているcscfgの内容だけで、自動更新に設定されている場合にどのGuest OS が使われているかは確認できません。</p>
</div>
<div class="section" id="get-azuredeploymant">
<h2>おまけ、Get-AzureDeploymant</h2>
<p>似たような情報を返してくるコマンドに、Get-AzureDeployment というのがあり、OSVersionが帰ってきます。「*」 が帰ってきて、すぐに実行中のGest OSがかえってくるわけではないことがわかりますが、ソースを確認してみます。コード的には、<a class="reference external" href="https://github.com/Azure/azure-powershell/blob/v1.1.0-January2016/src/ServiceManagement/Compute/Commands.ServiceManagement/Model/DeploymentInfoContext.cs#L253">このあたりで</a>OSVersion のプロパティを設定しています。つまり、csdefで設定されている<strong>osVersion</strong>が入り、自動更新を設定した場合、「*」となって現在のOS バージョンは分かりません。</p>
<p>最初これで行けるかと思ったんですがね。</p>
</div>
]]></description>
            <category><![CDATA[ Azure PowerShell ]]></category>
            <category><![CDATA[ PowerShell ]]></category>
             <pubDate>Fri, 05 Feb 2016 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/12/02/using_dnx_was.html</link>
            <guid>http://kyrt.in/2015/12/02/using_dnx_was.html</guid>
            <title><![CDATA[Azure Storage Client Library をDNXで使ってみた]]></title>
            <description><![CDATA[<h1>Azure Storage Client Library をDNXで使ってみた</h1>
<p><a class="reference external" href="http://qiita.com/advent-calendar/2015/azure">Microsoft Azure Advent Calendar 2015 2日目</a></p>
<p>.NET 用の<a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage/6.1.1-preview">Azure Storage Client Library</a>が、 6.1.1-preview (2015/10/30リリース) から DNXCore 5.0 にも対応しているので、どれぐらい動くのか簡単なコンソールアプリケーションを作ってみた。 ソース<a class="reference external" href="https://github.com/takekazuomi/scldnx-sample">github.com/takekazuomi/scldnx-sample</a></p>
<a class="reference external image-reference" href="https://flic.kr/p/zy9cWU"><img alt="butterfly" class="align-center" src="https://farm1.staticflickr.com/616/22023502300_b42e78e1dc_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>環境</h2>
<p>コードは、 Visual Studio 2015 Update 1 で書いて、dnx 関連のコマンドでコンパイル実行という流れ。最近なんやら、<strong>dotnet</strong>というコマンドも有るらしいが今回は使っていない。新規プロジェクトで、C# -&gt; Web の下の、コンソールアプリケーション(パッケージ）というのを選択。（どうしてWebの下なのかさっぱり分からない）</p>
<img alt="../../../_images/scl001.png" class="align-center" src="http://kyrt.in/_images/scl001.png"/>
<p>これで、見慣れぬ構造でプロジェクトが出来る。ソリューションのフォルダーには、sln のファイルと一緒に global.json が出来、プロジェクト本体は、src/[プロジェクト名] の下に作成される。プロジェクトファイルは、project.json とJSONのファイルになっている。（コメント書けないのでJSONは止めて欲しい）</p>
<p>dnxは、最新の実行環境を使うことにした。今のところ、stable とか release に拘ってもあまり意味ないほどころころとよく変わっている。dnvm コマンドのインストール方法はプラットフォーム毎に違うが、その後はかなり同じような感じで使える。</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span/>$ dnvm upgrade -a x86 -r coreclr -u
</pre></div>
</div>
<p>dnvm upgrade で入れると、alias default が定義され PATHも切られる。<cite>dnvm install</cite>と、<cite>dnvm use</cite>を使って方が良いかもしれない。入っているかを、dnvm list で確認する。最後の行が active になっている。</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span/>$ dnvm list

Active Version           Runtime Architecture OperatingSystem Alias
------ -------           ------- ------------ --------------- -----
       1.0.0-beta5       clr     x64          win
       1.0.0-beta5       clr     x86          win
       1.0.0-beta5       coreclr x64          win
       1.0.0-beta5       coreclr x86          win
       1.0.0-beta7       clr     x86          win
       1.0.0-beta7       coreclr x86          win
       1.0.0-beta8       clr     x64          win             clr
       1.0.0-beta8       clr     x86          win
       1.0.0-beta8       coreclr x64          win             coreclr
       1.0.0-beta8       coreclr x86          win
       1.0.0-rc1-15838   clr     x86          win
       1.0.0-rc1-15838   coreclr x86          win
       1.0.0-rc1-15904   clr     x86          win
       1.0.0-rc1-15904   coreclr x86          win
       1.0.0-rc1-update1 clr     x64          win
       1.0.0-rc1-update1 clr     x86          win
       1.0.0-rc1-update1 coreclr x64          win
       1.0.0-rc1-update1 coreclr x86          win
       1.0.0-rc2-16249   clr     x86          win
  *    1.0.0-rc2-16249   coreclr x86          win             default
</pre></div>
</div>
<p>このあたりは、ASP.NET 5 の アドベントカレンダー のネタなので軽く飛ばします。<a class="footnote-reference" href="#ref1" id="id2">[1]</a></p>
</div>
<div class="section" id="id3">
<h2>コードの概要</h2>
<p>基本的に、Azure Storage Client コード部分はほとんど従来の物と変わらない。</p>
<p>テーブルのリストを取る部分は、こんな感じ。</p>
<div class="code csharp highlight-default"><div class="highlight"><pre><span/>TableContinuationToken token = null;
do
{
    var result = await _tableClient.ListTablesSegmentedAsync(null, null, token, null, null, cancellationToken);

    result.Results.ToList().ForEach(table =&gt; Console.WriteLine($"{table.Name}"));

    token = result.ContinuationToken;
} while (token != null);
</pre></div>
</div>
<p>ちょっと困ったのは、Table のQueryが Fluent Mode しかサポートしていなくて IQueryable Mode が使えないこと。<a class="footnote-reference" href="#ref2" id="id4">[2]</a>試しに、WADのPerformanceカウンターを保存しているテーブルを操作するコードを書たら下記のようになった。フィルターの部分が少々煩雑だ。</p>
<div class="code csharp highlight-default"><div class="highlight"><pre><span/>public async Task RunAsync(CancellationToken cancellationToken)
{
         var sw = Stopwatch.StartNew();
         var min = _fromDate.ToUniversalTime().Ticks;
         var max = _toDate.ToUniversalTime().Ticks;

         var table = _tableClient.GetTableReference("WADPerformanceCountersTable");

         var query = new TableQuery&lt;WADPerformanceCountersTable&gt;()
             .Where(TableQuery.CombineFilters(
                 TableQuery.GenerateFilterCondition("PartitionKey", QueryComparisons.GreaterThanOrEqual, min.ToString("d19")),
                 TableOperators.And,
                 TableQuery.GenerateFilterCondition("PartitionKey", QueryComparisons.LessThan, max.ToString("d19"))));

         var result = new List&lt;WADPerformanceCountersTable&gt;();
         TableContinuationToken token = null;
         do
         {
             var segment = await table.ExecuteQuerySegmentedAsync(query, token, null, null, cancellationToken);
             token = segment.ContinuationToken;
             result.AddRange(segment.Results);
             // Console.Write($"{segment.Results.Count}.");

         } while (token != null);
         Console.WriteLine();

         sw.Stop();
         Console.WriteLine("Count:{0}, Min: {1}, Max: {2}, Elapsed: {3:F2} sec",
             result.Count, result.Min(e =&gt; e.PartitionKey), result.Max(e =&gt; e.PartitionKey), (sw.ElapsedMilliseconds / 1000.0));
}
</pre></div>
</div>
<p>余談だが、WAD(Windows Azure Diagonestics )のテーブルは、tickを”d19”で書式化したもので、パーテーションを指定すると時系列で絞り込むことができる。この方法は、パーテーションのレンジクリーになるので、時間的なパフォーマンスがあまり良くないが、パッチなどで使うならば結果のデータ量を絞り込めるという利点がある。時間的なコストが重要なシナリオでは、並列化を検討すると良い。</p>
</div>
<div class="section" id="id5">
<h2>動かしてみる</h2>
<p>Storageの接続文字列は、環境変数 AZURE_STORAGE_CONNECTION_STRING から拾うようにした。VSから実行するときは、プロジェクトのプロパティでデバックを選択し環境変数を設定する。デバック時に環境変数を設定出来るのは非常に便利、Visual Studio では今ままで無かったのが不思議なぐらい。ランタイムも選択できるが、dnvm install などで予め入れておく必要がある。</p>
<img alt="../../../_images/vsscreen05.png" src="http://kyrt.in/_images/vsscreen05.png"/>
<p>コマンドラインの場合は、下記のようにビルドして実行する。シェルの違いなどで若干違うが、ほとんど同じような感じで実行できる。便利である。</p>
<ul class="simple">
<li>Windows 10 TH2</li>
</ul>
<div class="code bash highlight-default"><div class="highlight"><pre><span/>$ $env:AZURE_STORAGE_CONNECTION_STRING="Azure Storage Key"
$ dnu restore
$ dnu build
$ cd bin\output\approot
$ .\sclxplatclr.cmd ListTable
</pre></div>
</div>
<ul class="simple">
<li>Mac OSX 10.11.1</li>
</ul>
<div class="code bash highlight-default"><div class="highlight"><pre><span/>$ export AZURE_STORAGE_CONNECTION_STRING="Azure Storage Key"
$ dnu restore
$ dnu build
$ cd bin/output/approot
$ ./sclxplatclr.cmd ListTable
</pre></div>
</div>
<p>実行しているのはテーブルのリストを取ってるだけの簡単なコードなので、結果は省略</p>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>結局、ubuntu 15.04 でやったのは下記のようになって動かなかった。<a class="footnote-reference" href="#ref3" id="id7">[3]</a></p>
<div class="code bash highlight-default"><div class="highlight"><pre><span/>$ dnu restore
failed to locate libcoreclr with error libunwind-x86_64.so.8: cannot open shared object file: No such file or directory
</pre></div>
</div>
<p>言語は同じC#でも、ライブラリ回りで細かい違いがあってなかなかコーディングの手間がかかる。今回だと、MEFを使おうかと思ったら dnxcore50 に対応してなくて、<a class="reference external" href="https://www.nuget.org/packages/Microsoft.Framework.DependencyInjection/1.0.0-beta8">Microsoft.Framework.DependencyInjection</a>を使ってみたり、<cite>Environment.CurrentDirectory()</cite>が、dnxcore50 に無かったり、カレントのAppDomain取ろうとしたら出来なかったり<a class="footnote-reference" href="#ref4" id="id8">[4]</a>などなど。</p>
<p>でもまあ、単独のバイナリに変換されるようになると、クロスプラットフォームなコンソールツールを作成する手段として重宝するんじゃないかなとは思った。</p>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>DNX環境のセットアップ、<a class="reference external" href="https://docs.asp.net/en/latest/getting-started/installing-on-mac.html">Installing ASP.NET 5 On Mac OS X</a>、<a class="reference external" href="https://docs.asp.net/en/latest/getting-started/installing-on-linux.html">Installing ASP.NET 5 On Linux</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>Fluent Mode と IQueryable Mode については、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/09/07/announcing-storage-client-library-2-1-rtm.aspx">Announcing Storage Client Library 2.1 RTM &amp; CTP for Windows Phone</a>の Conceptual model の部分が詳しい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td><a class="reference external" href="http://dotnet.readthedocs.org/en/latest/getting-started/installing-core-linux.html">Installing .NET Core on Linux</a>では、Ubuntu 14.04 TLS を使っている。RTMではなるべく14.04以降など広いバージョンのUbuntuをサポートして欲しいところ。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[4]</a></td><td><a class="reference external" href="https://github.com/dotnet/corefx/issues/1784">Assembly.GetExecutingAssembly, AppDomain.CurrentDomain and similar</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
             <pubDate>Wed, 02 Dec 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/10/16/niigata_net_2015_10_dml.html</link>
            <guid>http://kyrt.in/2015/10/16/niigata_net_2015_10_dml.html</guid>
            <title><![CDATA[Niigata.NET Page Blob Download 最適化]]></title>
            <description><![CDATA[<h1>Niigata.NET Page Blob Download 最適化</h1>
<p>10/10(土) に、<a class="reference external" href="https://ngtnet.doorkeeper.jp/events/30553">Niigata.NET 2015-10</a>に参加してきました。日本酒とへぎ蕎麦が美味しかったのでまた行きたいところ。LTで話した（かった）ことをここにまとめておきます。</p>
<a class="reference external image-reference" href="https://flic.kr/p/zQKV5z"><img alt="soba" class="align-center" src="https://farm6.staticflickr.com/5766/22211533525_cc58e2a2ac_c.jpg"/></a>
<div class="section" id="id1">
<h2>最初に</h2>
<p>Azure Storage 上でデータの移動が必要な場合、現時点でもっともお勧めなのは、AzCopy<a class="footnote-reference" href="#ref1" id="id2">[1]</a>です、多めのデータをアップロード、ダウンロードしたい場合には AzCopyを試してください。<a class="footnote-reference" href="#ref2" id="id3">[2]</a>ほかのツールを使うよりリソースをうまく使って効率的にデータを転送してくれます。転送に必要な時間は、ほぼネットワークインターの速度に依存します。（諸条件に依存しますが、ざっくり言うと）</p>
</div>
<div class="section" id="azure-storage-data-movement-library-preview">
<h2>Azure Storage Data Movement Library (Preview)</h2>
<p>AzCopyのライブラリー版 が、<a class="reference external" href="https://www.nuget.org/packages/Microsoft.Azure.Storage.DataMovement">Azure Storage Data Movement Library (Preview)</a>です。（以下 DML)<a class="footnote-reference" href="#ref3" id="id5">[3]</a>ライブラリなので、スクリプト＋AzCopyではちょっと難しいような細かい制御しながらデータの転送をすることが出来ます。DMLの実装では API の呼び出し方が Azure Storage に合わせてチューニングされていて、パフォーマンスが出るというのが大きな特徴です。DMLについては、<a class="reference internal" href="http://kyrt.in/2015/09/25/intro_azure_storage_data_movement_library.html"><span class="doc">Intro Azure Storage Data Movement Library</span></a>も参考にしてください。</p>
<p>チューニングの基本戦略は２つです。これは、Azure Storage では共通の戦略となります。</p>
<ol class="arabic simple">
<li>並列化<a class="footnote-reference" href="#ref5" id="id6">[5]</a></li>
<li>転送量の最小化</li>
</ol>
<p>今回は、Page Blob での転送量の最小化の話をします。（DMLでは、その他にもGCとかLOH周りの工夫も使われています）</p>
</div>
<div class="section" id="page-blob-download">
<h2>Page Blob Download 最適化</h2>
<p>昨今の近代的なファイシステムでは、sparse file という仕組みを持っています。<a class="footnote-reference" href="#ref6" id="id7">[6]</a>大きなファイルであっても、zero の部分はDISK上にアロケートされずにデータが書きこまれた部分(緑の部分)だけが確保されます。</p>
<img alt="../../../_images/sparse.png" src="http://kyrt.in/_images/sparse.png"/>
<p>Azure では、仮想マシンのDisk は VHD ファイルを Azure Storage Page Blob に配置されており、そのPage Blobは sparse data の保存のための仕組みをがあります。仕組は結構簡単で、Page Blob では、データが書き込まれた部分をページ単位(512B)でレンジ管理しており、実際にBlobにデータが保存されるのはこの領域だけです。この領域の外を読むと0 fill のデータが帰ります。（これが、俗に言われるPage Blogが、Disk アクセスに最適化されているという機能の一つです）REST APIの GetPageRanges<a class="footnote-reference" href="#ref7" id="id8">[7]</a>では、有効なデータを含むすべての連続したページ範囲のリストを返します。<a class="footnote-reference" href="#ref8" id="id9">[8]</a></p>
<p>つまり、GetPageRanges APIを使うと、Page Blob から実際にデータが入っている部分だけを取得することができます。例えば、100GBの仮想DISKであっても転送するのは実際使っている10GBだけにすることが可能になります。</p>
</div>
<div class="section" id="dml">
<h2>DMLでの実装</h2>
<p>DMでは、PageBlobReader.DoGetRangesAsync() でGetPageRangesAsyncを実行してRangeを取得<a class="footnote-reference" href="#ref9" id="id10">[9]</a>しています。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Range</span><span class="p">&gt;&gt;</span> <span class="n">DoGetRangesAsync</span><span class="p">(</span><span class="n">RangesSpan</span> <span class="n">rangesSpan</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">AccessCondition</span> <span class="n">accessCondition</span> <span class="p">=</span> <span class="n">Utils</span><span class="p">.</span><span class="n">GenerateIfMatchConditionWithCustomerCondition</span><span class="p">(</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Location</span><span class="p">.</span><span class="n">Blob</span><span class="p">.</span><span class="n">Properties</span><span class="p">.</span><span class="n">ETag</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Location</span><span class="p">.</span><span class="n">AccessCondition</span><span class="p">);</span>

    <span class="n">List</span><span class="p">&lt;</span><span class="n">Range</span><span class="p">&gt;</span> <span class="n">rangeList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Range</span><span class="p">&gt;();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">pageRange</span> <span class="k">in</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">pageBlob</span><span class="p">.</span><span class="n">GetPageRangesAsync</span><span class="p">(</span>
            <span class="n">rangesSpan</span><span class="p">.</span><span class="n">StartOffset</span><span class="p">,</span>
            <span class="n">rangesSpan</span><span class="p">.</span><span class="n">EndOffset</span> <span class="p">-</span> <span class="n">rangesSpan</span><span class="p">.</span><span class="n">StartOffset</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span>
            <span class="n">accessCondition</span><span class="p">,</span>
            <span class="n">Utils</span><span class="p">.</span><span class="n">GenerateBlobRequestOptions</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Location</span><span class="p">.</span><span class="n">BlobRequestOptions</span><span class="p">),</span>
            <span class="n">Utils</span><span class="p">.</span><span class="n">GenerateOperationContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Controller</span><span class="p">.</span><span class="n">TransferContext</span><span class="p">),</span>
            <span class="k">this</span><span class="p">.</span><span class="n">CancellationToken</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">rangeList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Range</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">StartOffset</span> <span class="p">=</span> <span class="n">pageRange</span><span class="p">.</span><span class="n">StartOffset</span><span class="p">,</span>
            <span class="n">EndOffset</span> <span class="p">=</span> <span class="n">pageRange</span><span class="p">.</span><span class="n">EndOffset</span><span class="p">,</span>
            <span class="n">HasData</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">rangeList</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ここはわかり易いですね。range list は、RangeBasedReader.DoGetRangesAsync() でダウンロードする範囲を決めるのに使われます。</p>
<p>ちょっと脱線しますが、Win32 APIでファイルシステムを操作する場合には、DeviceIoControl で FSCTL_QUERY_ALLOCATED_RANGES<a class="footnote-reference" href="#ref10" id="id11">[10]</a>を使うと実際にデータが保持されている range を取得することができます。</p>
</div>
<div class="section" id="id12">
<h2>資料</h2>
<p>LTで用意した資料です。</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/key/aluSAloWPZpeGH" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/azure-storage-data-movement-library-pageblob-optimize">Azure Storage Data Movement Library Page Blob Optimize</a></p>
</div>
<div class="section" id="id13">
<h2>最後に</h2>
<p>最後に、「<a class="reference external" href="https://ngtnet.doorkeeper.jp/events/30553">Niigata.NET 2015-10</a>」を聞きながら、思ったことを少し書きます。</p>
<p>プロジェクトで、最初にビルドとかnuget周りを揃えて置くのはとても良いと思います。msbuild 、nuget の闇に飲み込まれない範囲で華麗に捌いてくれる人が１人入ればイイデスネ。</p>
<p>make -&gt; ant -&gt; nant -&gt; msbuild -&gt; maven … と使ってきたけど、小技を使い過ぎると分からなくなるのが問題で。ビルドファイルを、いろいろ弄っているうちに秘伝のタレ化して触れなくなりがちです。</p>
<p>package manager は、dnxで改善されるはずなので、それに期待したいところ。install.ps1 とか必要になるとソウルジェムが濁ります。</p>
<p>「MEF の、Core CLR 対応ってどうなっているの？」という話が出たので、帰ってきてちょっと見たら、ASP.NET 5 と Entity Framework 7 では、<a class="reference external" href="https://github.com/aspnet/DependencyInjection">Microsoft.Framework.DependencyInjection</a>ってやつが使われていました。聞いたことがあったような気もするけど、使ったこと無かったので少し試してみたら、どうも、container builder、setter injection などが無いようで、えらくシンプルな実装。でもまあ、これはこれで良いのかなという感じでした。</p>
<p>「コードが”短く”書かれている」のが良いって話は、総論としては文句無いですが、その台詞を聞いた瞬間「linq がすべてを台無しにしてしまったなぁ」と思いました。基本的に短い方が何をしたいのかが理解し易いけど、それがメモリとCPUにどういう影響を与えるかは別問題で、アルゴリズム、遅延評価、linq 関数の実装を理解しないとコード見ただけでは短い方が良いかどうか分からないのが現状でしょう。結局いろいろ考えても分からないので、データを用意して流してプロファイラに掛けるしか無いという現実があります。</p>
<p>これは Linq だけの罪かと言うと、そういうわけでは無く、「生産性の高いライブラリを使う場合に起こる一般的な課題」です。抽象化度の高いものは人間に理解し易く生産性の向上に貢献しますが、実際のノイマン型コンピューターの仕組みと乖離が大きくなり、実行ステップとコードの乖離も大きくなります。簡単に言うと、「こう書いたからこう動く」という世界から離れていくことになる。 じゃあ、乖離してはダメなのかという、そうでもない。全てはバランスによって決まる。ズルズルと、長くなったので、これぐらいで。</p>
<p>プログラムを読むことに関しては、このOSS全盛時代に読むコードに困ることは無いと思うので、ぜひガンガン読んで欲しい。</p>
<p>などなど、いろいろ思うことがあって面白かった。</p>
</div>
<div class="section" id="id15">
<h2>追記</h2>
<p>Azure Files でも同じように sparse file が、サポートされていて、DMLでは対応しています。</p>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-use-azcopy/">AzCopy コマンド ライン ユーティリティの概要</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2015/06/05/build-2015-azure-storage-announcements.aspx">Azure Storage に関する Build 2015 での発表</a>によれば、そろそろ日本にも Import/Export が来ます。<a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/storage-import-export-service/">Microsoft Azure Import/Export サービスを使用した BLOB ストレージへのデータの転送</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2015/09/23/introducing-azure-storage-data-movement-library-preview.aspx">Introducing Azure Storage Data Movement Library Preview</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement">Microsoft Azure Storage Data Movement Library (0.1.0)</a><a class="reference external" href="https://www.nuget.org/packages/Microsoft.Azure.Storage.DataMovement">nuget Microsoft Azure Storage Data Movement… 0.1.0</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td><a class="reference external" href="http://kyrt.in/2015/09/25/intro_azure_storage_data_movement_library.html">Intro Azure Storage Data Movement Library</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[6]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Sparse_file">Sparse file</a><a class="reference external" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365566(v=vs.85).aspx">MSDN Sparse File Operations</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[7]</a></td><td><a class="reference external" href="https://msdn.microsoft.com/en-us/library/azure/ee691973.aspx">Get Page Ranges REST API</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref8" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[8]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2012/03/26/getting-the-page-ranges-of-a-large-page-blob-in-segments.aspx">Getting the Page Ranges of a Large Page Blob in Segments</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref9" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[9]</a></td><td><a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/blob/master/lib/TransferControllers/TransferReaders/PageBlobReader.cs#L70">DoGetRangesAsync</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref10" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[10]</a></td><td><a class="reference external" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364582(v=vs.85).aspx">FSCTL_QUERY_ALLOCATED_RANGES control code</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Fri, 16 Oct 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/09/25/intro_azure_storage_data_movement_library.html</link>
            <guid>http://kyrt.in/2015/09/25/intro_azure_storage_data_movement_library.html</guid>
            <title><![CDATA[Intro Azure Storage Data Movement Library]]></title>
            <description><![CDATA[<h1>Intro Azure Storage Data Movement Library</h1>
<p>先日（2015/9/23）、Microsoft Azure Storage Data Movement Library (Preview 以下 DML) というAzure Storage用のファイル転送ライブラリが公開されました。<a class="footnote-reference" href="#r1" id="id1">[1]</a></p>
<p>DML は、従来 Storage Client Library だけでは難しかったような、高速なファイル転送を簡単にアプリで実装できるようなライブライです。（ベースは AzCopyと同じらしい） Azure File、Blob、Local の ３つの間のデータ移動ができます。</p>
<a class="reference external image-reference" href="https://flic.kr/p/w6vCML"><img alt="brick" class="align-center" src="https://farm4.staticflickr.com/3810/19753067526_5e3efd7613_k.jpg"/></a>
<p>下記のような、関数が揃っていて、sourceとdestをセットして呼ぶとその間でデータが転送されるって感じです。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="k">public</span> <span class="k">static</span> <span class="n">Task</span> <span class="nf">CopyAsync</span><span class="p">(</span>
     <span class="n">Uri</span> <span class="n">sourceUri</span><span class="p">,</span>
     <span class="n">CloudBlob</span> <span class="n">destBlob</span><span class="p">,</span>
     <span class="kt">bool</span> <span class="n">isServiceCopy</span><span class="p">,</span>
     <span class="n">CopyOptions</span> <span class="n">options</span><span class="p">,</span>
     <span class="n">TransferContext</span> <span class="n">context</span><span class="p">,</span>
     <span class="n">CancellationToken</span> <span class="n">cancellationToken</span>
<span class="p">)</span>
</pre></div>
</div>
<p>どんな組み合わせがサポートされているかとを表にまとめるとこんな感じ。このうちUrl-&gt;Blob, Url-&gt;FileのCopyだけ isServerCopy (サーバー側で実行される非同期コピー) のオプションがあります。Local to Local はサポートされていません。現在のバージョンでは、すべての処理はファイル（オブジェクト）１つの単位です。例えば、ディレクトリを指定して、その下をまとめてUploadなどのようなことはできません。表は横が転送元で縦が転送先です。</p>
<table border="1" class="colwidths-given docutils" id="id13">
<caption><span class="caption-text">DML Matrix</span></caption>
<colgroup>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">元/先</th>
<th class="head">Local</th>
<th class="head">Blob</th>
<th class="head">File</th>
<th class="head">Url</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Local</td>
<td>なし</td>
<td>DownloadAsync</td>
<td>DownloadAsync</td>
<td>なし</td>
</tr>
<tr class="row-odd"><td>Blob</td>
<td>UploadAsync</td>
<td>CopyAsync</td>
<td>CopyAsync</td>
<td>CopyAsync※</td>
</tr>
<tr class="row-even"><td>File</td>
<td>UploadAsync</td>
<td>CopyAsync</td>
<td>CopyAsync</td>
<td>CopyAsync※</td>
</tr>
</tbody>
</table>
<p>isServerCopy(※付きのやつ) は、URLとして指定できるようなものならコピー元（ソース）にすることができます。public に公開されているURLなら、そのまま。private のものでも、S3のように、pre-signed URLが使えるならば、そのURLからAzure Storageにコピーすることが可能です。<a class="reference external" href="http://azure.github.io/azure-storage-net-data-movement/html/03609d0c-9ce9-c005-aaf5-ccc4cb017806.htm">TransferManager.CopyAsync Method (Uri, CloudBlob, Boolean, CopyOptions, TransferContext, CancellationToken)</a></p>
<p>これは、DMLの機能というよりAzure Storage Blobの機能で、2012/6 に追加された<strong>Asynchronous Cross-Account Copy Blob</strong>の副産物（？）です。<a class="footnote-reference" href="#r2" id="id2">[2]</a>（気が付いて無かったですが orz)</p>
<dl class="docutils">
<dt>Introducing Asynchronous Cross-Account Copy Blob から引用</dt>
<dd>Note: The source blob could even be a blob outside of Windows Azure, as long as it is publicly accessible or accessible via some form of a Signed URL. For source blobs outside of Windows Azure, they will be copied to block blobs.</dd>
</dl>
<p>「Note: 公開された url あるいは、なんらかのSigned URLのようなものなら Azure の外側でもかまいません。それは、block blob として copy されます」という感じでしょうか。DMLのAPIを見ると、Azure Fileにもコピーできますね、これは、2015/8/3 に公開された新機能です、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2015/08/04/azure-files-preview-update.aspx">Azure Files Preview Update</a>version 2015-02-21 から利用できます。<a class="footnote-reference" href="#r7" id="id3">[7]</a></p>
<p>DML のGitHub レポジトリを見ると、S3から Azure Blobにコピーするサンプルコードが公開されています。<a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/tree/master/samples/S3ToAzureSample">S3ToAzureSample</a></p>
<p>余談ですが、このサンプルを読んでいて気になったことがあったので PR を出してみたらさくっとマージされました。<a class="footnote-reference" href="#r3" id="id4">[3]</a>（軽微な修正ですが）</p>
<div class="section" id="wad-custom-log-downloader">
<h2>WAD Custom Log Downloader</h2>
<p>とりあえず、なにか作ってみようと思い Azure Diagonestics の Custom Log をローカルにDownloadするアプリ<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader">WADCustomLogDownloader</a>を書きました。AzCopyだけだと、ダウンロード対象のファイルのリストがどこか外部にあって参照しながらダウンロードするというのは効率悪くWADのCustom Logなどは不得意パターンでした。それをライブラリになったので、ちょっとやってみようという感じです。</p>
<p>環境変数<strong>AZURE_STORAGE_CONNECTION_STRING</strong>に、StorageのConnection文字列を入れて、下記のように実行します。-f から、-t の間のFileTimeのログを、WADDirectoriesTable から探し対応するファイルをblobから、-d で指定したローカルディレクトリにダウンロードします。ちょっと動かしてみた感じだとAzCopyと同じような速度を期待できそうです。（ちゃんと計っていないのですが）</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ <span class="nv">$env</span>:AZURE_STORAGE_CONNECTION_STRING<span class="o">=</span><span class="s2">"YOUR_STORAGE_KEY"</span>
$ ./WADCustomLogDownloader -container diagnostics-custom-logs -d c:<span class="se">\t</span>emp<span class="se">\l</span>ogs -f <span class="m">2015</span>-09-10 -t <span class="m">2015</span>-09-23 -v
</pre></div>
</div>
<p>ここから、コードの解説をしながらコーディングしていて気が付いた点をいくつか並べていきます。</p>
</div>
<div class="section" id="id5">
<h2>基本的な作り</h2>
<p>ダウンロード対象のBlobのリストを、Azure Table の WADDirectoriesTable から読んで、<a class="reference external" href="https://msdn.microsoft.com/en-us/library/dd997371(v=vs.110).aspx">BlockingCollection</a>に突っ込み、別TaskでBlockingCollection を読んで対象のBlobをダウンロードするという流れになっています。Producer が、<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L30">ListWadCustomLogs()</a>で、Consumer が、<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L64">DownloadFromBlob()</a>、その間を繋ぐ queue が、<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L25">BlockingCollection _jobQueue</a>です。</p>
<p>今回は、Producer が軽いので割と序盤で全部 queue に入ってしまって、順次 Consumer が処理するということになります。大量に対象のファイルがある場合、BlockingCollection の本領発揮なのでしょうが、今回は Producer–consumer problem<a class="footnote-reference" href="#r4" id="id6">[4]</a>には引っかからない気がするので枠組みだけ使ってさくっと進みます。この基本構造は、DMLのS3のサンプルからいただきました、王道ですね。</p>
</div>
<div class="section" id="id7">
<h2><a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement#best-practice">Best Practice</a></h2>
<p>パフォーマンスを出すには、DefaultConnectionLimit を増やすのと、 100-continue をOffにする必要があります。Azure Storage を使っている人にはお馴染みかと思いますが。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">DefaultConnectionLimit</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">ProcessorCount</span> <span class="p">*</span> <span class="m">8</span><span class="p">;</span>
<span class="n">ServicePointManager</span><span class="p">.</span><span class="n">Expect100Continue</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</pre></div>
</div>
<p>ちなみに、ASP.NET環境下では、HttpRuntimeの初期化が走ると、HttpRuntime.InitializeHostingFeatures() から、いろいろ呼ばれて、<a class="reference external" href="http://referencesource.microsoft.com/#System.Web/HttpRuntime.cs,1202">HttpRuntime.SetAutoConfigLimits()</a>で、下記のコードが実行されるので、DefaultConnectionLimit の変更は不要です。Consoleアプリや、WorkerRoleでは必須なので要注意です。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">ServicePointManager</span><span class="p">.</span><span class="n">DefaultConnectionLimit</span> <span class="p">=</span> <span class="n">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="producer-listwadcustomlogs">
<h2>Producer <a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L30">ListWadCustomLogs</a></h2>
<p>WADDirectoriesTable から、該当日付近のデータを取り出します。WAD(Windows Azure Diagonestics)では、PartitionKey にTickを使っているので日付をUTCにしてTickを19桁の文字列に展開します。ここは、Partition Queryなので、速度が必要なら分割してパラレルで実行した方が良いですが、実測で DC内で 100 ms/1000件 程度、西から東を見た場合でも、140ms/1000件、の時間でした。そのためあまり気にせず単純なクエリーで書きます。件数が多くなるのが想定できる場合は、適時分割した方が良いと思います。</p>
<p>ソース：<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L38">WADDirectoriesTable から該当期間のログのエンティティを取得</a></p>
<p>そのあと、ExecuteSegmentedAsync() を使って、1000件毎にエンティティを取得し、jobQueueに入れます。全部入れ終わたら、<strong>_jobQueue.CompleteAdding()</strong>します。Consumer 側では、<strong>_jobQueue.IsCompleted</strong>がtrueなら処理終了と判断します。true になるのは、complete とマークされてて queue が空の時です。<a class="footnote-reference" href="#r5" id="id9">[5]</a>これだけでも<strong>BlockingCollection</strong>ちょっと便利ですね。</p>
<p>今回は、<strong>BlockingCollection</strong>の maximum capacity を設定していないので<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L56">_jobQueue.Add(result.Results)</a>はブロックしません。Producer と Consumer のバランスをとる必要がある場合は適時設定するといいでしょう。</p>
</div>
<div class="section" id="consumer-downloadfromblob">
<h2>Consumer <a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L64">DownloadFromBlob</a></h2>
<p>_jobQueue に乗っている WADDirectoriesTable を<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L97">TransferManager.DownloadAsync</a>に渡してダウンロードするタスクを作成します。ここは、Task の作成しすぎとかは、気にせずにグルグル回してしまって良く、実際のTaskのスケジューリングは適時 DML内でやってくれます。基本的には、4MB chunk で、DownloadRangeToStreamAsync を使って分割ダウンロード、chunk は、buffer pool を利用、core 数*8 を並列実行という感じです。</p>
<p>DMLソース：<a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/blob/master/lib/TransferControllers/TransferReaders/BlockBasedBlobReader.cs#L301">BlokBlob ダウンロードの実装部分</a></p>
<p>並列度は、<a class="reference external" href="http://azure.github.io/azure-storage-net-data-movement/html/00d502f9-54dc-f902-6571-367fd8851081.htm">TransferConfigurations</a>で設定できます。デフォルトは、<a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/blob/master/lib/TransferConfigurations.cs#L45">core数*8</a>、その下の行を見ると、chunk size は、4MB（固定？）です。使うメモリーは、<a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/blob/master/lib/GlobalMemoryStatusNativeMethods.cs#L19">Native Method の GlobalMemoryStatusEx()</a>を呼んで物理メモリーサイズを拾っています。<strong>(なんと！)</strong></p>
<p>そして、DMLの一番の肝は、 buffer pool と並列実行度をリンクさせたスケジューラー<a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/blob/master/lib/TransferScheduler.cs#L21">TransferSchedulerTransferScheduler</a>ですね。Blobでパフォーマンスを上げるなら並列度を上げるのが重要で、大きなファイルを扱うためにはGCを避けるのが王道なので、こんな感じになるのかという気がします。</p>
<p>DMLの中に脱線していました、まだあまり読めてないのですが、いろいろ参考になるコードだと思います。</p>
<p>Consumerの細かいところを説明すると、大体４点</p>
<ol class="arabic simple">
<li>ダウンロード済みのファイルがあればSkipする：<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L71">TransferContext.OverwriteCallback</a>で、ダウンロード先にファイルがあるかどうかを見ています。WADDirectoriesTable の中のFileTime、FileSize と比較して同じだったらスキップとしています。WADDirectoriesTable のデータを参照するために、_sourceFileDictionary を参照しているのがイマイチな気がします。OverwriteCallback に、オプションのobject とか渡せれば解決なのですが…</li>
<li>MD5 Validation をOffにする：<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L83">DownloadOptions.DisableContentMD5Validation</a>WADのCustom log 転送を使って転送したBlobにはMD5Sumが付いていないので仕方ない。ここはOffです。WADDirectoriesTable の FileSize と同じかどうかを確認できるので大丈夫かな？と思いますが、選択できても良い気がします。MD5Sumの計算はコストが高いのでなるべく避けたい気持ちもわかりますが。</li>
<li>TransferException をハンドルする：<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L100">TransferException</a>ここでは、TransferErrorCode の TransferAlreadyExists、NotOverwriteExistingDestination を特別扱いしています。 TransferContext.OverwriteCallback で、false を返すと、NotOverwriteExistingDestination が帰ります。今回はすでにダウンロード済みの場合は、スキップしているのでエラーではありません。 TransferManager.DownloadAsync に、同じ source, dest のセットが追加されると TransferAlreadyExists が発生します。今回は、WADDirectoriesTable に残っている転送履歴からBlobを探しているので、複数回転送されると TransferAlreadyExists になります。これは、WAD の Custom Log転送をどう使うのかという話にも絡みますが、今回はスキップで扱います。<a class="footnote-reference" href="#r6" id="id11">[6]</a></li>
<li>ダウンロード後のファイルのタイムスタンプを合わせる：<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/Program.cs#L124">File.SetLastWriteTimeUtc</a>ここは、見て通りです。よく見ると、余計なcaptureがあるし、cancel とかの場合の分岐が出来てませんね orz ….</li>
</ol>
<p>あとは、 CountdownEvent を使って、全部のTaskの終了を待ちます。ProgressHandler をフックすると、転送量とか転送ファイル数のステータスをもらえるのは便利です。</p>
</div>
<div class="section" id="id12">
<h2>まとめ</h2>
<p>ちょっと長いコードになりましたが、割と簡単に効率的な転送プログラムが実装できました。DMLの内部構造を見てわかる通り、CPUとメモリーがある程度あるマシンでないと本来の性能が発揮できない傾向があります。合計1.6GB の50本ほどのlog を D1とD3の両方でダウンロードしてみたところ、D1で 12 Mbps ぐらい、D3では 800 Mbps ぐらいのスループットになりました。（速度を見るにはもう少し本格的にやってみないといけないので参考程度ですが）</p>
<p>exe 単体で動作するように、 Release Build では、ILMergeで、wadcldl.exe を作っています。</p>
<p>環境変数 AZURE_STORAGE_CONNECTION_STRING にStorage Account Keyをセットするスクリプト<a class="reference external" href="https://github.com/takekazuomi/WADCustomLogDownloader/blob/master/WADCustomLogDownloader/setenv.ps1">setenv.ps1</a>を入れてあるので参考にしてください。実行前に、Add-AzureAccount をします。</p>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://azure.microsoft.com/en-us/blog/introducing-azure-storage-data-movement-library-preview-2/">2015/9/23 Introducing Azure Storage Data Movement Library Preview</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2012/06/12/introducing-asynchronous-cross-account-copy-blob.aspx">Introducing Asynchronous Cross-Account Copy Blob</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><a class="reference external" href="https://github.com/Azure/azure-storage-net-data-movement/pull/8">Dispose GetObjectResponse object. Here are many run.</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">Producer–consumer problem</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[5]</a></td><td><a class="reference external" href="http://referencesource.microsoft.com/#System/sys/system/collections/concurrent/BlockingCollection.cs,97">Reference Source  BlockingCollection.IsCompleted</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[6]</a></td><td><a class="reference external" href="http://azure.github.io/azure-storage-net-data-movement/html/c0cc97ae-9bd8-37b2-a727-c4d714b5cc8f.htm">TransferErrorCode Enumeration</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[7]</a></td><td><a class="reference external" href="https://msdn.microsoft.com/en-us/library/azure/mt427372.aspx">MSDN Copy File</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Fri, 25 Sep 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/09/01/go_5_jazug_service_fabric_session.html</link>
            <guid>http://kyrt.in/2015/09/01/go_5_jazug_service_fabric_session.html</guid>
            <title><![CDATA[Go (5) JAZUG で Service Fabric の話をします]]></title>
            <description><![CDATA[<h1>Go (5) JAZUG で Service Fabric の話をします</h1>
<p>今週末、9/5の<a class="reference external" href="http://r.jazug.jp/index.html">JAZUG</a>5周年記念イベント<a class="reference external" href="https://jazug.doorkeeper.jp/events/29529">「ごーごー じゃずゆーじー」 Go(5) JAZUG</a>で、Azure Service Fabric<a class="footnote-reference" href="#r1" id="id1">[1]</a>をネタに<a class="reference external" href="http://tatsuakisakai.net/">酒井さん</a>と話をします。宣伝とメモを兼ねてちょっと予告編です。興味を持たれた方は是非ご来場下さい ↓click↓</p>
<a class="reference external image-reference" href="https://jazug.doorkeeper.jp/events/29529"><img alt="gogo jazug" class="align-center" src="http://kyrt.in/_images/29529_normal_1438663713_logo.png" style="width: 600px;"/></a>
<div class="section" id="azure-service-fabric">
<h2>Azure Service Fabric とは</h2>
<p>Azure Service Fabric は、BUILD 2015 に先駆けて発表された、「スケーラブルで信頼性が高く管理しやすいクラウド向けアプリケーションの構築向けの分散型システム プラットフォーム」<a class="footnote-reference" href="#r2" id="id3">[2]</a>です。</p>
<p>2015/4/20 に、Mark Russinovich が書いたBlog<a class="footnote-reference" href="#r3" id="id4">[3]</a>、翻訳<a class="footnote-reference" href="#r4" id="id5">[4]</a>から引用します。</p>
<ul class="simple">
<li>Service Fabric は、高度な制御プラットフォーム</li>
<li>開発者や ISV は、拡張性とカスタマイズ性の高いクラウド サービスを構築可</li>
<li>ミッションクリティカルなクラウド サービスを提供してきたマイクロソフトの経験を基礎として開発</li>
<li>5 年以上にわたって実際に運用</li>
<li>基盤となるテクノロジは、Azure のコア インフラストラクチャに使用（実証済）</li>
<li>Skype for Business、Intune、Event Hubs、DocumentDB、Azure SQL Database 、Bing Cortana などの基盤で利用</li>
<li>毎秒 5 億回を超える評価に対応可能な拡張性を持つ</li>
</ul>
<p>ざっくりまとめると、「マイクロソフトでAzureのインフラとして5年以上使っている技術がベースにとなっていて実績もいろいろあるよ」ってことのようです。これまでのAzureだとCloud Native アプリケーションの Computing は、<a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/services/cloud-services/">Cloud Service</a>あるいは<a class="reference external" href="https://azure.microsoft.com/ja-jp/services/app-service/">App Service</a>でということでしたが、新しい選択肢として<strong>Service Fabric</strong>というのが出てきたってことです。（まだ、preview でローカルの開発環境でしか動きませんが）</p>
<p>※ここでは、便宜上WebRole/WorkerRole を使う<a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/cloud-services-choose-me/#tellmecs/">Cloud Services</a>を<strong>PaaSv1</strong>と呼び、それに対して、Service Fabric を<strong>SF</strong>or<strong>PaaSv2</strong>と呼びます。</p>
<p>BUILD 2015のセッション<a class="footnote-reference" href="#r5" id="id6">[5]</a>,<a class="footnote-reference" href="#r6" id="id7">[6]</a>や、ドキュメントを見ると機能が結構盛りだくさんなのですが、「<strong>SF</strong>が取り組んで問題は何なのか、何故必要なのか？」というのが分かりずらい、面白そうだけど、<strong>ﾍ(ﾟдﾟ)ﾉ ﾅﾆｺﾚ?</strong>って感じもします。</p>
<p>9/5 のセッションでは、Service Fabricが出てから既に、4カ月以上経っているし、「Azure Service Fabric とは」的な内容はさくっと流して、私が感じていた<strong>SF</strong>に対する疑問に焦点を当てて話をしてみようと思います。</p>
</div>
<div class="section" id="service-fabric">
<h2>Service Fabricが取り組んでいる課題</h2>
<p>課題ですね、英語だと<strong>Challenge</strong>です。無理筋なのをやるとダメなやつですが、ここでは関係ありません。クラウド時代に突入してモダンなサービスは可用性とスケーラビリティを求められるようになりました。<a class="footnote-reference" href="#r7" id="id8">[7]</a></p>
<p>その結果、Cluster アプリケーションでは複数のマシンに配置されることになります（つまり分散、分割）。複数台で構成されているので障害時に全停止せず、台数を増やせば処理能力が増えてスケールすると言うのが基本的なストーリーです。</p>
<p>この考えに沿ったアーキテクチャの典型が、<strong>PaaSv1</strong>です。WebRole/WorkerRole を複数の障害ドメインのマシンに配置することで耐障害性を担保し、アプリケーションをステートレスにすることで、台数増加を性能向上に直結させ (<a class="reference external" href="http://www.publickey1.jp/blog/14/immutable_infrastructure_1.html">Immutable Infrastructure</a>ってやつです) 、高可用でスケーラブルなサービスを構築するというのが物語の粗筋です。</p>
<p>これはこれで良いのですが、<strong>PaaSv1</strong>では、全てのRoleは仮想マシンを専有するような配置を行います。そのため、OSの設定やランタイムのインストールなど細かいことを自由にできるという大きなメリットがありますが「問題もあるよね」というのが今回の話しです。<strong>SF</strong>が、取り組んでいる課題はいろいろあるのですが、今回はこの配置に関する課題の話をします。</p>
</div>
<div class="section" id="static-partitioning">
<h2>Static Partitioning 問題</h2>
<p><strong>PaaSv1</strong>では、Role毎に台数を増減できますが、複数のWebRoleを同一の仮想マシンで動かすことはできません。また、WebRoleとWorkerRoleを同一仮想マシンでホストすることもできません。<a class="footnote-reference" href="#r8" id="id9">[8]</a>このようにRoleの分割が静的に行われているのを、Static Partitioning （静的分割？）と言います。Static Partitioning は、Role を増やせば、増すほど扱いづらくなりますし、ワークロードによっては事前に予測することが難しい場合もあり、リソースの利用効率という観点からは<strong>ムダ</strong>が生じやすい仕組みで、これは大きな課題ですね。</p>
<img alt="../../../_images/pat01.png" class="align-center" src="http://kyrt.in/_images/pat01.png"/>
<p>Static Partitioning はシンプルなせいか、Cluster アプリケーションで広く使われてきました。最初のHadoop とか、昔の twitter とかですね。その結果あちこちから問題が聞こえてくるようになりました。その課題の解法の1つとして注目されているのが、Apache Mesos などで導入された手法です。 Mesosだと、このドキュメントが面白いです<a class="reference external" href="http://www.slideshare.net/charmalloc/buildingdeployingapplicationsmesos">Building and Deploying Application to Apache Mesos</a>、ちょっと引用します。</p>
<p>Mesos 以前は、Static Partition（静的分割）だった。<strong>Static Partition（静的分割）IS BAD</strong>、とても扱いづらい。</p>
<ul class="simple">
<li>マシンの効率的な利用ができない</li>
<li>効果的なスケールが出来ない</li>
<li>障害の取り扱いが難しく、ダウンタイムの発生を招く</li>
</ul>
<p>リンク先には、「動的リソース割り当てが必要だ。 Operating System === Datacenter で、Mesos =&gt; data center の<em>kernel</em>だ」というようなことが書いてあります。Hadoopも、台数増えてくると十分Nodeが働かないという問題がありました。<a class="footnote-reference" href="#r9" id="id10">[9]</a></p>
<p>確かにサービスを構成するアプリケーションを複数のコンポーネントに分けた場合、（例えばWeb Frontと、管理サイト、日時バッチ、月次バッチとか）。それぞれ、ワークロードも違えば、開発サイクルも違う。これを、クラスターに最適配置しようとするといろいろ<strong>メンドクサイ</strong>。<strong>PaaSv1</strong>で、現実的な解はRoleを分けることですが、月次バッチはWebFrontのオフピークの夜間にして効率的な運用をなどを考えると面倒なことになってくる・・・</p>
</div>
<div class="section" id="dynamic-partitioning">
<h2>Dynamic Partitioning</h2>
<p>Mesosから離れて、Service Fabric でどうしているのかを見てみます。 Service Fabric では、複数のNodeでクラスターを構成して、アプリケーションは同一Node内に複数配置することができます。どのように配置するかは、アプリケーションが要求を出して、配置条件にあたところにService Fabric が配置するという流れです。配置条件は、サービス マニフェストまたはアプリケーション マニフェストを使用するか、コード内で直接定義します。<a class="footnote-reference" href="#r10" id="id11">[10]</a></p>
<img alt="../../../_images/pat04.png" class="align-center" src="http://kyrt.in/_images/pat04.png"/>
<p>Node内に複数のアプリケーションを配置することができ、リソースの有効利用を実現します。YARNとかMesosとかも同じようなことができます。このあたりの考え方は最近のトレンドのようです。</p>
</div>
<div class="section" id="cluster-manager">
<h2>Cluster Manager <a class="footnote-reference" href="#r11" id="id12">[11]</a></h2>
<p>このように、Datacenetrから仮想マシンをまとめて借りだして Cluserとしてプールし、アプリケーションの要求に応じてリソースを割り当てるのコンポーネントを、<strong>Cluster Manager</strong>と呼びます。（最近のクラウド界隈は、混沌としているので名称はちょっと曖昧さがあるけど）代表的な<strong>Cluster Manager</strong>を、Service Fabric も含め上げておきます。Hadoop MRv1 では JobTrancker がボトルネックとなって働かない Node 問題が発生しており、YARNが対策として作成されました。いずれの、Cluster Manager (YARN では、Resource Managerと呼ぶ）も、万単位のサーバーを扱うの前提で作成されているので完全に１つのリソースプールに全部入れてしまって、そこからリースするような使い方でも行けそうです。</p>
<ul class="simple">
<li><a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/services/service-fabric/">Service Fabric</a></li>
<li><a class="reference external" href="http://mesos.apache.org/">Apache Mesos</a></li>
<li><a class="reference external" href="http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YARN.html">YARN, Apache Hadoop</a></li>
<li><a class="reference external" href="http://www.infoq.com/jp/news/2015/04/google-borg">Google Borg/Omega</a></li>
</ul>
</div>
<div class="section" id="id14">
<h2>最後に</h2>
<p>こんな感じで、Service Fabricがアプリケーションをクラスターに配置してくれるので、リソースとアプリケーションの分割の関係を柔軟に構成することができます。ワークロードと配置の関係をコード外でコントロールできるのは、なかなか嬉しい感じです。今回は時間の都合上入れられないと思いますが、開発支援、運用支援の機能もService Fabricには盛り込まれていて、かなり拾い範囲をサポートした分散型システム プラットフォームと言えそうです。</p>
<p>ソフトウェアの基本は、「分割して統治せよ」だと思いますが、残念ながら分割にはもろもろのメリットとデメリットがあり、過剰な分割はデスマーチの元という面もありました。Service Fabricは、今風に多くの問題を解決し次世代クラウドアプリケーションの作成に役立ってくれそうで</p>
<p>※Spark は、複数のCluster Managerに対応していて、これはこれで面白いと思います。</p>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/service-fabric-overview/">Service Fabric の概要</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="ServiceFabricドキュメント">Service Fabric ドキュメント</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><a class="reference external" href="http://azure.microsoft.com/ja-jp/blog/announcing-azure-service-fabric-reducing-complexity-in-a-hyper-scale-world/">Announcing Azure Service Fabric: Reducing Complexity in a Hyper-scale World</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2015/04/23/announcing-azure-service-fabric-reducing-complexity-in-a-hyper-scale-world.aspx">翻訳：Azure Service Fabric を発表: 高度なスケーラビリティをより簡単に実現</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[5]</a></td><td><a class="reference external" href="https://channel9.msdn.com/Events/Build/2015/3-618">BUILD 2015, Mark Russinovich, The Next Generation of Azure Compute Platform with Mark Russinovich</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[6]</a></td><td><a class="reference external" href="https://channel9.msdn.com/Events/Build/2015/2-640">BUILD 2015, Gopal Kakivaya, Microsoft Azure Service Fabric Architecture</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[7]</a></td><td>クラウドだから可用性とスケーラビリティを求められるのか、両者が求めらるからクラウドなのかは ニワトリと卵の関係のような気もします。クラウドによって、いくつかの面でコストが抑えられるようになったので、現実的なビジネスでの適応局面が増えたという言い方もできるます。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r8" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[8]</a></td><td>WebRole で複数Siteを定義すれば複数Endpoint Hostできます、また、WebRoleのRoleEntryPointのRunをoverride するとWorkerRole的なことが出来たりします。これらの方法の課題はアプリケーション間が無用に密接にくっついてしまっていることです。できるけど、イマイチやなという感じです。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r9" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[9]</a></td><td><a class="reference external" href="http://www.ibm.com/developerworks/jp/analytics/library/bd-yarn-intro/">YARN の紹介</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r10" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[10]</a></td><td><a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/service-fabric-resource-balancer-service-description/">サービス記述の概要</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r11" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[11]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Cluster_manager">Cluster manager</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r12" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[12]</td><td><a class="reference external" href="https://azure.microsoft.com/ja-jp/documentation/articles/service-fabric-resource-balancer-cluster-description/">クラスターの説明</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Service Fabric ]]></category>
             <pubDate>Tue, 01 Sep 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/08/23/how_to_use_nlog_in_cloud_service.html</link>
            <guid>http://kyrt.in/2015/08/23/how_to_use_nlog_in_cloud_service.html</guid>
            <title><![CDATA[Cloud Service で NLog を使う]]></title>
            <description><![CDATA[<h1>Cloud Service で NLog を使う</h1>
<p>先日故合ってNLogのコードを見てたら、Cloud Service のカスタムログ転送で面倒なところが簡単に改善できそうだったので、ローカルストレージの定義を、NLogの設定ファイルに書けるようにした<span class="docutils literal"><span class="pre">layout</span> <span class="pre">renderer</span> <span class="pre">${azure-local-resource}</span></span><a class="reference external" href="https://www.nuget.org/packages/NLog.Azure/">NLog.Azure</a>を作ってみました。</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/takekazuomi/19430236414/in/dateposted-public/"><img alt="face" class="align-center" src="https://farm1.staticflickr.com/395/19430236414_f9c9e427fd_c.jpg"/></a>
<p>「<a class="reference internal" href="http://kyrt.in/2015/04/08/azure_diagonestics_1_3_bugs.html"><span class="doc">Azure Diagnostics 1.3 PaaS BUGS</span></a>」は、無事 1.4で改修されて再び使えるようになりました。これで、普通に使えるようになったのですが、相変わらず面倒がことが２つ。</p>
<ol class="arabic simple">
<li>ローカルストレージからのカスタムログ転送はVSからの設定ができない</li>
<li>ローカルストレージのパスはデプロイ毎に変わる</li>
</ol>
<p>今回の趣旨は、２のデプロイ毎に変わるパスをNLogの設定ファイルに書くにはどうするかという話です。</p>
<p>ローカル ストレージ リソース については、MSDNの 「<a class="reference external" href="https://msdn.microsoft.com/ja-jp/library/azure/Ee758708.aspx">ローカル ストレージ リソースを構成する</a>」 を見てください。</p>
<div class="section" id="id2">
<h2>1. ローカルストレージからのカスタムログ転送設定</h2>
<p>ここは前段です。残念ながら現在のVisual Studioでは、GUIでローカルストレージからのカスタムログ転送設定ができません。ここはdiagnostics.wadcfgxに手で書きます。たいして面倒でもなくDataSources のタグの中が今回追加した記述です。これだけで、ローカルストレージ LogStorage からBlobコンテナdiagnostics-custom-logs への転送を定義になります。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/> <span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
 <span class="nt">&lt;DiagnosticsConfiguration</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;PublicConfig</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/ServiceHosting/2010/10/DiagnosticsConfiguration"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;WadCfg&gt;</span>
       <span class="nt">&lt;DiagnosticMonitorConfiguration</span> <span class="na">overallQuotaInMB=</span><span class="s">"4096"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;DiagnosticInfrastructureLogs</span> <span class="na">scheduledTransferLogLevelFilter=</span><span class="s">"Error"</span> <span class="nt">/&gt;</span>
         <span class="nt">&lt;Directories</span> <span class="na">scheduledTransferPeriod=</span><span class="s">"PT1M"</span><span class="nt">&gt;</span>
           <span class="nt">&lt;IISLogs</span> <span class="na">containerName=</span><span class="s">"wad-iis-logfiles"</span> <span class="nt">/&gt;</span>
           <span class="nt">&lt;FailedRequestLogs</span> <span class="na">containerName=</span><span class="s">"wad-failedrequestlogs"</span> <span class="nt">/&gt;</span>
<span class="hll">           <span class="nt">&lt;DataSources&gt;</span>
</span><span class="hll">             <span class="nt">&lt;DirectoryConfiguration</span> <span class="na">containerName=</span><span class="s">"diagnostics-custom-logs"</span><span class="nt">&gt;</span>
</span><span class="hll">               <span class="nt">&lt;LocalResource</span> <span class="na">relativePath=</span><span class="s">"."</span> <span class="na">name=</span><span class="s">"LogStorage"</span> <span class="nt">/&gt;</span>
</span><span class="hll">             <span class="nt">&lt;/DirectoryConfiguration&gt;</span>
</span><span class="hll">           <span class="nt">&lt;/DataSources&gt;</span>
</span>         <span class="nt">&lt;/Directories&gt;</span>

     ... 省略 ...

 <span class="nt">&lt;/DiagnosticsConfiguration&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>2. ローカルストレージのパスはデプロイ毎に変わる</h2>
<p>これで、ローカルストレージ LogStorage へログを書けばカスタムログ転送でBlobへ送られます。しかし、Cloud Service だと起動するまでローカルストレージがわかりません。また、デプロイ毎に異なったディレクトリを割り当てられます。WorkerRoleでは、csdef でローカルストレージのパスを環境変数に入れておいて、NLog.config の中で、<a class="reference external" href="https://github.com/NLog/NLog/wiki/Environment-layout-renderer">Environment layout renderer</a>を使ってパスを展開するという技も使えます。しかしWebRoleがFull IISになって以来、csdefが解釈実行されるプロセスとアプリケーションが動くプロセスが別になったので、ローカルストレージのパスを環境変数に入れて、configに渡すという技が使えなくなりました。（WebRoleがFull IIS になったのは、はるか昔のAzure SDK 1.3のことですが）基本的には、Microsoft.WindowsAzure.ServiceRuntime の RoleEnviromentからローカルストレージのパスを取得するのですが、そのためにはNLogの設定をコードでコニョゴニョしないといけません。そこで、NLog の設定ファイルにローカルストレージのパスを展開できるような、<span class="docutils literal"><span class="pre">layout</span> <span class="pre">renderer</span> <span class="pre">"${azure-local-resource}</span></span><a class="reference external" href="https://www.nuget.org/packages/NLog.Azure/">NLog.Azure</a>を書きました。（名前がおおざっぱ過ぎたかもしれません）</p>
<p>バイナリがNuGetに上げてあるので、インストールはここからします。微妙な気もするので、まだpreviewにしてあります。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ Install-Package NLog.Azure -Pre
</pre></div>
</div>
<p>これでインストールしたら、NLog.configに下記のように書くと実行時にローカルストレージのパスに展開されます。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="nt">&lt;variable</span> <span class="na">name=</span><span class="s">"logDirectory"</span> <span class="na">value=</span><span class="s">"${azure-local-resource:name=LogStorage:default=c\:/Logs/}"</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/takekazuomi/NLog.Azure/blob/master/NLog.Azure.Example/WebRole1/NLog.config">NLog.configのサンプル</a></p>
<p>name という引数に ローカルストレージ名を書きます。default は、ServiceRuntime が存在しないとき、あるいはローカルストレージの定義が無い場合に使われるバスを書きます。Azureの本番環境あるいはエミュレータ環境では、ローカルストレージにログを書き、そうでない場合はdefaultで指定された場所にログを書くという風に使うことを想定しています。NLogは結構素直な出来で、ここまではすっきり、さくっとできました。log4net よりいい感じですね。</p>
<p>参考までに、簡単なWebRoleのプロジェクトをGitHubに上げてあります。<a class="reference external" href="https://github.com/takekazuomi/NLog.Azure/tree/master/NLog.Azure.Example">NLog.Azure.Example</a></p>
</div>
<div class="section" id="id5">
<h2>おまけ</h2>
<p>実は、Microsoft.WindowsAzure.ServiceRuntime.dll には、再配布可能では無いという大きな問題があります。これはどういうことかというと、プロジェクトでServiceRuntime.dllを参照している場合、必ず Azure SDK を入れないと開発/実行できないということです。Storageなどのライブラリは、Azure SDK無しでもNuGet から落としてきたのだけで動くのに、ASP.NETの普通のプロジェクトとして作っていてもServiceRuntime に依存した瞬間にAzure SDKが必要です。NuGetからも入らないのでなかなか<strong>メンドクサイ</strong>ことになります。今回の<span class="docutils literal"><span class="pre">${azure-local-resource}</span> <span class="pre">layout</span> <span class="pre">renderer</span></span>も、ServiceRuntimeを参照してしまうと、Azure SDK の入ってない環境ではアセンブリのロードでエラーになってしまいます。せっかく、defaultパラメータとか作ったのに<strong>意味が無い</strong>、単純なASP.NETのアプリはそのままでに動くようにしておきたいのに。</p>
<p>こんなとき、.NET では、アセンブリを直接参照しないで自前でロードしてリフレクションで関数を呼び出すという方法があります。今回はServiceRuntimeのアセンブリはGACに登録されているけど物理パスがわからない！、さて困った。そんなときは Fusion API でGACから探し出すのが上等手段です。<a class="footnote-reference" href="#r1" id="id6">[1]</a>常套手段と言っても普通に暮らしてるとあまり出番ないですが。Fusion (Unmanaged API Reference)<a class="footnote-reference" href="#r2" id="id7">[2]</a>は、GACに登録されているアセンブリを操作する Unmanaged API です、昔はドキュメント無かった気がしますが今は普通に書いてありますね。今回は、GACからアセンブリを探してパスを所得するのだけに使います。CreateAssemblyCache() を呼んで AssemblyInfo を取得し、AssemblyInfo を読むだけです簡単ですね。 コード的には、<a class="reference external" href="https://github.com/takekazuomi/NLog.Azure/blob/master/NLog.Azure/FusionAPI.cs#L19-L33">GetAssemblyPath()</a>のあたり。あとは、リフレクションを駆使して、RoleEnvironment.IsAvailable とか、LocalResource.RootPath を呼んでいますが、ここはコード生成するべきかもしれません。 やっていることは簡単なのに<strong>メンドクサイ</strong></p>
</div>
<div class="section" id="id8">
<h2>最後に</h2>
<p>ずいぶん間が空いてしまいましたが、2015/5/12 に、株式会社 kyrt にしました、先月には、2015年7月期、Microsoft Azure のカテゴリで、Microsoft MVP Award を受賞をいただきました。皆さまのおかげです、これらかもよろしくお願いいたします。</p>
<p>File System をバッファーとして使うロギングシステムではパフォーマンスに注意した方が良さそうです。Azure Diagonesticsを使うと、out-process の log collector でよしなにBlobへの転送をしてくれるので、直にBlobやTableに書くより良いとは思いますが、アプリとout-process の間のつなぎがFile System なのは信頼性は良いけどパフォーマンスが疑問です。そんなにログ書くのかという話はあると思いますが。そう考えるとアプリとlog collectorの間はETWが良いような気もします。ついでに、log collector でアーカイブだけじゃなくてリアルタイム系のフィルタリングとかやってくれると便利なんだけど。<a class="reference external" href="https://github.com/mspnp/semantic-logging">SLAB</a>に期待ですね。</p>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[1]</a></td><td><a class="reference external" href="http://stackoverflow.com/questions/19456547/how-to-programmatically-determine-if-net-assembly-is-installed-in-gac">How to programmatically determine if .NET assembly is installed in GAC?</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td><a class="reference external" href="https://msdn.microsoft.com/en-us/library/ms404523.aspx">Fusion (Unmanaged API Reference)</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sun, 23 Aug 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/05/05/update_tinker_1_5_sphinx_1_3.html</link>
            <guid>http://kyrt.in/2015/05/05/update_tinker_1_5_sphinx_1_3.html</guid>
            <title><![CDATA[tinker 1.5 + sphinx 1.3.1 に updateしました]]></title>
            <description><![CDATA[<h1>tinker 1.5 + sphinx 1.3.1 に updateしました</h1>
<p>ゴールデンウェークでちょっと時間が出来たのでblobのbackendを更新しました</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/takekazuomi/16637835634"><img alt="bubble by Takekazu Omi" class="align-center" src="https://farm8.staticflickr.com/7650/16637835634_2127f916be_c.jpg"/></a>
<ul class="simple">
<li>sphinx を 1.3.1 へ<a class="reference external" href="http://docs.sphinx-users.jp/changes.html#release-1-3-1-released-mar-17-2015">更新内容 リリース 1.3.1 (2015年3月17日)</a></li>
<li>tinkerer を 1.5 へ<a class="reference external" href="http://tinkerer.me/2014/11/09/tinkerer_1_5_released.html">リリースノート</a></li>
</ul>
<p>テンプレートを変更してないので、見た目は変わりませんね。</p>
]]></description>
            <category><![CDATA[ blog ]]></category>
             <pubDate>Tue, 05 May 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/04/08/azure_diagonestics_1_3_bugs.html</link>
            <guid>http://kyrt.in/2015/04/08/azure_diagonestics_1_3_bugs.html</guid>
            <title><![CDATA[Azure Diagnostics 1.3 PaaS BUGS]]></title>
            <description><![CDATA[<h1>Azure Diagnostics 1.3 PaaS BUGS</h1>
<p><strong>更新: 2015/4/17 にリリースされた。Diagnostics Extention 1.4 で下記の問題は修正されました</strong></p>
<p>Azure SDK 2.5 から、Windows Azure Diagnostics (WAD) がVM Extentionになりました。それに伴って、Cloud Service (PaaS)でIISのログ転送と、ローカルストレージのカスタムログ転送が行われないという2つの問題があります。（IaaSでは問題はありません）</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/takekazuomi/15852128023"><img alt="Tohaku 2015" class="align-center" src="https://farm8.staticflickr.com/7391/15852128023_dc3fb6ea48_c.jpg"/></a>
<p>※この情報は、2015/4/8 Azure SDK 2.5.1, VM Extention 1.3.1.6 を元にして書いています。</p>
<div class="section" id="iis">
<h2>IISのログ転送</h2>
<p>デプロイ直後はIISのログ転送が行われず、再起動後に転送が開始されるという問題があります。</p>
<div class="section" id="id1">
<h3>原因</h3>
<p>WADは起動したときにIIS Management Service経由でIIISログの場所探します。デフォルトでは、この場所は、%SystemDrive%inetpublogsLogFiles に設定されています。PaaSでは WebRoleのIISConfigurator がサービス定義に基いてIISの設定を C:Resourcesdirectory{deploymentid.rolename}.DiagnosticStoreLogFilesWeb へ変更します。その結果、WADの構成が、IISConfigurator の前に実行されると、WADは間違ったディレクトリを監視することになってしまいます。</p>
</div>
<div class="section" id="id2">
<h3>対策</h3>
<p>WADの構成がIISConfiguratorの実行の後に起こればいいので、一度Roleを再起動します。それには、Startup Taskあるいは、Role の OnStartで下記のように処理します。最初の起動の時に、IISConfigurator が行った変更に基いて、2回めの起動でWADが構成を設定します。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="p">{</span>
    <span class="c1">// Write a RebootFlag.txt file to the %RoleRoot%\Approot\bin folder to track if this VM has rebooted to fix WAD 1.3 IIS logs issue</span>
    <span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="s">"RebootFlag.txt"</span><span class="p">;</span>
    <span class="c1">// If RebootFlag.txt already exists then skip rebooting the VM</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"Writing RebootFlag at "</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">"O"</span><span class="p">));</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Rebooting"</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">"shutdown"</span><span class="p">,</span> <span class="s">"/r /t 0"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">OnStart</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>この方法だと、ファイルをアプリケーションのディレクトリに作成しているので、インプレースアップグレードの度に再起動がかかります。そのかわり、アクセス権の問題が無いため、elevated する必要がありません。システムドライブや、Cドライブにファイルを作成する、あるいはレジストリにフラグを作成する方法を使うと、再起動は最小限に抑えられますが、.csdef に &lt;Runtime executionContext=”elevated” /&gt; の設定が必要です。</p>
</div>
</div>
<div class="section" id="id3">
<h2>カスタムログ転送</h2>
<p>現在のバージョンでは、従来行っていたローカルストレージからのカスタムログ転送は動作しませんので変わりに絶対ディレクトリからの転送を使います。（ちなみにローカルストレージからのカスタムログ転送はVSからの設定も出来ません）</p>
<p>注意点は2点、</p>
<ol class="arabic simple">
<li>ローカルストレージと違ってquotaが利きません。書き出す量を間違えると、ディスクが溢れて他の動作に影響する可能性があります。</li>
<li>絶対ディレクトリにはCドライブを指定しますが、指定ディレクトリには転送したいファイルだけが存在するようにします。</li>
<li>絶対ディレクトリを指定した場合、デプロイID毎に別のディレクトリにローカルストレージの領域が取られますが、絶対パスでは同じディレクトリが使われます。</li>
<li>アクセス権を設定する必要があります。</li>
</ol>
<div class="section" id="id4">
<h3>対策</h3>
<p>VSで診断構成のアプリケーションログ転送を開きます。</p>
<img alt="application log settings" class="align-center" src="http://kyrt.in/_images/screen001.png"/>
<p>この設定をしたら、IISのログ転送対策と同じように、RoleのOnStartで、下記の処理を入れます。ここでは、ディレクトリの有無を確認していますが、WADが先に起動した場合は、ディレクトリは作成されています。アクセス権が足りないので追加します。必要なIISのアクセス権については、<a class="reference external" href="http://blog.shibayan.jp/entry/20150127/1422369253">しばやん雑記：IIS 7 以降でのアプリケーションプールと権限について調べた</a>を参考にしています。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="k">if</span> <span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="s">@"c:\AppLogs"</span><span class="p">))</span>
    <span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="s">@"c:\AppLogs"</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">"icacls"</span><span class="p">,</span> <span class="s">"c:\\AppLogs /grant \"BUILTIN\\IIS_IUSRS:\":(OI)(CI)W"</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>最後に</h2>
<p>最後に上記の問題を合わせたコード例を上げておきます。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="s">@"c:\AppLogs\RebootFlag.txt"</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(!</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="s">@"c:\AppLogs"</span><span class="p">))</span>
        <span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="s">@"c:\AppLogs"</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">"icacls"</span><span class="p">,</span> <span class="s">"c:\\AppLogs /grant BUILTIN\\IIS_IUSRS:(OI)(CI)W"</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">WriteAllText</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"Writing RebootFlag at "</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">"O"</span><span class="p">));</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Trace</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Rebooting"</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Process</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">"shutdown"</span><span class="p">,</span> <span class="s">"/r /t 0"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>csdefに、下記のように、 &lt;Runtime executionContext=”elevated” /&gt; を追加します。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;ServiceDefinition</span> <span class="na">name=</span><span class="s">"AzureCloudService1"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition"</span> <span class="na">schemaVersion=</span><span class="s">"2014-06.2.4"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;WebRole</span> <span class="na">name=</span><span class="s">"WebRole1"</span> <span class="na">vmsize=</span><span class="s">"Small"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Runtime</span> <span class="na">executionContext=</span><span class="s">"elevated"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;Sites&gt;</span>
      <span class="nt">&lt;Site</span> <span class="na">name=</span><span class="s">"Web"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Bindings&gt;</span>
          <span class="nt">&lt;Binding</span> <span class="na">name=</span><span class="s">"Endpoint1"</span> <span class="na">endpointName=</span><span class="s">"Endpoint1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/Bindings&gt;</span>
      <span class="nt">&lt;/Site&gt;</span>
    <span class="nt">&lt;/Sites&gt;</span>
    <span class="nt">&lt;Endpoints&gt;</span>
      <span class="nt">&lt;InputEndpoint</span> <span class="na">name=</span><span class="s">"Endpoint1"</span> <span class="na">protocol=</span><span class="s">"http"</span> <span class="na">port=</span><span class="s">"80"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/Endpoints&gt;</span>
    <span class="nt">&lt;Imports&gt;</span>
      <span class="nt">&lt;Import</span> <span class="na">moduleName=</span><span class="s">"RemoteAccess"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;Import</span> <span class="na">moduleName=</span><span class="s">"RemoteForwarder"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/Imports&gt;</span>
  <span class="nt">&lt;/WebRole&gt;</span>
<span class="nt">&lt;/ServiceDefinition&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>参考</h2>
<ul class="simple">
<li>MSDN Forum<a class="reference external" href="https://social.msdn.microsoft.com/Forums/en-US/77e09c6b-5a9e-4aa2-b63a-fc4e46842c7e/cannot-configure-diagnostics-for-local-resources-with-sdk-25?forum=windowsazuredevelopment">Cannot configure diagnostics for local resources with SDK 2.5</a></li>
<li>Windows Azure - Troubleshooting &amp; Debugging<a class="reference external" href="http://blogs.msdn.com/b/kwill/archive/2015/02/23/sdk-2-5-wad-1-2-iis-logs-not-transferring-to-storage-in-paas-webroles.aspx">SDK 2.5 / WAD 1.2 — IIS Logs Not Transferring to Storage in PaaS WebRoles</a></li>
<li>Mode 13h<a class="reference external" href="http://mode13h.azurewebsites.net/Posts/AzureSdk25Diag">Azure SDK 2.5 Diagnostics Bugs</a></li>
<li>しばやん雑記<a class="reference external" href="http://blog.shibayan.jp/entry/20150127/1422369253">IIS 7 以降でのアプリケーションプールと権限について調べた</a></li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Wed, 08 Apr 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2015/01/18/goazure_2015.html</link>
            <guid>http://kyrt.in/2015/01/18/goazure_2015.html</guid>
            <title><![CDATA[GoAzure 2015 でAzureの永続化について話をしてきました]]></title>
            <description><![CDATA[<h1>GoAzure 2015 でAzureの永続化について話をしてきました</h1>
<p><a class="reference external" href="http://r.jazug.jp/goazure">GoAzure 2015</a>の2つのセッションで喋ってきました。ひとつでは、Azure Storageの概要からIaaSのDiskについてまでを「<a class="reference external" href="http://www.slideshare.net/takekazuomi/persistence-on-azure-microsoft-azure">Persistence on Azure - Microsoft Azure の永続化</a>」でみっちり53分ほど、もうひとつは、「しばやん」のセッション(<a class="reference external" href="http://blog.shibayan.jp/entry/20150117/1421492433">GoAzure 2015 でクラウドデザインパターンと Azure Websites について話してきました</a>) にちょっとお邪魔。</p>
<p>しばやんのセッションは、しばやんが気持ちよく喋ってるので間に割り込むのが難しく、しゃべりの修行の必要性を感じましたね。今後の課題です。</p>
<div class="section" id="id1">
<h2>Persistence on Azure - Microsoft Azure の永続化</h2>
<p>スライドは、SlideShareに公開しています。</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/43601587" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/persistence-on-azure-microsoft-azure">Persistence on Azure - Microsoft Azure の永続化</a></p>
<p>セッション、「Persistence on Azure - Microsoft Azure の永続化」は、資料を作り始めたら80ページ、90ページと順当に増えていって、到底50分に収まりそうもなく非常に難儀し、最終的にIaaSのDisk（Block Device）を落とし所にしてStorageの概要を話す形にしました。Azure Storageの特徴は、データセンターの構成や内部構造が絡んで、冗長構成とパフォーマンス特性に現れてくるので、どうしてそうなっているのかあたりを含めつつ短時間で話をするのはなかなか難しいです。</p>
<p>もう少し、Tableも交えて話すと、Azure Storageという共通の仕組みの上に、NoSQLとBlock Device（VM Disk）が乗ってることの素晴らしさが伝わったんじゃないかと思うと少々残念です。クラウドベンダーとしてのMicrosoftという観点から見ると、Storage共通基盤は投資効果が高く、他のベンダーとの差別化ができるポイントではないかと思うので、さらなる今後の発展に期待しています。</p>
<p>榎本さんのセッション 「<a class="reference external" href="http://atsushieno.hatenablog.com/entry/2015/01/17/003523">GoAzure2015 - オープンソース.NETと Mono / Xamarin の今後について</a>」が同じ時間の開催になってしまって見れなかったのが残念でした。自分で聞きたかったから、「台湾でばかり喋ってないで日本でも話してくれないか」とセッションに誘ったのに・・・ orz</p>
<p>後になって、クラウドデザインパターン色を入れても良かったのかなと思いつつも、イベントを楽しめました。聞きたいセッションが被り過ぎてたのが残念と言えば残念ですが、非常に充実したイベントでした。</p>
</div>
<div class="section" id="id3">
<h2>謝辞</h2>
<p>榎本さん、酒井さん、森島さん、しばやん、セッションお疲れ様でした。</p>
<p>JAZUGの皆さん、Microsoftの皆さん、スポンサーの皆さん、関係者の皆さん本当にありがとうございました。いつも裏方から表方までありがとうございます。</p>
<p>参加者の皆様、ありがとうございました。</p>
</div>
]]></description>
            <category><![CDATA[ Session ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Sun, 18 Jan 2015 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/12/02/introduction_to_azure_batch.html</link>
            <guid>http://kyrt.in/2014/12/02/introduction_to_azure_batch.html</guid>
            <title><![CDATA[Introduction to Azure Batch]]></title>
            <description><![CDATA[<h1>Introduction to Azure Batch</h1>
<p>※本記事は、<a class="reference external" href="http://qiita.com/advent-calendar/2014/azure">Azure Advent Calendar 2014</a>への寄稿記事です。</p>
<p>最近あまりに Azure の新機能が続々と出てくるので、なかなかフォローが難しですが、そんな時は、<a class="reference external" href="https://buchizo.wordpress.com/">No.1のBlog</a>と、 twitterで<a class="reference external" href="https://twitter.com/hashtag/azurejp?src=hash">#azurejp</a>を見ておけば良いですね。</p>
<p>そんな数ある今年のAzure新機能の中で、<a class="reference external" href="http://azure.microsoft.com/en-us/services/documentdb/">DocumentDB</a>と、<a class="reference external" href="http://azure.microsoft.com/en-us/services/batch/">Batch</a>の２つがお気に入りです。<span class="docutils literal"><span class="pre">DocumentDB</span></span>については、過日仙台で話をしたので、その時の<a class="reference external" href="http://www.slideshare.net/takekazuomi/introduction-to-documentdb">資料</a>を観てもらうことににして、今回は<span class="docutils literal"><span class="pre">Azure</span> <span class="pre">Batch</span></span>を紹介します。 公式名称は、<span class="docutils literal"><span class="pre">Batch</span></span>ということなのですが、一般名称を製品名に使うのは紛らわしいので止めて欲しいですが、ここでは、それを曲げて、<span class="docutils literal"><span class="pre">Batch</span></span>と書きます。</p>
<p><span class="docutils literal"><span class="pre">Batch</span></span>は、2014/10/28 に行われた TechEd Europe の Keynote でお披露目されました。その時の動画が公開されています。 開始から 1:11 ぐらいから<span class="docutils literal"><span class="pre">Batch</span></span>の紹介が始まって、1:15 から Mark Russinovich が<a class="reference external" href="http://www.blender.org/">blender</a>を使った3Dレンダリングを見せてくれます。そこだけなら、そんなに長くないしお勧めです。</p>
<a class="reference external image-reference" href="http://channel9.msdn.com/Events/TechEd/Europe/2014/KEY01"><img alt="TechEd Europe 2014 Keynote" class="align-center" src="http://kyrt.in/_images/batch000.png"/></a>
<p>.</p>
<div class="section" id="id2">
<h2>Batch とは</h2>
<p>簡単に言うと、バッチ処理向けのPaaSです。WorkerRoleを使ってバッチ処理を組むのに比べると、ジョブ·キュー、スケジューラ、VMのプロビジョニングなどをアプリケーション側で用意する必要がありません。また既存のexeファイルをクラウド上で大量に実行することなどが容易に出来るようになっています。Microsoft内部では、Media Serviceが動画のエンコードの処理の部分で使っているそうです。<span class="docutils literal"><span class="pre">Batch</span></span>のコンセプトと用語について説明します。</p>
<div class="section" id="azure-batch-account">
<h3>Azure Batch Account</h3>
<p><span class="docutils literal"><span class="pre">Batch</span></span>サービスを使うには、Bach アカウントが必要で、そのアカウントはポータルで作成します。アカウントを作成すると、サブスクリプション、リージョン、アカウント名とキーが確定します。アカウント名とキーはコードで利用します。</p>
<img alt="Azure Batch Account" class="align-center" src="http://kyrt.in/_images/batch001.png"/>
</div>
<div class="section" id="sdk">
<h3>SDK</h3>
<p><strong>Bach</strong>では、低レベルのHTTP REST APIと、高レベルの Batch Apps を用意しています。現在のところ、 .NET 向け<a class="reference external" href="http://www.nuget.org/packages/Microsoft.Azure.Batch.Apps.Cloud/">Batch Apps Cloud SDK</a>、<a class="reference external" href="http://www.nuget.org/packages/Microsoft.Azure.Batch.Apps/">Batch Apps Client SDK</a>と、<a class="reference external" href="https://github.com/Azure/azure-batch-apps-python">python 向け SDK</a>が用意されていて、<a class="reference external" href="https://visualstudiogallery.msdn.microsoft.com/8b294850-a0a5-43b0-acde-57a07f17826a">Visual Studio 向けの extension</a>もあります。</p>
</div>
<div class="section" id="azure-batch-rest-api">
<h3>Azure Batch REST API</h3>
<p>低レベルのHTTP REST API では、VM pool の管理、work item の実行を柔軟にコントロールすることができます。この方法では、あなたのリソースを完全に制御できますが、タスク実行パイプラインを管理するためにクライアントが必要です。</p>
</div>
<div class="section" id="azure-batch-apps">
<h3>Azure Batch Apps</h3>
<p>もう一つの高レベルの仕組みとして、<span class="docutils literal"><span class="pre">Batch</span> <span class="pre">Apps</span></span>と呼ばれる機能が用意されています。この仕組みでは、バッチワークロードを登録し、クライアントあるいは、Batch Apps portal から実行することが出来るなどよりユーザーよりの管理機能を用意しています。</p>
<img alt="Azure Batch Apps portal" class="align-center" src="http://kyrt.in/_images/batch004.png"/>
</div>
<div class="section" id="pools">
<h3>Pools</h3>
<p>バッチを実行する、ノードのグループです。Poolは、複数のVMで構成され、VMは、auto scaling rules で増減します。PoolへのVMの追加が必要な場合は、自動的に新規ノードが作成・追加されます。</p>
</div>
<div class="section" id="task-virtual-machines-tvms">
<h3>Task Virtual Machines (TVMs)</h3>
<p>TVMs は、Poolを構成する、compute nodeの１つです。<span class="docutils literal"><span class="pre">Batch</span></span>用に構成された Web/Worker Role と思ってください。scalable で stateless な仮想マシンとして利用できます。Poolに TVMs が追加される場合は、新規にクリーンな仮想マシンが用意されます。そのため、Poolの作成には少々時間がかかります。初期ノード数を指定して試してみたところ、1ノードで8分、100ノードぐらいの時間がかかりました。（Japan West、A1）</p>
<img alt="Pool and TVMs" class="align-center" src="http://kyrt.in/_images/batch006.png"/>
</div>
<div class="section" id="work-items">
<h3>Work Items</h3>
<p><span class="docutils literal"><span class="pre">Work</span> <span class="pre">Items</span></span>は、アプリケーションがプールでTVMs上で実行される方法を指定するテンプレートです。スケジューリングの設定（execute once とか 実行時間制限など）や、どの Pool でjobを実行するかなどを指定します。</p>
</div>
<div class="section" id="jobs">
<h3>Jobs</h3>
<p>jobは、work item のスケジュールされたインスタンスで、一度だけ実行されたり、何度か実行されたりします。複数の task の集まりです。個々の task は、pool のどこかのTVM で実行されます。</p>
</div>
<div class="section" id="tasks">
<h3>Tasks</h3>
<p>task は、job の中の一つの実行ステップです。 work item, job, task の関係は、下記の図のようになります。</p>
<img alt="work item, job, task" class="align-center" src="http://kyrt.in/_images/batch005.png"/>
</div>
</div>
<div class="section" id="batch-api">
<h2>Batch APIのサンプルコード</h2>
<p>現時点では、<span class="docutils literal"><span class="pre">Batch</span></span>のサンプルコードが6個<a class="reference external" href="https://code.msdn.microsoft.com/site/search?f%5B0%5D.Type=Topic&amp;f%5B0%5D.Value=Azure%20Batch&amp;f%5B0%5D.Text=Azure%20Batch">コードレシピ</a>に上がっています。そのうち、<a class="reference external" href="https://code.msdn.microsoft.com/Azure-Batch-Apps-Samples-dd781172">Azure Batch Sample - Hello World &lt;Batch AppsがBatch APIのサンプルで、 `Microsoft Azure Batch Apps Samples</a>がBatch Apps のサンプルでした。</p>
<p>Batch APIのサンプルの<a class="reference external" href="https://code.msdn.microsoft.com/Azure-Batch-Apps-Samples-dd781172">Hello World</a>の方をざっと眺めます。</p>
<div class="section" id="packages-config">
<h3>packages.config</h3>
<p>まず、<cite>packages.config &lt;https://code.msdn.microsoft.com/Azure-Batch-Sample-Hello-6573967c/sourcecode?fileId=127847&amp;pathId=1932330368&gt;</cite>を眺めます。最近、サンプルコードや、他人のコードを見る時は、最初にpackages.configを見るようになりました。どんなライブラリを使ってるかを把握しておくと理解が速くなる気がしています。</p>
<p><a class="reference external" href="http://www.nuget.org/packages/Azure.Batch/">Azure.Batch</a>を使っています。APIリファレンスは、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/azure/dn820177.aspx">Batch API</a>にあります。</p>
</div>
<div class="section" id="id5">
<h3>設定</h3>
<p>試しに動かして見ようとするならば、 BatchとStorageのアカウントが必要です。 これらを作成したら、Program.csに書き込みます。変更するのは、赤線部分、blobのendpoint、batchのアカウント、キー、ストレージのアカウント、キーの5箇所です。</p>
<img alt="hello world setting" class="align-center" src="http://kyrt.in/_images/batch007.png"/>
</div>
<div class="section" id="id6">
<h3>実行</h3>
<p>VSでビルドして実行すると下記のような感じで動きます。このサンプルを動かすだけならば、VS extension は必要ありません。</p>
<img alt="hello world exec" class="align-center" src="http://kyrt.in/_images/batch008.png"/>
</div>
<div class="section" id="batchclient">
<h3>1. BatchClient</h3>
<p>Batch アカウント、キーから、BatchCredentialsを作成して、BatchClient.Connect で BatchClientを取得します。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="c1">// Get an instance of the BatchClient for a given Azure Batch account.</span>
<span class="n">BatchCredentials</span> <span class="n">cred</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BatchCredentials</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="n">Key</span><span class="p">);</span>
<span class="k">using</span> <span class="p">(</span><span class="n">IBatchClient</span> <span class="n">client</span> <span class="p">=</span> <span class="n">BatchClient</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">Url</span><span class="p">,</span> <span class="n">cred</span><span class="p">))</span>
<span class="p">{</span>
<span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="pool">
<h3>2. Pool</h3>
<p>Poolを用意しますが、もしあれば使います。Poolは、PoolManager経由で操作します。Pool 名はBatch アカウント内でユニークな名前で無ければいけません。Pool作成時に、VMのサイズやOSを指定します。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">CreatePoolIfNotExist</span><span class="p">(</span><span class="n">IBatchClient</span> <span class="n">client</span><span class="p">,</span> <span class="kt">string</span> <span class="n">poolName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// All Pool and VM operation starts from PoolManager</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">IPoolManager</span> <span class="n">pm</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">OpenPoolManager</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// go through all the pools and see if it already exists</span>
        <span class="kt">bool</span> <span class="n">found</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">ICloudPool</span> <span class="n">p</span> <span class="k">in</span> <span class="n">pm</span><span class="p">.</span><span class="n">ListPools</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">// pools are uniquely identified by their name</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">poolName</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Found pool {0} already exists"</span><span class="p">,</span> <span class="n">poolName</span><span class="p">);</span>
                    <span class="n">found</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">found</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Creating pool: {0}"</span><span class="p">,</span> <span class="n">poolName</span><span class="p">);</span>
                <span class="c1">// if pool not found, call CreatePool</span>
                <span class="c1">//You can learn more about os families and versions at:</span>
                <span class="c1">//http://msdn.microsoft.com/en-us/library/azure/ee924680.aspx</span>
                <span class="n">ICloudPool</span> <span class="n">pool</span> <span class="p">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">CreatePool</span><span class="p">(</span><span class="n">poolName</span><span class="p">,</span> <span class="n">targetDedicated</span><span class="p">:</span> <span class="m">3</span><span class="p">,</span> <span class="n">vmSize</span><span class="p">:</span> <span class="s">"small"</span><span class="p">,</span> <span class="n">osFamily</span><span class="p">:</span> <span class="s">"3"</span><span class="p">);</span>
                <span class="n">pool</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="work-item">
<h3>3. work item</h3>
<p>ここはちょっと分かり辛い。CloudTask がTaskで、次に、Work Itemを定義します。 client.OpenWorkItemManager で、WorkItemManager を取得して。TaskSubmissionHelper を使って、複数のタスクを追加していきます。最後に、 TaskSubmissionHelper.Commitで、Work Itemが発行されJobとしてインスタンス化されます。WorkItemManager.GetJobでJobは取得できます。Jobの実行状況は、TaskStateMonitor で確認することができます。このコードでは、TaskStateMonitor.WaitAll() で全てのjobの完了を待っています。</p>
<div class="highlight-csharp"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">AddWork</span><span class="p">(</span><span class="n">IBatchClient</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">IWorkItemManager</span> <span class="n">wm</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">OpenWorkItemManager</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">//The toolbox contains some helper mechanisms to ease submission and monitoring of tasks.</span>
        <span class="n">IToolbox</span> <span class="n">toolbox</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">OpenToolbox</span><span class="p">();</span>

        <span class="c1">// to submit a batch of tasks, the TaskSubmissionHelper is useful.</span>
        <span class="n">ITaskSubmissionHelper</span> <span class="n">taskSubmissionHelper</span> <span class="p">=</span> <span class="n">toolbox</span><span class="p">.</span><span class="n">CreateTaskSubmissionHelper</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">Program</span><span class="p">.</span><span class="n">PoolName</span><span class="p">);</span>

        <span class="c1">// workitem is uniquely identified by its name so we will use a timestamp as suffix</span>
        <span class="n">taskSubmissionHelper</span><span class="p">.</span><span class="n">WorkItemName</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"USERNAME"</span><span class="p">)</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="s">"yyyyMMdd-HHmmss"</span><span class="p">);</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Creating work item: {0}"</span><span class="p">,</span> <span class="n">taskSubmissionHelper</span><span class="p">.</span><span class="n">WorkItemName</span><span class="p">);</span>

        <span class="c1">// add 2 quick tasks. Tasks within a job must have unique names</span>
        <span class="n">taskSubmissionHelper</span><span class="p">.</span><span class="n">AddTask</span><span class="p">(</span><span class="k">new</span> <span class="n">CloudTask</span><span class="p">(</span><span class="s">"task1"</span><span class="p">,</span> <span class="s">"hostname"</span><span class="p">));</span>
        <span class="n">taskSubmissionHelper</span><span class="p">.</span><span class="n">AddTask</span><span class="p">(</span><span class="k">new</span> <span class="n">CloudTask</span><span class="p">(</span><span class="s">"task2"</span><span class="p">,</span> <span class="s">"cmd /c dir /s"</span><span class="p">));</span>

        <span class="c1">//Commit the tasks to the Batch Service</span>
        <span class="n">IJobCommitUnboundArtifacts</span> <span class="n">artifacts</span> <span class="p">=</span> <span class="n">taskSubmissionHelper</span><span class="p">.</span><span class="n">Commit</span><span class="p">()</span> <span class="k">as</span> <span class="n">IJobCommitUnboundArtifacts</span><span class="p">;</span>

        <span class="c1">// TaskSubmissionHelper commit artifacts returns the workitem and job name</span>
        <span class="n">ICloudJob</span> <span class="n">job</span> <span class="p">=</span> <span class="n">wm</span><span class="p">.</span><span class="n">GetJob</span><span class="p">(</span><span class="n">artifacts</span><span class="p">.</span><span class="n">WorkItemName</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">.</span><span class="n">JobName</span><span class="p">);</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Waiting for all tasks to complete on work item: {0}, Job: {1} ..."</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">.</span><span class="n">WorkItemName</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">.</span><span class="n">JobName</span><span class="p">);</span>

        <span class="c1">//We use the task state monitor to monitor the state of our tasks -- in this case we will wait for them all to complete.</span>
        <span class="n">ITaskStateMonitor</span> <span class="n">taskStateMonitor</span> <span class="p">=</span> <span class="n">toolbox</span><span class="p">.</span><span class="n">CreateTaskStateMonitor</span><span class="p">();</span>

        <span class="c1">// blocking wait on the list of tasks until all tasks reach completed state</span>
        <span class="kt">bool</span> <span class="n">timedOut</span> <span class="p">=</span> <span class="n">taskStateMonitor</span><span class="p">.</span><span class="n">WaitAll</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">ListTasks</span><span class="p">(),</span> <span class="n">TaskState</span><span class="p">.</span><span class="n">Completed</span><span class="p">,</span> <span class="k">new</span> <span class="n">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">20</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">timedOut</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">TimeoutException</span><span class="p">(</span><span class="s">"Timed out waiting for tasks"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// dump task output</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">job</span><span class="p">.</span><span class="n">ListTasks</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Task "</span> <span class="p">+</span> <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">" says:\n"</span> <span class="p">+</span> <span class="n">t</span><span class="p">.</span><span class="n">GetTaskFile</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="n">StandardOutFileName</span><span class="p">).</span><span class="n">ReadAsString</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">// remember to delete the workitem before exiting</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Deleting work item: {0}"</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">.</span><span class="n">WorkItemName</span><span class="p">);</span>
        <span class="n">wm</span><span class="p">.</span><span class="n">DeleteWorkItem</span><span class="p">(</span><span class="n">artifacts</span><span class="p">.</span><span class="n">WorkItemName</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>4. 結果の取得</h3>
<p>完了後のJobを、CloudJob.ListTasks()して、個々のTaskの実行結果を拾うことができます。このコードでは、 GetTaskFile(Constants.StandardOutFileName) して標準出力を拾っています。</p>
</div>
<div class="section" id="id8">
<h3>終わり</h3>
<p>最後に、work item を消したり、BatchClientをdisposeしたりなどの後処理をします。基本的な流れは割りとシンプルだと思います。Batch Appsを使うと、予めクラウド側にアプリを登録して置いて、ポータルから実行したり、モニターもポータル経由で出来たりなど諸々便利機能が使えます。その分ちょっと面倒になる部分もありますが、VS extension がその辺りのデバッグなどを支援してくれるようです。</p>
</div>
</div>
<div class="section" id="id9">
<h2>最後に</h2>
<p><span class="docutils literal"><span class="pre">Batch</span></span>は、非常に定型的なコードで、ラージスケールなバッチ処理を実行できる面白い仕組みになっています。Azureの諸々の仕組みと上手く組み合わって、簡単なことならHadoop よりシンプルに同じようなことが実現できると言えそうです。ただ、ちょっとWork Item周りの処理が分かり辛く残念です。わりと簡単に使えるし、日本のデータセンターにも来ているので、興味があれば使ってみれば、良いのではないでしょうか。</p>
<p>この前Blogを書いてからだいぶ時間が空いてしました。今年はJAZUG でやっている<a class="reference external" href="http://jazug.doorkeeper.jp/events/17739">CDP勉強会</a>が次回第五回で延べ400人ほどの参加になりそうな勢い、<a class="reference external" href="http://www.slideshare.net/takekazuomi/presentations">slideshareの資料</a>は累積で7万PVを超える勢いで、Microsoft Azure の熱を肌に感じる１年でした。（slideshare のPVは2014/1/1 時点で5千ほどだったので急激に増えました）</p>
</div>
<div class="section" id="goazure-2015">
<h2>GoAzure 2015</h2>
<img alt="GoAzure" class="align-center" src="http://kyrt.in/_images/batch009.png"/>
<p>あの Scott Hanselman が来る！ ～ GoAzure が 1/16 に開催～ の<a class="reference external" href="http://r.jazug.jp/#event">GoAzure</a>で、Storage周りの話しをします（予定）<a class="reference external" href="http://r.jazug.jp/goazure-sessions.html">Persistence on Azure - Microsoft Azure における永続化</a>お待ちしてます。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Batch ]]></category>
             <pubDate>Tue, 02 Dec 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/08/01/cdp_azure.html</link>
            <guid>http://kyrt.in/2014/08/01/cdp_azure.html</guid>
            <title><![CDATA[クラウドデザインパターン の監訳に参加しました]]></title>
            <description><![CDATA[<h1>クラウドデザインパターン の監訳に参加しました</h1>
<p>「クラウドデザインパターン　Azureを例としたクラウドアプリケーション設計の手引き」という本が 日経BP から出ました。</p>
<p>Microsoft patterns &amp; practices チームの人達が書いた、「Cloud Design Patterns: Prescriptive Architecture Guidance for Cloud Applications」<a class="reference external" href="http://msdn.microsoft.com/en-us/library/dn568099.aspx">http://msdn.microsoft.com/en-us/library/dn568099.aspx</a>の翻訳本です。JAZUG繋がりで話があって、監訳に参加させていただきました。</p>
<p>ここのところ、日本語のデザインパターン本出ていませんでしたが、重要な課題が拾われていてお勧めな内容です。</p>
<p>とても気に入ったので機会を設けて、この本をネタにして7月に2回ほど話をさせてもらいました。最初は、ネタを被らせるていけば、大丈夫かな？と思っていたのですが、書いてみたらかぶりが殆ど無くさらに26,30日の日程にしたので、ちょっと辛かったです。</p>
<img alt="&#x30AF;&#x30E9;&#x30A6;&#x30C9;&#x30C7;&#x30B6;&#x30A4;&#x30F3;&#x30D1;&#x30BF;&#x30FC;&#x30F3;&#x3000;Azure&#x3092;&#x4F8B;&#x3068;&#x3057;&#x305F;&#x30AF;&#x30E9;&#x30A6;&#x30C9;&#x30A2;&#x30D7;&#x30EA;&#x30B1;&#x30FC;&#x30B7;&#x30E7;&#x30F3;&#x8A2D;&#x8A08;&#x306E;&#x624B;&#x5F15;&#x304D;" class="align-center" src="http://kyrt.in/_images/cdpazure001.png"/>
<p><a class="reference external" href="http://ec.nikkeibp.co.jp/item/books/P98330.html">http://ec.nikkeibp.co.jp/item/books/P98330.html</a></p>
<div class="section" id="the-return-of-f-7-26-27">
<h2>クラウド温泉4.0＠小樽 - The Return of F# 7/26-27</h2>
<p>内容は全く知らず、なんとなくクラウドって付いているから良いかなと思って行ってみたら、ケンブリッジと名古屋から怖い人達が集まるガチなヤツでした。非常に濃いF#成分のなか、現時点でPublic Cloud で、Data Management をどう扱うのか、制約と設計について話をしました。話切れないところもあったので、どこかででまた話したいと思っています。この集まりは、とても楽しくて中途半端だった、 functional programing の理解に風穴を開けてくれました。</p>
<p>その時のセッション資料です</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/37515750?rel=0" width="597" height="486" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/data-management-37515750">クラウドデザイン パターンに見る クラウドファーストな アプリケーション設計 Data Management編</a></p>
<p><a class="reference external" href="http://connpass.com/event/7177/">クラウド温泉4.0＠小樽 - The Return of F#</a></p>
</div>
<div class="section" id="jazug-7-30">
<h2>JAZUG クラウドデザインパターン勉強会 7/30</h2>
<p>この本は、コードフラグメントではなくて10個の完全に動作するサンプルコードが付属しています。このセッションでは、サンプルコードを読んで興味を引いたところを紹介するという流れにしました。JAZUGで話をするときはいつも、「他ではあまり聞けないような内容で、楽しんでいただこう」と思って題材を選ぶんのですが、あまり「わかりやすかった、良かった」という話を聞くことがありません。もしかすると、題材の選択に問題があるのかもしれないと思い。サンプルコード内の、「Exceptionのハンドリングどうする？」とか、「そのプロパティを設定するとどうなるの？」とかを流しながらパターンを見ていくというストーリにしました。これなら、いつもコーディングしている人なら、あるあるネタになって楽しめるんじゃないかといのが狙いです。これなら万人受けするはずと思ったのですが、セッション終わったら「濃かったですね」と言われ、残念ながら目的達成は道半ばだったようです。orz</p>
<p>その時のセッション資料です</p>
<iframe src="//www.slideshare.net/slideshow/embed_code/37486479?rel=0" width="597" height="486" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/20140830">JAZUG クラウドデザインパターンのコードを覗く</a></p>
</div>
<div class="section" id="id2">
<h2>最後に</h2>
<p>本の中で問題提起されている事柄をどのように扱うのか、それぞれの課題は古くからあるものですが、今回再度クローズアップされているのは何故なのかあたりも面白いと思います。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ CDP ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Fri, 01 Aug 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/07/02/mvp_2014_7.html</link>
            <guid>http://kyrt.in/2014/07/02/mvp_2014_7.html</guid>
            <title><![CDATA[2014 Microsoft MVP Award を受賞しました]]></title>
            <description><![CDATA[<h1>2014 Microsoft MVP Award を受賞しました</h1>
<p>2014年7月期、Microsoft Azure のカテゴリで、Microsoft MVP Award を受賞しました。</p>
<p>これも一重に皆様から多くの御支援をいただいた結果です。</p>
<p>今後も、Azure Storage を中心に、Cloud Scale なサービス構築をテーマに情報発信をして行きたいと思います。</p>
<p>これからも、よろしくお願いいたします。</p>
]]></description>
            <category><![CDATA[ MVP ]]></category>
             <pubDate>Wed, 02 Jul 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/06/09/websites_gradle_git.html</link>
            <guid>http://kyrt.in/2014/06/09/websites_gradle_git.html</guid>
            <title><![CDATA[WebSites で、Java + gradle + git を使う]]></title>
            <description><![CDATA[<h1>WebSites で、Java + gradle + git を使う</h1>
<p>5/12 - 15 に行われた、TechEd North America 2014 で、待望のWebSitesのJavaサポートが発表されました。TechEdでは、AzureのJavaサポートとして、仮想マシン、クラウドサービス、WebSites の話がされていました。Azureの各種SDKはJavaは.NETと並ぶぐらい順調に進んでいるようなので今後も注目です。</p>
<p>その中でも、WebSitesのJavaサポートが面白かったので紹介します。</p>
<p>TechEdのセッションの内容は、<a class="reference external" href="http://channel9.msdn.com/Events/TechEd/NorthAmerica/2014/DEV-B384">Java on Microsoft Azure</a>を観てもらうことにして、一般的な開発で行われるプロセスを Java on WebSites でやってみます。</p>
<div class="section" id="id1">
<h2>道具立て</h2>
<p>ソースコード管理には、git を使い。ビルドには昨今流行りの gradle 、 手元で動作を確認後、git push すると、kudu の deploy hook でbuildされて Web Sites に deploy というシナリオです。deploy の最終段には、tomcat の autoDeploy を使います。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/14109420833"><img alt="unagi by Takekazu Omi, on Flickr" class="align-center" src="http://farm3.staticflickr.com/2897/14109420833_a4fb730458_c.jpg"/></a>
</div>
<div class="section" id="web-sites">
<h2>Web Sitesを作成</h2>
<p>まず、azure cli を使うので、インストールしてください。</p>
<p>git repository 付きでWebSitesを作成します。（以下kinmugi006でやっていますが、同じ名前では作れないので適当に変更してください）</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ mkdir kinmugi006
$ <span class="nb">cd</span> kinmugi006
$ azure site create --location <span class="s2">"Japan West"</span> --git --gitusername kinmugi-king  kinmugi006
info:    Executing <span class="nb">command</span> site create
+ Getting sites
+ Getting locations
info:    Creating a new web site at kinmugi006.azurewebsites.net
-info:    Created website at kinmugi006.azurewebsites.net
+
info:    Executing <span class="sb">`</span>git init<span class="sb">`</span>
info:    Initializing remote Azure repository
+ Updating site information
info:    Remote azure repository initialized
+ Getting site information
info:    Executing <span class="sb">`</span>git remote add azure https://kinmugi.king@kinmugi006.scm.azurewebsites.net/kinmugi006.git<span class="sb">`</span>
info:    A new remote, <span class="s1">'azure'</span>, has been added to your <span class="nb">local</span> git repository
info:    Use git locally to make changes to your site, commit, and <span class="k">then</span> use <span class="s1">'git push azure master'</span> to deploy to Azure
info:    site create <span class="nb">command</span> OK
</pre></div>
</div>
<p>これで、Web Sitesが作成されて、Web Sites内に git repository が用意されます。この状態では、ローカルレポジトリは下記のような設定になっています。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ git remote -v
azure   https://kinmugi-king@kinmugi006.scm.azurewebsites.net/kinmugi006.git <span class="o">(</span>fetch<span class="o">)</span>
azure   https://kinmugi-king@kinmugi006.scm.azurewebsites.net/kinmugi006.git <span class="o">(</span>push<span class="o">)</span>
origin
</pre></div>
</div>
<p>この状態で、作成したサイトを見るには、下記のコマンドを実行します。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ azure site browse kinmugi006
</pre></div>
</div>
<p>もし、<span class="docutils literal"><span class="pre">Site</span> <span class="pre">kinmugi006</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">exist</span> <span class="pre">or</span> <span class="pre">has</span> <span class="pre">no</span> <span class="pre">hostname</span></span>のようなエラーになったら、まだ作成が完了していないと可能性があるので、少しまって再度実行してください。ほとんどの場合は、数分掛からずに作成は完了します。</p>
<p>このような画面が表示されるはずです。</p>
<img alt="Web Site の初期画面" class="align-center" src="http://kyrt.in/_images/20140609_azure002.PNG"/>
</div>
<div class="section" id="push">
<h2>試しに、なにか push してみましょう</h2>
<p>まず、ポータルサイトから git のパスワードを設定します。<span class="docutils literal"><span class="pre">DASHBOARD</span></span>-&gt;<span class="docutils literal"><span class="pre">Reset</span> <span class="pre">your</span> <span class="pre">deployment</span> <span class="pre">credentials</span></span>で設定できます。</p>
<img alt="local git のパスワード設定" class="align-center" src="http://kyrt.in/_images/20140609_azure001.PNG"/>
<p>index.html という名前で、Hello Java が書かれたHTMLファイルを作成します。git add、commitして、pushします。その時に、パスワードを聞かれるので、先ほどの設定したものを入れて下さい。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ git push azure master
Password <span class="k">for</span> <span class="s1">'https://kinmugi-king@kinmugi006.scm.azurewebsites.net'</span>:
Counting objects: <span class="m">3</span>, <span class="k">done</span>.
Writing objects: <span class="m">100</span>% <span class="o">(</span><span class="m">3</span>/3<span class="o">)</span>, <span class="m">230</span> bytes <span class="p">|</span> <span class="m">0</span> bytes/s, <span class="k">done</span>.
Total <span class="m">3</span> <span class="o">(</span>delta <span class="m">0</span><span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta <span class="m">0</span><span class="o">)</span>
remote: Updating branch <span class="s1">'master'</span>.
remote: Updating submodules.
remote: Preparing deployment <span class="k">for</span> commit id <span class="s1">'f522084597'</span>.
remote: Generating deployment script.
remote: Generating deployment script <span class="k">for</span> Web Site
remote: Generated deployment script files
remote: Running deployment command...
remote: Handling Basic Web Site deployment.
remote: KuduSync.NET from: <span class="s1">'D:\home\site\repository'</span> to: <span class="s1">'D:\home\site\wwwroot'</span>
remote: Deleting file: <span class="s1">'hostingstart.html'</span>
remote: Copying file: <span class="s1">'index.html'</span>
remote: Finished successfully.
remote: Deployment successful.
To https://kinmugi-king@kinmugi006.scm.azurewebsites.net/kinmugi006.git
 * <span class="o">[</span>new branch<span class="o">]</span>      master -&gt; master
</pre></div>
</div>
<p>これで、サイトを確認すると、こんな感じで見えます。 ちなみに、<span class="docutils literal"><span class="pre">azure</span> <span class="pre">site</span> <span class="pre">browse</span> <span class="pre">kinmugi006</span></span>でブラウザが開きます。</p>
<img alt="Hello Java" class="align-center" src="http://kyrt.in/_images/20140609_azure003.PNG"/>
</div>
<div class="section" id="java">
<h2>Java ランタイムの設定</h2>
<p>これで、git の設定ができたので、次のJava Runtimeの設定をします。ここでもgitのパスワード設定と同じようにポータルを使います。Web Sitesの CONFIGURE のメニューから、JAVA VERSION をOFFから、1.7.0_51(バージョン番号は随時変わります）にして、WEB CONTAINER をTOMCAT 7.0.50 にして、SAVEを押します。</p>
<img alt="Select Java runtime" class="align-center" src="http://kyrt.in/_images/20140609_azure004.PNG"/>
<p>ここで、<a class="reference external" href="http://kinmugi006.azurewebsites.net/">http://kinmugi006.azurewebsites.net/</a>を見ると、さきほどの<span class="docutils literal"><span class="pre">Hello</span> <span class="pre">Java</span></span>から下記のような画面になります。</p>
<img alt="Hello Java" class="align-center" src="http://kyrt.in/_images/20140609_azure003.PNG"/>
<p>さっき上げた、index.html では無くて、Web Sitesがデフォルトで用意しているJava Web Application が表示されています。なにが起きているのかを簡単に Kudu の画面から確認してみましょう。</p>
<p><a class="reference external" href="https://kinmugi006.scm.azurewebsites.net/">https://kinmugi006.scm.azurewebsites.net/</a>にアクセスします。ポータルとシングルサインオンになっているので、既にログインしている場合は、そのままアクセスすることができます。</p>
<p>Debug Console を選んで、d:/home/site/wwwroot に行きます。すると、index.htmlと、webapps が見えます。先ほどpushしたファイルが、index.htmlで、java runtime を有効にしたときに作成されたのが、webappsです。Web Sitesで動いている tomcat のserver.xmlでは下記のように定義されています。appBase が、ここに指定されているのが確認できます。autoDeploy=”true” になっているので、appBaseにwarファイルを置くと自動展開されます。Java Runtimeを有効にする前は、IISがwwwrootをdocumet rootにして動いおりindex.htmlが見えていましたが、tomcat がhttp requestをハンドリングするようになったので、webapps/ROOTが見えるようになりました。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">"localhost"</span>  <span class="na">appBase=</span><span class="s">"d:\home\site\wwwroot\webapps"</span> <span class="na">xmlBase=</span><span class="s">"d:\home\site\wwwroot\"</span>
      <span class="na">unpackWARs=</span><span class="s">"true"</span> <span class="na">autoDeploy=</span><span class="s">"true"</span> <span class="na">workDir=</span><span class="s">"${site.tempdir}"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">"org.apache.catalina.valves.AccessLogValve"</span> <span class="na">directory=</span><span class="s">"${site.logdir}"</span>
         <span class="na">prefix=</span><span class="s">"site_access_log."</span> <span class="na">suffix=</span><span class="s">".txt"</span>
         <span class="na">pattern=</span><span class="s">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/Host&gt;</span>
</pre></div>
</div>
<p>今回下記の設定をしてください。何故か、user.home が定義されていないので d:home にします。<a class="reference external" href="http://bugs.java.com/view_bug.do?bug_id=4787931">JDK-4787931 : System property “user.home” does not correspond to “USERPROFILE” (win)</a>Azureでは、IPV6をサポートしていない（今のところ）ので、IPv4 Stackのみにします。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ azure site  appsetting add <span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">"-Duser.home=d:\home -Djava.net.preferIPv4Stack=true"</span> kinmugi006
</pre></div>
</div>
<p>※想定外に話が長くなってきたので、飛ばして行きます。</p>
</div>
<div class="section" id="git-push">
<h2>git push後の自動ビルド</h2>
<p>標準の構成では、Web Sitesの git deploy を使うと、git の sever side hook のpost-receive<a class="footnote-reference" href="#r1" id="id2">[1]</a><a class="footnote-reference" href="#r7" id="id3">[7]</a>で、kudu.exe<a class="footnote-reference" href="#r2" id="id4">[2]</a>を起動します。kudu.exeは、repository をupdateし、規定のdeploy scriptを呼び出します。ASP.NETのようなコンパイルが必要なアプリケーションは良しなにやり、phpなどのように、そのまま展開すれば良いものはkudusyncで同期させます。<a class="footnote-reference" href="#r3" id="id5">[3]</a>今のところ、java用のビルド、展開スクリプトは用意されていないので、自前で作成します。</p>
<p>まずは、Javaのアプリの準備をします。</p>
<p>ビルドにgradleを使うので、<a class="reference external" href="http://www.gradle.org/">gradle公式</a>から、<a class="reference external" href="https://services.gradle.org/distributions/gradle-1.12-bin.zip">gradle-1.12-bin.zip</a>をダウンロードして展開します。バージョン番号が入ると面倒なので、ディレクトリ名は変更してます。srcの下のアプリケーションは、<span class="docutils literal"><span class="pre">gradle-1.12-(src|all).zip</span></span>に入っている、<a class="reference external" href="https://github.com/gradle/gradle/tree/REL_1.12/subprojects/docs/src/samples/webApplication/quickstart">webApplication/quickstart</a>です。</p>
<p>ディレクトリ構成</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>├─gradle
│  ├─bin
│  ├─init.d
│  ├─lib
│  │  └─plugins
│  └─media
└─src
    └─main
        ├─java
        │  └─org
        │      └─gradle
        │          └─sample
        ├─resources
        └─webapp
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">.deployemnt</span></span>という下記のような内容のファイルを作成します。このファイルがあると、kudu.exe は、git update の後に、規定のスクリプトを実行せずに、<span class="docutils literal"><span class="pre">.deployemnt</span></span>ファイルの設定に従います。今回は、作成したバッチを実行するだけです。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/><span class="o">[</span>config<span class="o">]</span>
<span class="nb">command</span> <span class="o">=</span> deploy.cmd
</pre></div>
</div>
<p><span class="docutils literal"><span class="pre">deploy.cmd</span></span>では、gradleを実行して、出来上がったwarファルをappBaseにコピーします。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>@if <span class="s2">"%SCM_TRACE_LEVEL%"</span> NEQ <span class="s2">"4"</span> @echo off

SET <span class="nv">GRADLE_HOME</span><span class="o">=</span>%~dp0%<span class="se">\g</span>radle
SET <span class="nv">GRADLE_HOME_CMD</span><span class="o">=</span>%GRADLE_HOME%<span class="se">\b</span>in<span class="se">\g</span>radle.bat

:: Setup
:: -----

setlocal enabledelayedexpansion

IF NOT DEFINED DEPLOYMENT_SOURCE <span class="o">(</span>
  SET <span class="nv">DEPLOYMENT_SOURCE</span><span class="o">=</span>%~dp0%.
<span class="o">)</span>

IF NOT DEFINED DEPLOYMENT_TARGET <span class="o">(</span>
  SET <span class="nv">DEPLOYMENT_TARGET</span><span class="o">=</span>%~dp0%<span class="se">\.</span>.<span class="se">\w</span>wwroot
<span class="o">)</span>

IF EXIST <span class="s2">"%GRADLE_HOME_CMD%"</span> <span class="o">(</span>
  call :ExecuteCmd <span class="s2">"%GRADLE_HOME_CMD%"</span> clean war
  IF !ERRORLEVEL! NEQ <span class="m">0</span> goto error
<span class="o">)</span>


:: copy war file to wwwroot

IF NOT EXIST <span class="s2">"%DEPLOYMENT_TARGET%"</span><span class="se">\w</span>ebapps <span class="o">(</span>
   mkdir <span class="s2">"%DEPLOYMENT_TARGET%"</span><span class="se">\w</span>ebapps &gt; NUL <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="o">)</span>

COPY /Y <span class="s2">"%DEPLOYMENT_SOURCE%"</span><span class="se">\b</span>uild<span class="se">\l</span>ibs<span class="se">\k</span>inmugi.war <span class="s2">"%DEPLOYMENT_TARGET%"</span><span class="se">\w</span>ebapps<span class="se">\R</span>OOT.war
IF !ERRORLEVEL! NEQ <span class="m">0</span> goto error

goto end

:: Execute <span class="nb">command</span> routine that will <span class="nb">echo</span> out when error
:ExecuteCmd
setlocal
<span class="nb">set</span> <span class="nv">_CMD_</span><span class="o">=</span>%*
call %_CMD_%
<span class="k">if</span> <span class="s2">"%ERRORLEVEL%"</span> NEQ <span class="s2">"0"</span> <span class="nb">echo</span> Failed <span class="nv">exitCode</span><span class="o">=</span>%ERRORLEVEL%, <span class="nv">command</span><span class="o">=</span>%_CMD_%
<span class="nb">exit</span> /b %ERRORLEVEL%

:error
endlocal
<span class="nb">echo</span> An error has occurred during web site deployment.
call :exitSetErrorLevel
call :exitFromFunction <span class="m">2</span>&gt;nul

:exitSetErrorLevel
<span class="nb">exit</span> /b <span class="m">1</span>

:exitFromFunction
<span class="o">()</span>

:end
endlocal
<span class="nb">echo</span> Finished successfully.
</pre></div>
</div>
<p>ここまでできたら、git add, commit して、pushしてください。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ git push azure master
Counting objects: <span class="m">189</span>, <span class="k">done</span>.
Delta compression using up to <span class="m">4</span> threads.
Compressing objects: <span class="m">100</span>% <span class="o">(</span><span class="m">178</span>/178<span class="o">)</span>, <span class="k">done</span>.
Writing objects: <span class="m">100</span>% <span class="o">(</span><span class="m">188</span>/188<span class="o">)</span>, <span class="m">40</span>.11 MiB <span class="p">|</span> <span class="m">973</span>.00 KiB/s, <span class="k">done</span>.
Total <span class="m">188</span> <span class="o">(</span>delta <span class="m">3</span><span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta <span class="m">0</span><span class="o">)</span>
remote: Updating branch <span class="s1">'master'</span>.
remote: Updating submodules.
remote: Preparing deployment <span class="k">for</span> commit id <span class="s1">'c190ab30ef'</span>.
remote: Running custom deployment command...
remote: Running deployment command...
remote: ..................
remote:         <span class="m">1</span> file<span class="o">(</span>s<span class="o">)</span> copied.
remote: Finished successfully.
remote: Deployment successful.
To https://kinmugi-king@kinmugi006.scm.azurewebsites.net/kinmugi006.git
   f522084..c190ab3  master -&gt; master
</pre></div>
</div>
<p>ただ一つだけ問題があります。最初に、WebSitesの作成したwebappsには、ROOTのディレクトリがあるのにROOT.warが無いので autoDeploy が上手く動作しません。どこかを修正してpushし直すか、ポータルから redeploy してください。問題があるのは初回だけで２回めからは前回upしたROOT.warがあるので無事自動展開されます。</p>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>kuduの仕組みが良く出来ていて<a class="footnote-reference" href="#r4" id="id7">[4]</a><a class="footnote-reference" href="#r5" id="id8">[5]</a><a class="footnote-reference" href="#r6" id="id9">[6]</a>特別なjava対応などが無くても、今回 WebSitesに入った httpPlatformHandler だけで、git pushしたらbuildしてdeployということが簡単に実現できました<a class="footnote-reference" href="#r8" id="id10">[8]</a>。ただ、<a class="reference external" href="https://github.com/projectkudu/kudu">kudu project</a>にある、kuduのソースはちょっと流し読みをして理解するには量が多く、動かしなら少しづつ確認するという形じゃないとなかなか動きを掴むのは難しところがあります。</p>
</div>
<div class="section" id="id11">
<h2>下記のサイトを参考にしました</h2>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://git-scm.com/book/ja/Git-%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA-Git-%E3%83%95%E3%83%83%E3%82%AF">Git のカスタマイズ - Git フック</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><a class="reference external" href="https://github.com/projectkudu/kudu/blob/master/Kudu.Console/Program.cs">kudu.exeは、Kudu.Console</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td><a class="reference external" href="https://github.com/projectkudu/kudu/wiki/Investigating-issues">SCM_TRACE_LEVEL = 4 にするとdeploy scriptのtraceが出る</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td><a class="reference external" href="https://github.com/projectkudu/kudu/blob/master/Kudu.Core/Deployment/WellKnownEnvironmentVariables.cs">Well Known Environment Variables</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r5" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[5]</a></td><td><a class="reference external" href="https://github.com/projectkudu/KuduSync.NET/blob/master/KuduSync.NET/KuduSyncOptions.cs">KuduSync のオプション</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r6" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[6]</a></td><td><a class="reference external" href="https://github.com/projectkudu/kudu/wiki/Deployment-Logic-Flow">Deployment Logic Flow</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r7" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[7]</a></td><td><a class="reference external" href="https://github.com/projectkudu/kudu/wiki/Deployment-hooks">Deployment hooks</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r8" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[8]</a></td><td><a class="reference external" href="http://blog.amitapple.com/post/38417491924/azurewebsitecustomdeploymentpart1/">Custom Deployment Scripts For Windows Azure Website Using Git Deployment</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Java ]]></category>
            <category><![CDATA[ WebSites ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Mon, 09 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/06/08/snowflake_c.html</link>
            <guid>http://kyrt.in/2014/06/08/snowflake_c.html</guid>
            <title><![CDATA[スケーラブルな採番とsnowflake]]></title>
            <description><![CDATA[<h1>スケーラブルな採番とsnowflake</h1>
<p>snowflake は、Twitter 社が作成した、ユニークなID生成のネットワークサービスです。いくつかの簡単な保証で高いスケーラビリティを実現しています。Twitter 社が、MySQLから Cassandra に移行するにあたって、Cassandra にシーケンシャルな id 生成の仕組みが無かったことから作成したそうです。 snowflake については<a class="reference external" href="https://dev.twitter.com/docs/twitter-ids-json-and-snowflake">Twitter IDs, JSON and Snowflake</a>に書いてあります。</p>
<p>snowflake のコードは、Apache License, Version 2.0 で<a class="reference external" href="https://github.com/twitter/snowflake/">Snowflake</a>に公開されています。</p>
<div class="section" id="id2">
<h2>スケーラブルな採番、背景的な話</h2>
<p>Cloudでスケーラビリティのあるサービスを見据えてコードを書いていると採番に関する問題が必ず出てきます。従来、RDBの自動採番などに頼っていたのがコスト、スケーラビリティ、耐障害性の観点から問題となり、別の方法を考える必要が出てくるというのが一般的です。</p>
<p>「ID＝連番」という話なら始まると話が混乱するので、基本に返って採番の要件を整理するところから初めましょう。ざっと考えたところ4つほどの条件が出てきたので、この線で話を進めます。</p>
<ol class="arabic simple">
<li>ユニークである：重複が無い。これはIDをキーにしたいので当然ですね</li>
<li>時系列で増えていく（または減っていく）：IDが生成される度に増加していくのは連番での重要な性質の一つです</li>
<li>秒間の発行数：採番を一箇所で行わずに分散してスケールするのがスケールする</li>
<li>連続性（連続した欠落の無い番号の生成）</li>
</ol>
<p>最後の連続性に関しては、スケーラビリティとパフォーマンスを両立させての実現は難しいでしょう。スケールと対象外性を考えて分散環境でID生成の度にどうしてもNode間でメッセージのやりとりをせざるを得ず、パフォーマンスを犠牲にせざる得ないので、今回は外して考えます。オンプレでも限定された条件下でのみ可能な採番ですね。</p>
<p>これとは別に何処で採番するかという観点もあります。これは２つのパターンがあります。</p>
<ol class="arabic simple">
<li>Cluster Service  で採番</li>
<li>クライアントで採番</li>
</ol>
<p>Cluster Service で採番するパターンとしては、memcached/Redis などの カウンター (incr command) を使ったり、storage を使った分散counterを使ったパターンが知られています。Snowfrakeもこの１種です。クライアントでの採番は、通信を伴わないので一番速い（コストが小さい）ですが制約もあります。</p>
</div>
<div class="section" id="id3">
<h2>採番のユニーク性</h2>
<p>採番と考えると最低限の要求は 「一意であること UNIQUENESS」でしょう。これには、発番した時にユニーク性を担保するか、永続化したときにユニーク性を担保するかの２つの選択肢があります。採番した時に一意性を担保するパターンとしては、<a class="reference external" href="http://ja.wikipedia.org/wiki/GUID">GUID</a>を使う方法よく知られています。ここでは、Guidを使う方法については深くふれません、<a class="reference external" href="http://blogs.msdn.com/b/oldnewthing/archive/2008/06/27/8659071.aspx">GUIDs are globally unique, but substrings of GUIDs aren’t</a>で面白い話が書いてあるんのでぜひ読んでみてください。（中には Snowflakeへのヒントになることも記述されています）</p>
<p>GUIDは非常に手軽で便利ですが、128bit(longlong)でかなり長い。時系列で並ばないなどの問題があります。</p>
</div>
<div class="section" id="id4">
<h2>永続化レイヤーでの一意性の担保</h2>
<p>一方永続化したときにユニーク性を担保するという考えもあります。一意なIDを振出すのはコストが高いので、擬似的な（一意性を十分期待できる）IDを振り出して永続化して可否を判断して、ダメならもう一度やってみるというのが「永続化レイヤーでの一意性の担保」の基本的な考え方です。</p>
<p>これは、永続化レイヤーが用意した限定された条件の下でユニーク制約を実装を利用することでユニーク性を担保するというアーキテクチャです。この場合は、「永続化レイヤーの制約」、「重複時の再試行」の２点を考慮しなければいけません。</p>
<p>例えば、Azure Tableでは、同一パーテーション内のRow Keyは一意であることが保証されています。他のパーテーションでは同一のRowkeyを持つことができますが、同一パーテーション内同じRawkeyは Insert できません。</p>
<p>この場合、Partition Key + Row Key でユニークになるので、ランダムなキーを生成して、TableにInsertできればそのパーテーション内ではユニークだと保証されるわけです。RDBのUniq制約でも同様です。Shareding されたデータベースでは、Inserできれば Shard内でユニークだという事になります。いずれも、Partition 内、 Shard 内という条件が付いていることに気を付けてください。永続化レイヤーによって異なった制約となりますが、分散システムではなんからの制約を伴うことが一般的です。</p>
</div>
<div class="section" id="id5">
<h2>重複時の再試行</h2>
<p>永続化レイヤーでUNIQ性を保証をする場合、「重複時の再試行」を前提としてください。クライアントがデータを永続化するまで、IDが有効かどうかわからないので、永続化した時に重複だった場合は再度IDを生成し直して処理を再試行する必要があります。</p>
</div>
<div class="section" id="id6">
<h2>時系列で増減</h2>
<p>IDがランダムではなく、時間と共に増加あるいは減少して欲しいことがあります。このようにIDが並んでいると、永続化レイヤーがレンジクエリーをサポートしていれば、前方一致で効率的に目的のデータを取得することができます。しかし時系列で増加するIDを発番しようとしてNodeのクロックを使うと信頼性が問題になります。</p>
<p>通常、複数Nodeで発番した場合は同一時刻で複数のコードが動くのでIDが重複します。それ以外にもNode内でも問題があります。Nodeのクロックは、外部のtime service に同期させているので、ローカルの時刻は随時進んだり戻ったりします。そのため、時刻だけを元に単純に採番するとIDが重複します。これらの時刻の不安定性に起因する問題を Clock Skew （クロックスキュー）問題と言います。</p>
<p>分散システムの問題の多くは、時刻の同期問題でもあり根が深いので、ここはスルーで先に行きます。</p>
<p>これらの問題を回避するために、IDの一部にランダムな要素を付与する方法が一般的に使われています。</p>
<p>例えば、下記のような感じ</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Hoge</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"{0:D19}_{1:D4}"</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Ticks</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">10000</span><span class="p">));</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ここで発番しているのは擬似的なUNIQ性を持ったIDでです。最終的なUNIQ性の保証は別のレイヤーに預ける前提です。ランダム桁数は、衝突の頻度と衝突時の再試行のコストを鑑みて決定します。この例だと、4桁取っていますが、昨今のCPUだとシングルCoreで同一Tick内で2-3程度は発番できるようなので、100coreぐらいあれば、2*100/10000 = 1/50 となって、結構な頻度で衝突します。（この数字は結構いい加減なので参考程度で）</p>
<p>順番を逆にしたい場合は、下記のようにします。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Hoge</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"{0:D19}_{1:D3}"</span><span class="p">,</span> <span class="kt">long</span><span class="p">.</span><span class="n">MaxValue</span> <span class="p">-</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Ticks</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">1000</span><span class="p">));</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>こうすると、最新のものが最初にきます。先頭から指定行を取得するようなクエリーをサポートしている永続化レイヤーで最新の情報を取得する場合にはこの並びが便利に使えます。</p>
</div>
<div class="section" id="id7">
<h2>秒間の発行数</h2>
<p>秒間どれぐらいの数のIDを生成可能なのかも重要なファクターです。一般的にオンメモリで計算のみで発番するものが一番速く、永続化付きKVS、RDBMSの順の速度になります。</p>
<p>ID生成はクラスターで行って、分散することでスケールするというのは基本的な考え方で、その場合ID生成クラスターのNodeコストが問題となります。一般的にメモリーで計算のみで発番するものはIDのユニーク性と耐障害性の両立が難しく、なんからの永続化をすることで問題を回避するという方法が取られる場合が多いようです。RDBはID生成を目的としてクラスター化するにはコスト高いのが問題となると思います。</p>
<p>クライアントで擬似的なUNIQ IDを生成して、永続化時に担保させるという方法はリーズナブルにスケールする方法だと言えます。</p>
</div>
<div class="section" id="id8">
<h2>Snowflake</h2>
<p>Clock Skew に上手く対応することで、オンメモリの計算と最低限のノード間通信でUNIQなIDを生成する仕組みです。永続化レイヤーの支援無しにUNIQなIDが生成できる、オンメモリなので速い（10k ids per second per process<a class="reference external" href="https://github.com/twitter/snowflake/">Snowflake</a>）というのが特徴です。</p>
<p>ある意味GUIDと似ているのですが、64bit(long) で実現しているところ、おおよそ時系列で増えていく「(Roughly) Time Ordered」なことが異なっています。</p>
</div>
<div class="section" id="id10">
<h2>データ構造</h2>
<p>snowfake では、64bitを下記のように分割して使います。timeが時間由来の数字でミリ秒単位です。machine id は、datacenter id と、worker idで構成されていて、Cluster内のNode固有の値になります。sequence number は、同一時間（timeが同じ）間にカウントアップされていく連番です。</p>
<table border="1" class="docutils">
<colgroup>
<col width="1%"/>
<col width="16%"/>
<col width="29%"/>
<col width="23%"/>
<col width="30%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="5">64 bits</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="2">0</td>
<td rowspan="2"><dl class="first last docutils">
<dt>time</dt>
<dd>41 bit</dd>
</dl>
</td>
<td colspan="2">machine id 10bit</td>
<td rowspan="2"><dl class="first last docutils">
<dt>sequence number</dt>
<dd>12bit</dd>
</dl>
</td>
</tr>
<tr class="row-odd"><td>datacenter id 5bit</td>
<td>worker id 5bit</td>
</tr>
</tbody>
</table>
<p>前記の時間ベースのID生成と比較すると、IDにNode固有の番号（machine id）が含まれている、同一時間内の採番では乱数ではなくカウンターを使って重複を避けていることが異なっているのがわかります。</p>
<p>実は、この構成は GUID V1と似ています。GUID V1 は、 timestamp 60 bits、computer identifier (MAC Address) 48 bits、uniquifier (乱数＋シーケンス）14 bits、fixed （）バージョン等） 6 bits から構成されています。全体的にGUIDの方がBitの使い方がリッチで余裕がある構成です。データは、DWORD-WORD-WORD-WORD-BYTE[8] として扱われます。Endian の問題もあってtimestamp由来なのに時系列で並びません。timestampは、100 ns 単位です。</p>
<p>snowflake は、GUIDを64 bits (正確には最上位が0固定のなので63 bits）に押し込んでUNIQ性を確保しています。</p>
<p>ではどうやって64bitに押し込んでいるのでしょう。</p>
<ol class="arabic simple">
<li>範囲の制限: 簡単に言うと、GUIDは グローバルにUNIQだけど、snowflakeは発番体系内でUNIQです。別のサービスで使っている snowflake clusterと比較するとUNIQ性は保証されません。ここは大きな違いですが、別サービスとIDが被るのは問題無いので、実用上は制限にはなりません。これで、MAC Address 48 bits の所を10 bits に押し込めています。</li>
<li>timestampの精度と範囲: GUIDは、100 ns 、snowflakeは、1 ms です。timestamp の精度を下げ、開始時間（0の時の日時、何時からの時間なのか）をサービス開始時などに合わせることで、timerのラップアラウンドの問題を軽減しています。(2^41)*(10^-3)/60/60/24/365 で約69年持ちます。ちなみにGUIDは、(2^60)*(10^-7)/60/60/24/365 で3655年以上持ちます。開始は、1582/10/15 0:00 です（3千年以上もつの開始はあまり重要じゃないですね）69年保てば問題無い気がしますね。これで、41 bitsにしています</li>
</ol>
</div>
<div class="section" id="id11">
<h2>ソースコード上での工夫</h2>
<p>なかなか興味深かったので、<a class="reference external" href="https://github.com/twitter/snowflake/blob/master/src/main/scala/com/twitter/service/snowflake/IdWorker.scala">IdWorker.scala</a>をC#で写経してみました。（scala が非常に分かりやすくて感動しました）</p>
<script src="https://gist.github.com/takekazuomi/9571376.js">&amp;amp;nbsp;</script><p>基本的な流れは、非常にシンブルです。</p>
<p>NextId()をざっと見てみましょう。</p>
<ol class="arabic simple">
<li>現在のtimestamp を取得<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L60">L60</a></li>
<li>最後に発番してからtimestampが戻っていないか確認<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L63">L63</a></li>
<li>巻き戻っていればエラーで帰る（呼び出し側が再試行する）<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L66">L66</a></li>
<li>同一timestampなら、_sequence をインクリメントして採番<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L72">L72</a></li>
<li>timestamp が進んでいれば、_sequence = 0で採番<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L82">L82</a></li>
</ol>
<p>この他は、下記のコードがポイントです。</p>
<p>timestampの開始時間を、採番開始時間にオフセットさせる<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L87">L87</a></p>
<p>同一 timestamp 内で、_sequence がオーバーフローした場合は、timestampが変わるまで待つ<a class="reference external" href="https://gist.github.com/takekazuomi/9571376#file-idworker-cs-L75">L75</a></p>
<p>この他に、Worker Idの管理には、zookeeper を使っているなど興味深いところはありますが、今回はこの辺でまとめます。</p>
</div>
<div class="section" id="id12">
<h2>最後に</h2>
<p>実は、この記事を書いている途中に、<a class="reference external" href="http://global.windowsazurebootcamp.com/">Global Microsoft Azure Bootcamp 2014</a>があり、このネタで発表してしまったので長らくお蔵入りしていました。読み直してみたら、セッションでは時間の都合で話をしなかった内容もあり、それなりに役に立つかなと思ったので公開します。肝心のsnowflake の採番が速い理由が書いてありませんが、採番node間の通信が最低限で（生きているかどうか）、重複採番の防止にしか使われていないのが、一番効いている気がします。</p>
<p>合わせて、セッション資料も御覧ください。</p>
<iframe src="http://www.slideshare.net/slideshow/embed_code/32853065" width="597" height="486" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/20140329-jazug-gwabgeenerating-unique-id-numbers-in-cloud">Generating unique id numbers in Azure</a></p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sun, 08 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/03/02/read_access_geo_redundant_storage.html</link>
            <guid>http://kyrt.in/2014/03/02/read_access_geo_redundant_storage.html</guid>
            <title><![CDATA[FiddlerCoreでRead-Access Geo Redundant Storage を検証する]]></title>
            <description><![CDATA[<h1>FiddlerCoreでRead-Access Geo Redundant Storage を検証する</h1>
<p><a class="reference external" href="http://www.windowsazure.com/ja-jp/community/calender/">Windows Azure – 技術者でつなぐ日めくりカレンダー</a>の 3/2 の記事です。先日、<a class="reference external" href="http://atnd.org/event/2014azurejpdc">Windows Azure 4周年記念 ＆ Japan DCオープンマジデシタ！JAZUG大会</a>のLTで、Azure Storageには3つの可用性設定があるという話をしました。例によって、時間内には収まらず。「続きはWebで・・・」ということで続きです orz</p>
<p>まずはLTの内容の復習から、簡単にまとめると下記のような内容です。</p>
<div class="section" id="id1">
<h2>振り返り</h2>
<blockquote>
<div><div class="line-block">
<div class="line">Azure Storageの可用性設定（冗長構成）には3種類ある。</div>
</div>
</div></blockquote>
<ol class="arabic simple">
<li>ローカル冗長ストレージ (LRS=Locally Redundant Storage)データセンター内3箇所、同期</li>
<li>地理冗長ストレージ (GRS=Geo Redundant Storage)地理的に離れた場所への複製（Local 3箇所＋リモート3箇所）、リモートは非同期、フェイルオーバー</li>
<li>読み取りアクセス地理冗長ストレージ (RA-GRS=Read Access - Geo Redundant Storage)　PREVIEW地理的に離れた場所にあるデータを読む機能</li>
</ol>
<p>読み取りアクセス地理冗長ストレージ (以下、RA-GRS）は、現状Previewなので、まずは<a class="reference external" href="https://account.windowsazure.com/PreviewFeatures">Windows Azure Preview</a>のページで申し込みをする必要がある。</p>
</div>
<div class="section" id="sdk">
<h2>SDKの対応状況</h2>
<p>RA-GRSの新機能を使うには REST version 2013-08-15 を使うStorage SDKが必要。ただし、RESTでEndpointが違うだけだから自前でもアクセスするだけならそんなに難しくない。</p>
<ol class="arabic simple">
<li>.NETだと、<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage">Storage Client Library 3.0</a>以降</li>
<li>Javaだと、<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">Windows Azure Storage SDK for Java 0.5.0</a>以降</li>
<li>その他、各自対応</li>
</ol>
<p>上記2つのSDKには、Blobs, Tables and Queues の最終同期時刻（Last Sync Time）をクエリーする機能と primary にアクセしできなかった時に secondary に自動的に retry する機能、並びにLocationMode で参照先の設定がる。リトライは、IRetryPolicyを拡張した IExtendedRetryPolicy が追加されている。これではリトライ時に参照先を切り替えするようになっている。</p>
<blockquote>
<div><div class="line-block">
<div class="line">LTの資料</div>
</div>
</div></blockquote>
<iframe src="http://www.slideshare.net/slideshow/embed_code/31655208?startSlide=2" width="597" height="486" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;"> </iframe><p><a class="reference external" href="http://www.slideshare.net/takekazuomi/20140226-ragrs-windows-azure-storage-lt">RA-GRS Windows Azure Storage LT</a></p>
<p>ここからが本題です。</p>
</div>
<div class="section" id="id2">
<h2>確認する</h2>
<p>RA-GRSで障害が起きた時の<span class="docutils literal"><span class="pre">IExtendedRetryPolicy</span></span>の動作確認をしたいのですが、そうは都合良くデータセンターの障害が起きるわけはありません。デバッガーでBreakしてネットワークを切断するとか、変数を書き換えるとかの方法もありますが、なんども繰り返すのは手間が掛かるしパターン増やすと面倒です。そんな時に、丁度いいタイミングで<a class="reference external" href="http://clr-h.jp/">CLR/H in Tokyo 第1回</a>で過酷な争奪戦に勝利し「実践Fiddler」をゲットしました。</p>
<a class="reference external image-reference" href="http://www.amazon.co.jp/%E5%AE%9F%E8%B7%B5-Fiddler-Eric-Lawrence/dp/4873116163"><img alt="実践 Fiddler Eric Lawrence　著、日本マイクロソフト株式会社 エバンジェリスト 物江 修 監訳、長尾 高弘 訳" class="align-center" src="http://www.oreilly.co.jp/books/images/picture_large978-4-87311-616-7.jpeg" style="width: 300px;"/></a>
<p>FidderCoreを使うとHTTP通信の途中に割り込んで内容を変更することが簡単に出来ます。フルスクラッチでProxy書いて「ゴニョゴニョ」すると結構手間がかかるので、今回は、FeddlerCoreを使って サクッとLocationMode.PrimaryThenSecondary を指定した時のリトライ動作を確認します。本にはいろいろ詳しく書いてあるので、興味が出た方は是非！</p>
</div>
<div class="section" id="id3">
<h2>準備</h2>
<p>下記の場所から、インストーラーを落としてきて入れます。exeが落ちてくるのでインストールすると、<cite>FiddlerCoreAPI</cite>というディレクトリーに入ります。</p>
<p><a class="reference external" href="http://www.telerik.com/fiddler/fiddlercore">http://www.telerik.com/fiddler/fiddlercore</a></p>
<img alt="../../../_images/2014-03-02-ragrs001.png" src="http://kyrt.in/_images/2014-03-02-ragrs001.png"/>
<p>インストール先の<cite>FiddlerCoreAPI\DotNet4\FiddlerCore4.dll</cite>を参照に追加します。</p>
<img alt="../../../_images/2014-03-02-ragrs002.png" src="http://kyrt.in/_images/2014-03-02-ragrs002.png"/>
<p>今回読み込みアクセスを試したいので、予めBlob にファイルを上げて起きます。</p>
<p>Blobからのダウンロードのコードは下記のような感じです。CloudBlobClient の LocationModeを設定しています。Client全体の設定はここで書き、ここのリクエストでは、BlobRequestOptionsで設定します。それ以外は普通のBlobからDownloadするコードですね。try の次の行ので読んでいる、FiddlerCoreSetup()でFiddlerCoreの設定を行っています。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">connectionString</span> <span class="p">=</span> <span class="n">CloudConfigurationManager</span><span class="p">.</span><span class="n">GetSetting</span><span class="p">(</span><span class="s">"ConnectionString"</span><span class="p">)</span> <span class="p">??</span> <span class="s">"UseDevelopmentStorage=true"</span><span class="p">;</span>
  <span class="kt">var</span> <span class="n">account</span> <span class="p">=</span> <span class="n">CloudStorageAccount</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">connectionString</span><span class="p">);</span>
  <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">account</span><span class="p">.</span><span class="n">CreateCloudBlobClient</span><span class="p">();</span>

  <span class="k">try</span>
  <span class="p">{</span>
    <span class="n">FiddlerCoreSetup</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">StorageUri</span><span class="p">.</span><span class="n">PrimaryUri</span><span class="p">.</span><span class="n">Host</span><span class="p">);</span>

    <span class="c1">// プライマリ→セカンダリで切り替え</span>
    <span class="n">client</span><span class="p">.</span><span class="n">LocationMode</span> <span class="p">=</span> <span class="n">LocationMode</span><span class="p">.</span><span class="n">PrimaryThenSecondary</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetContainerReference</span><span class="p">(</span><span class="s">"jejeje"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">blob</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetBlockBlobReference</span><span class="p">(</span><span class="s">"cray.png"</span><span class="p">);</span>
    <span class="n">blob</span><span class="p">.</span><span class="n">DownloadToFile</span><span class="p">(</span><span class="s">"cray.png"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">OpenOrCreate</span><span class="p">);</span>
    
  <span class="p">}</span>
  <span class="k">finally</span>
  <span class="p">{</span>
    <span class="n">FiddlerCoreShutdown</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>FiddlerCoreSetup() の中を見てみましょう。基本的には必要な処理をFiddlerのイベントハンドラに追加して、FidderCore プロキシを起動するだけです。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FiddlerCoreSetup</span><span class="p">(</span><span class="kt">string</span> <span class="n">blockedHostName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">FiddlerApplication</span><span class="p">.</span><span class="n">AfterSessionComplete</span> <span class="p">+=</span> <span class="n">os</span> <span class="p">=&gt;</span>
      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"AfterSessionComplete Session {0}({4}):{1} {2} {3}"</span><span class="p">,</span>
      <span class="n">os</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">responseCode</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">RequestMethod</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">fullUrl</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">oResponse</span><span class="p">.</span><span class="n">MIMEType</span><span class="p">);</span>

  <span class="n">FiddlerApplication</span><span class="p">.</span><span class="n">BeforeRequest</span> <span class="p">+=</span> <span class="n">os</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">HostnameIs</span><span class="p">(</span><span class="n">blockedHostName</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"BeforeRequest Session {0} {1} {2}"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">host</span><span class="p">);</span>
      <span class="n">os</span><span class="p">.</span><span class="n">host</span> <span class="p">=</span> <span class="n">blockedHostName</span> <span class="p">+</span> <span class="s">".jejeje"</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="n">FiddlerApplication</span><span class="p">.</span><span class="n">Startup</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">FiddlerCoreStartupFlags</span><span class="p">.</span><span class="n">ChainToUpstreamGateway</span><span class="p">);</span>

  <span class="kt">var</span> <span class="n">endpoint</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"127.0.0.1:{0}"</span><span class="p">,</span> <span class="n">FiddlerApplication</span><span class="p">.</span><span class="n">oProxy</span><span class="p">.</span><span class="n">ListenPort</span><span class="p">);</span>

  <span class="kt">var</span> <span class="n">feddlerProxy</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WebProxy</span><span class="p">(</span><span class="n">endpoint</span><span class="p">);</span>
  <span class="n">WebRequest</span><span class="p">.</span><span class="n">DefaultWebProxy</span> <span class="p">=</span> <span class="n">feddlerProxy</span><span class="p">;</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">endpoint</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FiddlerCoreShutdown</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">FiddlerApplication</span><span class="p">.</span><span class="n">Shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ちょっと細かく追いかけてみます。</p>
<p><span class="docutils literal"><span class="pre">AfterSessionComplete</span></span>はHTTP セッションが完了した後に生成されるイベントです。 このイベントハンドラにロギング代わりにコンソールへの書き出しを追加します。。今回は、ここのログを見て何処にアクセスに行っているのかを確認します。</p>
<p><span class="docutils literal"><span class="pre">BeforeRequest</span></span>はHttp リクエストのデータが揃いサーバーに接続する前に生成されるイベントです。このイベントハンドラに、Primary のホストが接続先だったときに、存在しないhostに繋ぎに行くようなハンドラを追加します。</p>
<p><span class="docutils literal"><span class="pre">FiddlerApplication.Startup()</span></span>を呼び出して、FeddlerCoreプロキシインスタンスを起動します。ポートに0を指定すると、FeddlerCore が自動的に空いているポートを探してリスニングに入ってくれます。ポートが使用中の問題が発生しないので便利なので、ポート番号を固定したいとき以外は0で良いと思います。自動で割り当てられたポート番号は FiddlerApplication.oProxy.ListenPort で確認できます。</p>
<p>今回は、このアプリケーションから出るリクエストだけ操作できればいいので、<span class="docutils literal"><span class="pre">FiddlerCoreStartupFlags</span></span>に<span class="docutils literal"><span class="pre">ChainToUpstreamGateway</span></span>を指定します。その他に、システム全体のProxyに入りたい場合は、<cite>RegisterAsSystemProxy</cite>を使います。</p>
<p>そして、<cite>WebRequest</cite>の<cite>DefaultWebProxy</cite>を、FeddlerCoreプロキシ で書き換えます。これで、Azure　Storage Client のリクエストが、Primary に向いているときは失敗するようになりました。</p>
<p>これで、実行すると下記のようになります。</p>
<div class="highlight-text"><div class="highlight"><pre><span/>127.0.0.1:19282
BeforeRequest Session 1 ragrsomi001jp.blob.core.windows.net ragrsomi001jp.blob.core.windows.net
AfterSessionComplete Session 1(text/html):502 GET http://ragrsomi001jp.blob.core.windows.net.jejeje/jejeje/cray.png?timeout=90
AfterSessionComplete Session 2(image/png):200 GET http://ragrsomi001jp-secondary.blob.core.windows.net/jejeje/cray.png?timeout=90
</pre></div>
</div>
<p>最初に、Primary にアクセスし、その後 Secondary にアクセスし直しているのがわかります。</p>
<p>Primary へのアクセスが<span class="docutils literal"><span class="pre">502</span> <span class="pre">Bad</span> <span class="pre">Gateway</span></span>なのはちょっとイマイチですが、FeddlerCoreがProxyで入るので仕方がないのかもしれません。</p>
</div>
<div class="section" id="id4">
<h2>まとめ</h2>
<p>実は、FeddlerCoreは、Azure Storage ClientのUnit Testでも使われています。<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/Test/FaultInjection/HttpMangler/HttpMangler.cs">GitHub azure-storage-net HttpMangler.cs</a>今回は非常に簡単な例を紹介しましたが、FeddlerCoreを使うとレスポンスを偽装したり変更したりなど柔軟にできて、通常エラーにならないような場合のテストケースを作ることができます。手軽に使えるのでカジュアルに使っても便利ですし、がっちりUnitTestを作るときにも役に立ちます。</p>
<p><a class="reference external" href="http://clr-h.jp/">CLR/H in Tokyo 第1回</a>はいろいろ知らないことを聴けたので面白かったですね。特に、技術者のブランディング戦略の重要性と独自の進化を遂げたプロビジョニング、構成管理ツールの話が秀逸だった。</p>
<p>最後に１つだけ、FiddlerCore をnugetで配布してくれると嬉しいなぁ・・・</p>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sun, 02 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/01/29/windows_azure_storage_emulator_2_2_1_preview_release.html</link>
            <guid>http://kyrt.in/2014/01/29/windows_azure_storage_emulator_2_2_1_preview_release.html</guid>
            <title><![CDATA[Windows Azure Storage Emulator 2.2.1 Preview]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Emulator 2.2.1 Preview</h1>
<p>Azure Storage 愛好者待望の、Azure Storage Emulator の 2013-08-15 version サポートがリリースされました。（まだ、preview ですが）</p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/01/27/windows-azure-storage-emulator-2-2-1-preview-release-with-support-for-2013-08-15-version.aspx">Windows Azure Storage Emulator 2.2.1 Preview Release with support for “2013-08-15” version</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">日本語訳 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2014/01/29/blog-windows-azure-storage-emulator-2-2-1-preview-release-with-support-for-2013-08-15-version.aspx">“2013-08-15” バージョンをサポートした Windows Azure ストレージ エミュレーター 2.2.1 のプレビューをリリース</a></div>
</div>
</div></blockquote>
<p>Windows Azure Storage Emulator 2.2.1 Preview Release の MSI package は、<a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=41670">ここ</a>からダンロードできます。</p>
<a class="reference external image-reference" href="http://flic.kr/p/f7UbCg"><img alt="insect by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3809/9267075295_acaa930254_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id2">
<h2>インストールの手順</h2>
<p>この release では、Windows Azure SDK 2.2 が予めインストールされている必要があります。これは preview release で、インストーラーは、Windows Azure Storage Emulator 2.2 のバイナリーを自動では入れ替えません。代わりに、32bit OSでは、<span class="docutils literal"><span class="pre">"%ProgramFiles%\Windows</span> <span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Emulator</span> <span class="pre">2.2.1\devstore"</span></span>に、64 bit OSでは<span class="docutils literal"><span class="pre">"%ProgramFiles(x86)%\Windows</span> <span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Emulator</span> <span class="pre">2.2.1\devstore"</span></span>にバイナリーを展開します。</p>
<p>更新されたエミュレータ(2.2.1 preview)を利用する場合は下記のステップを踏んでください。</p>
<ol class="arabic simple">
<li>Storage Emuratorの停止</li>
<li><span class="docutils literal"><span class="pre">"%ProgramFiles%\Microsoft</span> <span class="pre">SDKs\Windows</span> <span class="pre">Azure\Emulator\devstore"</span></span>にある既存のファイル(2.2)を他のディレクトリに保存</li>
<li>新たにインストールされた2.2.1 preview のファイルを<span class="docutils literal"><span class="pre">"%ProgramFiles%\Microsoft</span> <span class="pre">SDKs\Windows</span> <span class="pre">Azure\Emulator\devstore"</span></span>へ上書き</li>
</ol>
<p>以前のエミュレータ(2.2)に戻す場合は、Storage Emuratorを停止して保存したファイルを戻します。この方法で、簡単に2.2のStorage Emuratorに戻すことができ、SDK 2.2の再インストールなどは必要ありません。</p>
<p>これはちょっと手間ですが、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/01/27/windows-azure-storage-emulator-2-2-1-preview-release-with-support-for-2013-08-15-version.aspx">Windows Azure Storage Emulator 2.2.1 Preview Release with support for “2013-08-15” version</a>によると、preview のための暫定的な処理のようです。</p>
</div>
<div class="section" id="do-it">
<h2>Do It</h2>
<p>やってみます。まず、最初にAzure Storage Emulatorが動いていたら止めます。</p>
<img alt="../../../_images/2014-01-29-WASE221-005.png" src="http://kyrt.in/_images/2014-01-29-WASE221-005.png"/>
<p>Windows Azure Storage Emulator 2.2.1 Preview Release の MSI package を、<a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=41670">ここ</a>からダンロードしてきてインストールします。</p>
<img alt="../../../_images/2014-01-29-WASE221-001.png" src="http://kyrt.in/_images/2014-01-29-WASE221-001.png"/>
<p>インストールが終わると、README.txt が表示されます。上に書いたようなことが書いてあります。</p>
<img alt="../../../_images/2014-01-29-WASE221-002.png" src="http://kyrt.in/_images/2014-01-29-WASE221-002.png"/>
<p>手元はx64環境なので、<span class="docutils literal"><span class="pre">"%ProgramFiles(x86)%\Windows</span> <span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Emulator</span> <span class="pre">2.2.1\devstore"</span></span>にファイルが有るかを確認します。インストーラーは、ここにファイルを展開しますが、ここだと実行されません。これから規定の場所にコピーします。</p>
<img alt="../../../_images/2014-01-29-WASE221-003.png" src="http://kyrt.in/_images/2014-01-29-WASE221-003.png"/>
<p>問題無さそうなので、<span class="docutils literal"><span class="pre">"%ProgramFiles%\Microsoft</span> <span class="pre">SDKs\Windows</span> <span class="pre">Azure\Emulator\devstore"</span></span>のファイルをZIPで固めて避難してから、2.2.1のファイルをコピー上書きします。</p>
</div>
<div class="section" id="id5">
<h2>確認</h2>
<p>まずはStorage Emulatorを実行して起動を確認します</p>
<p>普通に　Windows Azure Storage Emulator - v2.2 のショートカットをクリックする方法以外に、下記のようにコマンドラインから起動をすることも出来ます。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ .\csrun.exe /devstore
Windows(R) Azure(TM) Desktop Execution Tool version 2.2.0.0
for Microsoft(R) .NET Framework 4.0
Copyright c Microsoft Corporation. All rights reserved.

Starting the storage emulator...
$

</pre></div>
</div>
<p>起動してきたので、念のためバージョン番号を確認します。残念ながら変わっていません…</p>
<img alt="../../../_images/2014-01-29-WASE221-004.png" src="http://kyrt.in/_images/2014-01-29-WASE221-004.png"/>
<p>次にJSONでアクセスしてみます。<span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span></span>後、下記のようなコードを書いて実行します。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.WindowsAzure.Storage.Table</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">WASE221pre</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">acct</span> <span class="p">=</span> <span class="n">CloudStorageAccount</span><span class="p">.</span><span class="n">DevelopmentStorageAccount</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">tableClient</span> <span class="p">=</span> <span class="n">acct</span><span class="p">.</span><span class="n">CreateCloudTableClient</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">table</span> <span class="p">=</span> <span class="n">tableClient</span><span class="p">.</span><span class="n">GetTableReference</span><span class="p">(</span><span class="s">"TestTable"</span><span class="p">);</span>
            <span class="n">table</span><span class="p">.</span><span class="n">CreateIfNotExists</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TableEntity</span>
            <span class="p">{</span>
                <span class="n">PartitionKey</span> <span class="p">=</span> <span class="s">"pk"</span><span class="p">,</span>
                <span class="n">RowKey</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"rk{0}"</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="n">Ticks</span><span class="p">)</span>
            <span class="p">};</span>

            <span class="n">table</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">TableOperation</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">entity</span><span class="p">));</span>

            <span class="kt">var</span> <span class="n">rows</span> <span class="p">=</span> <span class="n">table</span><span class="p">.</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="k">new</span> <span class="n">TableQuery</span><span class="p">&lt;</span><span class="n">TableEntity</span><span class="p">&gt;()).</span><span class="n">ToArray</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">testEntity</span> <span class="k">in</span> <span class="n">rows</span><span class="p">)</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"{0}, {1}"</span><span class="p">,</span> <span class="n">testEntity</span><span class="p">.</span><span class="n">PartitionKey</span><span class="p">,</span> <span class="n">testEntity</span><span class="p">.</span><span class="n">RowKey</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="p">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="p">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="p">=</span><span class="s">"utf-8"</span><span class="p">?&gt;</span>
<span class="p">&lt;</span><span class="n">packages</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"Microsoft.Data.Edm"</span> <span class="n">version</span><span class="p">=</span><span class="s">"5.6.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"Microsoft.Data.OData"</span> <span class="n">version</span><span class="p">=</span><span class="s">"5.6.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"Microsoft.Data.Services.Client"</span> <span class="n">version</span><span class="p">=</span><span class="s">"5.6.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"Microsoft.WindowsAzure.ConfigurationManager"</span> <span class="n">version</span><span class="p">=</span><span class="s">"1.8.0.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"Newtonsoft.Json"</span> <span class="n">version</span><span class="p">=</span><span class="s">"5.0.8"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"System.Spatial"</span> <span class="n">version</span><span class="p">=</span><span class="s">"5.6.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="n">package</span> <span class="n">id</span><span class="p">=</span><span class="s">"WindowsAzure.Storage"</span> <span class="n">version</span><span class="p">=</span><span class="s">"3.0.2.0"</span> <span class="n">targetFramework</span><span class="p">=</span><span class="s">"net451"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="n">packages</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>実行結果</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ WASE221pre.exe
pk, rk635265773262439816
pk, rk635265773303542415
pk, rk635265773965590960
pk, rk635265774455960355
pk, rk635265824937388844

</pre></div>
</div>
<p>上手く行きました。（何度か実行したので複数のエンティティがあります）</p>
<p>本当にJSONで流れているのかどうか念のために確認します。</p>
<p>接続文字列を、<span class="docutils literal"><span class="pre">"UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://ipv4.fiddler"</span></span>に変更します。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="c1">// var acct = CloudStorageAccount.DevelopmentStorageAccount;</span>
<span class="kt">var</span> <span class="n">acct</span> <span class="p">=</span> <span class="n">CloudStorageAccount</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">"UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://ipv4.fiddler"</span><span class="p">);</span>
</pre></div>
</div>
<p>実行してCaptureを確認します。</p>
<p>リクエスト</p>
<div class="highlight-none"><div class="highlight"><pre><span/>GET http://127.0.0.1:10002/devstoreaccount1/TestTable?timeout=90 HTTP/1.1
User-Agent: WA-Storage/3.0.2 (.NET CLR 4.0.30319.34003; Win32NT 6.3.9600.0)
x-ms-version: 2013-08-15
Accept-Charset: UTF-8
MaxDataServiceVersion: 3.0;NetFx
Accept: application/json;odata=minimalmetadata
x-ms-client-request-id: a4ed326b-e3a6-43f9-bb6e-8fb295014473
x-ms-date: Wed, 29 Jan 2014 09:04:42 GMT
Authorization: SharedKey devstoreaccount1:7Wt86EphqhTZTwLxkMrAkPGNV9WDSKa0df5Feaw8zkU=
Host: 127.0.0.1:10002


</pre></div>
</div>
<p>レスポンス</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 200 OK
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: fdd3f33e-e2d7-401e-a4c6-7654bd7ae584
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Wed, 29 Jan 2014 09:04:42 GMT

285
{"odata.metadata":"http://127.0.0.1:10002/devstoreaccount1/$metadata#TestTable","value":[{"PartitionKey":"pk","RowKey":"rk635265773262439816","Timestamp":"2014-01-29T07:28:46.35Z"},{"PartitionKey":"pk","RowKey":"rk635265773303542415","Timestamp":"2014-01-29T07:28:50.513Z"},{"PartitionKey":"pk","RowKey":"rk635265773965590960","Timestamp":"2014-01-29T07:29:56.707Z"},{"PartitionKey":"pk","RowKey":"rk635265774455960355","Timestamp":"2014-01-29T07:30:45.74Z"},{"PartitionKey":"pk","RowKey":"rk635265824937388844","Timestamp":"2014-01-29T08:54:54.147Z"},{"PartitionKey":"pk","RowKey":"rk635265830822644693","Timestamp":"2014-01-29T09:04:42.46Z"}]}
0
</pre></div>
</div>
<p>無事に動いていることを確認できました。</p>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>preview ですが、Storage Emulatorが 2013-08-15 versionをサポートし、軽くですがJSONでのアクセスが動くことを確認できました。12月の<a class="reference internal" href="http://kyrt.in/2013/12/21/windows_azure_storage_client_library_for_c_preview.html"><span class="doc">Windows Azure Storage Client Library for C++ Preview</span></a>では、2013-08-15 version 対応のStorage　Emulator が、来月には出せそうということだったので、ほぼ予定通りですね。どうしても手元で確認したい場合は、Storage Emulator 2.2.1 previewを使って、そうでない場合は本番を利用して開発ということになりそうです。</p>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure Table ]]></category>
             <pubDate>Wed, 29 Jan 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2014/01/06/windows_azure_storage_3_0_2_hotfix.html</link>
            <guid>http://kyrt.in/2014/01/06/windows_azure_storage_3_0_2_hotfix.html</guid>
            <title><![CDATA[Windows Azure Storage 3.0.2 Hotfix]]></title>
            <description><![CDATA[<h1>Windows Azure Storage 3.0.2 Hotfix</h1>
<p>2014/1/4<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.2">Windows Azure Storage 3.0.2</a>がリリースされました。2013/11/27 3.0のリリース 「<a class="reference internal" href="http://kyrt.in/2013/11/28/cors_json_minute_metrics_and_more.html"><span class="doc">Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介</span></a>」、2013/12/11 の 3.0.1 hotfix 「<a class="reference internal" href="http://kyrt.in/2013/12/11/windows_azure_storage_client_3_0_1.html"><span class="doc">Windows Azure Storage Client 3.0.1</span></a>」 に続く３回めのリリースです。</p>
<a class="reference external image-reference" href="http://flic.kr/p/iSAtsB"><img alt="zenko-ji by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3665/11730616035_d5730064f3_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>修正点</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/changelog.txt#L184">Issues fixed in 3.0.2.0 :</a>:</p>
<ol class="arabic simple">
<li>All (WP): 多くのAPIで ArgumentOutOfRangeException になる問題の修正</li>
<li>Queues: 存在するqueueの再度作成で、NullReferenceException になる問題を修正</li>
<li>Tables: レスポンスがparseできなかったときに、TableServiceContext が NullReferenceException になる問題を修正</li>
<li>Tables (RT): JSON形式がまだRT library でサポートされていないため、ユーザーは、RTで RequestOptions に JsonFullMetadata formart を設定することはできません</li>
</ol>
<p>コードを確認したところ、最初のやつが興味深いものでした。</p>
</div>
<div class="section" id="all-wp-api-argumentoutofrangeexception">
<h2>1. All (WP): 多くのAPIで ArgumentOutOfRangeException になる問題の修正</h2>
<p>対象は、Windows Phone プラットフォームだけで特定のAPIでなく全般的に発生します。関連する Issue として 、<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/issues/16">System.ArgumentOutOfRangeException in Microsoft.WindowsAzure.Storage.Table.CloudTable.EndExecute</a>が出ています。</p>
<p>共通で使っている、API内のパラメータのバウンダリー検査関数（<span class="docutils literal"><span class="pre">AssertInBounds</span></span>）が動いていなくてあちこちで問題が発生するということになっていたようです。（そうは言っても、テストはしているので、そうそう起きるわけでは無いとは思います）</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17">Storage Client Library 3.0.2 のPR</a>でdiffを見みると、WINDOWS_PHONEだけで下記のように修正されていました。</p>
<img alt="../../../_images/2014-01-06-github001.png" src="http://kyrt.in/_images/2014-01-06-github001.png"/>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17/files#diff-546e2cf76676e7cafc795f6d4d105fefR160">https://github.com/WindowsAzure/azure-storage-net/pull/17/files#diff-546e2cf76676e7cafc795f6d4d105fefR160</a></p>
<p>#if WINDOWS_PHONE で AssertInBounds に、<span class="docutils literal"><span class="pre">[System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoOptimization)]</span></span>を指定しています。この指定は、JITやNGENでのコード最適化を抑制するもので、<a class="footnote-reference" href="#r1" id="id2">[1]</a>Windows Phone の場合だけ native code 生成に問題があったので抑制するオプションを付けたということです。</p>
<p>Windows Phone というだけで、どのような場合に発生する問題かなどわかりませんが、WP アプリのコードが挙動不審の場合は試してみると良いかもしれません。Storage Clinet Library内では、この方法で修正されているようなので問題は無いのですが、普通に書いたコードでも起きるとすると、ちょっと困りますね。もう少し詳しい情報が欲しいところです。<a class="footnote-reference" href="#r2" id="id3">[2]</a></p>
<p>これ以外は、あまり気になる点はありませんでした。互換性の問題も無さそうなので、3系のStorage Clinetは 3.0.2 を使うのがお勧めです。</p>
</div>
<div class="section" id="windows-phone">
<span id="scl302-more-info"/><h2>2014/1/11 追記 Windows Phoneの問題</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17#issuecomment-31639331">PR の質問</a>に返事を貰いました。</p>
<blockquote>
<div><div class="line-block">
<div class="line">この問題は、Windows Phone でだけ起き、assemblyに、AssertInBoundsとAssertInBounds 両方が存在する場合に、最適化で実行時にAssertInBoundsの間違ったインスタンス化を選択することによって引き起こされる</div>
</div>
</div></blockquote>
<p><span class="docutils literal"><span class="pre">internal</span> <span class="pre">static</span> <span class="pre">void</span> <span class="pre">AssertInBounds&lt;T&gt;(string</span> <span class="pre">paramName,</span> <span class="pre">T</span> <span class="pre">val,</span> <span class="pre">T</span> <span class="pre">min,</span> <span class="pre">T</span> <span class="pre">max)</span> <span class="pre">where</span> <span class="pre">T</span> <span class="pre">:</span> <span class="pre">IComparable</span></span>と、<span class="docutils literal"><span class="pre">internal</span> <span class="pre">static</span> <span class="pre">void</span> <span class="pre">AssertInBounds&lt;T&gt;(string</span> <span class="pre">paramName,</span> <span class="pre">T</span> <span class="pre">val,</span> <span class="pre">T</span> <span class="pre">min)</span> <span class="pre">where</span> <span class="pre">T</span> <span class="pre">:</span> <span class="pre">IComparable</span></span>の両方が同一 assembly にあるのが問題のようです。 必ず起きるというわけでも無さそうなので、Windows Phone で嵌ったら思い出してみるという程度で良さそうです。</p>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://msdn.microsoft.com/ja-jp/library/system.runtime.compilerservices.methodimploptions(v=vs.110).aspx">About System.Runtime.CompilerServices.MethodImplOptions</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17#issuecomment-31676932">We escalated this internally …</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Mon, 06 Jan 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/27/azure_storage_known_issues_november_2013_resolved.html</link>
            <guid>http://kyrt.in/2013/12/27/azure_storage_known_issues_november_2013_resolved.html</guid>
            <title><![CDATA[[Resolved] Windows Azure Storage Known Issues 2013/11]]></title>
            <description><![CDATA[<h1>[Resolved] Windows Azure Storage Known Issues 2013/11</h1>
<p><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html"><span class="doc">Windows Azure Storage Known Issues 2013/11</span></a>の既知の問題が解決されたとアナウンスがありました。<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">Windows Azure Storage Known Issues (November 2013) [Resolved]</a>どんな感じになったのかを確認しました。</p>
<div class="section" id="id1">
<h2>引用</h2>
<blockquote>
<div><div class="line-block">
<div class="line">更新 [2013/12/10] : <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">このBlog に記述されている問題</a> <a class="footnote-reference" href="#r1" id="id2">[1]</a> は、service と client library の更新で解決されました。issue 2 の client table の件は、 <a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage/2.1.0.4">2.1.0.4</a>  <a class="footnote-reference" href="#r2" id="id4">[2]</a> と  <a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage">3.x</a> <a class="footnote-reference" href="#r3" id="id5">[3]</a> の client library の releases で解決されています。</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br/></div>
</div>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9742159560"><img alt="matuyama by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7416/9742159560_500e7d6301.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
</div>
<div class="section" id="id6">
<h2>問題点の確認</h2>
<p>問題点は下記の3つが有りました。「3」は、既に、<a class="reference internal" href="http://kyrt.in/2013/11/30/fixed_storage_client_cast_problem_in_2013_08_15_version.html"><span class="doc">Storage Client 2.1.0.4 以降での Cast問題の修正</span></a>で、Client Library 2.1.0.4、3.xで修正確認ができているので、ここでは1と2を確認します。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><span class="std std-ref">SASとコンテナの前の// 問題</span></a></li>
<li><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><span class="std std-ref">TableのDataServiceContext.ResolveName 指定 問題</span></a></li>
<li><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a></li>
</ol>
</div>
<div class="section" id="sas">
<h2><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><span class="std std-ref">SASとコンテナの前の “//” 問題</span></a></h2>
<p>下記のようなプログラムで確認しました。Signitureの生成結果を確認しやすいように、2013/12/01から一年有効なREADのSASにしています。Storage Client 2.1.0.4 では、2012-02-12 versionが使われて、コンテナの前が<span class="docutils literal"><span class="pre">"//"</span></span>になっていても動きましたが、3.0.1だと、2013-08-15 versionが使われ、400 のエラーで弾かれるという結果になりました。もともと、<span class="docutils literal"><span class="pre">"//"</span></span>と書いたら<span class="docutils literal"><span class="pre">"/"</span></span>と解釈されるというのはあまりイケてない動きなので、古いバージョンのみ互換性を持つように変更して新しいものでは動作変更ということにしたのは妥当な落とし所かと思います。Storage Versionによって動作が違うようです。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetSASUrl</span><span class="p">(</span><span class="n">CloudStorageAccount</span> <span class="n">storageAccount</span><span class="p">,</span> <span class="kt">string</span> <span class="n">containerName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">blobName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">blobClient</span> <span class="p">=</span> <span class="n">storageAccount</span><span class="p">.</span><span class="n">CreateCloudBlobClient</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">blobClient</span><span class="p">.</span><span class="n">GetContainerReference</span><span class="p">(</span><span class="n">containerName</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">blockBlob</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetBlockBlobReference</span><span class="p">(</span><span class="n">blobName</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">startDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">"2013/12/01"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">sas</span> <span class="p">=</span> <span class="n">blockBlob</span><span class="p">.</span><span class="n">GetSharedAccessSignature</span><span class="p">(</span><span class="k">new</span> <span class="n">SharedAccessBlobPolicy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Permissions</span> <span class="p">=</span> <span class="n">SharedAccessBlobPermissions</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span>
        <span class="n">SharedAccessStartTime</span> <span class="p">=</span> <span class="n">startDate</span><span class="p">,</span>
        <span class="n">SharedAccessExpiryTime</span> <span class="p">=</span> <span class="n">startDate</span><span class="p">.</span><span class="n">AddYears</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">});</span>
    
    <span class="k">return</span> <span class="n">blockBlob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="n">sas</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id7">
<h3>2.1.0.4での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span> <span class="pre">-Version</span> <span class="pre">2.1.0.4</span></span>で2.1.0.4を入れます。何度も、違うバージョンのライブラリを入れ替えて使っていて、混乱したので念のためpackage.configの内容を併記します。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;packages&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.Data.Edm"</span> <span class="na">version=</span><span class="s">"5.2.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.Data.OData"</span> <span class="na">version=</span><span class="s">"5.2.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.WindowsAzure.ConfigurationManager"</span> <span class="na">version=</span><span class="s">"1.8.0.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"System.Spatial"</span> <span class="na">version=</span><span class="s">"5.2.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"WindowsAzure.Storage"</span> <span class="na">version=</span><span class="s">"2.1.0.4"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<p>生成されたURLで成功を確認</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture">http://test.blob.core.windows.net/images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture</a>]</div>
</div>
</div></blockquote>
<p>コンテナの前に、<span class="docutils literal"><span class="pre">"/"</span></span>を追加して確認、成功！</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net//images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture">http://test.blob.core.windows.net//images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture</a>]</div>
</div>
</div></blockquote>
<p><span class="docutils literal"><span class="pre">sv=2012-02-12</span></span>になっていて、versionがわかります。</p>
</div>
<div class="section" id="id8">
<h3>3.0.1での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span></span>で最新版、3.0.1で確認</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;packages&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.Data.Edm"</span> <span class="na">version=</span><span class="s">"5.6.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.Data.OData"</span> <span class="na">version=</span><span class="s">"5.6.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.Data.Services.Client"</span> <span class="na">version=</span><span class="s">"5.6.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Microsoft.WindowsAzure.ConfigurationManager"</span> <span class="na">version=</span><span class="s">"1.8.0.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"Newtonsoft.Json"</span> <span class="na">version=</span><span class="s">"5.0.8"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"System.Spatial"</span> <span class="na">version=</span><span class="s">"5.6.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">"WindowsAzure.Storage"</span> <span class="na">version=</span><span class="s">"3.0.1.0"</span> <span class="na">targetFramework=</span><span class="s">"net451"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<p>生成されたURLで成功を確認</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r">http://test.blob.core.windows.net/images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r</a></div>
</div>
</div></blockquote>
<p>コンテナの前に、<span class="docutils literal"><span class="pre">"/"</span></span>を追加。これは失敗します。</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net//images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r">http://test.blob.core.windows.net//images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r</a></div>
</div>
</div></blockquote>
<p>レスポンスを見ると下記のようになっていました。（XMLは整形してあります）</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 400 The requested URI does not represent any resource on the server.
Content-Length: 434
Content-Type: application/xml
Server: Microsoft-HTTPAPI/2.0
x-ms-request-id: a9275897-8810-48b2-bcd5-d45af85f6f14
Date: Fri, 27 Dec 2013 12:34:46 GMT

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;Error&gt;
  &lt;Code&gt;InvalidUri&lt;/Code&gt;
  &lt;Message&gt;
    The requested URI does not represent any resource on the server.
    RequestId:a9275897-8810-48b2-bcd5-d45af85f6f14
    Time:2013-12-27T12:34:46.6851586Z
  &lt;/Message&gt;
  &lt;UriPath&gt;
  http://test.blob.core.windows.net//images/photo.jpg?sv=2013-08-15&amp;amp;sr=b&amp;amp;sig=[signiture]&amp;amp;se=2014-11-30T15:00:00Z&amp;amp;sp=r
  &lt;/UriPath&gt;
&lt;/Error&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="tabledataservicecontext-resolvename">
<h2><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><span class="std std-ref">TableのDataServiceContext.ResolveName 指定 問題</span></a></h2>
<p>同様に、下記のようなコードを使って、2.1.0.4と、3.0.1で確認しました。 2.1.0.4 では、動作しましたが 3.0.1 では動きませんでした。結果はSASと似ているのですが、service側では処理が成功しているのでちょっと違った感じを受けます。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ResolveName</span><span class="p">(</span><span class="n">CloudStorageAccount</span> <span class="n">storageAccount</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">cloudTableClient</span> <span class="p">=</span> <span class="n">storageAccount</span><span class="p">.</span><span class="n">CreateCloudTableClient</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">table</span> <span class="p">=</span> <span class="n">cloudTableClient</span><span class="p">.</span><span class="n">GetTableReference</span><span class="p">(</span><span class="s">"sometable"</span><span class="p">);</span>
    <span class="n">table</span><span class="p">.</span><span class="n">CreateIfNotExists</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">tableServiceContext</span> <span class="p">=</span> <span class="n">cloudTableClient</span><span class="p">.</span><span class="n">GetTableServiceContext</span><span class="p">();</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">ResolveName</span> <span class="p">=</span> <span class="n">entityType</span> <span class="p">=&gt;</span> <span class="n">entityType</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleEntity</span><span class="p">(</span><span class="s">"somePK"</span><span class="p">,</span> <span class="s">"someRK2"</span><span class="p">);</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">AddObject</span><span class="p">(</span><span class="s">"sometable"</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id9">
<h3>2.1.0.4での確認結果</h3>
<p>普通に動いて成功しました。リクエストを見ると、categoryの属性に、<span class="docutils literal"><span class="pre">term="StorageIssue201311.SimpleEntity"</span></span>と有りますが、正常に処理されてレスポンスが帰ってきているのがわかります。</p>
<p>参考までに、リクエストとレスポンスを貼っておきます</p>
<p>リクエスト</p>
<div class="highlight-none"><div class="highlight"><pre><span/>POST http://test.table.core.windows.net/sometable HTTP/1.1
User-Agent: Microsoft ADO.NET Data Services
DataServiceVersion: 1.0;NetFx
MaxDataServiceVersion: 2.0;NetFx
x-ms-date: Fri, 27 Dec 2013 13:30:17 GMT
Authorization: SharedKeyLite [signiture]
x-ms-version: 2012-02-12
Accept: application/atom+xml,application/xml
Accept-Charset: UTF-8
Content-Type: application/atom+xml
Host: test.table.core.windows.net
Content-Length: 735

&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;
&lt;entry xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://www.w3.org/2005/Atom"&gt;
  &lt;category scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" term="StorageIssue201311.SimpleEntity" /&gt;
  &lt;title /&gt;
  &lt;author&gt;
    &lt;name /&gt;
  &lt;/author&gt;
  &lt;updated&gt;2013-12-27T13:30:17.8428287Z&lt;/updated&gt;
  &lt;id /&gt;
  &lt;content type="application/xml"&gt;
    &lt;m:properties&gt;
      &lt;d:PartitionKey&gt;somePK&lt;/d:PartitionKey&gt;
      &lt;d:RowKey&gt;someRK7&lt;/d:RowKey&gt;
      &lt;d:Timestamp m:type="Edm.DateTime"&gt;0001-01-01T00:00:00&lt;/d:Timestamp&gt;
    &lt;/m:properties&gt;
  &lt;/content&gt;
&lt;/entry&gt;
</pre></div>
</div>
<p>レスポンス</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 201 Created
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/atom+xml;type=entry;charset=utf-8
ETag: W/"datetime'2013-12-27T13%3A30%3A08.6638521Z'"
Location: http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK7')
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 765ae397-974c-4f3c-9d3a-d4e99bdcf9f5
x-ms-version: 2012-02-12
X-Content-Type-Options: nosniff
Date: Fri, 27 Dec 2013 13:30:08 GMT

3AE
&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;entry xml:base="http://test.table.core.windows.net/" xmlns="http://www.w3.org/2005/Atom" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" m:etag="W/&amp;quot;datetime'2013-12-27T13%3A30%3A08.6638521Z'&amp;quot;"&gt;&lt;id&gt;http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK7')&lt;/id&gt;&lt;category term="test.sometable" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /&gt;&lt;link rel="edit" title="sometable" href="sometable(PartitionKey='somePK',RowKey='someRK7')" /&gt;&lt;title /&gt;&lt;updated&gt;2013-12-27T13:30:08Z&lt;/updated&gt;&lt;author&gt;&lt;name /&gt;&lt;/author&gt;&lt;content type="application/xml"&gt;&lt;m:properties&gt;&lt;d:PartitionKey&gt;somePK&lt;/d:PartitionKey&gt;&lt;d:RowKey&gt;someRK7&lt;/d:RowKey&gt;&lt;d:Timestamp m:type="Edm.DateTime"&gt;2013-12-27T13:30:08.6638521Z&lt;/d:Timestamp&gt;&lt;/m:properties&gt;&lt;/content&gt;&lt;/entry&gt;
0


</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
</div>
<div class="section" id="id10">
<h3>3.0.1での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span></span>として最新版、3.0.1で確認したところ、下記のようにエラーになりました。データ自体は、Tableに入っており正常終了していますが、レスポンスを読み込んでエンティティを更新するのに失敗しているようです。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>ハンドルされていない例外: System.Data.Services.Client.DataServiceRequestException: この要求の処理中にエラーが発生しました。 ---&gt; System.InvalidOperationException: メタデータ URI 'http://fooomiimg001.table.core.windows.net/$metadata#sometable/@Element' は 'fooomiimg001.sometable' という名前のエンティティ型を参照していますが、予期されたエンティティ型の名前は 'StorageIssue201311.SimpleEntity' で、'fooomiimg001.sometable' という名前のエンティティ型と互換性がありません。 ---&gt; Microsoft.Data.OData.ODataException: メタデータ URI 'http://fooomiimg001.table.core.windows.net/$metadata#sometable/@Element' は 'fooomiimg001.sometable' という名前のエンティティ型を参照していますが、予期されたエンティティ型の名前は 'StorageIssue201311.SimpleEntity' で、'fooomiimg001.sometable' という名前のエンティティ型と互換性がありません。
   場所 Microsoft.Data.OData.ReaderValidationUtils.ValidateFeedOrEntryMetadataUri(ODataJsonLightMetadataUriParseResult metadataUriParseResult, Scope scope)
   場所 Microsoft.Data.OData.JsonLight.ODataJsonLightReader.ReadAtStartImplementationSynchronously(DuplicatePropertyNamesChecker duplicatePropertyNamesChecker)
   場所 Microsoft.Data.OData.JsonLight.ODataJsonLightReader.ReadAtStartImplementation()
   場所 Microsoft.Data.OData.ODataReaderCore.ReadImplementation()
   場所 Microsoft.Data.OData.ODataReaderCore.ReadSynchronously()
   場所 Microsoft.Data.OData.ODataReaderCore.InterceptException[T](Func`1 action)
   場所 Microsoft.Data.OData.ODataReaderCore.Read()
   場所 System.Data.Services.Client.Materialization.ODataReaderWrapper.Read()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryRead()
   --- 内部例外スタック トレースの終わり ---
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryRead()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryStartReadFeedOrEntry()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryReadFeedOrEntry(Boolean lazy, ODataFeed&amp; feed, MaterializerEntry&amp; entry)
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.Read()
   場所 System.Data.Services.Client.Materialization.ODataReaderEntityMaterializer.ParseSingleEntityPayload(IODataResponseMessage message, ResponseInfo responseInfo, Type expectedType)
   場所 System.Data.Services.Client.SaveResult.HandleOperationResponseData(IODataResponseMessage responseMsg, Stream responseStream)
   --- 内部例外スタック トレースの終わり ---
   場所 System.Data.Services.Client.SaveResult.HandleResponse()
   場所 System.Data.Services.Client.BaseSaveResult.EndRequest()
   場所 System.Data.Services.Client.DataServiceContext.SaveChanges(SaveChangesOptions options)
   場所 System.Data.Services.Client.DataServiceContext.SaveChanges()
   場所 StorageIssue201311.Program.ResolveName(CloudStorageAccount storageAccount) 場所 c:\Users\Takekazu\Documents\GitHub\sandbox\csharp\StorageIssue201311\StorageIssue201311\Program.cs:行 52
   場所 StorageIssue201311.Program.Main(String[] args) 場所 c:\Users\Takekazu\Documents\GitHub\sandbox\csharp\StorageIssue201311\StorageIssue201311\Program.cs:行 59







</pre></div>
</div>
<p>参考までに、リクエストとレスポンスを貼っておきます。これを見ると、x-ms-version: 2013-08-15 で、payloadは、<span class="docutils literal"><span class="pre">Content-Type:</span> <span class="pre">application/json;odata=minimalmetadata</span></span>になっていますが、<span class="docutils literal"><span class="pre">Prefer:</span> <span class="pre">return-no-content</span></span>が指定されておらず、レスポンスのBodyにechoが帰ってきているのがわかります。</p>
<p>リクエスト</p>
<div class="highlight-none"><div class="highlight"><pre><span/>POST http://test.table.core.windows.net/sometable HTTP/1.1
DataServiceVersion: 3.0;NetFx
MaxDataServiceVersion: 3.0;NetFx
Accept: application/json;odata=minimalmetadata
Accept-Charset: UTF-8
User-Agent: Microsoft ADO.NET Data Services
x-ms-date: Fri, 27 Dec 2013 13:07:55 GMT
Authorization: SharedKeyLite [signiture]
x-ms-version: 2013-08-15
Content-Type: application/json;odata=minimalmetadata
Host: test.table.core.windows.net
Content-Length: 125

{"odata.type":"StorageIssue201311.SimpleEntity","PartitionKey":"somePK","RowKey":"someRK6","Timestamp":"0001-01-01T00:00:00"}
</pre></div>
</div>
<p>レスポンス</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 201 Created
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
ETag: W/"datetime'2013-12-27T13%3A07%3A45.3753816Z'"
Location: http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK6')
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: b1797f33-1888-487a-a0cb-0a454fca1356
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Fri, 27 Dec 2013 13:07:45 GMT

B2
{"odata.metadata":"http://test.table.core.windows.net/$metadata#sometable/@Element","PartitionKey":"somePK","RowKey":"someRK6","Timestamp":"2013-12-27T13:07:45.3753816Z"}
0


</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h2>まとめ</h2>
<p><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html"><span class="doc">Windows Azure Storage Known Issues 2013/11</span></a>で報告されている既知の Braking Change は、2.1.0.4 の修正と、サーバー側(service)の修正でFIXされました。ただし、<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><span class="std std-ref">SASとコンテナの前の “//” 問題</span></a>は、2013-08-15 version では仕様となり、<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><span class="std std-ref">TableのDataServiceContext.ResolveName 指定 問題</span></a>も、Storage Client 3.0.1 では、ResolveNameの指定をすると動作しません。 最新のライブラリを使う場合はコードを直して欲しいということだと思います。</p>
<p>2.1系のライブラリを使う場合は上記3点の問題がFIXされた 2.1.0.4 がお勧めです。3.x系は、幾つかのBraking Changeが含まれるので既存のコードは移行が必要ですが、2013-08-15 versionのパフォーマンス向上策がちゃんと活用できるのが大きな利点だと言えます。</p>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>日本語訳<a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/11/29/blog-windows-azure-storage-known-issues.aspx">Windows Azure ストレージの既知の問題</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>gitbugの<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/">WindowsAzure/azure-sdk-for-net</a>レポジトリのmasterには、Storage Clientのコードは既にありません。2.1.0.4を確認するには、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/tree/v2.1.0.4/microsoft-azure-api/Services/Storage">tag:v2.1.0.4 Storage</a>を見て下さい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">3.x github</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Fri, 27 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/22/azure_posh_2012_12_19_version_0_7_2_1.html</link>
            <guid>http://kyrt.in/2013/12/22/azure_posh_2012_12_19_version_0_7_2_1.html</guid>
            <title><![CDATA[Windows Azure Powershell 0.7.2.1 リリース]]></title>
            <description><![CDATA[<h1>Windows Azure Powershell 0.7.2.1 リリース</h1>
<p>Windows Azure Powershello 0.7.2.1 Hotfix がリリースされました。<a class="reference internal" href="http://kyrt.in/2013/12/11/windows_azure_powershel_0_7_2_release.html"><span class="doc">Windows Azure PowerShell 0.7.2 リリース</span></a>のHotfix です。</p>
<blockquote>
<div><div class="line-block">
<div class="line">修正: Hive query “%” が含まれた場合のエンコーディングの問題をFIX <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/blob/master/ChangeLog.txt#L1">ChangeLog.txt</a></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br/></div>
</div>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/11233678353"><img alt="beans persimmon by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7405/11233678353_a8e7a8b12f_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>インストール</h2>
<p>Web Platform Installer を使うと最新版が入ります。12/18 リリースのWindows Azure Poershell を選択してください。</p>
<img alt="../../../_images/2013_12_22_webpi001.png" src="http://kyrt.in/_images/2013_12_22_webpi001.png"/>
<p>インストールしたら念のためバージョンを確認します。Azureの所が、0.7.2 のママです orz….</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ Get-Module <span class="p">|</span> ft name,version

Name                                                        Version
----                                                        -------
Autoload                                                    <span class="m">0</span>.0
Azure                                                       <span class="m">0</span>.7.2
Microsoft.PowerShell.Management                             <span class="m">3</span>.1.0.0
Microsoft.PowerShell.Utility                                <span class="m">3</span>.1.0.0
posh-git                                                    <span class="m">0</span>.0
PsEnv                                                       <span class="m">0</span>.0
PSReadline                                                  <span class="m">1</span>.0.0.1
</pre></div>
</div>
<p>今回のリリースでは、ModuleVersion が変更されていません。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/blob/master/WindowsAzurePowershell/src/Commands.Utilities/Azure.psd1#L15">Azure.psd1#L15</a>要注意です。</p>
<p>確認のためインストール先のアセンブリを見ます。</p>
<p>手元の環境では、<cite>C:Program Files (x86)Microsoft SDKsWindows AzurePowerShellAzure</cite>にインストールされています。 Explorer で、<cite>Microsoft.WindowsAzure.Commands.dll</cite>のプロパティを確認したら下記のようになっていました。0.7.2.1になっているようです。</p>
<img alt="../../../_images/2013_12_22_asm001.png" class="align-center" src="http://kyrt.in/_images/2013_12_22_asm001.png"/>
</div>
<div class="section" id="id2">
<h2>最後に</h2>
<p>更新だけする場合は、Web Platform Installer を起動して新しいものが出ているかどうかを確認するのが一番簡単です。</p>
<p>この方法だと、現在入っているバージョンは分からないので、現在入っているバージョンを知りたければ、<cite>Get-Module | ft name,version</cite>して、0.7.2 だったら、アセンプリのバージョンを見て0.7.2.1かどうかの確認をするということになります。</p>
<p>ちょっと面倒ですね。</p>
</div>
<div class="section" id="id3">
<h2>2013/12/23 追記</h2>
<p>ModuleVersionが更新されていない件について、GitHubに<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/issues/2189">Issue</a>を上げました。</p>
</div>
<div class="section" id="azure-posh-0721-verfix">
<span id="id4"/><h2>2014/1/8 追記</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/issues/2189">Issue</a>に「0.7.3 で直すよ」と返事をもらいました<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/issues/2189#issuecomment-31790944">This will be fixed in 0.7.3</a>まだ、0.x ですし、バージョン番号を変更するためにリリースするのもどうかと思うので妥当な判断だと思います。</p>
<p>ちなみに、バージョン番号は、<a class="reference external" href="http://semver.org/">Semantic Versioning</a>に沿って付けられているそうです。nugetでは、<a class="reference external" href="http://docs.nuget.org/docs/reference/versioning">Versioning</a>は、semverなので揃える方向性なんでしょうか、開発者的には分かりやすくなって嬉しいですね。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure PowerShell ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Sun, 22 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/21/windows_azure_storage_client_library_for_c_preview.html</link>
            <guid>http://kyrt.in/2013/12/21/windows_azure_storage_client_library_for_c_preview.html</guid>
            <title><![CDATA[Windows Azure Storage Client Library for C++ Preview]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Client Library for C++ Preview</h1>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/20/windows-azure-storage-client-library-for-cplusplus-preview.aspx">Windows Azure Storage Client Library for C++ Preview がリリースされました</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/12/27 Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/27/windows-azure-storage-client-library-for-c-preview.aspx">C++ 用 Windows Azure ストレージ クライアント ライブラリのプレビュー版をリリース</a></div>
</div>
</div></blockquote>
<p>待望のC++用のライブラリです。</p>
<p>以下にざっくりと訳します。</p>
<div class="section" id="id2">
<h2>抄訳 Windows Azure Storage Client Library for C++ Preview</h2>
<p>これは、Preview release です、まだ puroduction codeでは使用しないでください（should not be used in your production code）。 その代わり、ざっと目を通して試してみて、あなたがGAに必要だと考える拡張・変更のフィードバックを下さい。</p>
<p>Windows Azure Storage に付いての詳しい情報は、SOSP Paper<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2011/11/20/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency.aspx">Windows Azure Storage: A Highly Available Cloud Storage Service with Strong Consistency</a><a class="footnote-reference" href="#r1" id="id3">[1]</a>を参照してください。</p>
<div class="section" id="emulator-guidance">
<h3>Emulator Guidance</h3>
<p>このライブラリが使う<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">2013-08-15 REST</a>は、現在のAzure SDK(2.2)のStorage Emulatorでサポートされていません。これらの全ての機能をサポートしたAzure Storage Emulatorのアップデートを来月には出せる見込みです。(An updated Windows Azure Storage Emulator is expected to ship with full support of these new features in the next month)Storage Emulatorの現在のバージョンを使って開発しようとすると不正な要求エラーを受け取ることになります。アップデートが出るまでは、新機能を使用したいユーザーは、Windows Azure Storage Account (本番環境）を使ってテストをして下さい。<a class="footnote-reference" href="#r2" id="id4">[2]</a></p>
</div>
<div class="section" id="id5">
<h3>サポートされるプラットフォーム</h3>
<p>今回のリリースでは、Visual Studio 2012 (v110) と Visual Studio 2013 (v120) platform toolsets 用ライブラリの x64およびx86バージョンを提供します。パッケージには、8 build flavors が含まれます。</p>
<ol class="arabic simple">
<li>Release, x64, v120</li>
<li>Debug, x64, v120</li>
<li>Release, Win32, v120</li>
<li>Debug, Win32, v120</li>
<li>Release, x64, v110</li>
<li>Debug, x64, v110</li>
<li>Release, Win32, v110</li>
<li>Debug, Win32, v110</li>
</ol>
</div>
<div class="section" id="id6">
<h3>入手方法</h3>
<p>ライブラリは、<a class="reference external" href="http://www.nuget.org/packages/wastorage">NuGet</a>から、完全なソースコードは<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">GitHub</a>からダウンロードできます。NuGet packageは、<a class="reference external" href="http://coapp.org/">CoApp tools</a>を使って作成され、3つのpackage として構成されています。</p>
<ul class="simple">
<li>wastorage.0.2.0-preview.nupkg：このパッケージには、アプリケーションの開発に必要なヘッダーとLIBファイルが含まれています。これは、再配布（redist） package に依存します。NuGet は、自動的にredist packageのインストールを行います。</li>
<li>wastorage.redist.0.2.0-preview.nupkg：このパッケージを実行し、アプリケーションを再配布するために必要なDLLファイルが含まれています。</li>
<li>wastorage.symbols.0.2.0-preview.nupkg：このパッケージには、それぞれのDLLファイルのシンボルが含まれています。オプションのパッケージです。</li>
</ul>
<p>パッケージは、<a class="reference external" href="https://www.nuget.org/packages/cpprestsdk/">C++ REST SDK</a>に依存しており、それもNuGetで自動的にインストールされます。<a class="reference external" href="http://casablanca.codeplex.com/">C++ REST SDK (codename “Casablanca”)</a>は、native code の cloud-based client-server communication のための Microsoft のプロジェクトです。これは、native code の REST services アクセスを、multiple platforms で非同期な HTTP, JSON, URIs の C++ bindings として提供します。Windows Azure Storage Client Library では、このライブラリを Windows Azure Storage Blob, Queue, Table services との通信で利用しています。</p>
</div>
<div class="section" id="id7">
<h3>できること</h3>
<p>ここでは、REST API に付いて話をする代わりに、Windows Azure Storage Client Library の概要を説明します。</p>
<ul class="simple">
<li>Windows Azure Storage REST API version<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">2013-08-15</a>全体を簡単に使えるようにする実装</li>
<li>Retry policies: リクエストが失敗した場合の再試行ロジックとして、exponential や linear back off algorithm を実装</li>
<li>Streamlined authentication model: 共有鍵と共有認証署名の両方をサポート</li>
<li>操作コンテキストとETWのログを使用して要求の詳細と結果に潜り込む能力</li>
<li>サイズや、Blob typeに関係の無い、ユーザー設定による、parallel block/page アップロード</li>
<li>特定のupload/download APIに対応しなくても、読み取りまたはBLOBへの書き込みを許可するBLOB Stream</li>
<li>すべてのBlob uploadおよびdownload での完全なMD5のサポート</li>
<li>Table layerでは、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Azure Storage Table の新しいJSON サポート</a>を利用</li>
<li>Table service の、Entity Group Transaction サポート。（Entity Group Transactionでは、単一トランザクションで複数操作が可能）</li>
</ul>
</div>
<div class="section" id="read-access-geo-redundant-storage-ra-grs">
<h3>Read Access Geo Redundant Storage (RA-GRS) サポート</h3>
<p>このリリースでは、storage account のsecondary region データへの読込アクセスをフルサポートしています。　この機能は、Portalで有効にしないと利用できません、詳しくは、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/11/introducing-read-access-geo-replicated-storage-ra-grs-for-windows-azure-storage.aspx">RA-GRS</a>を参照<a class="footnote-reference" href="#r3" id="id9">[3]</a>して下さい。</p>
</div>
<div class="section" id="how-to-use-it">
<h3>How to use it?</h3>
<p>NuGet package を入れると、<cite>was</cite>(Windows Azure Storageの略) のフォルダーに全てのヘッダー が入ります。  このディレクトリでは下記のheader ファイルが重要です。</p>
<ul class="simple">
<li>blob.h: Blob service 関連の全ての宣言</li>
<li>queue.h: Queue service 関連の全ての宣言</li>
<li>table.h: Table service 関連の全ての宣言</li>
<li>storage_account.h: account の name/key 、あるいは connection string から、service client のオブジェクトを簡単に作成するための cloud_storage_account type の宣言</li>
<li>retry_policies.h: 全ての操作で使われる、幾つかの retry policies の宣言</li>
</ul>
<p>下記のように使います</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="cp">#include</span> <span class="cpf">"was/storage_account.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"was/queue.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"was/table.h"</span><span class="cp"/>
<span class="cp">#include</span> <span class="cpf">"was/blob.h"</span><span class="cp"/>
</pre></div>
</div>
<p>その後、我々は作成されますcloud_storage_accountコードの後半でサービス·クライアント·オブジェクトを作成するために私達を可能にするオブジェクトを、。私たちは安全な接続のために以下のHTTPSを使用しているが、アプリケーションをデバッグするときに、HTTPは非常に便利であることに注意してください。</p>
<p>その後、下記のコードでcloud_storage_account オブジェクトを作成します。 ここでは、セキュアな接続のため https を使っていますが、デバックする場合は http が非常に便利です。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_storage_account</span> <span class="n">storage_account</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_storage_account</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"AccountName=&lt;account_name&gt;;AccountKey=&lt;account_key&gt;;DefaultEndpointsProtocol=https"</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="blobs">
<h3>Blobs</h3>
<p>ここでは、blob container を作成し、<cite>”some text</cite>” と入ったblobを作って、それを download 、そして container 内のblobをリストします。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="c1">// Create a blob container</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_blob_client</span> <span class="n">blob_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_blob_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_blob_container</span> <span class="n">container</span> <span class="o">=</span> <span class="n">blob_client</span><span class="p">.</span><span class="n">get_container_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"mycontainer"</span><span class="p">));</span>
<span class="n">container</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Upload a blob</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_block_blob</span> <span class="n">blob1</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">get_block_blob_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"myblob"</span><span class="p">));</span>
<span class="n">blob1</span><span class="p">.</span><span class="n">upload_text</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"some text"</span><span class="p">));</span>

<span class="c1">// Download a blob</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_block_blob</span> <span class="n">blob2</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">get_block_blob_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"myblob"</span><span class="p">));</span>
<span class="n">utility</span><span class="o">::</span><span class="n">string_t</span> <span class="n">text</span> <span class="o">=</span> <span class="n">blob2</span><span class="p">.</span><span class="n">download_text</span><span class="p">();</span>

<span class="c1">// List blobs</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_result_segment</span> <span class="n">blobs</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">list_blobs_segmented</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_continuation_token</span><span class="p">());</span>
</pre></div>
</div>
</div>
<div class="section" id="tables">
<h3>Tables</h3>
<p>以下のサンプルでは、 Tableを作成し、様々な型のプロパティの組をエンティティに挿入し、最終的にはその指定したエンティティを取得します。最初の検索操作では、ポイント·クエリを実行し、特定のエンティティを取得します。一方クエリ操作では、PartitionKeyが<cite>“partition”</cite>に等しく、かつ、RowKey が、<cite>“m”</cite>より大きいすべてのエンティティを照会します。これは、結果的にinsertした全てのエンティティになります。</p>
<p>Windows Azure Tables に関する詳しい情報は、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179338.aspx">Understanding the Table Service Data Model</a>の記事と、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/11/06/how-to-get-most-out-of-windows-azure-tables.aspx">How to get most out of Windows Azure Tables</a>の blog post を見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="c1">// Create a table</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_table_client</span> <span class="n">table_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_table_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table_client</span><span class="p">.</span><span class="n">get_table_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"mytable"</span><span class="p">));</span>
<span class="n">table</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Insert a table entity</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span> <span class="n">entity</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"partition"</span><span class="p">),</span> <span class="n">U</span><span class="p">(</span><span class="s">"row"</span><span class="p">));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"PropertyA"</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"some string"</span><span class="p">))));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"PropertyB"</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">utility</span><span class="o">::</span><span class="n">datetime</span><span class="o">::</span><span class="n">utc_now</span><span class="p">())));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"PropertyC"</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">utility</span><span class="o">::</span><span class="n">new_uuid</span><span class="p">())));</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span> <span class="n">operation1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span><span class="o">::</span><span class="n">insert_or_replace_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_result</span> <span class="n">table_result</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation1</span><span class="p">);</span>

<span class="c1">// Retrieve a table entity</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span> <span class="n">operation2</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span><span class="o">::</span><span class="n">retrieve_entity</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"partition"</span><span class="p">),</span> <span class="n">U</span><span class="p">(</span><span class="s">"row"</span><span class="p">));</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation2</span><span class="p">);</span>

<span class="c1">// Query table entities</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span> <span class="n">query</span><span class="p">;</span>
<span class="n">query</span><span class="p">.</span><span class="n">set_filter_string</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">combine_filter_conditions</span><span class="p">(</span>
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">generate_filter_condition</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"PartitionKey"</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_comparison_operator</span><span class="o">::</span><span class="n">equal</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="s">"partition"</span><span class="p">)),</span> 
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_logical_operator</span><span class="o">::</span><span class="n">and</span><span class="p">,</span> 
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">generate_filter_condition</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"RowKey"</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_comparison_operator</span><span class="o">::</span><span class="n">greater_than_or_equal</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="s">"m"</span><span class="p">))));</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="queues">
<h3>Queues</h3>
<p>最後の例では、Queueを作成します、それにmessageを追加、同じmessageを取得し、最終的にそれを更新します。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="c1">// Create a queue</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_client</span> <span class="n">queue_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_queue_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">queue_client</span><span class="p">.</span><span class="n">get_queue_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"myqueue"</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Add a queue message</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_message</span> <span class="n">message1</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"mymessage"</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">message1</span><span class="p">);</span>

<span class="c1">// Get a queue message</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_message</span> <span class="n">message2</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">get_message</span><span class="p">();</span>

<span class="c1">// Update a queue message</span>
<span class="n">message2</span><span class="p">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"changedmessage"</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">update_message</span><span class="p">(</span><span class="n">message2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>デバック方法</h3>
<p>なにか上手く行っていない場合、exception で帰ってきます。この exception は、wa::storage::storage_exception の型で、なにか問題なのかの詳細な情報を含んでいます。次のコードを見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="k">try</span>
<span class="p">{</span>
    <span class="n">blob1</span><span class="p">.</span><span class="n">download_attributes</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">storage_exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Exception: "</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">"The request that started at "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">start_time</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">" and ended at "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">end_time</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">" resulted in HTTP status code "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">http_status_code</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">" and the request ID reported by the server was "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">service_request_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>blobが存在しない場合, このコードは下記のような結果になります。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Exception: The specified blob does not exist.

The request that started at Fri, 13 Dec 2013 18:31:11 GMT and ended at Fri, 13 Dec 2013 18:31:11 GMT resulted in HTTP status code 404 and the request ID reported by the server was 5de65ae4-9a71-4b1d-9c99-cc4225e714c6
</pre></div>
</div>
<p>ライブラリでは、type wa::storage::operation_context を提供しています。これは、全てのAPIでサポートされ、操作中に行われていることについてより多くの情報を取得するために使います。次のコードを見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span/><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span> <span class="n">context</span><span class="p">;</span> 

<span class="n">context</span><span class="p">.</span><span class="n">set_sending_request</span><span class="p">([]</span> <span class="p">(</span><span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_request</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">,</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">"The request is being sent to "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">request</span><span class="p">.</span><span class="n">request_uri</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">});</span>

<span class="n">context</span><span class="p">.</span><span class="n">set_response_received</span><span class="p">([]</span> <span class="p">(</span><span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_request</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_response</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">,</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">"The reason phrase is "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">response</span><span class="p">.</span><span class="n">reason_phrase</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">});</span>

<span class="k">try</span> 
<span class="p">{</span> 
  <span class="n">blob1</span><span class="p">.</span><span class="n">download_attributes</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">access_condition</span><span class="p">(),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_request_options</span><span class="p">(),</span> <span class="n">context</span><span class="p">);</span> 
<span class="p">}</span> 
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">storage_exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Exception: "</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">}</span> 

<span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">"Executed "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">context</span><span class="p">.</span><span class="n">request_results</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">" request(s) to perform this operation and the last request's status code was "</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">context</span><span class="p">.</span><span class="n">request_results</span><span class="p">().</span><span class="n">back</span><span class="p">().</span><span class="n">http_status_code</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>もう一度、blobが存在しない状況で動かします。すると下記のような結果になります。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>wa::storage::operation_context context; 

context.set_sending_request([] (web::http::http_request&amp; request, wa::storage::operation_context) 
{ 
  ucout &lt;&lt; U("The request is being sent to ") &lt;&lt; request.request_uri().to_string() &lt;&lt; std::endl; 
});

context.set_response_received([] (web::http::http_request&amp;, const web::http::http_response&amp; response, wa::storage::operation_context) 
{ 
  ucout &lt;&lt; U("The reason phrase is ") &lt;&lt; response.reason_phrase() &lt;&lt; std::endl; 
});

try 
{ 
  blob1.download_attributes(wa::storage::access_condition(), wa::storage::blob_request_options(), context); 
} 
catch (const wa::storage::storage_exception&amp; e) 
{ 
  std::cout &lt;&lt; "Exception: " &lt;&lt; e.what() &lt;&lt; std::endl; 
} 

ucout &lt;&lt; U("Executed ") &lt;&lt; context.request_results().size() &lt;&lt; U(" request(s) to perform this operation and the last request's status code was ") &lt;&lt; context.request_results().back().http_status_code() &lt;&lt; std::endl;
</pre></div>
</div>
</div>
<div class="section" id="samples">
<h3>Samples</h3>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp/tree/master/Microsoft.WindowsAzure.Storage/samples">github 上のプロジェクトのサンプル</a>フォルダの中に、幾つかの重要なシナリを説明する コードがあります。</p>
<p>Visual Studioで「Microsoft.WindowsAzure.Storage.Samples.sln」という名前のサンプルのソリューションファイルを開きます。Microsoft.WindowsAzure.Storage.SamplesCommonプロジェクトの下samples_common.hファイルの、ストレージのアカウント情報を更新します。Solution Explorer のウィンドウに移動し、（例えば、Microsoft.WindowsAzure.Storage.BlobsGettingStarted）実行したいサンプルプロジェクトを選択してStartUp Projectにするか、コンテキストメニューから実行します。</p>
</div>
<div class="section" id="summary">
<h3>Summary</h3>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/20/windows-azure-storage-client-library-for-cplusplus-preview.aspx">コメント欄 （原文）</a>、フォーラム、あるいは<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">GitHub</a>でのフィードバックをお待ちしています。BUGに当たった場合、GitHubに上げてもらえると、その後の解決策などをトラックすることができるようになります。</p>
<p>Serdar Ozler, Mike Fisher, and Joe Giardino</p>
</div>
<div class="section" id="resources">
<h3>Resources</h3>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">Source (GitHub)</a></div>
<div class="line"><a class="reference external" href="http://www.nuget.org/packages/wastorage">Binaries (NuGet)</a></div>
<div class="line"><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></div>
<div class="line"><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h2>まとめ</h2>
<p>C++用のクライアントは良いですね、やっぱり欲しい。</p>
<p>その他に、今回<a class="reference external" href="http://coapp.org/">CoApp tools</a>が気になりました。native code をnugetでpackege化して配布するプロジェクトです。 Windows にapt-getみたいな位置づけに機能を盛り込むのを狙っているようで、期待できます。<a class="footnote-reference" href="#r4" id="id16">[4]</a>これで、python、ruby、node.js で Windows パッケージのバイナリコードのビルドに引っかかる問題も、このレポジトリを参照することで解決できると良いなあと思いますが、今のところプロジェクトのターゲットに入っていないようで、そこはちょっと残念です。</p>
<p>もう一つ、<a class="reference external" href="http://casablanca.codeplex.com/">http://casablanca.codeplex.com/</a>は、<a class="reference external" href="http://msdn.microsoft.com/library/jj969455(v=vs.120).aspx">MSDN C++ REST SDK (Codename “Casablanca”)</a>に割りとしっかりしたドキュメントが上がっていて、nugetでは、production 扱いなので、使っても良さそうな感じです。<a class="reference external" href="http://www.nuget.org/packages/cpprestsdk/">C++ REST SDK 1.4.0</a>今年の４月からパッケージとしては上がっていたようですが、気が付きませんでした。</p>
<p>nugetを見てみたところ、C++ REST SDK も、SDK、 Redist、Symbols の３本立てになってました。でも、SDKが1.4.0なのに他が1.3.1のままですね。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk/">C++ REST SDK 1.4.0</a></li>
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk.redist/">C++ REST SDK Redist 1.3.1</a></li>
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk.symbols/">C++ REST SDK Symbols 1.3.1</a></li>
</ul>
<p>パッケージマネージャー関連は、nuget を中心に、整備が進んでいるようで、いろいろ期待できますね。</p>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>日本語訳<a class="reference external" href="http://download.microsoft.com/download/C/0/2/C02C4D26-0472-4688-AC13-199EA321135E/23rdACM_SOSP_WindowsAzureStorage_201110_jpn.pdf">SOSP 論文 Windows Azure ストレージ: 高可用性と強い一貫を両立する クラウド ストレージ サービス</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Windows Azure Storage Client Library for Java v. 0.5.0</a>では、<cite>An updated Windows Azure Storage Emulator is expected to ship with full support of these new features in the next couple of months.</cite>になっていました。数ヶ月先って話だったので、来月だとすると良い知らせですね。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[3]</a></td><td>日本語訳<a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/19/blog-windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage.aspx">Windows Azure ストレージの冗長オプションと読み取りアクセス地理冗長ストレージ</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[4]</a></td><td><a class="reference external" href="http://coapp.org/news/2013-10-02-State-of-CoApp.html">The State of CoApp</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Sat, 21 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0.html</link>
            <guid>http://kyrt.in/2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0.html</guid>
            <title><![CDATA[Windows Azure Storage Client Library for Java v. 0.5.0]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Client Library for Java v. 0.5.0</h1>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Windows Azure Storage Client Library for Java v. 0.5.0 がリリースされました</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/12/27  Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/27/blog-windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Java v. 0.5.0 用 Windows Azure ストレージ クライアント ライブラリ</a></div>
</div>
</div></blockquote>
<p>以下にざっくりと訳します。</p>
<div class="section" id="windows-azure-storage-team-blog-windows-azure-storage-client-library-for-java-v-0-5-0">
<h2>抄訳 Windows Azure Storage Team Blog - Windows Azure Storage Client Library for Java v. 0.5.0</h2>
<p>このリリースでは、logging support, 新しい API overloads、そして 2013-08-15 REST<a class="footnote-reference" href="#r1" id="id2">[1]</a>が完全にサポートされています。今までのようにソースコードは、<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">github Windows Azure Storage libraries for Java</a>で公開されています。<a class="footnote-reference" href="#r2" id="id3">[2]</a>従来のようにmaven のレポジトリに登録されています。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="nt">&lt;dependency&gt;</span>  
     <span class="nt">&lt;groupId&gt;</span>com.microsoft.windowsazure.storage<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>microsoft-windowsazure-storage-sdk<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>0.5.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="section" id="id4">
<h3>エミュレータ ガイダンス</h3>
<p>現在のAzure SDK(2.2)のエミュレータは、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">2013-08-15 REST</a>をサポートしていません。今後数ヶ月以内にサポートしたものを出す予定です。</p>
</div>
<div class="section" id="samples">
<h3>Samples</h3>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">github</a>のソースのなかに、幾つかの重要なシナリを説明する<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">サンプル</a>があります。指定されたサンプルを実行するには、サンプルプロジェクトをロードし、ストレージの資格情報を提供するために、Utility.javaの次の行を更新します。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">storageConnectionString</span> <span class="o">=</span> <span class="s">"DefaultEndpointsProtocol=http;AccountName=[ACCOUNT_NAME];AccountKey=[ACCOUNT_KEY]"</span><span class="o">;</span>
</pre></div>
</div>
<p>fiddler を使ってサンプル実行中の traffic を見たい場合は、Utility.java の下記の2行をコメントアウトを外してください。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="c1">// System.setProperty("http.proxyHost", "localhost");</span>
<span class="c1">// System.setProperty("http.proxyPort", "8888");</span>
</pre></div>
</div>
</div>
<div class="section" id="note-about-packaging-and-versioning">
<h3>Note about Packaging and Versioning</h3>
<p>このリリースで、大きな Windows Azure SDK for Java から、ストレージパッケージを独立させました。現在、既存のSDKを活用している開発者は、それに応じて依存関係を更新する必要があります。さらに、パッケージ名は、この新しい構造を反映するように変更されました：</p>
<ul class="simple">
<li>com.microsoft.windowsazure.storage - RetryPolicies、LocationMode、StorageException、StorageAccountなどサービス間で共通しているすべてのpublicクラス</li>
<li>com.microsoft.windowsazure.storage.blob -  Blob convenience implementation、Windows Azure Blobを利用しているアプリケーションは、importしてください。</li>
<li>com.microsoft.windowsazure.storage.queue - Queue convenience implementation、Windows Azure Queueを利用するアプリケーションは、importしてください。</li>
<li>com.microsoft.windowsazure.storage.table - Table convenience implementation、Windows Azure Tableを利用しているアプリケーションは、importしてください。</li>
</ul>
<p>さらに詳しい情報は、以下の Change Log &amp; Breaking Changes  のセクションを見て下さい。</p>
<p>また、Storage Client SDK componentでは、<a class="reference external" href="http://semver.org/">Semantic Versioning</a>を採用します。これは、SDKを活用する開発者に一貫した予測可能なバージョン管理指針を提供するのに役立ちます。</p>
</div>
</div>
<div class="section" id="whats-new">
<h2>Whats New</h2>
<p>Java client library の 0.5.0 では、2013-08-15 REST service version の全ての機能<a class="footnote-reference" href="#r1" id="id6">[1]</a>をサポートします。</p>
<div class="section" id="support-for-read-access-geo-redundant-storage">
<h3>Support for Read Access Geo Redundant Storage</h3>
<p>このリリースでは、secondary region の storage account data の読み取りアクセス (RA-GRS)<a class="footnote-reference" href="#r3" id="id7">[3]</a>を完全にサポートしています。クライアントオブジェクト上の位置モードを設定し、getServiceStatsを起動すると、以下の例に示されている。LocationModeもRequestOptionsオブジェクト上に設定することで、リクエストごとに設定することができます。</p>
<p>下記の例では、client objectの location mode を設定して getServiceStats を呼び出すことで、 replication の状態を取得しています。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="n">CloudStorageAccount</span> <span class="n">httpAcc</span> <span class="o">=</span> <span class="n">CloudStorageAccount</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">connectionString</span><span class="o">);</span>
<span class="n">CloudTableClient</span> <span class="n">tClient</span> <span class="o">=</span> <span class="n">httpAcc</span><span class="o">.</span><span class="na">createCloudTableClient</span><span class="o">();</span>

<span class="c1">// Set the LocationMode to SECONDARY_ONLY since getServiceStats is supported only on the secondary endpoints.</span>
<span class="n">tClient</span><span class="o">.</span><span class="na">setLocationMode</span><span class="o">(</span><span class="n">LocationMode</span><span class="o">.</span><span class="na">SECONDARY_ONLY</span><span class="o">);</span>
<span class="n">ServiceStats</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">tClient</span><span class="o">.</span><span class="na">getServiceStats</span><span class="o">();</span>
<span class="n">Date</span> <span class="n">lastSyncTime</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getGeoReplication</span><span class="o">().</span><span class="na">getLastSyncTime</span><span class="o">();</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Replication status = %s and LastSyncTime = %s"</span><span class="o">,</span><span class="n">stats</span><span class="o">.</span><span class="na">getGeoReplication</span><span class="o">().</span><span class="na">getStatus</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">lastSyncTime</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">lastSyncTime</span><span class="o">.</span><span class="na">toString</span><span class="o">():</span> <span class="s">"empty"</span><span class="o">));</span>
</pre></div>
</div>
</div>
<div class="section" id="expanded-table-protocol-support-json">
<h3>Expanded Table Protocol Support (JSON)</h3>
<blockquote>
<div>table traffic で、JSONがサポートされました。TableClient の setTablePayloadFormat() で、TablePayloadFormatを指定することでJSONformatを使うことができます。</div></blockquote>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="n">CloudStorageAccount</span> <span class="n">httpAcc</span> <span class="o">=</span> <span class="n">CloudStorageAccount</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">connectionString</span><span class="o">);</span>
<span class="n">CloudTableClient</span> <span class="n">tableClient</span> <span class="o">=</span> <span class="n">httpAcc</span><span class="o">.</span><span class="na">createCloudTableClient</span><span class="o">();</span>

<span class="c1">// Set the payload format to JsonNoMetadata.</span>
<span class="n">tableClient</span><span class="o">.</span><span class="na">setTablePayloadFormat</span><span class="o">(</span><span class="n">TablePayloadFormat</span><span class="o">.</span><span class="na">JsonNoMetadata</span><span class="o">);</span>
</pre></div>
</div>
<p>JsonNoMetadataを指定した場合メタデータがpayloadに有りません、その場合プロパティの型はpropertyResolver を用意して下記のようにコードで解釈します。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Class1</span> <span class="kd">extends</span> <span class="n">TableServiceEntity</span> <span class="kd">implements</span> <span class="n">PropertyResolver</span> <span class="o">{</span>    
    <span class="kd">private</span> <span class="n">String</span> <span class="n">A</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">B</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getA</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">A</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getB</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">B</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setA</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">A</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setB</span><span class="o">(</span><span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">B</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">EdmType</span> <span class="nf">propertyResolver</span><span class="o">(</span><span class="n">String</span> <span class="n">pk</span><span class="o">,</span> <span class="n">String</span> <span class="n">rk</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"A"</span><span class="o">))</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">EdmType</span><span class="o">.</span><span class="na">STRING</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"B"</span><span class="o">))</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">EdmType</span><span class="o">.</span><span class="na">BINARY</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</pre></div>
</div>
<p>この、propertyResolver は、TableRequestOptions にセットします。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="n">Class1</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class1</span><span class="o">();</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setA</span><span class="o">(</span><span class="s">"myPropVal"</span><span class="o">);</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setB</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span> <span class="o">});</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setPartitionKey</span><span class="o">(</span><span class="s">"testKey"</span><span class="o">);</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setRowKey</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

<span class="n">options</span><span class="o">.</span><span class="na">setPropertyResolver</span><span class="o">(</span><span class="n">ref</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="table-insert-optimizations">
<h3>Table Insert Optimizations</h3>
<p>以前のバージョンでは、Table Insertのレスポンスでentity全体が返されていましたが、このバージョンから inserts が成功したときは 204 (no-content) でbodyは空がかえるようになりました。従来と同じように動作させるには、insert(TableEntity, boolean) method に true を指定します。</p>
</div>
<div class="section" id="table-reflection-optimizations">
<h3>Table Reflection Optimizations</h3>
<p>clients が、POJOを永続化するときに、繰り返しの reflection calls を無くすために、type や property information をcacheするようにしました。この最適化の結果劇的にCPU時間が削減されます。このCache機能を無効にするには、TableServiceEntity.setReflectedEntityCacheDisabled(true) を使って下さい。</p>
</div>
<div class="section" id="new-apis-and-overloads">
<h3>New APIs and overloads</h3>
<p>customer feedback から下記のAPIを追加しました、</p>
<ul class="simple">
<li>CloudBlob.downloadRange</li>
<li>CloudBlob.downloadToByteArray</li>
<li>CloudBlob.downloadRangeToByteArray</li>
<li>CloudBlob.uploadFromByteArray</li>
<li>CloudBlob.uploadFromByteArray</li>
<li>CloudBlob.downloadToFile</li>
<li>CloudBlob.uploadFromFile</li>
<li>CloudBlockBlob.uploadText</li>
<li>CloudBlockBlob.downloadText</li>
</ul>
</div>
<div class="section" id="logging">
<h3>Logging</h3>
<p>0.5.0 リリースでは、<a class="reference external" href="http://www.slf4j.org/">SLF4J</a>logging facade をサポートしています。</p>
<p>詳細省略</p>
</div>
</div>
<div class="section" id="change-log-breaking-changes">
<h2>Change Log &amp; Breaking Changes</h2>
<p>このリリースには、 2013-08-15 REST<a class="footnote-reference" href="#r1" id="id8">[1]</a>のサポート以外にも幾つかの重要な変更があります。要点を下記にまとめます。</p>
<div class="section" id="common">
<h3>Common</h3>
<ul class="simple">
<li>Package の再構築</li>
<li>RetryResultが追加機能を提供しRetryInfoに置き換えられています</li>
<li>request中に起きるevent operations (event firingを含む) は、同期では無くなりました。 (thread safety は、event listenersのCopyOnWriteArrayList で保証されます)</li>
<li>OperationContext.sendingRequest eventは、 headerを変更することができるように connection が established されるまえに fireされます</li>
</ul>
</div>
<div class="section" id="blob">
<h3>Blob</h3>
<ul class="simple">
<li>BlobdownloadRangeはStreamにダウンロードします。以前のdownloadRangeはdownloadRangeToByteArrayに変更されました</li>
<li>sparse page blob feature は削除されました</li>
<li>CloudBlobContainer.createIfNotExistはCloudBlobContainer.createIfNotExistに改名されました</li>
<li>CloudBlobClient.streamMinimumReadSizeInBytesは削除されました。この機能は、はCloudBlob.streamMinimumReadSizeInBytesで提供さえます（これは、Client毎のではなくBlob毎の設定です）</li>
<li>CloudBlobClient.pageBlobStreamWriteSizeInBytesとCloudBlobClient.writeBlockSizeInBytesは削除されました。この機能は、CloudBlob.streamWriteSizeInBytesで提供されます</li>
</ul>
</div>
<div class="section" id="table">
<h3>Table</h3>
<ul class="simple">
<li>TableResultから id field が削除されました（getId、setIdも）</li>
<li>CloudTable.createIfNotExistはCloudTable.createIfNotExistに名前が変更されました</li>
<li>Insert 操作はcontents echoをしません。</li>
<li>デフォルトのPayload形式は、JsonMinimalMetadataになりました。CloudTableClient.setTablePayloadFormatで全てのリクエスト、あるいは個々のリクエストでTableRequestOptions.setTablePayloadFormatを使ってpayload formatを変更することができます</li>
</ul>
</div>
<div class="section" id="queue">
<h3>Queue</h3>
<ul class="simple">
<li>CloudQueue.createIfNotExistはCloudQueue.createIfNotExistに名前が変更されました</li>
</ul>
</div>
</div>
<div class="section" id="resources">
<h2>Resources</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">Source (github)</a></p>
<p><a class="reference external" href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22com.microsoft.windowsazure.storage%22">Maven</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/blob/master/BreakingChanges.txt">BreakingChanges</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/blob/master/ChangeLog.txt">ChangeLog</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/11/introducing-read-access-geo-replicated-storage-ra-grs-for-windows-azure-storage.aspx">Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage</a></p>
<p><a class="reference external" href="http://semver.org/">SemVer Specification</a></p>
</div>
<div class="section" id="id9">
<h2>最後に</h2>
<p>0.4 にあった、<a class="reference internal" href="http://kyrt.in/2013/10/17/azure_java_sdk_long_value_filtering_bug.html"><span class="doc">Azure SDK for Java 0.4.6 long値のfilter BUG</span></a>は無事改修されているようです。<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/commit/834daae4e23b51e16e65e5bbf13096075d1f47ca#diff-f8d410db4741b0e56a8050948b11115c">https://github.com/WindowsAzure/azure-storage-java/commit/834daae4e23b51e16e65e5bbf13096075d1f47ca#diff-f8d410db4741b0e56a8050948b11115c</a></p>
<div class="line-block">
<div class="line">互換性の問題などから、0.4を使い続ける場合は引き続き注意が必要です。</div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id6">2</a>, <a class="fn-backref" href="#id8">3</a>)</em> version 2013-08-15 storage<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">英語</a><a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/03/blog-windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">日本語</a><a class="reference external" href="http://satonaoki.wordpress.com/2013/11/30/azure-storage-cors-json-metric/">SATO NAOKI訳</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>0.4 までは、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-java">azure-sdk-for-java</a>だったのですが、レポジトリが変わり。 0.5からは、<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">azure-storage-java</a>になりました。.NETのStorage Clientと同じような名前変更がされたようです。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/19/blog-windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage.aspx">Windows Azure ストレージの冗長オプションと読み取りアクセス地理冗長ストレージ</a></td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Fri, 20 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/17/owin_azure_cache_session_middleware.html</link>
            <guid>http://kyrt.in/2013/12/17/owin_azure_cache_session_middleware.html</guid>
            <title><![CDATA[OWIN - Open Web Interface for .NET を使う]]></title>
            <description><![CDATA[<h1>OWIN - Open Web Interface for .NET を使う</h1>
<p><a class="reference external" href="http://owin.org/">OWIN(Open Web Interface for .NET)</a>は、.NET Framework の WebサーバとWebアプリケーション接続するためのインタフェースであり、新しい HTTP Serverのプログラミング抽象化レイヤーを定義するものだ。2010年の終わりのころに<a class="reference external" href="http://bvanderveen.com/">Benjamin van der Veen 氏</a>が始め、<a class="reference external" href="http://owin.org/spec/owin-1.0.0draft7.html">Draft 7 12 July 2012</a>では、Author: OWIN working group となっている。参照:<a class="reference external" href="http://owin.org/spec/history-1.0.html">http://owin.org/spec/history-1.0.html</a></p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/7814536388"><img alt="arch by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7126/7814536388_03ac4c1eba_c.jpg"/></a>
<p>.NETでは、HTTP Serverのプログラミング抽象化レイヤーは、ASP.NETの初期のことに構築されてその後ほぼ変らずに今まで来た、<a class="reference external" href="http://www.asp.net/aspnet/overview/owin-and-katana/an-overview-of-project-katana">An Overview of Project Katana August 30, 2013 Howard Dierking</a>に、初めのころの話としてASP.NET設計時のターゲットの話が書いあり実に面白い。</p>
<p>これによると、当時（ASP.NETの初期設計時）の主なターゲットは、「Classic ASPを使っている人」と、「VB6等でWindows で業務アプリを書いている人」にWebプラットフォームプログラミングを提供することで、.NET Frameworkの一部としてリリースされるということもありあまり時間も無い中で作られたらしい。</p>
<p>その結果出来上がったのが、従来のVB6アプリの習慣に沿ったイベントモデルをベースにしたWeb Formsのアーキテクチャーと論理的に異なる HTTP ObjectとWeb Forms FrameworkがタイトにカップルされたSystem.Web.dll らしい。</p>
<p>昔を振り返ってみると、1993年の終わりころ<a class="footnote-reference" href="#r1" id="id2">[1]</a><a class="reference external" href="http://en.wikipedia.org/wiki/NCSA_HTTPd">UCSA HTTPd</a>にCGI が現れ、1996年には Windows NT 4.0 Option Pack で ASPが登場、1997年には、Java Servlet が出ている。<a class="reference external" href="http://en.wikipedia.org/wiki/ASP.NET">ASP.NETのリリースは2002年</a>なので、ASPのリリースから6年たってほぼ同じモデルを踏襲した設計になっているということになる。今は更に11年後、ASPから数えると17年経ってる、変わらないのは資産の継承という点では良い面もあるが、その間蓄積された知識が十分生かされているかどうかとかんがえるとちょっと期間が長すぎたような気もする。</p>
<p>その間Rubyを始めとする他のプラットフォームは新しいデザインを模索しており、OWINの発想のもとになっていると言われている<a class="reference external" href="http://rack.github.io/">Rack: a Ruby Webserver Interface Feb 2007</a>が生まれる。こちらは（Ruby)は、.NET と事情が違って、標準的なWebサーバとWebアプリケーション接続するためのインタフェースが存在しない中数多くのWeb サーバー、フレームワークが存在する問題への解法としてRackが生まれている。</p>
<p>.NETでは最初に標準的なWeb Server（IIS）と、Framework（System.Web.dll）ありきで始まったため混乱は無かったが自由な発展が阻害され、一方Ruby/Pythonなど標準的なものが無い中では混沌のなかから優れた標準（Rack/WSGI)が生まれたというのは実に面白い。</p>
<div class="section" id="owin">
<h2>OWINの基本</h2>
<p>The Open Web Interface for .NET (OWIN) の主要なデータ構造は２つしか無い。ひとつは、環境を保持する  environment dictionary　これに、HTTP request and response を処理するのに必要なデータは保持される。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>２つ目は、application delegate　全てのコンポーネントの間は下記の function signature で呼ばれる。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="n">Func</span><span class="p">&lt;</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="n">Task</span><span class="p">&gt;;</span>
</pre></div>
</div>
<p>Headers、Request Body、Response Body などの抽象度の高いオブジェクトを、この上に構築している。ちょっと中を見てみた感じでは、OWIN自体は非常にシンプルな構成<a class="footnote-reference" href="#r2" id="id3">[2]</a>でコンポーネント指向も高くいい感じで使えそうだ。とりあえずなにか、OWIN Middleware を作ってみようと思ったけどネタが思い付かない。どうしようかと思っていたら、<a class="reference external" href="https://github.com/neuecc/Owin.RedisSession">neuecc/Owin.RedisSession</a>なんてものを見つけ「ああOWINだとSessionすら無いのか」と気が付いて Azure Cache 版を作ってみることにした。</p>
</div>
<div class="section" id="owin-middleware-azure-cache-session">
<h2>OWIN Middleware Azure Cache Session</h2>
<p>そんなわけで、Azure Cache に Session を保存するOWIN Middleware を作成した。コードはGitHubにある<a class="reference external" href="https://github.com/takekazuomi/OwinAzureCacheSessionMiddleware">OWIN Azure Cache Session Middleware</a>手探りで作った習作だが、簡単に中身を説明する。OWIN Middleware を使って下記のような構成にする。Azure CacheとSessionのMiddlewareはブラウザとアプリケーションの間にフィルタのように入る。この手のパターンは便利でWeb Application Frameworkでは随所に出てくる。今回、CacheとSessionで分ける必要があるか迷ったが、書いてみたら分けた方がシンプルになったので分けてある。</p>
<div><a class="reference internal image-reference" href="http://kyrt.in/_images/seqdiag-8f2eeb28ecdddedcbd15b7454d37dd303aef57bf.png"><img height="372.11538461538464" src="http://kyrt.in/_images/seqdiag-8f2eeb28ecdddedcbd15b7454d37dd303aef57bf.png" width="600.0"/></a></div></div>
<div class="section" id="owin-selfhost-application">
<h2>OWIN SelfHost Applicationの作成</h2>
<p>まずは試しで、OWIN Selft Host環境を作って書いてみる。</p>
<div class="section" id="console-project">
<h3>Console Projectを作成して必要なパッケージを入れる</h3>
<p>nugetから必要なパッケージを入れる</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>install-package Microsoft.Owin.Hosting
install-package Microsoft.Owin.Host.HttpListener
install-package Microsoft.Owin.Diagnostics
install-Package Owin.Extensions
</pre></div>
</div>
</div>
<div class="section" id="program-csmain">
<h3>Program.csのmainを下記のようにする</h3>
<p><cite>WebApp.Start&lt;Startup&gt;(url)</cite>とするとlistnerを上げて、Startup Classにリクエストを回してくれる。今回の設定だと、Microsoft.Owin.Host.HttpListener が入っているのでHttpListnerを使ったSelfHostになる。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin.Hosting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">uri</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="s">"http://localhost:8081/"</span> <span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">WebApp</span><span class="p">.</span><span class="n">Start</span><span class="p">&lt;</span><span class="n">Startup</span><span class="p">&gt;(</span><span class="n">uri</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Started"</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Stopping"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="startup">
<h3>Startup用のクラスを追加する</h3>
<p><cite>[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</cite>でアプリケーションのクラスを登録する。登録されたクラスのConfiguration MethodがWebApp.Start()で実行される。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>

<span class="na">[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseWelcomePage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>これで動かすとこんな感じになる</h3>
<p>このコードでは、<cite>app.UseWelcomePage();</cite>としているので、Welcomeページが表示される。このあたりの実装は、<a class="reference external" href="http://katanaproject.codeplex.com/SourceControl/latest#src/Microsoft.Owin.Diagnostics/WelcomePageMiddleware.cs">katanaproject.codeplex.com WelcomePageMiddleware</a>見ると非常に参考になる。</p>
<img alt="../../../_images/2013_12_08_scrn-001.png" src="http://kyrt.in/_images/2013_12_08_scrn-001.png"/>
</div>
</div>
<div class="section" id="azure-cache-session-middleware">
<h2>Azure Cache Session Middleware</h2>
<p>ざっと手順を説明して、コード上のポイントを解説する。例外処理周りなどは検討の余地が多い。</p>
<div class="section" id="windows-azure-cache-client">
<h3>Windows Azure Cache Client を入れる</h3>
<div class="highlight-bash"><div class="highlight"><pre><span/>Install-Package Microsoft.WindowsAzure.Caching
</pre></div>
</div>
</div>
<div class="section" id="app-configazure-cache">
<h3>App.config内のAzure Cacheの設定をする</h3>
<p>App.config 内の configuration/dataCacheClients/dataCacheClient/autoDiscover のidentifier属性をAzure CacheのEndpointにして、securityProperties/messageSecurityのauthorizationInfo属性にManage Access Keys を設定する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"dataCacheClients"</span> <span class="na">type=</span><span class="s">"Microsoft.ApplicationServer.Caching.DataCacheClientsSection, Microsoft.ApplicationServer.Caching.Core"</span> <span class="na">allowLocation=</span><span class="s">"true"</span> <span class="na">allowDefinition=</span><span class="s">"Everywhere"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"cacheDiagnostics"</span> <span class="na">type=</span><span class="s">"Microsoft.ApplicationServer.Caching.AzureCommon.DiagnosticsConfigurationSection, Microsoft.ApplicationServer.Caching.AzureCommon"</span> <span class="na">allowLocation=</span><span class="s">"true"</span> <span class="na">allowDefinition=</span><span class="s">"Everywhere"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>
  <span class="nt">&lt;startup&gt;</span> 
    <span class="nt">&lt;supportedRuntime</span> <span class="na">version=</span><span class="s">"v4.0"</span> <span class="na">sku=</span><span class="s">".NETFramework,Version=v4.5"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/startup&gt;</span>
  <span class="nt">&lt;dataCacheClients&gt;</span>
    <span class="nt">&lt;dataCacheClient</span> <span class="na">name=</span><span class="s">"default"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!--To use the in-role flavor of Windows Azure Cache, set identifier to be the cache cluster role name --&gt;</span>
      <span class="c">&lt;!--To use the Windows Azure Cache Service, set identifier to be the endpoint of the cache cluster --&gt;</span>
      <span class="nt">&lt;autoDiscover</span> <span class="na">isEnabled=</span><span class="s">"true"</span> <span class="na">identifier=</span><span class="s">"********.cache.windows.net"</span> <span class="nt">/&gt;</span>

      <span class="c">&lt;!--&lt;localCache isEnabled="true" sync="TimeoutBased" objectCount="100000" ttlValue="300" /&gt;--&gt;</span>
      
      <span class="c">&lt;!--Use this section to specify security settings for connecting to your cache. This section is not required if your cache is hosted on a role that is a part of your cloud service. --&gt;</span>
      <span class="nt">&lt;securityProperties</span> <span class="na">mode=</span><span class="s">"Message"</span> <span class="na">sslEnabled=</span><span class="s">"false"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;messageSecurity</span> <span class="na">authorizationInfo=</span><span class="s">"*************************"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/securityProperties&gt;</span>
    <span class="nt">&lt;/dataCacheClient&gt;</span>
<span class="nt">&lt;/dataCacheClients&gt;&lt;/configuration&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="owin-middleware">
<h3>OWIN Middleware用のプロジェクトを追加する</h3>
<p>今回は、Owin.Middleware という名前で作成して、Azure CacheとSessnionのMiddlewareを作成する。<a class="reference external" href="https://github.com/takekazuomi/OwinAzureCacheSessionMiddleware/tree/master/Owin.Middleware">Owin.Middleware project</a>必要なパッケージを追加する。このプロジェクトではOWIN Hosting系のパッケージは入れない。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>install-Package Microsoft.Owin
install-Package Microsoft.WindowsAzure.Caching
install-Package EnterpriseLibrary.TransientFaultHandling.Caching
</pre></div>
</div>
</div>
<div class="section" id="azrue-cache-middleware">
<h3>Azrue Cache Middleware</h3>
<p>OWIN Middleware 定番クラスを３つ追加する。Middleware が処理の本体、Optionsは、Middlewareのオプション、Extensionsは拡張メソッドが入っている。今回は、素のOwinではなく、Microsoft.Owin を使っている。Microsoft.Owin は、Microsoftが作成したOwinの薄いラッパである程度型割り当て済みのデータを渡してくれるのでコーディングが楽になる。<a class="footnote-reference" href="#r3" id="id5">[3]</a></p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ApplicationServer.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AzureCacheMiddleware</span> <span class="p">:</span> <span class="n">OwinMiddleware</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CacheKeyName</span> <span class="p">=</span> <span class="s">"Kyrt.CacheKeyName"</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">AzureCacheOptions</span> <span class="n">_options</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">AzureCacheMiddleware</span><span class="p">(</span><span class="n">OwinMiddleware</span> <span class="n">next</span><span class="p">,</span> <span class="n">AzureCacheOptions</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_options</span> <span class="p">=</span> <span class="n">options</span> <span class="p">??</span> <span class="k">new</span> <span class="n">AzureCacheOptions</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">object</span> <span class="n">cache</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">CacheKeyName</span><span class="p">,</span> <span class="k">out</span> <span class="n">cache</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">cache</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzureCacheClient</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">CacheName</span><span class="p">);</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">[</span><span class="n">CacheKeyName</span><span class="p">]</span> <span class="p">=</span> <span class="n">cache</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">DataCacheException</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                <span class="k">throw</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">Next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Middlewareの基本的な考えは非常に簡単で Invoke の処理内で次のInvokeの前後に割り込んで処理をするだけ。AzureCacheMiddlewareでは、AzureCacheClient（中身はDataCache）を作成してEnvironmentに追加している。このケースでは、Invokeの前に処理を入れただけで、Invoke後は何もしていない。</p>
<p>オプションや拡張メソッドのクラスはおまけのようになもので大したことはしていない。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AzureCacheOptions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">AzureCacheOptions</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">CacheName</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CacheName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AzureCacheExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">IAppBuilder</span> <span class="nf">UseAzureCache</span><span class="p">(</span><span class="k">this</span> <span class="n">IAppBuilder</span> <span class="n">builder</span><span class="p">,</span> <span class="n">AzureCacheOptions</span> <span class="n">options</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">builder</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"builder"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">AzureCacheMiddleware</span><span class="p">),</span> <span class="n">options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">AzureCacheClient</span> <span class="nf">Cache</span><span class="p">(</span><span class="k">this</span> <span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"context"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">[</span><span class="n">AzureCacheMiddleware</span><span class="p">.</span><span class="n">CacheKeyName</span><span class="p">]</span> <span class="k">as</span> <span class="n">AzureCacheClient</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<p>Session Middlewareは、Invoke前処理でCacheからのSessionの復元とResponseのCookieへのセッションIDの設定、後処理でSessionの保存を行っている。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SessionMiddleware</span> <span class="p">:</span> <span class="n">OwinMiddleware</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">SessionKeyName</span> <span class="p">=</span> <span class="s">"Kyrt.Session"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">SessionMiddleware</span><span class="p">(</span><span class="n">OwinMiddleware</span> <span class="n">next</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">sessionId</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">sessionId</span> <span class="p">=</span> <span class="n">AzureCacheSessionProvidor</span><span class="p">.</span><span class="n">PreInvoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">SessionKeyName</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">Next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">ContinueWith</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">state</span> <span class="k">as</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="n">IOwinContext</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;;</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">!=</span><span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">p</span><span class="p">.</span><span class="n">Item2</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="n">AzureCacheSessionProvidor</span><span class="p">.</span><span class="n">PostInvoke</span><span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">SessionKeyName</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Item2</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
            <span class="p">},</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>アプリケーションの変更</h2>
<p>最後に、アプリケーションをCacheとSessionを使うように変更する。</p>
<div class="highlight-c#"><div class="highlight"><pre><span/><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin.Middleware</span><span class="p">;</span>

<span class="na">[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseAzureCache</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseSession</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"start app.Run {0}"</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">);</span>

                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"text/html"</span><span class="p">;</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">time</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Cache</span><span class="p">().</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="s">"first time"</span><span class="p">,</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
                    <span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Cache</span><span class="p">().</span><span class="n">Increment</span><span class="p">(</span><span class="s">"counter"</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="kt">int</span> <span class="n">sessionCount</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Session</span><span class="p">().</span><span class="n">Get</span><span class="p">(</span><span class="s">"sessionCount"</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
                    <span class="n">sessionCount</span><span class="p">++;</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Session</span><span class="p">()[</span><span class="s">"sessionCount"</span><span class="p">]</span> <span class="p">=</span> <span class="n">sessionCount</span><span class="p">;</span>

                    <span class="kt">var</span> <span class="n">msg</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"Hello, World! {0} {1}/{2} {3}&lt;br&gt;"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">sessionCount</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">);</span>
                    <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>


                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<p>OWINは、シンプルで柔軟なHTTP 抽象化レイヤーを提供してくれる。Middlewareのinvoke chain の仕組みと拡張可能なEnvironmetはシンプルだた強力だ。<a class="reference external" href="http://katanaproject.codeplex.com/">katanaproject.codeplex.com</a>を見ると認証系、View Engine、Compressionなどのmiddlewareが散見され、それぞれのコードは興味深い。ただ、現時点ではアプリケーションの構築プラットフォームとして使うには道具立てが足りないようだ。でも今回のようにAzure Cache Session Provider などを書いてみると、パフォーマンス的な問題や実装上の課題などが見えてきてなかなか勉強になるし、ブレイクスルーできるような点も見えてくる。少々フロンティア的な色が強いが挑戦する価値のある分野だと思う。</p>
<div class="line-block">
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface#cite_note-1">Server Scripts, by Rob McCool, www-talk mailing list, Sun, 14 Nov 1993</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Katana Project のコードを見ると重量級で途方にくれる。System.Web との相互運用性をもたせようとして難しいことになっているらしい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>生 Owin だと型の情報がほどんど無い(<cite>IDictionary&lt;string, object&gt;</cite>なので）ので日和ってしまった。</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ OWIN ]]></category>
             <pubDate>Tue, 17 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/11/windows_azure_storage_client_3_0_1.html</link>
            <guid>http://kyrt.in/2013/12/11/windows_azure_storage_client_3_0_1.html</guid>
            <title><![CDATA[Windows Azure Storage Client 3.0.1]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Client 3.0.1</h1>
<p>2013/12/11 Windows Azure Storage Client 3.0.1 がリリースされました。変更内容はBUG FIXのみです。<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.1">nuget:Windows Azure Storage 3.0.1</a></p>
<div class="section" id="id2">
<h2><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/changelog.txt#L176">修正点 3.0.1.0:</a></h2>
<ul class="simple">
<li>All (WP): Get/SetACL で明示的に Accept type application/xml を設定</li>
<li>Blobs: Lease operations の後で、LastModified と ETag プロパティを設定</li>
<li>Tables: Nuget package に Microsoft.Data.Services.Client への明示的な参照を追加</li>
<li>Tables: Json .NET の bug に起因したtable query responseのパース時の問題を修正。Json .NET bugの詳細:<a class="reference external" href="http://james.newtonking.com/archive/2013/11/29/fixing-jarray-getenumerator-method-not-found-bug">http://james.newtonking.com/archive/2013/11/29/fixing-jarray-getenumerator-method-not-found-bug</a></li>
<li>Tables (RT): クエリーと列挙操作の継続トークンに関する問題を修正</li>
</ul>
</div>
<div class="section" id="id3">
<h2>メモ</h2>
<p>Json .NET の bug から発生している問題は、Json .NETの5.0.5 で JArray.GetEnumerator をpublicにした結果、IEnumerableを取った時に、今までIEnumerable&lt;JToken&gt;)が返ってたのがJArray.GetEnumerator になってしまったことに起因するようです。５系の中で非互換な修正をしてしまったので、storageが使うJson .NETと他の部分で使うのが混在したときに両立出来ずにお手上げになってしまう可能性があったそうですが、このバージョンで解決されます。</p>
</div>
]]></description>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Wed, 11 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/11/windows_azure_powershel_0_7_2_release.html</link>
            <guid>http://kyrt.in/2013/12/11/windows_azure_powershel_0_7_2_release.html</guid>
            <title><![CDATA[Windows Azure PowerShell 0.7.2 リリース]]></title>
            <description><![CDATA[<h1>Windows Azure PowerShell 0.7.2 リリース</h1>
<p>Windows Azure PowerShell 0.7.2 がリリースされました。 10月の 0.7.0 、11月の 0.7.1 続く12月リリースです。最近毎月リリースされています。Azureに新機能が出ると追っかけでcmdletが追加されます。| 主な変更は、HDInsight cmdletsの追加、Web Site、VM cmdletの改善、Virtual IP reservation、Cloud Service cmdletの Visual Studio 互換です。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9207001266"><img alt="IMG_0911 by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3700/9207001266_9084fa6fc2_z.jpg"/></a>
<div class="section" id="id1">
<h2>インストール</h2>
<p>最新版はWeb Platform Installer 経由で入れられます。12/10 リリースのWindows Azure Poershell を選択してください。</p>
<img alt="../../../_images/2013_12_11_webpi001.png" src="http://kyrt.in/_images/2013_12_11_webpi001.png"/>
<p>インストールしたら念のためバージョンを確認します。Azureの所が、0.7.2ですね。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ Get-Module <span class="p">|</span> ft name,version

Name                                                        Version
----                                                        -------
Autoload                                                    <span class="m">0</span>.0
Azure                                                       <span class="m">0</span>.7.2
Microsoft.PowerShell.Management                             <span class="m">3</span>.1.0.0
Microsoft.PowerShell.Utility                                <span class="m">3</span>.1.0.0
posh-git                                                    <span class="m">0</span>.0
PsEnv                                                       <span class="m">0</span>.0
PSReadline                                                  <span class="m">1</span>.0.0.1
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>変更点</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/tree/release-0.7.2">2013.12.10 Version 0.7.2</a></p>
<ul class="simple">
<li>HDInsight cmdlets<ul>
<li>Add-AzureHDInsightConfigValues</li>
<li>Add-AzureHDInsightMetastore</li>
<li>Add-AzureHDInsightStorage</li>
<li>Get-AzureHDInsightCluster</li>
<li>Get-AzureHDInsightJob</li>
<li>Get-AzureHDInsightJobOutput</li>
<li>Get-AzureHDInsightProperties</li>
<li>New-AzureHDInsightCluster</li>
<li>New-AzureHDInsightClusterConfig</li>
<li>New-AzureHDInsightHiveJobDefinition</li>
<li>New-AzureHDInsightMapReduceJobDefinition</li>
<li>New-AzureHDInsightPigJobDefinition</li>
<li>New-AzureHDInsightSqoopJobDefinition</li>
<li>New-AzureHDInsightStreamingMapReduceJobDefinition</li>
<li>Remove-AzureHDInsightCluster</li>
<li>Revoke-AzureHDInsightHttpServicesAccess</li>
<li>Set-AzureHDInsightDefaultStorage</li>
<li>Start-AzureHDInsightJob</li>
<li>Stop-AzureHDInsightJob</li>
<li>Use-AzureHDInsightCluster</li>
<li>Wait-AzureHDInsightJob</li>
<li>Grant-AzureHDInsightHttpServicesAccess</li>
<li>Invoke-AzureHDInsightHiveJob</li>
</ul>
</li>
<li>Web Site の WebSocket と managed pipe mode の設定<ul>
<li>Set-AzureWebsite -WebSocketEnabled -ManagedPipelineMode</li>
</ul>
</li>
<li>Web Site の remote debugging 設定<ul>
<li>Enable-AzureWebsiteDebug -Version</li>
<li>Disable-AzureWebsiteDebug</li>
</ul>
</li>
<li>VM を削除した時の VHD cleaning up オプション<ul>
<li>Remove-AzureVM -DeleteVHD</li>
<li>Remove-AzureService -DeleteAll</li>
<li>Remove-AzureDeployment -DeleteVHD</li>
</ul>
</li>
<li>仮想 IP 予約 (Virtual IP reservation) preview feature (in AzurePreview module)<ul>
<li>Get-AzureDeployment</li>
<li>Get-AzureReservedIP</li>
<li>New-AzureReservedIP</li>
<li>New-AzureVM</li>
<li>Remove-AzureReservedIP</li>
</ul>
</li>
<li>下記の cmdletsでの Visual Studio Cloud Service プロジェクトのサポート<ul>
<li>Start-AzureEmulator</li>
<li>Publish-AzureServiceProject</li>
<li>Save-AzureServiceProjectPackage</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2>最後に</h2>
<p>今回の目玉は、HDInsight cmdletsかなと思いますが、個人的にはVisual Studioで作ったプロジェクトが使えるようになったのが一番嬉しいですね。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure PowerShell ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Wed, 11 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/06/azure_table_json_payload.html</link>
            <guid>http://kyrt.in/2013/12/06/azure_table_json_payload.html</guid>
            <title><![CDATA[Windows Azure Table の JSON payload]]></title>
            <description><![CDATA[<h1>Windows Azure Table の JSON payload</h1>
<p>2013/11/27 に公開された最新のWindows Azure Storageでは新しくJSON Payload Format が導入されました。変更点の詳細が Windows Azure Storage Team Blog の<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a>に出ています、興味深い内容です。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/11248464764"><img alt="mojya mojya by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3755/11248464764_54794780d3_z.jpg"/></a>
<p>翻訳は追々出ると思うので、拾い読みしながら気になったことを書きます。</p>
<blockquote>
<div><ul class="simple">
<li>[引用]JSON Payloadは、version “2013-08-15”の一部してリリースされました。JSONは従来の AtomPub<a class="footnote-reference" href="#f1" id="id1">[1]</a>フォーマットの OData payload format に比べて著しくサイズが小さくなり latency が低くなっています。また、payload size を削減するため、 insert の payload echo を Off にする方法を提供します。これらの新機能は、新しい<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Client 3.0</a>ではデフォルトの機能として働きます。</li>
</ul>
</div></blockquote>
<p>従来の HTTP request/response を見ていると無駄が目立ったので、それが削減されるのは大歓迎です。ここには、version “2013-08-15”でのplayloadの削減が書いてありますが、2013年11月（先月）ぐらいから、version “2012-02-12” の AtomPub でも余計な改行や空白を削減するなどの変更が行われています。このあたりの変更については、<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_tables_breaking_changes_2013_11.html"><span class="doc">Windows Azure Tables の Breaking Changes 2013/11</span></a>を見て下さい。</p>
<p>Insert の payload echo を Off にする話が出ていますが、version “2011-08-18” でサポートされた<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh452241.aspx">Insert Or Merge Entity (REST API)</a>ではレスポンスのBODYが空でステータスコードは204 (No Content) を返すようになっていました、これを insert でも同じように動作するモードを付けたということのようです。Insertの時にサーバー側で付与される情報はETagとTimestampだけで、それ以外は送信した内容と同じです、レスポンスヘッダーにETagは返ってくるので、エンティティ全体が帰ってこなくても困ることはほとんど無いと思います。場合によっては、Timestamp を使う場合があるかもしれませんが、その場合は設計を見直すか、エンティティ全体を返すモードで使うかになります。</p>
<div class="section" id="what-is-json">
<h2>What is JSON</h2>
<blockquote>
<div><ul class="simple">
<li>[引用]<a class="reference external" href="http://json.org/">JSON</a>(JavaScript Object Notation) は、構造化データをシリアライズするための lightweight text format です。<a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/atom-format/">AtomPub</a>と同じように、 OData extends JSON formatでは、エンティティとプロパティの一般的な規則を定義します。AtomPubは異なり、OData JSON では response payload が一部がペイロードサイズを低減するために省略されます。そのため、受信側でlink, type と control dataなどのデータを再構成ための表現力が不足しています。OData には下記のような複数の JSON フォーマットがあります:</li>
</ul>
</div></blockquote>
<p>ちょっと分かりづらいです（訳が悪いのでしょうか）、この辺りの考えは、<a class="reference external" href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/cos01/odata-json-format-v4.0-cos01.html#_Toc372793038">OData JSON Format Version 4.0 2 Candidate OASIS Standard 01 の 2.JSON Format Design</a>がわかりやすく考え方を説明してくれています。それによると、実際のpayloadからwire formatの予測可能な部分を取り除いて送信できるようにするという考えでデザインされているそうです。クライアントがデータに関するメタデータを持っているというシナリオでは毎回のpayloadに全メタ情報を載せて送る（以前のAtomPubのように）のは無駄なので省略できるようにしますという話です。どこまでメタデータを持たせるかは nometadata、minimalmetadata、fullmetadata の3段階用意しています。あとそれに伴って、name/valueのペアに順序の制約を付けています。順序の話は、Hashにそのまま読み込めなくなるので少々面倒な制約です。IDLやXML Schema のようなメタ情報を定義する仕組みを持ち込まずに、受信側のクライアントのコードで実装もしくは、JSON内にメタ情報埋め込みという話にしたのは、JSONの手軽さを損なわないという点で評価できます。</p>
<p>nometadata、minimalmetadata、fullmetadata や、JSON payload の詳細については<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dn535600.aspx">Payload Format for Table Service Operations</a>を見て下さい。</p>
</div>
<div class="section" id="atompub-vs-json-format">
<h2>AtomPub vs JSON format</h2>
<p>具体的に、AtomPubとJSONを比較してみます。JSONにすると、基本的に閉じタグが無くなるので、それだけでもかなりの削減になるのはすぐわかります。<a class="reference internal" href="http://kyrt.in/2013/12/06/azure_table_json_payload.html#fullatompub"><span class="std std-ref">AtomPub [引用]</span></a>と、<a class="reference internal" href="http://kyrt.in/2013/12/06/azure_table_json_payload.html#json-nometadata"><span class="std std-ref">JSON nometadata [引用]</span></a>を見ると一目瞭然です。<a class="reference internal" href="http://kyrt.in/2013/12/06/azure_table_json_payload.html#fullatompub"><span class="std std-ref">AtomPub [引用]</span></a>の方は、元々、<a class="reference external" href="http://ja.wikipedia.org/wiki/Atom#Atom_Publishing_Protocol">Atom Publishing Protocol</a>もので、インターネット上でのコンテンツの交換を目的として設計されたものです。Table Storageでは使われない、冗長なタグが散見されます。title、id、link、author あたりとか、namespace は不要なので、それも外してしまうと結構スッキリします。試しに、XMLで余計なタグを削った<a class="reference internal" href="http://kyrt.in/2013/12/06/azure_table_json_payload.html#xml-nometadata"><span class="std std-ref">XML nometadata （参考までに作ってみました）</span></a>というのを作ってみました。閉じタグだけはなんとも成らないですが、結構シンプルになります。これを見ると、XMLを選択した功罪というより AtomPub を選択した問題の方が大きかったことがわかります。OData/WCFの流れに拘りすぎてちょっと遠回りしてしまったようです。</p>
<p>Payloadの違いによる比較のテーブルが面白いので引用します</p>
<table border="1" class="docutils" id="id12">
<caption><span class="caption-text">To compare JSON and AtomPub</span></caption>
<colgroup>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Format</th>
<th class="head">Request Header Size</th>
<th class="head">Request Body Size</th>
<th class="head">Response Header Size</th>
<th class="head">Response Body Size</th>
<th class="head">% Savings in HTTP Body Size only vs. AtomPub</th>
<th class="head">% Savings in total HTTP transfer vs. AtomPub</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AtomPub</td>
<td>3,611</td>
<td>2,861</td>
<td>3,211</td>
<td>8,535</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr class="row-odd"><td>JSON MinimalMetadata</td>
<td>3,462</td>
<td>771</td>
<td>3,360</td>
<td>2,529</td>
<td>71%</td>
<td>44%</td>
</tr>
<tr class="row-even"><td>JSON NoMetadata</td>
<td>3,432</td>
<td>771</td>
<td>3,330</td>
<td>1,805</td>
<td>77%</td>
<td>49%</td>
</tr>
</tbody>
</table>
<div class="section" id="fullatompub">
<span id="id2"/><h3>AtomPub [引用]</h3>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;feed</span> <span class="na">xml:base=</span><span class="s">"http://someaccount.table.core.windows.net/"</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2005/Atom"</span> <span class="na">xmlns:d=</span><span class="s">"http://schemas.microsoft.com/ado/2007/08/dataservices"</span> <span class="na">xmlns:m=</span><span class="s">"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"</span> <span class="na">xmlns:georss=</span><span class="s">"http://www.georss.org/georss"</span> <span class="na">xmlns:gml=</span><span class="s">"http://www.opengis.net/gml"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;title</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;</span>Customers<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"self"</span> <span class="na">title=</span><span class="s">"Customers"</span> <span class="na">href=</span><span class="s">"Customers"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">"W/&amp;quot;datetime'2013-12-03T06%3A37%3A20.9709094Z'&amp;quot;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Jonathan',RowKey='Foster')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">"someaccount.Customers"</span> <span class="na">scheme=</span><span class="s">"http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"edit"</span> <span class="na">title=</span><span class="s">"Customers"</span> <span class="na">href=</span><span class="s">"Customers(PartitionKey='Jonathan',RowKey='Foster')"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">"application/xml"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Jonathan<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Foster<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2013-12-03T06:37:20.9709094Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>1234 SomeStreet St, Bellevue, WA 75001<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Jonathan@fourthcoffee.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2005-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">"Edm.Int32"</span><span class="nt">&gt;</span>3<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">"W/&amp;quot;datetime'2013-12-03T06%3A37%3A21.1259249Z'&amp;quot;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Lisa',RowKey='Miller')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">"someaccount.Customers"</span> <span class="na">scheme=</span><span class="s">"http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"edit"</span> <span class="na">title=</span><span class="s">"Customers"</span> <span class="na">href=</span><span class="s">"Customers(PartitionKey='Lisa',RowKey='Miller')"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">"application/xml"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Lisa<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Miller<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2013-12-03T06:37:21.1259249Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>4567 NiceStreet St, Seattle, WA 54332<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Lisa@northwindtraders.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2003-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">"Edm.Int32"</span><span class="nt">&gt;</span>2<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">"W/&amp;quot;datetime'2013-12-03T06%3A37%3A20.7628886Z'&amp;quot;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Walter',RowKey='Harp')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">"someaccount.Customers"</span> <span class="na">scheme=</span><span class="s">"http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"edit"</span> <span class="na">title=</span><span class="s">"Customers"</span> <span class="na">href=</span><span class="s">"Customers(PartitionKey='Walter',RowKey='Harp')"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">"application/xml"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Walter<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Harp<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2013-12-03T06:37:20.7628886Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>1345 Fictitious St, St Buffalo, NY 98052<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Walter@contoso.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">"Edm.DateTime"</span><span class="nt">&gt;</span>2010-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">"Edm.Int32"</span><span class="nt">&gt;</span>4<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/feed&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="json-minimalmetadata">
<span id="id3"/><h3>JSON minimalmetadata [引用]</h3>
<div class="highlight-json"><div class="highlight"><pre><span/><span class="p">{</span>
    <span class="nt">"odata.metadata"</span><span class="p">:</span><span class="s2">"http://someaccount.table.core.windows.net/$metadata#Customers"</span><span class="p">,</span>
    <span class="nt">"value"</span><span class="p">:[</span>
        <span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Jonathan"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Foster"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:39:56.6443475Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"1234 SomeStreet St, Bellevue, WA 75001"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Jonathan@fourthcoffee.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince@odata.type"</span><span class="p">:</span><span class="s2">"Edm.DateTime"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2005-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Lisa"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Miller"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:39:56.7943625Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"4567 NiceStreet St, Seattle, WA 54332"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Lisa@northwindtraders.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince@odata.type"</span><span class="p">:</span><span class="s2">"Edm.DateTime"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2003-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">2</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Walter"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Harp"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:39:56.4743305Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"1345 Fictitious St, St Buffalo, NY 98052"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Walter@contoso.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince@odata.type"</span><span class="p">:</span><span class="s2">"Edm.DateTime"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2010-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">4</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="json-nometadata">
<span id="id4"/><h3>JSON nometadata [引用]</h3>
<div class="highlight-json"><div class="highlight"><pre><span/><span class="p">{</span>
    <span class="nt">"value"</span><span class="p">:[</span>
	<span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Jonathan"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Foster"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:45:00.7254269Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"1234 SomeStreet St, Bellevue, WA 75001"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Jonathan@fourthcoffee.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2005-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">3</span>
	<span class="p">},</span>
	<span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Lisa"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Miller"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:45:00.8834427Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"4567 NiceStreet St, Seattle, WA 54332"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Lisa@northwindtraders.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2003-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">2</span>
	<span class="p">},</span>
	<span class="p">{</span>
            <span class="nt">"PartitionKey"</span><span class="p">:</span><span class="s2">"Walter"</span><span class="p">,</span>
            <span class="nt">"RowKey"</span><span class="p">:</span><span class="s2">"Harp"</span><span class="p">,</span>
            <span class="nt">"Timestamp"</span><span class="p">:</span><span class="s2">"2013-12-03T06:45:00.5384082Z"</span><span class="p">,</span>
            <span class="nt">"Address"</span><span class="p">:</span><span class="s2">"1345 Fictitious St, St Buffalo, NY 98052"</span><span class="p">,</span>
            <span class="nt">"Email"</span><span class="p">:</span><span class="s2">"Walter@contoso.com"</span><span class="p">,</span>
            <span class="nt">"PhoneNumber"</span><span class="p">:</span><span class="s2">"425-555-0101"</span><span class="p">,</span>
            <span class="nt">"CustomerSince"</span><span class="p">:</span><span class="s2">"2010-01-05T00:00:00Z"</span><span class="p">,</span>
            <span class="nt">"Rating"</span><span class="p">:</span><span class="mi">4</span>
	<span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="xml-nometadata">
<span id="id5"/><h3>XML nometadata （参考までに作ってみました）</h3>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="nt">&lt;Feed&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Jonathan<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Foster<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.6443475Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>1234 SomeStreet St, Bellevue, WA 75001<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Jonathan@fourthcoffee.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2005-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>3<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Lisa<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Miller<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.7943625Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>4567 NiceStreet St, Seattle, WA 54332<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Lisa@northwindtraders.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2003-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>2<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Walter<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Harp<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.4743305Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>1345 Fictitious St, St Buffalo, NY 98052<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Walter@contoso.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2010-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>4<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
<span class="nt">&lt;/Feed&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>書き始めたら案外知らないことが多く。てっきり、OData V3 の JSON<a class="footnote-reference" href="#f2" id="id7">[2]</a>、<cite>Content-Type: application/json;odata=verbose</cite>、<cite>json light (content-type : application/json; odata=light)</cite>が使われているのかと思ったら、いつの間にかOData Version 4.0 JSON<a class="footnote-reference" href="#f3" id="id8">[3]</a>なんてものがあって、そっちが使われていたことに気が付いたり。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Client 3.0</a>で使っている、<a class="reference external" href="http://www.nuget.org/packages/Microsoft.Data.OData/5.6.0">ODataLib 5.6.0</a>から OData V4をサポートしているらしい<a class="footnote-reference" href="#f4" id="id10">[4]</a>ということが分かったりということで手間取りました。</p>
<p>じゃあ、ODataLib 5.6.0 のコードちょっと見ておくかと思ったら、odata.codeplex.com の ODataLib は2011年から放置状態になっていて（これは知ってました）、<a class="reference external" href="http://www.symbolsource.org/Public/Metadata/NuGet/Project/Microsoft.Data.Services/5.6.0">http://www.symbolsource.org/Public/Metadata/NuGet/Project/Microsoft.Data.Services/5.6.0</a>からコードが確認できるってことに気が付いたりで手間取りました。</p>
<p>今回は前半しか紹介できていないので、そのうち続きを書きたいと思います。</p>
<div class="section" id="resources">
<h3>Resources</h3>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/atom-format/">AtomPub</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td><a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/json-verbose-format/">OData V3 JSON Verbose Format</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[3]</a></td><td><a class="reference external" href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/odata-json-format-v4.0.html">OData JSON Format Version 4.0 Candidate OASIS Standard 01 19 November 2013</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[4]</a></td><td>OData V4 のstackが、ODataLib として提供されることがコメントに書いてある<a class="reference external" href="http://blogs.msdn.com/b/astoriateam/archive/2013/08/26/wcf-data-services-5-6-0-release.aspx">WCF Data Services 5.6.0 Release</a></td></tr>
</tbody>
</table>
</div>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
             <pubDate>Fri, 06 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/06/github_windows_azure_storage_libraries_for_net_3_0.html</link>
            <guid>http://kyrt.in/2013/12/06/github_windows_azure_storage_libraries_for_net_3_0.html</guid>
            <title><![CDATA[GitHub/Windows Azure Storage Libraries for .NET 3.0.0]]></title>
            <description><![CDATA[<h1>GitHub/Windows Azure Storage Libraries for .NET 3.0.0</h1>
<p>3.0.0では、GitHub上の Windows Azure Storage の .NET Client ライブラリの場所が変わりました。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9269858396"><img alt="leaf by Takekazu Omi, on Flickr" class="align-center" src="http://farm6.staticflickr.com/5471/9269858396_5b59a95e64_z.jpg"/></a>
<p>Storage の .NET Client ライブラリは、2.1までは、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET github:azure-sdk-for-net</a>にありましたが、3.0からは、Storageは独立して<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Libraries for .NET github:azure-storage-net</a>になりました。2.1系は継続して、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET github:azure-sdk-for-net</a>でメンテされるようです。現在2.1系の最新は、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/tree/v2.1.0.4">2.1.0.4</a>です。</p>
<p>今後<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET</a>は、<a class="reference external" href="http://www.nuget.org/packages/Microsoft.WindowsAzure.ConfigurationManager/">Windows Azure Configuration Manager</a>や<a class="reference external" href="http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Libraries/0.9.2-preview">Windows Azure Management Libraries</a>の場所ということになりそうです。</p>
<p>最初は、Windows Azure SDK for .NET という名前で、中身がStorageのライブラリで始まって、そのうち Configuration Manager が追加、Management Libraries が追加され、Media関連はディレクトリはあるけど別レポジトリ、とだんだん膨れてわかり辛くなってきたところだったので整理するにはいいタイミングだった気がします。</p>
<div class="section" id="breaking-changes">
<h2>Breaking Changes</h2>
<p><a class="reference internal" href="http://kyrt.in/2013/12/05/minute_metrics_storage_version_2013_08_15.html"><span class="doc">Windows Azure Storage 2013-08-15 の Minute Metrics</span></a>で、3.0の変更点が分からないと書きましたが、レポジトリの<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/BreakingChanges.txt#L33">BreakingChanges.txt</a>に記載がありました。</p>
<p>３つあります。簡単にまとめます。</p>
<ol class="arabic simple">
<li>テーブルの操作にDataServiceContextを使った場合、OperationContextのresponse received eventは no longer fired（もはや起こらない）</li>
<li>ContinuationToken の WriteXml()/ReadXml()が変更されました。詳細は原文を参照してください。</li>
<li>ServiceProperties では、uploadされたものだけが変更されます。例えば、CORSの設定だけをすると、Logging と Metering 関連の設定は変更されません。</li>
</ol>
<p>ServicePropertiesのプロパティが変更された件などは、上記 Breaking Changes に書いてありませんので互換性に関しては注意が必要だと思います。</p>
</div>
<div class="section" id="id3">
<h2>まとめ</h2>
<p>このレポジトリの移動に関して<a class="reference internal" href="http://kyrt.in/2013/11/28/cors_json_minute_metrics_and_more.html"><span class="doc">Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介</span></a>に下記のような記述があります。</p>
<blockquote>
<div><div class="line-block">
<div class="line">これらの機能に対応した、Windows Azure Storage Client Library を <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">github:azure-storage-net</a> にリリースします。</div>
</div>
</div></blockquote>
<p>今までのレポジトリを見てソースが上がってこないので、3.0のソースは公開されないのかと思って困惑していましたが、無事ソースも確認できて安心しました。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Fri, 06 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/05/minute_metrics_storage_version_2013_08_15.html</link>
            <guid>http://kyrt.in/2013/12/05/minute_metrics_storage_version_2013_08_15.html</guid>
            <title><![CDATA[Windows Azure Storage 2013-08-15 の Minute Metrics]]></title>
            <description><![CDATA[<h1>Windows Azure Storage 2013-08-15 の Minute Metrics</h1>
<p><a class="reference external" href="http://qiita.com/advent-calendar/2013/azure">Windows Azure Advent Calendar 2013 - Qiita [キータ]</a>の 5 日目の記事です。最初Javaネタを書こうと思ってたのですが、11/27にWindows Azure Storageの新しいバージョン(x-ms-version:2013-08-15)が公開され盛り上がっているのでストレージネタに切り替えました。</p>
<p>新バージョンに付いては以前に書いているので、それを見て下さい。</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/">Windows Azure Storage Team Blog</a> で、新しいWindows Azure Storageのリリースが紹介されています。<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></div>
</div>
</div></blockquote>
<p>立派な訳が出てるので、こちらも合わせてどうぞ。</p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/11/30 翻訳が出ました。S/N RATIO BY SATO NAOKI <a class="reference external" href="http://satonaoki.wordpress.com/2013/11/30/azure-storage-cors-json-metric/">Windows Azureストレージのリリース – CORS、JSON、分単位メトリックなど</a></div>
</div>
<div class="line-block">
<div class="line">2013/12/20  Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/03/blog-windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure ストレージのリリース - CORS、JSON、分単位メトリックなど各種機能の導入</a></div>
</div>
</div></blockquote>
<p>久しぶりのストレージ のリリースで機能盛り沢山なのですが<a class="footnote-reference" href="#f1" id="id2">[1]</a>、その中でもパフォーマンスジャンキー注目の Minute Metrics （分単位メトリックス）を紹介します。機能紹介だけだと面白くないので脱線しながら書きますのでお楽しみ下さい。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9204218499"><img alt="DEAD END by takekazu, on Flickr" class="align-center" src="http://farm6.staticflickr.com/5498/9204218499_3d95538ae6_z.jpg"/></a>
<div class="section" id="minute-metrics">
<h2>Minute Metrics （分単位メトリックス）とは</h2>
<p>今まで、Windows Azure StorageのMetricsは時間集計でした。<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh343258.aspx">Storage Analytics Metrics の詳細</a>新しい 2013-08-15 version のMinute Metrics では、5分以内に 分単位の集計（Minute Metrics） が参照できるようになりました。それに伴って下記のテーブルが追加されています。</p>
<blockquote>
<div><ul class="simple">
<li>$MetricsHourPrimaryTransactionsBlob</li>
<li>$MetricsHourPrimaryTransactionsTable</li>
<li>$MetricsHourPrimaryTransactionsQueue</li>
<li>$MetricsMinutePrimaryTransactionsBlob</li>
<li>$MetricsMinutePrimaryTransactionsTable</li>
<li>$MetricsMinutePrimaryTransactionsQueue</li>
</ul>
</div></blockquote>
<p>Hourと付いているのは、以前の $MetricsTransactionsBlob、$MetricsTransactionsTable、$MetricsTransactionsQueue の名前が変わったものです。古い名前のものもありますが、Minute Metrics の導入に伴って命名規則が整理されたようです。今のところ Windows Azure Portal では分単位の設定はできませんが、将来サポートされるそうです。</p>
<p>名前を見ていて面白いのは、Primary という文字列が入っていることです。もしかしたら、GEO replication 先のメトリックスも見れるようになるんじゃないかと思って、「$MetricsMinuteSecondaryTransactionsTable」って名前でテーブルを参照してみました。</p>
<p>エラーには成らなかったのですが、下記のようなレスポンスでTableは空のようです。<a class="footnote-reference" href="#f2" id="id3">[2]</a></p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 200 OK
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 9e39e71e-70ea-41b3-be3e-b7a6231315b0
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Thu, 05 Dec 2013 12:00:39 GMT

83
{"odata.metadata":"http://waac2013omi001diag.table.core.windows.net/$metadata#$MetricsMinuteSecondaryTransactionsTable","value":[]}
0
</pre></div>
</div>
<p>ちなみに、$で始まる適当な名前でリクエストを流すと400 Bad Requestで、リソースに不正な文字が含まれているというエラーになります。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 400 Bad Request
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 272dce2f-ac46-46b7-b59d-b0338cefa78b
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Thu, 05 Dec 2013 11:57:59 GMT

DE
{"odata.error":{"code":"InvalidResourceName","message":{"lang":"en-US","value":"The specifed resource name contains invalid characters.\nRequestId:272dce2f-ac46-46b7-b59d-b0338cefa78b\nTime:2013-12-05T11:58:00.5348125Z"}}}
0
</pre></div>
</div>
<p>メトリックス系のテーブルは下記のようにListTableでも帰ってこないので存在するかどうかは難しいところですが、エラーにならないところを見ると特別扱いされているようで期待してしまいます。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>var tables = tableClient.ListTables("$Metrics");
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>Minute Metrics （分単位メトリックス）を有効にする</h2>
<p>Minute Metricsを有効にするには、xms-version:2013-08-15 を指定して、Set Service Properties REST APIを使います。今回は、<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.0">Widnows Azure Storage Client 3.0.0</a>を使います。今のところ<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.0">Widnows Azure Storage Client 3.0.0</a>のドキュメントがほぼ存在しないのですが、nugetで入れるとデフォルトでは入ります。設定は、ServiceProperties に、Version、MetricsLevel、RetentionDays（保存期間）を入れて、CreateCloud(Blob|Table|Queue)ClientのSetServicePropertiesを呼ぶだけです、簡単ですね。下記のコードだと、Loggingと時間集計メトリックスの設定も同時にやっています。Minute MetricsのRetentionの期間は従来と同じで日付なのでデータ量には要注意です。従来の時間単位集計に比べて60倍のデータが蓄積されます。<a class="footnote-reference" href="#f3" id="id6">[3]</a></p>
<div class="highlight-none"><div class="highlight"><pre><span/>private static void SetStorageAnalytics(CloudStorageAccount account)
{
    var serviceProperty = new ServiceProperties
    {
        Logging = new LoggingProperties
        {
            Version = "1.0",
            LoggingOperations = LoggingOperations.All,
            RetentionDays = 7,

        },
        HourMetrics = new MetricsProperties
        {
            Version = "1.0",
            MetricsLevel = MetricsLevel.ServiceAndApi,
            RetentionDays = 7
        },
        MinuteMetrics = new MetricsProperties
        {
            Version = "1.0",
            MetricsLevel = MetricsLevel.ServiceAndApi,
            RetentionDays = 1
        }
    };
    account.CreateCloudBlobClient().SetServiceProperties(serviceProperty);
    account.CreateCloudTableClient().SetServiceProperties(serviceProperty);
    account.CreateCloudQueueClient().SetServiceProperties(serviceProperty);

}
</pre></div>
</div>
<p>このコード書いていてServicePropertiesのプロパティで「あれ？」と思いました。以前は、ServicePropertiesは、LoggingProperties と MetricsProperties の２つのプロパティを持っていたのですが、3.0では MetricsProperties が無くなって HourMetrics になってしまっているようです、Table側は古い名前も残してあるのに、ライブラリは Braking Changesにしてしまったようですね。このあたりの判断は難しいところなのでしょうが、古い名前もあっても良い気がします。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/v2.1.0.4/microsoft-azure-api/Services/Storage/Lib/Common/Shared/Protocol/ServiceProperties.cs#L97">2.1.0.4 ServiceProperties.cs</a></p>
<p>nugetから無条件で最新版として入るのに前のバージョンと互換性が無いっていうのは大胆な気がしますが、なんらかの事情でちょっとドキュメントが遅れているだけなのでしょう。</p>
<p>実行してリクエスト、レスポンスを覗いてみます。</p>
<div class="section" id="http-request">
<h3>http request</h3>
<div class="highlight-none"><div class="highlight"><pre><span/>PUT http://waac2013omi001diag.blob.core.windows.net/?comp=properties&amp;restype=service&amp;timeout=90 HTTP/1.1
User-Agent: WA-Storage/3.0.0 (.NET CLR 4.0.30319.34003; Win32NT 6.3.9600.0)
x-ms-version: 2013-08-15
x-ms-client-request-id: 56bffee5-4626-4835-b254-af38a1520242
x-ms-date: Thu, 05 Dec 2013 12:39:54 GMT
Authorization: SharedKey ********************************************************
Host: waac2013omi001diag.blob.core.windows.net
Content-Length: 626
Connection: Keep-Alive

&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;StorageServiceProperties&gt;&lt;Logging&gt;&lt;Version&gt;1.0&lt;/Version&gt;&lt;Delete&gt;true&lt;/Delete&gt;&lt;Read&gt;true&lt;/Read&gt;&lt;Write&gt;true&lt;/Write&gt;&lt;RetentionPolicy&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;Days&gt;7&lt;/Days&gt;&lt;/RetentionPolicy&gt;&lt;/Logging&gt;&lt;HourMetrics&gt;&lt;Version&gt;1.0&lt;/Version&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;RetentionPolicy&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;Days&gt;7&lt;/Days&gt;&lt;/RetentionPolicy&gt;&lt;IncludeAPIs&gt;true&lt;/IncludeAPIs&gt;&lt;/HourMetrics&gt;&lt;MinuteMetrics&gt;&lt;Version&gt;1.0&lt;/Version&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;RetentionPolicy&gt;&lt;Enabled&gt;true&lt;/Enabled&gt;&lt;Days&gt;1&lt;/Days&gt;&lt;/RetentionPolicy&gt;&lt;IncludeAPIs&gt;true&lt;/IncludeAPIs&gt;&lt;/MinuteMetrics&gt;&lt;Cors /&gt;&lt;/StorageServiceProperties&gt;
</pre></div>
</div>
</div>
<div class="section" id="http-response">
<h3>http response</h3>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 202 Accepted
Transfer-Encoding: chunked
Server: Windows-Azure-Blob/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 650e2253-9e51-43e5-90bd-6077ef43ef31
x-ms-version: 2013-08-15
Date: Thu, 05 Dec 2013 12:39:47 GMT

0
</pre></div>
</div>
<p>リクエストで、ServicePropertiesに設定した内容を投げていますがXMLなんですね。ここはJSONじゃないのかと思ったけど、そんなにトラフィックが多いところじゃないので問題ないですね。シンプルでいい感じです。</p>
</div>
</div>
<div class="section" id="id7">
<h2>Minute Metrics （分単位メトリックス）の結果</h2>
<p>細かい確認ができていないのですが、結果自体はテーブル名が違うだけで従来の時間集計と同じものが出てるようです。パーテションキーが単位で採番されています。</p>
<table border="1" class="docutils" id="id10">
<caption><span class="caption-text">Minute Metricsの例</span></caption>
<colgroup>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
<col width="17%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">PartitionKey</th>
<th class="head">RowKey</th>
<th class="head">TotalIngress</th>
<th class="head">TotalEgress</th>
<th class="head">AverageE2ELatency</th>
<th class="head">AverageServerLatency</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>20131205T0303</td>
<td>user;All</td>
<td>393</td>
<td>59079</td>
<td>352</td>
<td>53</td>
</tr>
<tr class="row-odd"><td>20131205T0303</td>
<td>user;QueryEntities</td>
<td>393</td>
<td>59079</td>
<td>352</td>
<td>53</td>
</tr>
<tr class="row-even"><td>20131205T0304</td>
<td>system;All</td>
<td>8057</td>
<td>9452</td>
<td>20</td>
<td>19</td>
</tr>
<tr class="row-odd"><td>20131205T0304</td>
<td>user;All</td>
<td>2188</td>
<td>15747</td>
<td>46.833333</td>
<td>5.166667</td>
</tr>
<tr class="row-even"><td>20131205T0304</td>
<td>user;QueryEntities</td>
<td>1478</td>
<td>14291</td>
<td>68.5</td>
<td>6.25</td>
</tr>
<tr class="row-odd"><td>20131205T0304</td>
<td>user;QueryTables</td>
<td>710</td>
<td>1456</td>
<td>3.5</td>
<td>3</td>
</tr>
<tr class="row-even"><td>20131205T0305</td>
<td>system;All</td>
<td>24161</td>
<td>28398</td>
<td>14.333333</td>
<td>13.333333</td>
</tr>
<tr class="row-odd"><td>20131205T0305</td>
<td>user;All</td>
<td>2041</td>
<td>13787</td>
<td>268.5</td>
<td>5.75</td>
</tr>
<tr class="row-even"><td>20131205T0305</td>
<td>user;GetTableServiceProperties</td>
<td>338</td>
<td>584</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="row-odd"><td>20131205T0305</td>
<td>user;QueryEntities</td>
<td>1703</td>
<td>13203</td>
<td>357.333333</td>
<td>7</td>
</tr>
<tr class="row-even"><td>20131205T0306</td>
<td>system;All</td>
<td>32239</td>
<td>37972</td>
<td>17.25</td>
<td>16</td>
</tr>
<tr class="row-odd"><td>20131205T0307</td>
<td>system;All</td>
<td>23475</td>
<td>27904</td>
<td>15</td>
<td>14.5</td>
</tr>
</tbody>
</table>
<p><a class="reference download internal" href="http://kyrt.in/_downloads/20131205-minutemetrics-sample.zip" download=""><span class="xref download docutils literal"><span class="pre">表だと厳しいのでcsvをどうぞ</span> <span class="pre">(zip)</span></span></a></p>
</div>
<div class="section" id="id8">
<h2>まとめ</h2>
<p>Minute Metrics は出てくるまで少々遅延(5分ぐらい？)があるようですが、分単位のメトリックスが見れるのは助かります。簡単な負荷テストの結果を確認するのにも使えます。今回はStorage Clinet 3.0を使いましたが、現時点ではGitHubにコードが出ていない、変更点のドキュメントが無いなど少々使いづらいところがあります。もし新機能にこだわりが無いなら、あの嫌らしいCastのBUGも治ってますし2.1.0.4 を使うのが良いと思います。今回のように、Minute Metricsの設定がしたいというなら、Storage Clinet 3.0 が必要です。あと、ServicePropertiesに、CorsPropertiesが追加されているので、CROS が使いたい場合も3.0が便利だと思います。</p>
</div>
<div class="section" id="id9">
<h2>訂正 2013/12/06</h2>
<p>訂正です。Storage Clinet 3.0は、現時点ではGitHubにコードが出ていないと書きましたが、正式名称 Windows Azure Storage Libraries for .NET のソースは<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">github:azure-storage-net</a>で公開されています。</p>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>日本リージョン、IaaSのGAなど大きな話題が続いている Azure 全体に比べると地味ですね。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>レスポンスのbodyがJSONですね、このバージョンからJSONがサポートされています。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>当たり前ですね</td></tr>
</tbody>
</table>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
             <pubDate>Thu, 05 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/12/03/windows_azure_sdk_for_ruby_release_0_6_0.html</link>
            <guid>http://kyrt.in/2013/12/03/windows_azure_sdk_for_ruby_release_0_6_0.html</guid>
            <title><![CDATA[Windows Azure SDK for Ruby Release 0.6.0]]></title>
            <description><![CDATA[<h1>Windows Azure SDK for Ruby Release 0.6.0</h1>
<p>Windows Azure SDK for Ruby 0.6.0 がリリースされました。2013/04/25に 0.5.0 が出て以来7ヶ月ぶりのリリースです。RubyGemsから入ります</p>
<div class="highlight-ruby"><div class="highlight"><pre><span/><span class="no">INISTALL</span> <span class="o">&gt;</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">azure</span>
</pre></div>
</div>
<div class="section" id="id1">
<h2>新機能</h2>
<p>0.6.0では、主にmanagement APIの追加とBUG修正が行われたようです。</p>
<ul class="simple">
<li>service management API のライブラリとして下記のものが追加されています。<ul>
<li>Virtual Machine</li>
<li>Virtual Machine Image</li>
<li>Virtual Network</li>
<li>Cloud Service</li>
<li>Storage</li>
<li>Sql Database</li>
<li>Location and Affinity Group</li>
</ul>
</li>
</ul>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-ruby/blob/master/ChangeLog.txt#L1">ChangeLog.txt</a></div>
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-ruby">GitHub WindowsAzure/azure-sdk-for-ruby</a></div>
<div class="line"><a class="reference external" href="http://rubygems.org/gems/azure">RubyGems Azure</a></div>
</div>
</div>
<div class="section" id="get-blob-properties-bug">
<h2>get_blob_properties のBUG修正</h2>
<p><a class="reference external" href="https://github.com/takekazuomi/azure-sdk-for-ruby/commit/f52ce92c9276544720ab45d150f96d4d5bf2de7b">5月にPRを出した修正</a>も取り込まれてリリースされました。これで、Blobのプロパティを取ったらBodyが付いてくるという大きな問題は解決されたことになります。</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-ruby/commits/master/lib/azure/blob/blob_service.rb">azure/blob/blob_service.rb</a></div>
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-ruby/commits/master/lib/azure/core/http/http_error.rb">azure/core/http/http_error.rb</a></div>
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-ruby/commits/master/lib/azure/core/http/http_response.rb">azure/core/http/http_response.rb</a></div>
</div>
<p>これで出すに出せなかったやつが出せるようになります。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure SDK ]]></category>
            <category><![CDATA[ Ruby ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Tue, 03 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/11/30/fixed_storage_client_cast_problem_in_2013_08_15_version.html</link>
            <guid>http://kyrt.in/2013/11/30/fixed_storage_client_cast_problem_in_2013_08_15_version.html</guid>
            <title><![CDATA[Storage Client 2.1.0.4 以降での Cast問題の修正]]></title>
            <description><![CDATA[<h1>Storage Client 2.1.0.4 以降での Cast問題の修正</h1>
<p>Storage Client 2.0.3以前と、最新のWindows Azure Storage の組み合わせで発生していた<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a>が最新(2.1.0.4, 3.0.0 2013/11/29 現在)では解決されているようです。正式なアナウンスはまだ有りませんが、必要な方は以下の検証結果を参考にしてください。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/8216154715"><img alt="red takekazu, on Flickr" src="http://farm9.staticflickr.com/8062/8216154715_53106b0941_z.jpg"/></a>
<div class="section" id="issue">
<h2>issueの再現</h2>
<p>まずは、問題が報告されているStorage Clinet 2.1.0.3で再現することを確認します。再現コードは<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a>で提示されているものを使います。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">GetEntities</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">CloudTable</span> <span class="n">table</span><span class="o">)</span>  <span class="n">where</span> <span class="n">T</span> <span class="o">:</span> <span class="n">ITableEntity</span><span class="o">,</span> <span class="k">new</span><span class="o">()</span>
<span class="o">{</span>
    <span class="n">IQueryable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">CreateQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;().</span><span class="na">Where</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">PartitionKey</span> <span class="o">==</span> <span class="s">"1"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">ToList</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<p>nugetで、問題のあるバージョンのライブラリをインストールします:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Install-Package WindowsAzure.Storage -Version 2.1.0.3
</pre></div>
</div>
<div class="section" id="id1">
<h3>実行結果</h3>
<p><a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a>で報告されている通り、http requestのtraceのGET URLに$filter=castの文字列が入ってしまっており、http responseのtraceでは、400 Bad Requestになっているのが確認できました。x-ms-versionは、 2012-02-12 です。</p>
<p>http requestのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>GET http://asdpojasldfj001.table.core.windows.net/people?$filter=cast%28%27%27%29%2FPartitionKey%20eq%20%271%27&amp;timeout=90 HTTP/1.1
User-Agent: WA-Storage/2.1.0.3 (.NET CLR 4.0.30319.34003; Win32NT 6.3.9600.0)
x-ms-version: 2012-02-12
Accept: application/atom+xml,application/xml
Accept-Charset: UTF-8
MaxDataServiceVersion: 2.0;NetFx
x-ms-client-request-id: af7cf5c3-c287-4c1f-a9fe-ee0b6c374317
x-ms-date: Fri, 29 Nov 2013 23:25:01 GMT
Authorization: SharedKey asdpojasldfj001:*********************************************
Host: asdpojasldfj001.table.core.windows.net
</pre></div>
</div>
<p>http responseのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 400 Bad Request
Transfer-Encoding: chunked
Content-Type: application/xml;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: abf14b12-7a80-4b75-a652-604c56bdb817
x-ms-version: 2012-02-12
X-Content-Type-Options: nosniff
Date: Fri, 29 Nov 2013 23:25:01 GMT

131
&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;error xmlns="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"&gt;&lt;code&gt;InvalidInput&lt;/code&gt;&lt;message xml:lang="en-US"&gt;One of the request inputs is not valid.
RequestId:abf14b12-7a80-4b75-a652-604c56bdb817
Time:2013-11-29T23:25:02.0389849Z&lt;/message&gt;&lt;/error&gt;
0
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>2.1.0.4 での修正確認</h2>
<p>nugetの履歴によると<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage">nuget.org: Windows Azure Storage</a>2013/11/27 に、2.1.0.4と、3.0.0が同時にリリースされています。同じコードをライブラリのバージョンだけ変更して実行します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Install-Package WindowsAzure.Storage -Version 2.1.0.4
</pre></div>
</div>
<div class="section" id="id3">
<h3>実行結果</h3>
<p>GET URLがスッキリして、結果は 200 OK が帰ってきています。FIXされているようです。</p>
<p>http requestのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>GET http://asdpojasldfj001.table.core.windows.net/people?$filter=PartitionKey%20eq%20%271%27&amp;timeout=90 HTTP/1.1
User-Agent: WA-Storage/2.1.0.4 (.NET CLR 4.0.30319.34003; Win32NT 6.3.9600.0)
x-ms-version: 2012-02-12
Accept: application/atom+xml,application/xml
Accept-Charset: UTF-8
MaxDataServiceVersion: 2.0;NetFx
x-ms-client-request-id: e9319d53-b9eb-41c6-9a93-63566842984e
x-ms-date: Fri, 29 Nov 2013 23:33:17 GMT
Authorization: SharedKey asdpojasldfj001:*********************************************
Host: asdpojasldfj001.table.core.windows.net
</pre></div>
</div>
<p>http responseのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 200 OK
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/atom+xml;type=feed;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: d1056e7a-f0ff-4ab4-b5a4-4b546eb48515
x-ms-version: 2012-02-12
X-Content-Type-Options: nosniff
Date: Fri, 29 Nov 2013 23:33:17 GMT

96A
&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;feed xml:base="http://asdpojasldfj001.table.core.windows.net/" xmlns="http://www.w3.org/2005/Atom" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata"&gt;&lt;id&gt;http://asdpojasldfj001.table.core.windows.net/people&lt;/id&gt;&lt;title type="text"&gt;people&lt;/title&gt;&lt;updated&gt;2013-11-29T23:33:18Z&lt;/updated&gt;&lt;link rel="self" title="people" href="people" /&gt;&lt;entry m:etag="W/&amp;quot;datetime'2013-11-28T10%3A24%3A23.5715047Z'&amp;quot;"&gt;&lt;id&gt;http://asdpojasldfj001.table.core.windows.net/people(PartitionKey='1',RowKey='1')&lt;/id&gt;&lt;category term="asdpojasldfj001.people" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /&gt;&lt;link rel="edit" title="people" href="people(PartitionKey='1',RowKey='1')" /&gt;&lt;title /&gt;&lt;updated&gt;2013-11-29T23:33:18Z&lt;/updated&gt;&lt;author&gt;&lt;name /&gt;&lt;/author&gt;&lt;content type="application/xml"&gt;&lt;m:properties&gt;&lt;d:PartitionKey&gt;1&lt;/d:PartitionKey&gt;&lt;d:RowKey&gt;1&lt;/d:RowKey&gt;&lt;d:Timestamp m:type="Edm.DateTime"&gt;2013-11-28T10:24:23.5715047Z&lt;/d:Timestamp&gt;&lt;d:Data&gt;foo&lt;/d:Data&gt;&lt;/m:properties&gt;&lt;/content&gt;&lt;/entry&gt;&lt;entry m:etag="W/&amp;quot;datetime'2013-11-28T10%3A21%3A02.0298712Z'&amp;quot;"&gt;&lt;id&gt;http://asdpojasldfj001.table.core.windows.net/people(PartitionKey='1',RowKey='2')&lt;/id&gt;&lt;category term="asdpojasldfj001.people" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /&gt;&lt;link rel="edit" title="people" href="people(PartitionKey='1',RowKey='2')" /&gt;&lt;title /&gt;&lt;updated&gt;2013-11-29T23:33:18Z&lt;/updated&gt;&lt;author&gt;&lt;name /&gt;&lt;/author&gt;&lt;content type="application/xml"&gt;&lt;m:properties&gt;&lt;d:PartitionKey&gt;1&lt;/d:PartitionKey&gt;&lt;d:RowKey&gt;2&lt;/d:RowKey&gt;&lt;d:Timestamp m:type="Edm.DateTime"&gt;2013-11-28T10:21:02.0298712Z&lt;/d:Timestamp&gt;&lt;d:Data&gt;foo&lt;/d:Data&gt;&lt;/m:properties&gt;&lt;/content&gt;&lt;/entry&gt;&lt;entry m:etag="W/&amp;quot;datetime'2013-11-29T23%3A16%3A04.1332012Z'&amp;quot;"&gt;&lt;id&gt;http://asdpojasldfj001.table.core.windows.net/people(PartitionKey='1',RowKey='3')&lt;/id&gt;&lt;category term="asdpojasldfj001.people" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" /&gt;&lt;link rel="edit" title="people" href="people(PartitionKey='1',RowKey='3')" /&gt;&lt;title /&gt;&lt;updated&gt;2013-11-29T23:33:18Z&lt;/updated&gt;&lt;author&gt;&lt;name /&gt;&lt;/author&gt;&lt;content type="application/xml"&gt;&lt;m:properties&gt;&lt;d:PartitionKey&gt;1&lt;/d:PartitionKey&gt;&lt;d:RowKey&gt;3&lt;/d:RowKey&gt;&lt;d:Timestamp m:type="Edm.DateTime"&gt;2013-11-29T23:16:04.1332012Z&lt;/d:Timestamp&gt;&lt;d:Data&gt;foo&lt;/d:Data&gt;&lt;/m:properties&gt;&lt;/content&gt;&lt;/entry&gt;&lt;/feed&gt;
0
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>おまけの 3.0.0 での修正確認</h2>
<p>同じことを最新の 3.0.0 でやりました。バッチリ動きます。x-ms-versionが 2013-08-15になって結果がjsonになっています:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Install-Package WindowsAzure.Storage -Version 2.1.0.4
</pre></div>
</div>
<p>http requestのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>GET http://asdpojasldfj001.table.core.windows.net/people?$filter=PartitionKey%20eq%20%271%27&amp;timeout=90 HTTP/1.1
User-Agent: WA-Storage/3.0.0 (.NET CLR 4.0.30319.34003; Win32NT 6.3.9600.0)
x-ms-version: 2013-08-15
Accept-Charset: UTF-8
MaxDataServiceVersion: 3.0;NetFx
Accept: application/json;odata=minimalmetadata
x-ms-client-request-id: 5b6e366f-dde8-4ec0-b433-10fac62c117d
x-ms-date: Fri, 29 Nov 2013 23:17:23 GMT
Authorization: SharedKey asdpojasldfj001:*********************************************
Host: asdpojasldfj001.table.core.windows.net
</pre></div>
</div>
<p>http responseのtrace:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>HTTP/1.1 200 OK
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: fa6db02e-b080-4bc4-8761-1016920fb1b0
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Fri, 29 Nov 2013 23:17:22 GMT

168
{"odata.metadata":"http://asdpojasldfj001.table.core.windows.net/$metadata#people","value":[{"PartitionKey":"1","RowKey":"1","Timestamp":"2013-11-28T10:24:23.5715047Z","Data":"foo"},{"PartitionKey":"1","RowKey":"2","Timestamp":"2013-11-28T10:21:02.0298712Z","Data":"foo"},{"PartitionKey":"1","RowKey":"3","Timestamp":"2013-11-29T23:16:04.1332012Z","Data":"foo"}]}
0
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>ソースコード上の修正点</h2>
<p>2.1.0.4はgithub上でコードが公開されているので、レポジトリ上の修正点を確認しましょう。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/changelog.txt#L162">ChangeLog</a>では:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Issues fixed in 2.1.0.4 :
  - Tables: Do not send the cast operator in the table query filter string.
</pre></div>
</div>
<p>microsoft-azure-api/Services/Storage/Lib/Common/Table/Queryable/ExpressionWriter.cs で、2.1でExpressionをURLに展開するときのUnaryの処理にcastを使ってしまっていたのを削除したようです。</p>
<p>修正のCommitは、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/commit/d34d1e881c7f744f5343cc6fab031b6c4a716caf">XSCL 2.1.0.4 - Hotfix</a>で、ソースは、<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/30ef61170e1d745d75fec09f1fb9c0a1dd94fa1f/microsoft-azure-api/Services/Storage/Lib/Common/Table/Queryable/ExpressionWriter.cs">ExpressionWriter.cs</a>です。</p>
<p>残念ながら、3.0.0は、まだコードが公開されていないので確認することができません。</p>
</div>
<div class="section" id="id6">
<h2>まとめ</h2>
<p>2.1.0.4/3.0.0では、<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a>の問題はFIXされています。そのうちアナウンスは出ると思いますが、必要な場合は試してみてください。<a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html"><span class="doc">Windows Azure Storage Known Issues 2013/11</span></a>で報告されていた幾つかの問題の中で、Cast問題はスマートに回避するのが難しいものだったので、これで解決されて助かります。これ以外のものはどちらということ利用者側のコードに問題がある場合に起きる問題な気がします。</p>
<p>本題とは外れますが、今回の場合では、363 byte(json) と、2,436 byte (xml)とhttp responseのbodyのサイズが大きく違い期待以上に良好な結果になっています。今回はデータが非常に小さいのでmeta 情報部分が冗長なxmlのオーバーヘッドが目立つ結果になっているのでしょうが、それにしても大きな違いです。</p>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ GitHub観察記 ]]></category>
             <pubDate>Sat, 30 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/11/28/cors_json_minute_metrics_and_more.html</link>
            <guid>http://kyrt.in/2013/11/28/cors_json_minute_metrics_and_more.html</guid>
            <title><![CDATA[Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介</h1>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/">Windows Azure Storage Team Blog</a>で、新しいWindows Azure Storageのリリースが紹介されています。<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/11/30 翻訳が出ました。S/N RATIO BY SATO NAOKI <a class="reference external" href="http://satonaoki.wordpress.com/2013/11/30/azure-storage-cors-json-metric/">Windows Azureストレージのリリース – CORS、JSON、分単位メトリックなど</a></div>
</div>
<div class="line-block">
<div class="line">2013/12/20  Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/03/blog-windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure ストレージのリリース - CORS、JSON、分単位メトリックなど各種機能の導入</a></div>
</div>
</div></blockquote>
<p>以下に抜粋で内容を紹介します。</p>
<div class="section" id="id2">
<h2>3つの主要な機能</h2>
<ol class="arabic">
<li><p class="first">CORS (Cross Origin Resource Sharing):Windows Azure Blobs, Tables, Queues でCORS が有効できるようにになった。これによって、browser から異なったドメインのリソースへのアクセス・操作ができる。CORS は、Service Properties の 設定で有効化。詳しくは<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dn535601.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dn535601.aspx</a>を参照してください。</p>
</li>
<li><p class="first">JSON (JavaScript Object Notation): 現在、Windows Azure Table は、<a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/">OData 3.0</a>の<a class="reference external" href="http://www.json.org/">JSON format</a>をサポートしている。JSON format では、AtomPub XML payloadの冗長な部分が削減されより効率的な転送になる。</p>
<p>JSONは下記3つの形式でサポート</p>
<ul class="simple">
<li>No Metadata - これは最も効率的なformatで、クライアントがカスタムプロパティのデータ型を知っている場合に便利です</li>
<li>Minimal Metadata - この形式は、暗黙的に解釈できない特定の種類のカスタムプロパティのデータ型情報が含まれている。例えば、Azure Table Browserのような、一般的なツールのように保存されているEntityのデータ型を知らないで読まなければいけない場合に便利です</li>
<li>Full Metadata - このフォーマットは、 generic OData readers で読む場合に便利です</li>
</ul>
<p>Windows Azure TableのJSONについての詳細情報は<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dn535600.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dn535600.aspx</a>を参照してださい。</p>
</li>
<li><p class="first">Windows Azure Storage Analytics の Minute Metrics: 今まで、Windows Azure StorageのMetricsは時間集計でした。（<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh343258.aspx">Storage Analytics Metrics の詳細</a>） 新しい 2013-08-15 version では、 いくつかの主要な値に付いて 5分以内に 分集計（Minute Metrics） が取得できるようになります。それに伴って下記のテーブルを追加します。</p>
<ul class="simple">
<li>$MetricsHourPrimaryTransactionsBlob</li>
<li>$MetricsHourPrimaryTransactionsTable</li>
<li>$MetricsHourPrimaryTransactionsQueue</li>
<li>$MetricsMinutePrimaryTransactionsBlob</li>
<li>$MetricsMinutePrimaryTransactionsTable</li>
<li>$MetricsMinutePrimaryTransactionsQueue</li>
</ul>
<p>時間集計のテーブル名が変わっているので注意してください。古いテーブルも継続して存在します。</p>
<p>分集計の設定は、2013-08-15 version を設定して、Set Service Properties REST APIを使います。現在  Windows Azure Portal では設定ができませんが、将来サポートされる予定です。</p>
<p>詳細情報は、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh343258.aspx">About Storage Analytics Metrics</a>を見てくだい。</p>
</li>
</ol>
</div>
<div class="section" id="id3">
<h2>その他の追加機能</h2>
<p>これらの他の2013-8-15 versionでは、以下の機能を実装しています。2013-8-15 version の変更詳細のリストは：<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx</a>にあります。</p>
<ul class="simple">
<li>Copy blob で、Shared Access Signature (SAS) を、コピー先にも適応します。（同じstorage accountの場合）</li>
<li>Windows Azure Blob service は、Content-Disposition と response headers の cache-control などの ability control (via. SAS）をサポートします。Content-Disposition は、Set Blob Properties で設定します。</li>
<li>Windows Azure Blob service は、Get Blob と Get Blob Propertiesで、複数の HTTP conditional header をサポートします。この機能は、web-browsers which から CDN servers 経由でアクセスする場合に有用です。</li>
<li>Windows Azure Blob Service は、uncommitted blobはある状態での、Delete Blob operation をサポートします。以前は、事前にcommitしないとdelete Blob出来ませんでした。</li>
<li>List Containers, List Blobs と List Queues は、2013-08-15 version から、resourceに、URL address field を含みません。 これは、clientで再構築できる fields を削減したためです。</li>
<li>Lease Blob と Lease Container は、2013-08-15 version から、ETag と Last Modified Time を response headers で返します。これによって、lease holder は最後に見た時から、リソースが変更されたかどうかを簡単に確認することができます。（つまり、blob や その metadata が更新されたか)。以前と同じくblob の lease operations では、ETagは変更されません。</li>
</ul>
<p>これらの機能に対応した、Windows Azure Storage Client Library を<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">github:azure-storage-net</a>にリリースします。数ヶ月で、Windows AzureのSDK 2.2、Windows Azure Storage Emulatorのアップデートをリリースする予定です。この更新は、2013-08-15 version の新機能をサポートします。</p>
<p>既知の問題が幾つかあります。下記の記事を参照してください。</p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx</a><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-breaking-changes-for-windows-azure-tables-november-2013.aspx">http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-breaking-changes-for-windows-azure-tables-november-2013.aspx</a></p>
<p>以上</p>
</div>
<div class="section" id="id4">
<h2>最後に</h2>
<p>Azure Storage Client (Windows Azure Storage)は、3.0.0がリリースされています。nugetは<a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/">nuget:WindowsAzure.Storage</a>Dependenciesを見ると、Microsoft.Data.OData 5.6以上になっているので、既存のコードとコンフリクトするかもしれません、要注意です。BUILD 2013で話が出てきたStorageの新機能の一部がまだ出てきていないようなので、年末に向けてさらに期待しています。負荷試験している時とかはMinute Metricsは便利ですね、嬉しいです。</p>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Azure Storage ]]></category>
             <pubDate>Thu, 28 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/11/28/using_helios_on_azure_cloud_service.html</link>
            <guid>http://kyrt.in/2013/11/28/using_helios_on_azure_cloud_service.html</guid>
            <title><![CDATA[Helios を Azure Cloud Service で使う]]></title>
            <description><![CDATA[<h1>Helios を Azure Cloud Service で使う</h1>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference internal" href="http://kyrt.in/2013/11/28/using_helios_on_azure_cloud_service.html#helios-fix-runtime"><span class="std std-ref">2013/12/13 追記</span></a> Microsoft.Owin.Host.IIS 0.1.1-pre では、<a class="reference internal" href="http://kyrt.in/2013/11/28/using_helios_on_azure_cloud_service.html#helios-startuptask"><span class="std std-ref">WebRoleのStartup taskの作成</span></a> の問題は解決されました。</div>
</div>
</div></blockquote>
<p>巷で話題のHeliosをCloud Serviceで使おうとしたらちょっとハマりました。基本的には、<a class="reference external" href="http://weblog.west-wind.com/posts/2013/Nov/23/Checking-out-the-Helios-IIS-Owin-Web-Server-Host">Checking out the Helios IIS Owin Web Server Host</a>と同じですが、Cloud Service、WebRoleの組み合わせでDeployしたら下記のようなエラーになります。</p>
<a class="reference internal image-reference" href="http://kyrt.in/_images/2013_11_helios009.png"><img alt="../../../_images/2013_11_helios009.png" class="align-center" src="http://kyrt.in/_images/2013_11_helios009.png" style="width: 600px;"/></a>
<p>最初、なにかアセンブリが足りないのかと思って、Fusion Logを調べたりしていたのですが、結局Helios内で使っているnavite code dllが依存しているVC12のランタイムが無かったという話でした。startup taskを用意してVC12のランタイムを入れてやると上手く動くようになります。</p>
<p>ここでは、Cloud Serviceの作成から、Heliosの組み込み、startup taskの作成まで一通り説明します。</p>
<div class="section" id="id1">
<h2>手順の確認</h2>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="webrolehelios">
<h3>WebRoleの作成からHeliosのインストールまで</h3>
<ol class="arabic simple">
<li>Cloud Service を作ってWebRoleを追加します普通にCloudServiceを作成し、WebRoleを追加します。テンプレートはEmptyにします</li>
</ol>
<a class="reference internal image-reference" href="http://kyrt.in/_images/2013_11_helios003.png"><img alt="../../../_images/2013_11_helios003.png" class="align-center" src="http://kyrt.in/_images/2013_11_helios003.png" style="width: 600px;"/></a>
<ol class="arabic simple" start="2">
<li>projectを、.NET 4.5.1 を使うようにします</li>
</ol>
<a class="reference internal image-reference" href="http://kyrt.in/_images/2013_11_helios004.png"><img alt="../../../_images/2013_11_helios004.png" class="align-center" src="http://kyrt.in/_images/2013_11_helios004.png" style="width: 600px;"/></a>
<ol class="arabic" start="3">
<li><p class="first">コンパイルして問題無いのを確認します。</p>
</li>
<li><p class="first">System.Webの参照を全て削除します</p>
</li>
<li><p class="first">nugetを使って、Microsoft.Owin.Host.IISをインストールします:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>Install-Package Microsoft.Owin.Host.IIS -Pre
</pre></div>
</div>
</li>
</ol>
<p>下記のような参照になります</p>
<img alt="../../../_images/2013_11_helios006.png" class="align-center" src="http://kyrt.in/_images/2013_11_helios006.png"/>
</div>
<div class="section" id="startup-class">
<h3>Startup Classの設定</h3>
<p>下記のようなStartup classのコードを追加します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>using System;
using Microsoft.Owin;
using Owin;

[assembly: OwinStartup(typeof(WebRole1.Startup))]

namespace WebRole1
{
    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {

            app.Run(async context =&gt;  // IOWinContext
            {
                context.Response.StatusCode = 200;
                context.Response.ContentType = "text/html";

                await context.Response.WriteAsync("Hello Herios. Time is: " + DateTime.Now.ToString());
            });
        }
    }
}
</pre></div>
</div>
<p>これで、WebRoleを動かしてみて、動くことを確認します。</p>
</div>
<div class="section" id="webrolestartup-task">
<span id="helios-startuptask"/><h3>WebRoleのStartup taskの作成</h3>
<p><a class="reference external" href="http://www.nuget.org/packages/Microsoft.Owin.Host.IIS/0.1.0-pre">Helios 0.1.0</a>の中で使われている、unmanaged codeがmsvcr120.dllに依存しているので、動作環境ではVC12 のランタイムが必要です。ここでは、WebRoleのstartup taskでVC12のランタイムをインストールする方法を説明します。</p>
<img alt="../../../_images/2013_11_helios007.png" class="align-center" src="http://kyrt.in/_images/2013_11_helios007.png"/>
<p>ServiceDefinition.csdefに下記の定義を追加します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;ServiceDefinition name="HelloHelios" xmlns="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition" schemaVersion="2013-10.2.2"&gt;
  &lt;WebRole name="WebRole1" vmsize="Small"&gt;
    &lt;Startup&gt;
      &lt;Task commandLine="startup.cmd" executionContext="elevated" taskType="simple" /&gt;
    &lt;/Startup&gt;

    &lt;Sites&gt;
    以下省略・・・・
</pre></div>
</div>
<p>WebRoleのプロジェクトに、startup.cmdというbatchファイルとvcredist_x64.exeを追加して、プロパティで出力ディレクトリにコピーするように設定します。</p>
<dl class="docutils">
<dt>startup.cmd::</dt>
<dd>vcredist_x64.exe /install /quiet</dd>
</dl>
<p>vcredist_x64.exe は、<a class="reference external" href="http://www.microsoft.com/ja-jp/download/details.aspx?id=40784">Visual Studio 2013 の Visual C++ 再頒布可能パッケージ</a>からダウンロードできます。VS 2013をインストールしている場合は、<cite>C:Program Files (x86)Microsoft Visual Studio 12.0VCredist</cite>等のディレクトリにファイルがあります。</p>
<p>startup taskについて：<a class="reference external" href="http://msdn.microsoft.com/ja-jp/library/windowsazure/hh180155.aspx">Windows Azure でスタートアップ タスクを実行する</a></p>
</div>
<div class="section" id="osfamily">
<h3>osFamilyの変更</h3>
<p>.NET Framework 4.5.1は、Windows Server 2012R2では最初から入っています。簡単なので、osFamilyを4にして.NET Framework 4.5.1を使います。</p>
<p>ServiceConfiguration.(Local|Cloud).cscfgのosFamilyを3から4に変更します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;ServiceConfiguration serviceName="HelloHelios" xmlns="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceConfiguration" osFamily="4" osVersion="*" schemaVersion="2013-10.2.2"&gt;
  &lt;Role name="WebRole1"&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>まとめ</h2>
<p><a class="reference external" href="http://www.nuget.org/packages/Microsoft.Owin.Host.IIS/0.1.0-pre">Helios 0.1.0</a>runtimeには、native codeのDLLが含まれている。このDLLは、VC12(VS2013)のランタイム、msvcr120.dllに依存している。msvcr120.dllは、Cloud Service のWindows 2013R2 サーバーに存在しない。vcredist_x64.exeを使うとmsvcr120.dllがインストールされて問題が解決する。この問題は、厳密に言うと<a class="reference external" href="http://www.nuget.org/packages/Microsoft.Owin.Host.IIS/0.1.0-pre">Microsoft.Owin.Host.IIS 0.1.0-pre</a>が使っている、<a class="reference external" href="http://www.nuget.org/packages/Microsoft.AspNet.Loader.IIS/0.1.0-pre">Microsoft.AspNet.Loader.IIS 0.1.0-pre</a>に起因する。このままだとちょっと使いづらいですね。</p>
</div>
<div class="section" id="helios-fix-runtime">
<span id="id4"/><h2>2013/12/13 追記</h2>
<p>2013/12/02<a class="reference external" href="http://www.nuget.org/packages/Microsoft.Owin.Host.IIS/0.1.1-pre">Microsoft.Owin.Host.IIS 0.1.1-pre</a>では、<a class="reference external" href="http://www.nuget.org/packages/Microsoft.AspNet.Loader.IIS/0.1.1-pre">Microsoft.AspNet.Loader.IIS 0.1.1-pre</a>に含まれる。Microsoft.AspNet.Loader.IIS.Interop.dll がMSVCR120.DLLに依存しなくなりました。そのため、<a class="reference internal" href="http://kyrt.in/2013/11/28/using_helios_on_azure_cloud_service.html#helios-startuptask"><span class="std std-ref">WebRoleのStartup taskの作成</span></a>のようなことをしないでも動作します。これで普通に使えるようになりますね。</p>
<img alt="../../../_images/2013_11_helios011.png" src="http://kyrt.in/_images/2013_11_helios011.png"/>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Helios ]]></category>
            <category><![CDATA[ OWIN ]]></category>
             <pubDate>Thu, 28 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html</link>
            <guid>http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html</guid>
            <title><![CDATA[Windows Azure Storage Known Issues 2013/11]]></title>
            <description><![CDATA[<h1>Windows Azure Storage Known Issues 2013/11</h1>
<blockquote>
<div><div class="line-block">
<div class="line">2013/11/29 以下の内容は正式な日本語訳が出ています <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/11/29/blog-windows-azure-storage-known-issues.aspx">Windows Azure ストレージの既知の問題</a></div>
</div>
<div class="line-block">
<div class="line">2013/11/30 <a class="reference internal" href="http://kyrt.in/2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><span class="std std-ref">Table Query での Cast 問題</span></a> が解決されたStorage Client Libraryがリリースされています。検証記事 <a class="reference internal" href="http://kyrt.in/2013/11/30/fixed_storage_client_cast_problem_in_2013_08_15_version.html"><span class="doc">Storage Client 2.1.0.4 以降での Cast問題の修正</span></a></div>
</div>
</div></blockquote>
<p>cros, json 対応などのmajor releaseの準備に伴って実装が変更されているようです。それが原因でいくつかの意図しない問題が発生していることが報告されています。以下は Windows Azure Storage の Blog<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">Windows Azure Storage Known Issues (November 2013)</a>からの抜粋です。これらの問題が修正されプロダクションに公開され次第 Blog の記事は更新されるということです。</p>
<div class="section" id="windows-azure-blobs-tables-and-queue-shared-access-signature-sas-issue">
<span id="known-issue-20131101"/><h2>Windows Azure Blobs, Tables and Queue Shared Access Signature (SAS)のIssue</h2>
<ul class="simple">
<li>下記のような、2012-02-12 バージョンのSASが、 HTTP Status Code 400 (Bad Request)になります。従来の実装だと、コンテナの前の<cite>“//”</cite>は、<cite>“/”</cite>に折りたたまれて処理されていましたが、現時点ではコンテナが無効である（null）として解釈されてしまいます。これは、修正される予定ですが、当面は<cite>“//”</cite>を送らないようにして下さい</li>
</ul>
<p><cite>http://myaccount.blob.core.windows.net//container/blob?sv=2012-02-12&amp;si=sasid&amp;sx=xxxx</cite></p>
</div>
<div class="section" id="windows-azure-tablesissue">
<h2>Windows Azure TablesのIssue</h2>
<p>下記の2つの既知のissueがあります。サービス側または当社のクライアント·ライブラリの一部としてhotfixを出す予定です。</p>
<ol class="arabic simple" id="known-issue-20131102">
<li>clients で、<cite>DataServiceContext.ResolveName</cite>を定義し、<cite>&lt;Account Name&gt;.&lt;Table Name&gt;</cite>以外の型の名前を指定すると、CUD operation が 400 (Bad Request) を返します。これは、新しい実装では、ATOM の “Category” element の term 属性が、&lt;Account Name&gt;.&lt;Table Name&gt; と同じで無ければいけないのが原因です。以前のバージョン（実装）では、送信された型の名前は無視していました。これは再び無視するように修正される予定ですが、それまでの間は次の回避策を検討してください。ResolveName の設定は、Azure Tables では必要無いのでclient application のから外してください。そうすると OData の “category” element は送信されません。</li>
</ol>
<p>下記は問題が発生するコードの例です。これを実行するとサーバー側で失敗します。</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="n">CloudTableClient</span> <span class="n">cloudTableClient</span> <span class="o">=</span> <span class="n">storageAccount</span><span class="o">.</span><span class="na">CreateCloudTableClient</span><span class="o">();</span>
<span class="n">TableServiceContext</span> <span class="n">tableServiceContext</span> <span class="o">=</span> <span class="n">cloudTableClient</span><span class="o">.</span><span class="na">GetDataServiceContext</span><span class="o">();</span>
<span class="n">tableServiceContext</span><span class="o">.</span><span class="na">ResolveName</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">(</span><span class="n">Type</span> <span class="n">entityType</span><span class="o">)</span>
<span class="o">{</span>
<span class="c1">// This would cause class name to be sent as the value for term in the category element and service would return Bad Request.</span>
<span class="k">return</span> <span class="n">entityType</span><span class="o">.</span><span class="na">FullName</span><span class="o">;</span>
<span class="o">};</span>

<span class="n">SimpleEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleEntity</span><span class="o">(</span><span class="s">"somePK"</span><span class="o">,</span> <span class="s">"someRK"</span><span class="o">);</span>
<span class="n">tableServiceContext</span><span class="o">.</span><span class="na">AddObject</span><span class="o">(</span><span class="s">"sometable"</span><span class="o">,</span> <span class="n">entity</span><span class="o">);</span>
<span class="n">tableServiceContext</span><span class="o">.</span><span class="na">SaveChanges</span><span class="o">();</span>
</pre></div>
</div>
<p>この Issue の解決のためには client 側で<cite>tableServiceContext.ResolveName</cite>delegate の設定を外してください。</p>
<ol class="arabic simple" id="known-issue-201311" start="2">
<li>service updateの一環として、サーバー側で使っている新しい .NET WCF Data Services library は、$filter query の 一部に empty “cast” があると 400 (Bad Request) で拒否します。古い .NET framework libraryではそうではありませんでした。これによって、Windows Azure Storage Client Library 2.1のIQueryable implementationに影響が出ます。.NET の DataServiceContext の挙動を、cast を送信しないようにクライアントライブラリを修正中です。これは、数週間以内に利用できるようになります( this should be available in the next couple of weeks )それまでの間次の回避策を検討してください。このクライアントライブラリの問題では、IEnumerable&lt;T&gt; で ITableEntityインターフェイスに制約するのでは無く、インスタンス化される型を明示的に使うことで回避できます。</li>
</ol>
<p>下記は問題があるコードです</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="kd">static</span> <span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">GetEntities</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">CloudTable</span> <span class="n">table</span><span class="o">)</span>  <span class="n">where</span> <span class="n">T</span> <span class="o">:</span> <span class="n">ITableEntity</span><span class="o">,</span> <span class="k">new</span><span class="o">()</span>
<span class="o">{</span>
    <span class="n">IQueryable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">CreateQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;().</span><span class="na">Where</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">PartitionKey</span> <span class="o">==</span> <span class="s">"mypk"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">ToList</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<p>このように書くと 2.1 storage client library の IQueryable interface は、下記のUriに展開されて新しい service updateでは、400 (Bad Request) で拒否されます</p>
<p><cite>http://myaccount.table.core.windows.net/invalidfiltertable?$filter=cast%28%27%27%29%2FPartitionKey%20eq%20%27mypk%27&amp;timeout=90</cite></p>
<p>コードを下記のように変更してquery の castを取り除いてください。そうすれば、cast operator は送信されません</p>
<div class="highlight-java"><div class="highlight"><pre><span/><span class="n">IQueryable</span><span class="o">&lt;</span><span class="n">SimpleEntity</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">CreateQuery</span><span class="o">&lt;</span><span class="n">SimpleEntity</span><span class="o">&gt;().</span><span class="na">Where</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="na">PartitionKey</span> <span class="o">==</span> <span class="s">"mypk"</span><span class="o">);</span>
<span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">ToList</span><span class="o">();</span>
</pre></div>
</div>
<p>Uri request は下記のようになり、service に受け付けられます</p>
<p><cite>http://myaccount.table.core.windows.net/validfiltertable?$filter=PartitionKey%20eq%20%27mypk%27&amp;timeout=90</cite></p>
<p>We apologize for these issues and we are working on a hotfix to address them. (我々はこれらの問題について謝罪し、我々はそれらに対処するための修正プログラムに取り組んでいます)</p>
</div>
<div class="section" id="id1">
<h2>感想、コメント等</h2>
<ul class="simple">
<li>最後の Uriに cast operatorが出てしまって、それがあるとサーバーではねられて 400 (Bad Request) というのは嵌りそうです。回避策もなかなか厳しい気がします。</li>
<li>コンテナの前が<cite>//</cite>になってるとSASが効かないっていうのは、自前でUriを作成していると起きそうな気がします。要注意ですね。</li>
<li>ResolveName の件は、DataServiceContextにあって、TableServiceContextでは動作に関係しないものという混乱の原因になりがちなやつです。元々意味無かったはずなので、外せば良いと思います。</li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sun, 24 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/11/24/windows_azure_tables_breaking_changes_2013_11.html</link>
            <guid>http://kyrt.in/2013/11/24/windows_azure_tables_breaking_changes_2013_11.html</guid>
            <title><![CDATA[Windows Azure Tables の Breaking Changes 2013/11]]></title>
            <description><![CDATA[<h1>Windows Azure Tables の Breaking Changes 2013/11</h1>
<blockquote>
<div><div class="line-block">
<div class="line">2013/11/29 以下の内容は正式な日本語訳が出ています <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/11/29/blog-windows-azure-tables-breaking-changes.aspx">Windows Azure テーブルにおける重大な（互換性のない）変更</a></div>
</div>
</div></blockquote>
<p>Azure Storage Team より、Windows Azure Table のJSONサポート準備のため Table の response が一部変更されている旨アナウンスされました。基本的に、HTTP、AtomPubの規格内の変更で互換性を保てるように最大限の努力をしているということですが、自前のカスタムパーサーを書いている場合などは問題になるかもしれません。</p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-breaking-changes-for-windows-azure-tables-november-2013.aspx">Windows Azure Tables Breaking Changes (November 2013)</a>から変更点を紹介します。</p>
<div class="section" id="id1">
<h2>変更点</h2>
<ol class="arabic simple">
<li>新しいリリースでは、AtomPub response は、XML要素の間に改行、空白がありません。</li>
<li>AtomPub XML Responce内のXML element（title、idなど）は、順番が変更される場合があります。</li>
<li>HTTP HeaderのContent-Typeに”type” placeholder が追加されました。例えば, query の response (point query以外) は、content type に charset と application/atom+xmlに、<cite>type=feed</cite>が追加されます変更前: Content-Type: application/atom+xml;charset=utf-8変更後: Content-Type: application/atom+xml;type=feed;charset=utf-8</li>
<li>MIME type のセキュリティ リスクの削減のための新しいresponse header<cite>X-Content-Type-Options: nosniff</cite>が返されます。参照：<a class="reference external" href="http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx</a></li>
</ol>
</div>
<div class="section" id="id2">
<h2>感想等</h2>
<ul class="simple">
<li>手元のアカウントで確認してみたら既に上記の通りに変更されていました。事前に予告が欲しいです。</li>
<li>改行、空白が無くなった件は、今までのは、「XMLが element毎に改行されインデントされてるようなフォーマットで人が読むわけではないのに転送データ量が増えてMOTTAINAI」と思ってたので妥当な変更な気がします。これは、普通のXML parsersを通していれば問題になることは無さそうですし。</li>
<li>XML element の順番の件は引っかかるとちょっと面倒ですが、元々AtomPubの仕様に沿ったものなので無茶な話ではないと思います。</li>
<li>AtomPub内のXML elementの順番に関しては、<a class="reference external" href="http://www.futomi.com/lecture/japanese/rfc4287.html#s4_1_1">RFC 4287 The Atom Syndication Format 日本語訳</a>が参考になります。feedの中のelementはどんな順番で出てきても良いことになっていますね。</li>
<li>HTTP ヘッダーの変更は、ここまでパースしていることがあまり無いような気がするので、「影響はあまり無いのかな」という気がします。</li>
</ul>
<p>json対応に向けて着々と進んでいるのは、とても嬉しいです。</p>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sun, 24 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/10/17/azure_java_sdk_long_value_filtering_bug.html</link>
            <guid>http://kyrt.in/2013/10/17/azure_java_sdk_long_value_filtering_bug.html</guid>
            <title><![CDATA[Azure SDK for Java 0.4.6 long値のfilter BUG]]></title>
            <description><![CDATA[<h1>Azure SDK for Java 0.4.6 long値のfilter BUG</h1>
<p>Azure SDK for Java 0.4.6 では、Azure TableのプロパティをLong値で$filterした場合に、URL展開で数字の末尾の’L’が付かないという不備があります。その結果、MAX_INTより大きな値を条件にするとサーバーの処理がエラーになってしまいます。</p>
<p>この問題に気が付いたのは、0.4.4で、0.4.6でもまだ修正されていません。</p>
<p>修正して、Pull Requestを投げています。(2013/10/13)</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-java/pull/413">#413 Long value filtering has error when value more than MAX_INT</a></p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9742098820/"><img alt="Amago by takekazu, on Flickr" src="http://farm8.staticflickr.com/7459/9742098820_0d6eb52271_z.jpg"/></a>
<hr class="docutils"/>
<div class="section" id="id1">
<h2>修正内容</h2>
<script src="https://gist.github.com/takekazuomi/7031393.js">&amp;amp;nbsp;</script><p>edmType が、EdmType.INT64の場合に、値のpostfixに’L’を付けるように変更しました。</p>
</div>
<div class="section" id="id2">
<h2>元の仕様</h2>
<p>どこからこの’L’が出てきたかという話をチョットします。Azure Table REST APIは、OData の仕様に準拠しているのでリテラルの書式などはそれを見ると書いてあるはずです。ODataのPrimitive Data Typesでは、64bit整数は下記のように定義されていました。’L’ですね。</p>
<table border="1" class="docutils" id="id3">
<caption><span class="caption-text">OData Primitive Data Types</span></caption>
<colgroup>
<col width="25%"/>
<col width="25%"/>
<col width="25%"/>
<col width="25%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Primitive Types     Literal Form    Example</th>
<th class="head"> </th>
<th class="head"> </th>
<th class="head"> </th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Edm.Int64 Represents a signed 64-bit</td>
<td>integer value</td>
<td>[-] [0-9]+L</td>
<td>Example 1: 64L Example 2: -64L</td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="http://www.odata.org/documentation/overview/#AbstractTypeSystem">odata.org  6. Primitive Data Types</a>より</p>
<p>念のため他のデータ型の実装も確認すると、Azure Tableでサポートされているデータ型でリテラル表記に癖があるEdm.Guid, Edm.DateTimeのあたりですは問題なさそうです。</p>
</div>
]]></description>
            <category><![CDATA[ Azure SDK ]]></category>
             <pubDate>Thu, 17 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2013/10/15/windows_azure_plugin_for_eclipse_with_java.html</link>
            <guid>http://kyrt.in/2013/10/15/windows_azure_plugin_for_eclipse_with_java.html</guid>
            <title><![CDATA[Windows Azure Plugin for Eclipse with JavaとPlay Framework 2.1]]></title>
            <description><![CDATA[<h1>Windows Azure Plugin for Eclipse with JavaとPlay Framework 2.1</h1>
<p>Pyay Framework 2.1のアプリを作ってWindows AzureにDeployするまでを簡単に流します。Java, Play Frameworkに付いてある程度知識があって、Windows Azureを使ってみようという人を前提としています。</p>
<div class="section" id="id1">
<h2>必要環境</h2>
<p>確認は下記の環境で行いました。</p>
<ol class="arabic simple">
<li>Windows 8</li>
<li>Java Developer Kit (JDK), v1.7</li>
<li>Eclipse IDE for Java EE Developers Kepler</li>
<li>Windows Azure SDK 2.1</li>
<li>Play Framework 2.1</li>
</ol>
<p>Windows Azure Plugin for Eclipse with JavaとPlay Framework 2.1の開発環境としては、JDKは1.6以降、Eclipseは、 Indigo 以降がサポートされています。Windows Azure SDKは最新（2.1）が必要です。Play Frameworkに関しては2.1.5で試しましたが、他のバージョンとの互換性は確認していません。</p>
<div class="section" id="windows-azure-sdk-2-1">
<h3>Windows Azure SDK 2.1のインストール</h3>
<p>Windows Azure SDK 2.1は、Web Platform Installer 4.6経由で入れるのがお勧めです。少し慣れないと分かりづらいので説明します。</p>
<p>Web Platform Installerを起動して、右上の検索ボックス①に<span class="docutils literal"><span class="pre">azure</span> <span class="pre">sdk</span> <span class="pre">2.1</span></span>と入力して改行すると検索結果が表示されます。その中の<span class="docutils literal"><span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">SDK</span> <span class="pre">2.1</span></span>② を「インストールする」して下さい。（画面はインストール後になってしまっているのですが、右端のインストールボタンを押すとインストール候補として選択されます）Visual Studio用のツールなど複数表示されますが、今回必要なのは、<span class="docutils literal"><span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">SDK</span> <span class="pre">2.1</span></span>だけです。</p>
<p>画面下の「インストール」ボタン③を押すと処理が始まります、この時に必要な依存関係も同時にインストールされます。</p>
<img alt="../../../_images/2013_10_webpi002.png" src="http://kyrt.in/_images/2013_10_webpi002.png"/>
<ul class="simple">
<li>Web Platform Installer 4.6 は、<a class="reference external" href="http://www.microsoft.com/web/downloads/platform.aspx">Microsoft Web Platform Installer 4.6</a>からインストールできます。</li>
</ul>
</div>
<div class="section" id="id2">
<h3>もっと簡単な方法</h3>
<p>This plugin requires Windows Azure SDK 2.1. This can be downloaded using theWeb Platform Installer (WebPI) 経由で<span class="docutils literal"><span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">SDK</span> <span class="pre">2.1</span></span>をインストールするplugin(exe)も配布されています。<a class="reference external" href="http://go.microsoft.com/fwlink/?LinkID=252838">http://go.microsoft.com/fwlink/?LinkID=252838</a>このリンク先さからダウンロードされるEXEを起動するとSDKのインストールが自動的に始まります。どちらの方法でインストールしても同じものが入ります。</p>
</div>
</div>
<div class="section" id="windows-azure-plugin-for-eclipse-with-java-by-microsoft-open-technologies">
<h2>Windows Azure Plugin for Eclipse with Java (by Microsoft Open Technologies)</h2>
<p>次に、Microsoft Open Technologiesが作っている Windows Azure Plugin for Eclipse with Java を入れます。現在(2013/10/15)の最新版は、2.1.1です。プラグインのインストールは、通常のものと同じに、Help メニューのInstall New Softwareから行います。</p>
<p>レポジトリとして、<span class="docutils literal"><span class="pre">http://dl.msopentech.com/eclipse</span></span>を追加すると、<span class="docutils literal"><span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">Toolkit</span> <span class="pre">for</span> <span class="pre">Java</span></span>が表示されます。</p>
<img alt="../../../_images/2013_10_javaplugininstall002.png" src="http://kyrt.in/_images/2013_10_javaplugininstall002.png"/>
<p>必要に応じてライブラリを選択してください。今回はとりあえず、全部選択します。</p>
<div class="section" id="id3">
<h3>サポートされているライブラリの種類</h3>
<p>Windows Azure Plugin for Eclipse with Javaが、EclipseのUIとツールを提供するもので、その他のものはAzureのAPIをラップしたクラスライブラリです。</p>
<ul class="simple">
<li>Microsoft JDBC Driver 4.0 for SQL Server: SQL Database 用のコンポーネント</li>
<li>Package for Apache Qpid Client Libraries for JMS (by MS Open Tech): Azureのメッセージングサービス向けのJMS client library （Apache Qpid project が元になっています）</li>
<li>Package for Windows Azure Libraries for Java (by MS Open Tech): このコンポーネントは、Windows Azure でスケーラブルなクラウドコンピューティングを実現するためのライブラリを提供</li>
<li>Windows Azure Access Control Services Filter (by MS Open Tech): このコンポーネントはWindows Azure ACS を使った認証アプリケーション向け</li>
<li>Windows Azure Common Plugin (by MS Open Tech): 他のこのコンポーネントとの共通コンポーネント</li>
<li>Windows Azure Plugin for Eclipse with Java (by MS Open Tech): このコンポーネントは、project configuration logic、the publish-to-cloud wizard、と user interfaceを含む</li>
</ul>
<p>インストールに異常に時間がかかる場合は、<span class="docutils literal"><span class="pre">Contact</span> <span class="pre">all</span> <span class="pre">update</span> <span class="pre">sites</span> <span class="pre">during</span> <span class="pre">install</span> <span class="pre">to</span> <span class="pre">find</span> <span class="pre">required</span> <span class="pre">software</span></span>のチェックを外してみてください。</p>
<p>ここまでの内容は、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh690946.aspx">Installing the Windows Azure Plugin for Eclipse with Java (by Microsoft Open Technologies)</a>に詳しく書いてありますので、そちらも参照してください。</p>
</div>
</div>
<div class="section" id="play-frameworkeclipse">
<h2>Play Frameworkのプロジェクト作成からEclipseへの取り込へ</h2>
<p>動作確認のためにPlay Frameworkのプロジェクトを作成して、Eclipseへ取り込みます。</p>
<p>MyFirstAppという名前で、play frameworkのアプリを作ります。今回は全くコードは書かないので関係ありませんが言語はJavaを選択します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ play new MyFirstApp
       _            _
 _ __ | | __ _ _  _| |
| '_ \| |/ _' | || |_|
|  __/|_|\____|\__ (_)
|_|            |__/

play! 2.1.5 (using Java 1.7.0_25 and Scala 2.10.0), http://www.playframework.org

The new application will be created in C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp

What is the application name? [MyFirstApp]
&gt;

Which template do you want to use for this new application?

  1             - Create a simple Scala application
  2             - Create a simple Java application

&gt; 2
OK, application MyFirstApp is created.

Have fun!
</pre></div>
</div>
<p>eclipseのプロジェクトを作ります。先ほど作成したアプリのディレクトリに移動してeclipseのプロジェクトを作成します。 普通の開発ならば、<span class="docutils literal"><span class="pre">eclipse</span> <span class="pre">with-source=true</span></span>の方が良いかもしれませんが、今回はダウンロード時間の節約でソースは持ってきません:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ cd .\MyFirstApp
$ play
[info] Loading project definition from C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\project
[info] Set current project to MyFirstApp (in build file:/C:/Users/Takekazu/Documents/GitHub/sandbox/java/play002/MyFirstApp/)
       _            _
 _ __ | | __ _ _  _| |
| '_ \| |/ _' | || |_|
|  __/|_|\____|\__ (_)
|_|            |__/

play! 2.1.5 (using Java 1.7.0_25 and Scala 2.10.0), http://www.playframework.org

&gt; Type "help play" or "license" for more information.
&gt; Type "exit" or use Ctrl+D to leave this console.

[MyFirstApp] $ eclipse
[info] About to create Eclipse project files for your project(s).
[info] Updating {file:/C:/Users/Takekazu/Documents/GitHub/sandbox/java/play002/MyFirstApp/}MyFirstApp...
[info] Done updating.
[info] Compiling 4 Scala sources and 2 Java sources to C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\classes...
[info] Successfully created Eclipse project files for project(s):
[info] MyFirstApp
[MyFirstApp] $ exit
</pre></div>
</div>
<p>AzureのDeploy用のパッケージ(cspkg)に入れるためアプリの配布用zipを作成します:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>$ play dist
[info] Loading project definition from C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\project
[info] Set current project to MyFirstApp (in build file:/C:/Users/Takekazu/Documents/GitHub/sandbox/java/play002/MyFirstApp/)
[info] Packaging C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\myfirstapp_2.10-1.0-SNAPSHOT-sources.jar ...
[info] Done packaging.
[info] Generating Scala API documentation for main sources to C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\api...
[info] Wrote C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\myfirstapp_2.10-1.0-SNAPSHOT.pom
[info] Packaging C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\myfirstapp_2.10-1.0-SNAPSHOT.jar ...
[info] Done packaging.
model contains 17 documentable templates
[info] Scala API documentation generation successful.
[info] Packaging C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\target\scala-2.10\myfirstapp_2.10-1.0-SNAPSHOT-javadoc.jar ...
[info] Done packaging.

Your application is ready in C:\Users\Takekazu\Documents\GitHub\sandbox\java\play002\MyFirstApp\dist\myfirstapp-1.0-SNAPSHOT.zip

[success] Total time: 8 s, completed 2013/10/15 14:57:13
$
</pre></div>
</div>
<p>この時に、<span class="docutils literal"><span class="pre">Your</span> <span class="pre">application</span> <span class="pre">is</span> <span class="pre">ready</span> <span class="pre">in</span></span>の行に表示される zip ファイル名（以下 dist zip名）をメモして置いて下さい、この前で使います。</p>
<p>eclipseを起動して、プロジェクトをimportします。</p>
<img alt="../../../_images/2013_10_eclipse002.png" src="http://kyrt.in/_images/2013_10_eclipse002.png"/>
<p>これで、サンプルのplay frameworkのプロジェクトの作成とビルドが終わりました。この先は、Azure 用のプロジェクトを作成に入ります。</p>
<p>参考：<a class="reference external" href="http://www.playframework.com/documentation/2.2.x/IDE">Setting up your preferred IDE</a></p>
</div>
<div class="section" id="azure-project">
<h2>Azure 用のProjectの作成</h2>
<p>ツールバーの<span class="docutils literal"><span class="pre">New</span> <span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">Deployment</span> <span class="pre">Project</span></span>を押します。</p>
<img alt="../../../_images/2013_10_eclipse003.png" src="http://kyrt.in/_images/2013_10_eclipse003.png"/>
<p>New Windows Azure Deployment Projectの設定POPUPが開きます。Project Nameを入れます。今回は、MyAzureProjectにしました。例では、default locationを変更してplay frameworkのプロジェクトの横のディレクトリに持ってきていますが、プロジェクトの場所はどこでも構いません。</p>
<img alt="../../../_images/2013_10_eclipse004.png" src="http://kyrt.in/_images/2013_10_eclipse004.png"/>
<p>Nextを押すと、JDKの設定に移ります。Emulator deployment と書いてある部分が、Emulatorを使った場合に利用されるJDKの設定で、Cloud deployment の部分がクラウド上（Azure環境）で使われるJDKの設定です。Deploy my local JDKを選択すると、Emulatorで使うように設定したものを自動的にCloudにアップロードしてクラウド上でも同じものを使うようになります。今回は、ローカルのJDK 1.7を両方で使うように設定しています。この画面ではJDKの設定しかしません。SeverとApplicationは何も触らずにFinish のボタンを押します。</p>
<img alt="../../../_images/2013_10_eclipse005.png" src="http://kyrt.in/_images/2013_10_eclipse005.png"/>
<p>下記のような内容のプロジェクトが作成されます。</p>
<img alt="../../../_images/2013_10_eclipse006.png" src="http://kyrt.in/_images/2013_10_eclipse006.png"/>
<div class="section" id="workerrole1myfirstappdist-zip">
<h3>プロジェクトのWorkerRole1へMyFirstAppのdist zipを追加する</h3>
<p>WorkerRole1を選択してプロパティを開き、Windows Azure RoleのTreeを開いてComponentsを選びます。コンポーネントリストにHelloWorld.warがありますが、不要なのでremoveします。その後Addを押してMyFirstAppのdist zipを追加します。</p>
<img alt="../../../_images/2013_10_eclipse007.png" src="http://kyrt.in/_images/2013_10_eclipse007.png"/>
<p>「Windows Azure Role Component」のpopupをでは、Import into packageのFrom Pathの部分に、dist zip のフルパス名を入れます。Methodは、copyを選択、As Nameは、dist zipのファイル名入れます（ここは、From Pathのファイル名部分がデフォルトで入力されるはずです）その下の、Deploy from packageの設定は、Methodをunzip、To directoryを.にしてください。今回</p>
<img alt="../../../_images/2013_10_eclipse008.png" src="http://kyrt.in/_images/2013_10_eclipse008.png"/>
</div>
<div class="section" id="id4">
<h3>環境変数の追加</h3>
<p>dist zip名をRoleの実行タスクに渡す良い方法が無かったので、環境変数を使います。環境変数名ZIP_NAMEにdist zipのbase名(今回は、<span class="docutils literal"><span class="pre">myfirstapp-1.0-SNAPSHOT</span></span>)を定義します。</p>
<img alt="../../../_images/2013_10_eclipse009.png" src="http://kyrt.in/_images/2013_10_eclipse009.png"/>
</div>
<div class="section" id="endpoint">
<h3>EndPointを変更</h3>
<p>play frameworkアプリのデフォルトの待ち受けポートが9000なので、EndPointを9000に変更します。publicで定義されているのがAzure のload brancer がインターネット上で公開しているポート番号で、privateがAzure インスタンスでアプリが待ち受けているポート番号です。play frameworkアプリのデフォルトの待ち受けポートが9000なので、EndPointを9000に変更します。Azure Load brancerがこの定義に基いてポート変換を実行します。</p>
<img alt="../../../_images/2013_10_eclipse010.png" src="http://kyrt.in/_images/2013_10_eclipse010.png"/>
</div>
<div class="section" id="script">
<h3>scriptの変更</h3>
<p>MyAzureProject/WorkerRole1/approotにあるstartup.cmdとrun.cmdを下記のように変更します。</p>
<p>startup.cmd:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>del /q run_body.cmd
powershell -ExecutionPolicy RemoteSigned -f replace.ps1 run_body.cmd.template &gt; run_body.cmd
</pre></div>
</div>
<p>run.cmd:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>rem @ECHO OFF

set _SLEEPLENGTH=15000
set _FILENAME=run_body.cmd

@REM Create a temporary sleep script in VBScript
echo WScript.sleep(%_SLEEPLENGTH%) &gt; %Temp%\_mysleep.vbs

:Loop
if exist %_FILENAME% (goto:StartToRun)

cscript /Nologo %Temp%\_mysleep.vbs
goto:Loop

del %Temp%\_mysleep.vbs

:StartToRun
call %_FILENAME%
</pre></div>
</div>
<p>replace.ps1と、run_body.cmd.templateの2つファイルを追加します。</p>
<p>replace.ps1:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>cat $args[0] | % {$l = $_ -creplace '__JAVA_HOME__',"$Env:JAVA_HOME"; "$l" } | % {$l = $_ -creplace '__ZIP_NAME__',"$Env:ZIP_NAME"; "$l" }
</pre></div>
</div>
<p>run_body.cmd.template:</p>
<div class="highlight-none"><div class="highlight"><pre><span/>set JAVA_HOME=__JAVA_HOME__
set ZIP_NAME=__ZIP_NAME__

set PATH=%JAVA_HOME%\bin;%PATH%

setlocal
set d=%~dp0
set d=%d:\=/%
java %* -cp "%d%/%ZIP_NAME%/lib/*;" play.core.server.NettyServer %d%
</pre></div>
</div>
</div>
<div class="section" id="emulator">
<h3>Emulatorでの実行</h3>
<p>これで準備ができました。<span class="docutils literal"><span class="pre">Run</span> <span class="pre">In</span> <span class="pre">Windows</span> <span class="pre">Azure</span> <span class="pre">Emurator`</span></span>を押してEmulatorでの実行します。成功すると、80と9000のポートで結果を見ることができます。80はAzure SDKに付属のCompute Emulator経由で、9000はPlay Frameworkの待受を見ていることになります。また、EndPointの設定で80にしていますが、Compute Emulatorが起動時に、既に80が使われていた場合は順次ポート番号をインクリメントしていき空いているポートを利用します。</p>
<img alt="../../../_images/2013_10_eclipse011.png" src="http://kyrt.in/_images/2013_10_eclipse011.png"/>
<p>Emulatorの管理画面が同時に起動します。Windows Azure Compute Emurator のウインドウを開いてWorkerRole1の0を選択すると、コンソール画面が表示されます。</p>
<img alt="../../../_images/2013_10_eclipse012.png" src="http://kyrt.in/_images/2013_10_eclipse012.png"/>
</div>
<div class="section" id="azuredeploy">
<h3>Azure環境へのDeploy</h3>
<p>Publish to Windows Azure Cloudを押してAzure環境にDeploy します。必要に応じて、StorageとCloud Serviceを作成してください。</p>
<img alt="../../../_images/2013_10_eclipse013.png" src="http://kyrt.in/_images/2013_10_eclipse013.png"/>
<p>この設定だと、Azure環境ではAzure LoadBarancerが介在して外部から port 80で見えます。</p>
</div>
</div>
<div class="section" id="bookmarks">
<h2>Bookmarks</h2>
<ul class="simple">
<li><a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh690943.aspx">Java Developer Guidance</a>Java開発の入り口</li>
<li><a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh694271.aspx">Windows Azure Plugin for Eclipse with Java (by Microsoft Open Technologies)</a></li>
</ul>
</div>
]]></description>
            <category><![CDATA[ Azure ]]></category>
            <category><![CDATA[ Java ]]></category>
             <pubDate>Tue, 15 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2012/12/26/asc2_dot_0asyncbug.html</link>
            <guid>http://kyrt.in/2012/12/26/asc2_dot_0asyncbug.html</guid>
            <title><![CDATA[Azure Storage Client 2.0 CompletedSynchronously FIX]]></title>
            <description><![CDATA[<h1>Azure Storage Client 2.0 CompletedSynchronously FIX</h1>
<p>以前の記事<a class="reference internal" href="http://kyrt.in/2012/12/08/waac2012day2.html"><span class="doc">Azure Storage Gen 2は速かった</span></a>の補足です。その中の<a class="reference internal" href="http://kyrt.in/2012/12/08/waac2012day2.html#waac2012day2-pending"><span class="std std-ref">非同期で同時接続数が上がらない？</span></a>で、</p>
<blockquote>
<div>このコードを動かしてみたら、「単一スレッド＋非同期の組み合わせだと、おおよそ２から３程度のコネクションしか作成されない」ことに気が付きました。場合によっては、5ぐらいまで上がることもあるようですが、どうしてこうなるのか不思議です。<strong>これは、Azure Storage Client 2.0のBUG</strong>だったようです。2.0.2で修正されています。</div></blockquote>
<p>と書きました、結局執筆時点でのAzure Storage Client 2.0.1にはBUGがあり、後日2.0.2で修正されたことが分かりました。少々混乱したのでここに顛末をまとめます。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/8307052288/"><img alt="candle by takekazu, on Flickr" src="http://farm9.staticflickr.com/8082/8307052288_2a8cdf5678_c.jpg"/></a>
<hr class="docutils"/>
<div class="section" id="bug">
<h2>BUGの内容</h2>
<p>BUGの内容としては、非同期メソッドが返すIAsyncResultオブジェクトのCompletedSynchronouslyプロパティが一貫性の無い値になっていて、その結果、TaskFactory.FromAsyncが正しく動作しないというものでした。</p>
<div class="section" id="id1">
<h3>参照</h3>
<ol class="arabic simple">
<li><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/changelog.txt">WindowsAzure/azure-sdk-for-net changelog.txt</a></li>
<li><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/pull/134">WindowsAzure/azure-sdk-for-net Issue #141:</a></li>
</ol>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="id2">
<h2>再現試験</h2>
<p>まずは、2.0.1での問題の再現性の確認し、2.0.3で解決されているのかを検証します。コードは[前の記事] (Azure Storage Gen 2は速かった) とほとんど同じですが、なるべく簡略化したものにしています。</p>
<p>まずは、APM (Asynchronous Programming Model)パターンの非同期メソッドをTask.FromAsync()でラップしてExecuteAsyncメソッドを作ります。今回問題となっているのは、CloudTable.BeginExecute から、AsyncCallback を呼び出すときに渡すIAsyncResultオブジェクトのCompletedSynchronouslyプロパティです。ちょと問題があるような気がしますが、今回はこれで行きます。</p>
<script src="https://gist.github.com/takekazuomi/4369349.js">&amp;amp;nbsp;</script><p>このExecuteAsyncを使って指定回ループしてテーブルにエンティティをInsertします。</p>
<script src="https://gist.github.com/takekazuomi/4369329.js">&amp;amp;nbsp;</script><p>このコードは、Insertの数だけ、Taskが生成されて全部まとめてWaitしています。これを、.NET 4.0でやるとTask毎にWait Handleを確保するので非常に効率が悪いですが、.NET 4.5では、Waitの数しかリソースを使わないので、そんなに悪くありません。それでも件数に応じて使用メモリーが増えるので本番で使うのはあまりお勧めできないコーディングパターンです。</p>
<p>.NET 4.5のTask回りの変更については、このBlogの記事「<a class="reference external" href="http://csharptan.wordpress.com/2011/12/11/%E6%96%B0%E6%A9%9F%E8%83%BD%E3%81%8C%E5%85%A5%E3%82%8B%E3%81%BE%E3%81%A7/">C#たんっ！ 新機能が入るまで</a>」から読み始めるのがお勧めです、必要な部分へのリンクが張られています。</p>
</div>
<div class="section" id="id3">
<h2>2.0.1 で動かす</h2>
<p>このコードを、Azure Storage Client 2.0.1 で動かしてみます。ライブラリのバージョンを指定するには、nugetを使うと便利です。もし、すでにAzure Storage Client が入っていたら下記のように削除してからバージョンを指定して入れ直します。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>&gt; Uninstall-Package WindowsAzure.Storage –RemoveDependencies
&gt; Install-Package  WindowsAzure.Storage -Version 2.0.1
</pre></div>
</div>
<p>これで動かします。非同期メソッドが本当に非同期で動いているかどうかの確認はUIならUI Threadがブロックされていているかどうかなどで分かり易いのですが、サーバーサイドのプログラム（今回コンソールですが）ではちょっと見には分かりません。このコードはAzure Storageとの間でSocketを張っているのでTCP/IP接続の数を見ることで並列度が分かります。また、ネットワーク転送速度（Send）も参考になります。</p>
<div class="section" id="azure-storage-client-2-0-1-resource-moniter">
<h3>Azure Storage Client 2.0.1 時のResource Moniter画面</h3>
<img alt="2.0.1時のResource Moniter画面" src="http://kyrt.in/_images/2012_12_connections-asc2.0.1.png"/>
<p>見事に接続数が伸びません。</p>
</div>
</div>
<div class="section" id="id4">
<h2>2.0.3では？</h2>
<p>これを、2.0.3 でビルドし直します。2012/12/24現在の最新が2.0.3でバージョン指定しないと最新版が落ちてきます。</p>
<div class="highlight-none"><div class="highlight"><pre><span/>&gt; Uninstall-Package WindowsAzure.Storage –RemoveDependencies
&gt; Install-Package  WindowsAzure.Storage
</pre></div>
</div>
<div class="section" id="azure-storage-client-2-0-3-resource-moniter">
<h3>Azure Storage Client 2.0.3 時のResource Moniter画面</h3>
<img alt="2.0.3時のResource Moniter画面" src="http://kyrt.in/_images/2012_12_connections-asc2.0.3.png"/>
</div>
</div>
<div class="section" id="id5">
<h2>結論</h2>
<p>劇的にコネクション数が変わります。画面だとコネクションの数ははっきりとわかりませんが、 2.0.1 の時の画面と全く違っているのがわかると思います。数を数えると開始直後に1000接続以上が作成されます。これで、2.0.1の実装には問題があり、非同期メソッドを使ってもほとんど非同期に実行されてなかったこと、それが、2.0.3では修正されていることが確認できました。</p>
<p>ちなみに、今回確認はしていませんが、以前に1.4のAzure Storage Clientを試した時には非同期メソッドで同時接続数が少なくて困るという問題は無ありませんでした、2.0で発生したBUGで2.0.2でFIXということのようです。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id6">
<h2>次の問題</h2>
<p>万事解決、良かった良かったと言いたいところですが別の問題が起きます。並列度があがったのは良いのですが、コネクションを張りすぎてExceptionが大量に発生します。</p>
<div class="section" id="azure-storage-client-2-0-3-exception">
<h3>Azure Storage Client 2.0.3 時でのException</h3>
<img alt="Azure Storage Client 2.0.3 時でのException" src="http://kyrt.in/_images/2012_12_connections-asc2.0.3-cmd.png"/>
<p>何らかの方法で、並列度を制限しないと実用的ではありません。特にバッチの中で非同期呼び出しを使う場合などはこれは致命的です。</p>
<p>ここでは、Blob でのUpload処理が参考になります。Windows Azure Storage 2.0 の Blob Uploadで参照している処理を見ると、Semaphoreを使って非同期処理には入れる数を制御していますので、これを参考にします。</p>
</div>
</div>
<div class="section" id="semaphore">
<h2>Semaphoreを使う</h2>
<p>上記の処理方法に習って、Semaphoreを使って同時実行数を制御します。SemaphoreSlim という便利がものがあるのでそれを使います。こうすることで、同時実行数を制御することがでます。とりあえず100で制限します。これで普通に動きます。</p>
<script src="https://gist.github.com/takekazuomi/4369880.js">&amp;amp;nbsp;</script></div>
<hr class="docutils"/>
<div class="section" id="id7">
<h2>まとめ</h2>
<ol class="arabic simple">
<li>Azure Storage Client 2.0 は、2.0.2で非同期周りのBUGが直っている。</li>
<li>非同期呼び出しをループ内で使うと過剰にリソースを消費することがある。</li>
<li>同時実行数を制御するにはSemaphoreを使うと制限できる。</li>
</ol>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Wed, 26 Dec 2012 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2012/12/22/azurevmfix1221.html</link>
            <guid>http://kyrt.in/2012/12/22/azurevmfix1221.html</guid>
            <title><![CDATA[Azure Virtual MachineのDISK性能]]></title>
            <description><![CDATA[<h1>Azure Virtual MachineのDISK性能</h1>
<p>twitterで、「<a class="reference external" href="https://twitter.com/kamebuchi/status/282094138269261825">Azure VMのLinuxを21日以降作るか、更新手順を実施するとパフォーマンスが改善されるらしー</a>」というのを読んで、以前DISK性能を調べ始めてそのまま放置していたのを思い出した。Azure Ubuntu 12.04 iozone 速報 2012/7/4</p>
<p>Azure Storageの非同期と同期の比較をしようと始めたのだけど、なかなか手間取って進まない。ちょっと寄り道して速くなったというAzure VMを試してみることにした。</p>
<p>前のVMは消してしまったので、新たにインストールし直すところから始める。AzureのポータルからUbuntuをインストールして、DataDiskを接続するあたりまでは他に任せてubuntuが起動した後から書いていきます。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/7987640250/"><img alt="Triangle by takekazu, on Flickr" src="http://farm9.staticflickr.com/8450/7987640250_b87fdcf1f1_c.jpg"/></a>
<hr class="docutils"/>
<div class="section" id="ubuntu">
<h2>Ubuntu 環境の準備</h2>
<p>基本的には、前回と同じになるようにします。だたUbuntuを12.10にして、data diskのホストキャッシュの設定を変えて3つのDISKを接続して測定しました。以前の測定:Azure Ubuntu 12.04 iozone 速報 2012/7/4ホストキャッシュの設定はポータルからはできずに、デフォルトでした。その時(2012/7/4)は、ホストキャッシュ無しがデフォルトだったと思うのですが、ちょっとドキュメントが見つからないので前の結果は参考程度にしてください。</p>
<p>Azure iDC は、West USで、2 coreのインスタンス（M）を使いました。Sにするか少し考えたのですが、クラウドサービスについては、I/O パフォーマンスがXS、Sでは制限されているのでMを使うことにしました。参考：<a class="reference external" href="http://www.windowsazure.com/ja-jp/pricing/details/">Windows Azure の料金と、請求の計測単位の詳細</a></p>
<p>正確には、今回試そうとしているVirtual Machine はまだ Previewで Cloud Serviceと同じような制限になるかは情報が公開されていない（私は知らないだけかもしれませんが）のですが、同じになってそうな気がしたのでMにしました。</p>
<p>ちょっと古いものでは、<a class="reference external" href="http://msdn.microsoft.com/ja-jp/library/windowsazure/ee814754.aspx">仮想マシンのサイズの構成方法</a>という情報もあります。</p>
<p>インスタンスの選択で考慮する必要があると思われるのは、「Data Diskはネットワーク経由で接続されるく、ソフトウェアで処理する部分が多い＝CPUを使う」ということです。従ってネットワーク帯域制限やCore数の影響を無視できないはずです。XSやSのインスタンスだと何を測定しているのか不安になる気がしたのでMを選択しました。実際どのインスタンスサイズの程度影響があるのかは興味ありますが未測定です。</p>
<p>ざっと流すと、以下のような手順踏んで用意をします。</p>
<ol class="arabic simple">
<li>Ubuntu 12.10 を、azure portalから、virtual machineイメージをインストール</li>
<li>data disk を、256Gで3つ作成、/dev/sdc, sdd, sdeを確認、キャッシュをそれぞれ「なし、読み取り専用、読み取り/書き込み」と指定</li>
<li>fdiskして、/dev/sd[cde]1にext4でfilesystemを作成し/mnt/data, /mnt/data1, /mnt/data2へmount</li>
<li>apt-get update, upgrade して最新に更新</li>
<li>/etc/apt/sources.list で、multiverse を追加（コメントを外しただけ）</li>
<li>apt-get install iozone3 でインストール</li>
</ol>
</div>
<div class="section" id="id2">
<h2>ディスク構成</h2>
<table border="1" class="docutils" id="id7">
<caption><span class="caption-text">表1 ディスク構成</span></caption>
<colgroup>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
<col width="20%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ディスク</th>
<th class="head">種類</th>
<th class="head">ホスト キャッシュ</th>
<th class="head">サイズ</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>/dev/sda</td>
<td>OS ディスク</td>
<td>読み取り/書き込み</td>
<td>30GB</td>
<td> </td>
</tr>
<tr class="row-odd"><td>/dev/sdc</td>
<td>データ ディスク</td>
<td>なし</td>
<td>256GB</td>
<td> </td>
</tr>
<tr class="row-even"><td>/dev/sdd</td>
<td>データ ディスク</td>
<td>読み取り専用</td>
<td>256GB</td>
<td> </td>
</tr>
<tr class="row-odd"><td>/dev/sde</td>
<td>データ ディスク</td>
<td>読み取り/書き込み</td>
<td>256GB</td>
<td> </td>
</tr>
</tbody>
</table>
</div>
<hr class="docutils"/>
<div class="section" id="id3">
<h2>手順</h2>
<p>今後の再テストのためのメモも兼ねて、コマンドをラインに流したもの抜粋を挙げておきます。(以下sudo省略)</p>
<ol class="arabic simple">
<li>ポータルで256Gでdata diskを作成して接続を確認</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ dmesg <span class="p">|</span> grep -e <span class="s2">"\[sd[a-z]\]"</span>
sd <span class="m">2</span>:0:0:0: <span class="o">[</span>sda<span class="o">]</span> <span class="m">62914560</span> <span class="m">512</span>-byte logical blocks: <span class="o">(</span><span class="m">32</span>.2 GB/30.0 GiB<span class="o">)</span>
sd <span class="m">2</span>:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Write Protect is off
sd <span class="m">2</span>:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Mode Sense: 0f <span class="m">00</span> <span class="m">10</span> <span class="m">00</span>
sd <span class="m">2</span>:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Write cache: enabled, <span class="nb">read</span> cache: enabled, supports DPO and FUA
sd <span class="m">2</span>:0:0:0: <span class="o">[</span>sda<span class="o">]</span> Attached SCSI disk
sd <span class="m">3</span>:0:1:0: <span class="o">[</span>sdb<span class="o">]</span> <span class="m">283115520</span> <span class="m">512</span>-byte logical blocks: <span class="o">(</span><span class="m">144</span> GB/135 GiB<span class="o">)</span>
sd <span class="m">3</span>:0:1:0: <span class="o">[</span>sdb<span class="o">]</span> Write Protect is off
sd <span class="m">3</span>:0:1:0: <span class="o">[</span>sdb<span class="o">]</span> Mode Sense: 0f <span class="m">00</span> <span class="m">10</span> <span class="m">00</span>
sd <span class="m">3</span>:0:1:0: <span class="o">[</span>sdb<span class="o">]</span> Write cache: enabled, <span class="nb">read</span> cache: enabled, supports DPO and FUA
sd <span class="m">3</span>:0:1:0: <span class="o">[</span>sdb<span class="o">]</span> Attached SCSI disk
sd <span class="m">6</span>:0:0:0: <span class="o">[</span>sdc<span class="o">]</span> <span class="m">536870912</span> <span class="m">512</span>-byte logical blocks: <span class="o">(</span><span class="m">274</span> GB/256 GiB<span class="o">)</span>
sd <span class="m">6</span>:0:0:0: <span class="o">[</span>sdc<span class="o">]</span> Write Protect is off
sd <span class="m">6</span>:0:0:0: <span class="o">[</span>sdc<span class="o">]</span> Mode Sense: 0f <span class="m">00</span> <span class="m">10</span> <span class="m">00</span>
sd <span class="m">6</span>:0:0:0: <span class="o">[</span>sdc<span class="o">]</span> Write cache: enabled, <span class="nb">read</span> cache: enabled, supports DPO and FUA
sd <span class="m">6</span>:0:0:0: <span class="o">[</span>sdc<span class="o">]</span> Attached SCSI disk
sd <span class="m">6</span>:0:0:1: <span class="o">[</span>sdd<span class="o">]</span> <span class="m">536870912</span> <span class="m">512</span>-byte logical blocks: <span class="o">(</span><span class="m">274</span> GB/256 GiB<span class="o">)</span>
sd <span class="m">6</span>:0:0:1: <span class="o">[</span>sdd<span class="o">]</span> Write Protect is off
sd <span class="m">6</span>:0:0:1: <span class="o">[</span>sdd<span class="o">]</span> Mode Sense: 0f <span class="m">00</span> <span class="m">10</span> <span class="m">00</span>
sd <span class="m">6</span>:0:0:1: <span class="o">[</span>sdd<span class="o">]</span> Write cache: enabled, <span class="nb">read</span> cache: enabled, supports DPO and FUA
sd <span class="m">6</span>:0:0:1: <span class="o">[</span>sdd<span class="o">]</span> Attached SCSI disk
sd <span class="m">6</span>:0:0:2: <span class="o">[</span>sde<span class="o">]</span> <span class="m">536870912</span> <span class="m">512</span>-byte logical blocks: <span class="o">(</span><span class="m">274</span> GB/256 GiB<span class="o">)</span>
sd <span class="m">6</span>:0:0:2: <span class="o">[</span>sde<span class="o">]</span> Write Protect is off
sd <span class="m">6</span>:0:0:2: <span class="o">[</span>sde<span class="o">]</span> Mode Sense: 0f <span class="m">00</span> <span class="m">10</span> <span class="m">00</span>
sd <span class="m">6</span>:0:0:2: <span class="o">[</span>sde<span class="o">]</span> Write cache: enabled, <span class="nb">read</span> cache: enabled, supports DPO and FUA
sd <span class="m">6</span>:0:0:2: <span class="o">[</span>sde<span class="o">]</span> Attached SCSI disk
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>parted で全セクタを使ってパーテーションを作成</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ sudo parted /dev/sdc --script mklabel gpt
$ sudo parted /dev/sdc --script <span class="s1">'mkpart disk1 ext4 1M -1'</span>
$ sudo parted /dev/sdc --script <span class="s1">'print'</span>

Model: Msft Virtual Disk <span class="o">(</span>scsi<span class="o">)</span>
Disk /dev/sdc: 275GB
Sector size <span class="o">(</span>logical/physical<span class="o">)</span>: 512B/512B
Partition Table: gpt

Number  Start   End    Size   File system  Name   Flags
<span class="m">1</span>      1049kB  275GB  275GB  ext4         disk1

$ sudo parted /dev/sdd --script mklabel gpt
$ sudo parted /dev/sdd --script <span class="s1">'mkpart disk2 ext4 1M -1'</span>
$ sudo parted /dev/sdd --script <span class="s1">'print'</span>

___ snip ___

$ sudo parted /dev/sde --script mklabel gpt
$ sudo parted /dev/sde --script <span class="s1">'mkpart disk3 ext4 1M -1'</span>
$ sudo parted /dev/sde --script <span class="s1">'print'</span>

___ snip ___

$ sudo mkfs.ext4 /dev/sdc1
___ snip ___
$ sudo mkfs.ext4 /dev/sdd1
___ snip ___
$ sudo mkfs.ext4 /dev/sde1
___ snip ___
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>mount point 作って、/mnt/resouceとともにパーミッションを変更</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ mkdir /mnt/data1 /mnt/data2 /mnt/data3
$ chmod a+wrx /mnt/data*
$ chmod a+wrx /mnt/resource
$ ls -l /mnt/
total <span class="m">20</span>
drwx------ <span class="m">3</span> root root <span class="m">4096</span> Dec <span class="m">21</span> <span class="m">15</span>:56 cdrom
drwxrwxrwx <span class="m">2</span> root root <span class="m">4096</span> Dec <span class="m">22</span> <span class="m">21</span>:04 data1
drwxrwxrwx <span class="m">2</span> root root <span class="m">4096</span> Dec <span class="m">22</span> <span class="m">21</span>:04 data2
drwxrwxrwx <span class="m">2</span> root root <span class="m">4096</span> Dec <span class="m">22</span> <span class="m">22</span>:47 data3
drwxrwxrwx <span class="m">4</span> root root <span class="m">4096</span> Dec <span class="m">21</span> <span class="m">22</span>:14 resource
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>とりあえず、マウントして確認</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ sudo mount -t ext4 /dev/sdc1 /mnt/data1
$ sudo mount -t ext4 /dev/sdd1 /mnt/data2
$ sudo mount -t ext4 /dev/sde1 /mnt/data3

$ df -T
Filesystem     Type     1K-blocks    Used Available Use% Mounted on
/dev/sda1      ext4      <span class="m">30953664</span> <span class="m">1142056</span>  <span class="m">28539332</span>   <span class="m">4</span>% /
udev           devtmpfs   <span class="m">1751196</span>      <span class="m">12</span>   <span class="m">1751184</span>   <span class="m">1</span>% /dev
tmpfs          tmpfs       <span class="m">704872</span>     <span class="m">280</span>    <span class="m">704592</span>   <span class="m">1</span>% /run
none           tmpfs         <span class="m">5120</span>       <span class="m">0</span>      <span class="m">5120</span>   <span class="m">0</span>% /run/lock
none           tmpfs      <span class="m">1762172</span>       <span class="m">0</span>   <span class="m">1762172</span>   <span class="m">0</span>% /run/shm
none           tmpfs       <span class="m">102400</span>       <span class="m">0</span>    <span class="m">102400</span>   <span class="m">0</span>% /run/user
/dev/sdb1      ext4     <span class="m">139334632</span>  <span class="m">192000</span> <span class="m">132064848</span>   <span class="m">1</span>% /mnt/resource
/dev/sdc1      ext4     <span class="m">264221700</span>  <span class="m">191576</span> <span class="m">250608456</span>   <span class="m">1</span>% /mnt/data1
/dev/sdd1      ext4     <span class="m">264221700</span>  <span class="m">191576</span> <span class="m">250608456</span>   <span class="m">1</span>% /mnt/data2
/dev/sde1      ext4     <span class="m">264221700</span>  <span class="m">191576</span> <span class="m">250608456</span>   <span class="m">1</span>% /mnt/data3
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>再起動してもマウントされるように、UUIDを確認して /etc/fstab に追加。</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ blkid
/dev/sda1: <span class="nv">LABEL</span><span class="o">=</span><span class="s2">"cloudimg-rootfs"</span> <span class="nv">UUID</span><span class="o">=</span><span class="s2">"56d8a977-c1fe-461e-a328-b19fc47c743f"</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">"ext4"</span>
/dev/sdb1: <span class="nv">UUID</span><span class="o">=</span><span class="s2">"d063d8a2-32fc-486c-a9b4-e6bcf7e5deae"</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">"ext4"</span>
/dev/sdd1: <span class="nv">UUID</span><span class="o">=</span><span class="s2">"88f28b19-fdc6-46dc-a2d7-2daa1754754f"</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">"ext4"</span>
/dev/sdc1: <span class="nv">UUID</span><span class="o">=</span><span class="s2">"a1cb5045-178a-476e-9821-084f8f6d92a6"</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">"ext4"</span>
/dev/sde1: <span class="nv">UUID</span><span class="o">=</span><span class="s2">"15b8b45e-fbd0-4efc-9534-5e38b1877828"</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">"ext4"</span>

$ vi /etc/fstab

___ snip ___

$ cat /etc/fstab
<span class="nv">UUID</span><span class="o">=</span>56d8a977-c1fe-461e-a328-b19fc47c743f       /        ext4   defaults        <span class="m">0</span> <span class="m">0</span>
<span class="nv">UUID</span><span class="o">=</span>a1cb5045-178a-476e-9821-084f8f6d92a6       /mnt/data1        ext4   defaults        <span class="m">0</span> <span class="m">0</span>
<span class="nv">UUID</span><span class="o">=</span>88f28b19-fdc6-46dc-a2d7-2daa1754754f       /mnt/data2        ext4   defaults        <span class="m">0</span> <span class="m">0</span>
<span class="nv">UUID</span><span class="o">=</span>15b8b45e-fbd0-4efc-9534-5e38b1877828       /mnt/data3        ext4   defaults        <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li>最新にして再起動する</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ apt-get update
___ snip ___
$ apt-get upgrade
___ snip ___

$ shutdown -r now
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li>iozone3 を入れる</li>
</ol>
<p>/etc/apt/sources.list を変更して、multiverse を追加（コメントを外しただけ）</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ vi /etc/apt/sources.list

___ snip ___

$ apt-get update
$ apt-get install iozone3
</pre></div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="id4">
<h2>測定</h2>
<p>これで環境が出来たので測定します。基本的には、iozone 一発で細かいオプションの指定はしません。なんとなく、Excelファイルにしたのですが、面倒になるだけであまりメリットは無かったかもしれません。</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ iozone -Ra -f /mnt/resource/tmp/test -b sdb2-001.xls -s 1g
$ iozone -Ra -f /mnt/data1/tmp/test -b sdc1-001hcnone.xls -s 1g
$ iozone -Ra -f /mnt/data2/tmp/test -b sdd1-001hcro.xls -s 1g
$ iozone -Ra -f /mnt/data3/tmp/test -b sde1-001hcrw.xls -s 1g
</pre></div>
</div>
<p><a class="reference download internal" href="http://kyrt.in/_downloads/20121222-iozone-azurevm.zip" download=""><span class="xref download docutils literal"><span class="pre">結果のファイル(zip)</span></span></a></p>
</div>
<div class="section" id="iozone">
<h2>iozone の実行結果</h2>
<p>iozoneの測定結果をローカルドライブ、Data Diskの順で見ていく。それぞれの結果を図にした。</p>
<div class="section" id="id5">
<h3>ローカルディスクの性能</h3>
<p>まずは、ローカルドライブの実行結果から見る。読み込みはレコードサイズが8Kあたりから256KBまでは、2,500,000 KB/sec  - 3,000,000 KB/sec で、レコードサイズが増えていくとだんだん遅くなっていく。書き込み側は同じ軸ではとスケールが違い過ぎてよくわからない。</p>
<div class="figure" id="id8">
<img alt="図1 /dev/sdb2 ローカルドライブ 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdb2-rw.png"/>
<p class="caption"><span class="caption-text">図1 /dev/sdb2 ローカルドライブ 2012/12/22 測定</span></p>
</div>
<p>そこで、書き込みの系統だけを表示させた。Record Rewriteの結果が桁外れに速い。これは「Iozone Filesystem Benchmark Download Documentation」 によると、同じ内容を繰り返し書き込むテストということなのでキャッシュの効果だろうと思われる。</p>
<div class="figure" id="id9">
<img alt="図1-1 /dev/sdb2 ローカルドライブ 書き込みのみ表示(1) 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdb2-note1-w.png"/>
<p class="caption"><span class="caption-text">図1-1 /dev/sdb2 ローカルドライブ 書き込みのみ表示(1) 2012/12/22 測定</span></p>
</div>
<p>さらによく見ると、同じ再書き込みでも、Rewrite、Recoed Rewrite、Refwriteの違いがなかなか興味深い。Recoed Rewriteだけがリード並に桁外れに速い。Rewrite、Refwriteはファイル単位の再書き込みで、Recoed Rewriteは特定レコードの再書き込み（Iozone Filesystem Benchmark Download Documentationから）ということなので、キャッシュが利く場合は限定されてるらしいことがわかる。同じものを繰り返し書き込むというのは、現実にはあまり無いことなので、Rewriteをグラフから外して、書き込みのパフォーマンスを見やすくてみる。</p>
<div class="figure" id="id10">
<img alt="図2 /dev/sdb2 ローカルドライブ  書き込みのみ表示(2) 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdb2-w.png"/>
<p class="caption"><span class="caption-text">図2 /dev/sdb2 ローカルドライブ  書き込みのみ表示(2) 2012/12/22 測定</span></p>
</div>
<p>小さいブロックのランダム書き込みが苦手だということがわかる。これはHDDの一般的な傾向で納得できる。以降では書き込みの図は図2と同じデータ項目を表示する。</p>
</div>
<div class="section" id="data-disk">
<h3>Data Diskの性能</h3>
<p>話題のData Diskの性能に入る。ローカルドライ比較で、読み込みはほぼ同等な性能だったが、書き込みは半分程度の性能しか出ていない。ホストキャッシュの設定で大きな違いが出ることを期待したが図を見る限りでは顕著な違いというほどの差異は認められなかった。</p>
<div class="figure" id="id11">
<img alt="図3 /dev/sdc1 ホストキャッシュなし 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdc1-rw.png"/>
<p class="caption"><span class="caption-text">図3 /dev/sdc1 ホストキャッシュなし 2012/12/22 測定</span></p>
</div>
<div class="figure" id="id12">
<img alt="図4 /dev/sdc1 ホストキャッシュなし 2012/12/22 書き込みのみ表示  測定" src="http://kyrt.in/_images/2012_12_sdc1-w.png"/>
<p class="caption"><span class="caption-text">図4 /dev/sdc1 ホストキャッシュなし 2012/12/22 書き込みのみ表示  測定</span></p>
</div>
<div class="figure" id="id13">
<img alt="図5 /dev/sdd1 ホストキャッシュ 読み取り専用 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdd1-rw.png"/>
<p class="caption"><span class="caption-text">図5 /dev/sdd1 ホストキャッシュ 読み取り専用 2012/12/22 測定</span></p>
</div>
<div class="figure" id="id14">
<img alt="図6 /dev/sdd1 ホストキャッシュ 読み取り専用 書き込みのみ表示 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sdd1-w.png"/>
<p class="caption"><span class="caption-text">図6 /dev/sdd1 ホストキャッシュ 読み取り専用 書き込みのみ表示 2012/12/22 測定</span></p>
</div>
<div class="figure" id="id15">
<img alt="図7 /dev/sde1 ホストキャッシュ 読み取り/書き込み 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sde1-rw.png"/>
<p class="caption"><span class="caption-text">図7 /dev/sde1 ホストキャッシュ 読み取り/書き込み 2012/12/22 測定</span></p>
</div>
<div class="figure" id="id16">
<img alt="図8 /dev/sde1 ホストキャッシュ 読み取り/書き込み 書き込みのみ表示 2012/12/22 測定" src="http://kyrt.in/_images/2012_12_sde1-w.png"/>
<p class="caption"><span class="caption-text">図8 /dev/sde1 ホストキャッシュ 読み取り/書き込み 書き込みのみ表示 2012/12/22 測定</span></p>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="id6">
<h3>結論</h3>
<p>iozoneという選択肢がどうだったのかという気もするが、なかなか調子が良い。最初にパフォーマンス向上的な話ではなじめたが、7/4の結果に比べて劇的に変わっているという気はしない。もう少しデータを精査する必要を感じるが、思ったより長くなりすぎたので、また別の方法を絡めて再考してみようと思う。</p>
<p>今回、テスト自体は一回しか走らせていないので再試験して結果を公開してもらえる嬉しい。今まで、Azure Tableの性能評価をした時も、何度か走らせると結果が違ったり、いつの間にかパフォーマンスが改善されたりなどすることがあるので、明確な数字を出すことは難しい。しかし、いろいろなパターンの性能情報があると設計時の精度もあがるので、この手の情報は重要とは思う。</p>
</div>
<div class="section" id="bookmarks">
<h3>Bookmarks</h3>
<ol class="arabic simple">
<li>Iozone Filesystem Benchmark</li>
<li>Iozone Filesystem Benchmark Download Documentation</li>
<li>IOzoneによるファイルシステムのパフォーマンス測定</li>
<li>Azure Ubuntu 12.04 iozone 速報 2012/7/4</li>
</ol>
</div>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sat, 22 Dec 2012 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2012/12/08/blobasyncinside.html</link>
            <guid>http://kyrt.in/2012/12/08/blobasyncinside.html</guid>
            <title><![CDATA[Windows Azure Storage 2.0 の Blob Upload]]></title>
            <description><![CDATA[<h1>Windows Azure Storage 2.0 の Blob Upload</h1>
<p>前の記事<a class="reference internal" href="http://kyrt.in/2012/12/08/waac2012day2.html"><span class="doc">Azure Storage Gen 2は速かった</span></a>では非同期呼び出しを使っていますが、これには理由があります。以前（2010年ぐらい）、Windows Azureを使い始めたころにSorage Client 1.xと、.NET Framework 4.0の組み合わせでいろいろ試した時には、スレッドを上げてやったのと非同期にしてやったので比べた時には有意な違いは出ませんでした。非同期でコードを書くと面倒になることも多かったので、「手間の割にはあまりメリットは無いなあ」というのが当時の結論だったのです。</p>
<p>ところが、2012年10月の末にAzure Storage Client 2.0が出てAPIや実装が大幅に変わったので変更点を眺めていたら面白いことに気が付きました。2.0ではBlobの書き込みは、Stream.WriteToSync()でやっていて、そのWriteToSyncの中が非同期呼び出しで実装されているとか、非同期呼び出し数をセマフォを使って制限しているところなどなかなか良さげな実装になっています。</p>
<p>ある日、<a class="reference external" href="https://github.com/chgeuer/AzureLargeFileUploader">AzureLargeFileUploader</a>というのがGitHubに上がっているのに気が付いて中を見てみたら、前に読んだSDKの実装に比べても、そんなに優れているようには見えません。「あのコードより2.0の実装の方が大きなファイルでも効率的にUploadできるはず、もしかしたら2.0のコードは壊れているのからこんなことしてるのかな？」と思い2.0のコードを動かして実際に試して見ました。やってみたらなかなか調子が良く2.0の実装では十分な速度でBlobにアップロードされます。</p>
<p>C# 5.0で await/asyc もサポートされ .NET 4.5になってTask周りも改善されて非同期を使うには良い環境が揃ってきていると感じました。それで改めて非同期呼び出しを使ってみることにしました。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/8149221698/"><img alt="shibuya by takekazu, on Flickr" src="http://farm9.staticflickr.com/8328/8149221698_e44be55a36_c.jpg"/></a>
<hr class="docutils"/>
<div class="section" id="id1">
<h2>試行（やってみた）</h2>
<p>Azure Datacenter内にLargeのインスタンスを用意して適当なファイルを元にして8GBのファイルを用意しました。そのファイルを同一のBlobに4回アップロードして平均の速度を測定します。結果は、 ** 平均473Mbps ** でした。これは、ほぼインスタンスのネットワーク帯域制限値と同じです。なかなか良い結果と言えます。</p>
<p>確認に使ったコード、（メッセージがドイツ語になっているのは、AzureLargeFileUploader の名残です）</p>
<script src="https://gist.github.com/takekazuomi/4133960.js">&amp;amp;nbsp;</script><p>このコードのポイントは下記の3点です。</p>
<ol class="arabic simple">
<li>18行目ので接続数の制限を1024に設定していること</li>
<li>59行目で並列度の設定をコア数の12倍にしていること</li>
<li>55,56行目ではPage/Block Blobのどちらを使うかを切り替えていること</li>
</ol>
<p>接続が作れないと並列度が上がらないのでDefaultConnectionLimitを増やし、Storage Client 2.0ではParallelOperationThreadCount のデフォルトが1になっているのでコア数の12倍に設定します。Storage Client 2.0では、55, 56行目のように切り替えるだけで、どちらでも並列アップロードができるようになっています。1.xのときは、UploadFromStreamを使った時にBlock Blobでしか並列アップロードがサポートされてなかったことに比べて改善されています。</p>
<p>アップロード中をリソースマネージャーで観察するとコネクションが数多く作成されているのが確認できます。右側のNetworkトラフィックのグラフが波打っているのが興味深いところです。ピーク時に600-700Mbps程度行くこともありますが平均すると470 Mbpsという結果でした。CPUは5-10%程度しか使われていませんし、メモリーも開始から終了までほぼ一定です。なかなか優秀です。</p>
<img alt="../../../_images/2012-08-screen01.png" src="http://kyrt.in/_images/2012-08-screen01.png"/>
<p>![Resource Monitor](/images/2012-08-screen01.png)</p>
<hr class="docutils"/>
<p>** ここからは、ソースを見ながら確認していった過程のメモです。リンクばかりで分かり辛いかもしれませんが参考までに。興味深いのは非同期と同期の処理の境界と並列度の制限をしている部分です。 **</p>
</div>
<hr class="docutils"/>
<div class="section" id="paralleloperationthreadcount">
<h2>どうしてこんなところが変わったの？ ParallelOperationThreadCount のデフォルト値</h2>
</div>
<div class="section" id="x">
<h2>1.x では</h2>
<p>CloudBlobClientに、ParallelOperationThreadCount というのがあります。１系では、下記のように定義されていました。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/sdk_1.7.1/microsoft-azure-api/StorageClient/CloudBlobClient.cs#L261">StorageClient/CloudBlobClient.cs#L261</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/sdk_1.7.1/microsoft-azure-api/StorageClient/CloudBlobClient.cs#L52">CloudBlobClient.cs#L52</a></p>
<p>試しに、下記のようなコードでioThreadsを確認したところデスクトップPCでは２，Azure上のLargeのインスタンスでは４でした。どちらの環境でもデフォルトでParallelOperationThreadCountが２以上になり並列で動作します。</p>
<script src="https://gist.github.com/takekazuomi/4239681.js">&amp;amp;nbsp;</script></div>
<div class="section" id="id2">
<h2>2.0 では</h2>
<p>それに対し、２系では下記のように定義されています。parallelismFactorは、47行目付近で1で初期化されておりデフォルトは1となります。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/Common/Blob/CloudBlobClientBase.cs#L232">CloudBlobClientBase.cs#L232</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/Common/Blob/CloudBlobClientBase.cs#L47">CloudBlobClientBase.cs#L47</a></p>
<p>これからParallelOperationThreadCount のデフォルトが1に変わったことがわかります。これは、<a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2012/10/29/windows-azure-storage-client-library-2-0-breaking-changes-amp-migration-guide.aspx">Windows Azure Storage Client Library 2.0 Breaking Changes &amp; Migration Guide</a>にも書いてあるBreaking Changesです。</p>
<p>2.0に移行した後、Block Blobのアップロードが遅くなった場合はParallelOperationThreadCountを確認するといいかもしれません。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id3">
<h2>ParallelOperationThreadCountの使われ方</h2>
<p>1.xでは、ParallelOperationThreadCount は、ParallelUpload で並列度の定義になっています。このクラスは、Streamをblock blobにUploadするもので、BlobClient.UploadFromStreamを、Block blobで使った時しか使われません。** Page Blobでは並列アップロードは実装されていません。 ** おそらく、SDK 1xではPage Blogのパラレルアップロードをサポートしていないので、<a class="reference external" href="https://github.com/chgeuer/AzureLargeFileUploader">AzureLargeFileUploader</a>を用意したのだと思います ** あのソースだけだと分からないですが</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/sdk_1.7.1/microsoft-azure-api/StorageClient/ParallelUpload.cs">ParallelUpload.cs</a></p>
<p>ParallelExecute あたりの処理をみると、Block毎にTaskを上げているらしいことがわかります。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/sdk_1.7.1/microsoft-azure-api/StorageClient/ParallelUpload.cs#L148">ParallelUpload.cs#L148</a></p>
<p>2.0.1では、CloudBlockBlob のUploadFromStreamは、並列処理をするときにはStreamの拡張メソッドのWriteToSyncを呼んでいます。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/DotNetCommon/Blob/CloudBlockBlob.cs#L116">CloudBlockBlob.cs#L116</a></p>
<hr class="docutils"/>
</div>
<div class="section" id="blobasyncinside-borderofsyncasync">
<span id="id5"/><h2>同期と非同期の境界</h2>
<p>WriteToSyncの実装は下記のようになっています。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/Common/Core/Util/StreamExtensions.cs#L64">StreamExtensions.cs#L64</a></p>
<p>ちょっと見ると、WriteToSyncは、読み込み側のStreamを非同期で読み出すためのフラグをもっているだけで書き込みは同期していて、並列動作しないような感じです。これだと、ParallelOperationThreadCountに2以上をセットしてもパラレルアップロードは行われないのかな？と思いますが、その先のtoStream.Write の実装を見ると内部が非同期に処理されています。</p>
<p>toStreamの実態は、BlobをStreamとして扱うBlobWriteStreamのインスタンスで、これは内部的に非同期で書き込みを行います。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/DotNetCommon/Blob/BlobWriteStream.cs">BlobWriteStream.cs</a></p>
<p>呼び出し側を見ると同期処理のように見えるが、BlobWriteStreamBase で、AsyncSemaphore　parallelOperationSemaphoerをParallelOperationThreadCountの数で初期化しており、ストーリーム内のブロック書き込みは非同期に行われています。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/DotNetCommon/Blob/BlobWriteStream.cs#L286">BlobWriteStream.cs#L286</a></p>
<p>この設計はなかなかイイ。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id6">
<h2>非同期実行数の制限</h2>
<p>ここで、AsyncSemaphoreは、既定の数以上に処理が実行されないように非同期実行数を制御している役割を果たしている。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/blob/master/microsoft-azure-api/Services/Storage/Lib/DotNetCommon/Core/Util/AsyncSemaphore.cs">AsyncSemaphore.cs</a></p>
<p>BlobWriteStreamでは、書き込みが全部終わると、最後に PutBlockList して終了する。同様な処理がPage Blobにも用意されていて並列アップロードされるような実装になっている。</p>
<p>このあたりは、<a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/jj721952.aspx">What’s New in Storage Client Library for .NET (version 2.0)</a>に書いてある説明通りの実装になってるようだ。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id7">
<h2>結論</h2>
<p>Blobのアップロードのような I/O がボトルネックとなるような処理ではI/O の非同期を使うことでCPU、メモリの負荷を最低限にして効率的に処理をすることができる。このコードでは、Stream 書き込みの内部処理を非同期化することで全体のパフォーマンスを向上しプログラミングモデルへの影響は最低限にしている。サーバーサイドのプログラミングではこのような、同期、非同期の境界を発見して設計することが重要だと言える。非同期実行数の制限もなかなか興味深い。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id8">
<h2>おまけ</h2>
<p>LargeのRoleからStorageにUploadしたら450Mbps程度の速度が出た。ローカルからも、20Mbps程度だったので結構速い。転送中を見ていると、しばらくは複数のコネクションを使ってデータ転送していて最後にコネクションが一本になって終わる。、</p>
<p>PutBlobを非同期でやって最後にPutBlobListで終了となってるようだ。PutBlobの処理中はCPUはほとんど使われずに、ネットワーク帯域がボトルネックになっるぐらいには効率がいい。最後のPutBlobListの間はStorage側の待ちになってしまう。</p>
<p>これを考えると、複数のファイルをUploadする場合は、スレッドを分けて個々に処理した方が短時間で終わるのではないかと考えられる。ただ、あまり多くのスレッドを起動するメリットは無さそうだ。</p>
<p>今回は、UploadFromStreamを使ったが下記の説明にはOpenWriteを使うとStreamのように処理できると書いてある。やってみたら同じように動いた。つまりBlobをStreamとして使えるってことだ素晴らしい。</p>
<p><a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.storage.blob.cloudblockblob.openwrite.aspx">CloudBlockBlob.OpenWrite Method</a></p>
</div>
]]></description>
            <category><![CDATA[ Azure Blob ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sat, 08 Dec 2012 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://kyrt.in/2012/12/08/waac2012day2.html</link>
            <guid>http://kyrt.in/2012/12/08/waac2012day2.html</guid>
            <title><![CDATA[Azure Storage Gen 2は速かった]]></title>
            <description><![CDATA[<h1>Azure Storage Gen 2は速かった</h1>
<p>今年も早いもので、あっという間に12月になりました。個人的なAzure今年の目玉は、Azure Storageのパフォーマンスの向上(Gen2)と新しくなったWindows Azure Storage 2.0です。</p>
<p>IaaS、Web Site、Mobile Service、Media Serviceなど新機能満載なAzureですが、目立たないところで地味にストレージ関連は改善されています。ストレージはクラウドの足回りなので重要です。</p>
<ul class="simple">
<li>元記事は、Windows Azure Advent Calendar 2012 2日目として書きました。<a class="reference external" href="http://atnd.org/events/34353">Windows Azure Advent Calendar jp: 2012</a></li>
</ul>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/8217239370/"><img alt="omikuji by takekazu, on Flickr" src="http://farm9.staticflickr.com/8484/8217239370_f6ebb8d21d_z.jpg"/></a>
<hr class="docutils"/>
<div class="section" id="azure-storage">
<h2>Azure Storageのパフォーマンスの向上</h2>
<p>2012/6/7 以降に作成されたストレージアカウントで、下記のようにパフォーマンスターゲットが引き上げられました。Gen 2と呼ばれているようです。以前のもの（Gen1）に比べ秒間のトランザクションベースだと4倍程度になっています（Azure Table 1Kエンティティの場合）</p>
<p>詳しくはリンク先を見てもらうとして下記の4点が注目です。</p>
<ol class="arabic simple">
<li>ストレージ ノード 間のネットワーク速度が1Gbpsから10Gbpsに向上</li>
<li>ジャーナリングに使われるストレージデバイスがHDDからSSDに改善</li>
<li>単一パーテーション  500 エンティティ/秒 -&gt;   2,000 エンティティ/秒 (15Mbps)</li>
<li>複数パーテーション 5,000 エンティティ/秒 -&gt; 20,000 エンティティ/秒 (156Mbps)</li>
</ol>
<p>参照：<a class="reference external" href="http://satonaoki.wordpress.com/2012/11/03/windows-azure%E3%81%AE%E3%83%95%E3%83%A9%E3%83%83%E3%83%88-%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF-%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%A82012%E5%B9%B4%E7%89%88%E3%82%B9/">Windows Azureのフラット ネットワーク ストレージと2012年版スケーラビリティ ターゲット</a></p>
</div>
<hr class="docutils"/>
<div class="section" id="id1">
<h2>確認しよう</h2>
<p>ではどれだけ速くなったのか確認しましょう。なるべく実利用環境に近いようにということでC#を使います。ライブライは、最近出たばかりですが、Azure Storage Client 2.0を使います。このライブラリのコードをざっと見た感じだと、従来のコードに比べてシンプルになって読みやすく速度も期待できそうです。</p>
<p>比較的限界が低い単一パーテーションで確認します。前記のGen2の記事には、エンティティが1KByteで、単一パーテーションの場合、2,000 エンティティ/秒というパフォーマンスターゲットが記述されています。これを確認しようとするとAzure外部からのネットワークアクセスだと厳しいのでWorkerRoleを立てて、リモートデスクトップでログインしてプログラムを実行します。プログラムは秒間2000オブジェクトを計測時間の間は作りづけないといけないのでCPUやGCがボトルネックになるかもしれません、今回はLargeのインスタンスを使うことにしました。</p>
<p>Largeだとメモリ7GByte、coreが8つ、ネットワーク400Mbpsというスペックなので気にしなくても良いかと思ったのですが、GCをなるべく減らすためにエンティティのデータ部分をCache（共有）します。1KByteぐらいだとあまり効果が無いかもしれませんが。</p>
<script src="https://gist.github.com/takekazuomi/4238298.js">&amp;amp;nbsp;</script><p>さらに、Threadを上げる数を減らして並列性を上げるために非同期呼び出しを使います。.NET 4.5 から await/async が使えるので割合簡単に非同期コードが記述できるのですが、少し手間がかかりました。</p>
<p>なんと残念ながら、Windows Azure Storage 2.0になっても APM (Asynchronous Programming Model) のメソッドしか用意されておらず、 await で使えるTaskAsyncの形式がサポートされていません。仕方がないので、自分で拡張メソッドを書きますが、引数が多くて intellisense があっても混乱します。泣く泣く、コンパイルエラーで期待されているシグニチャーをみながら書きました。コードとしてはこんな感じで簡単です。</p>
<script src="https://gist.github.com/takekazuomi/4238639.js">&amp;amp;nbsp;</script><p>この辺りは、下記のサイトが詳しくお勧めです。</p>
<p>参照：<a class="reference external" href="http://ufcpp.net/study/csharp/sp5_async.html#async">++C++; // 未確認飛行C 非同期処理</a></p>
<div class="section" id="waac2012day2-pending">
<span id="id2"/><h3>非同期で同時接続数が上がらない？</h3>
<p>このコードを動かしてみたら、「単一スレッド＋非同期の組み合わせだと、おおよそ２から３程度のコネクションしか作成されない」ことに気が付きました。場合によっては、5ぐらいまで上がることもあるようですが、どうしてこうなるのか不思議です。</p>
<p>#### ** これは、Azure Storage Client 2.0のBUG ** だったようです。2.0.2で修正されています。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/pull/134">WindowsAzure/azure-sdk-for-net Issue #141</a></p>
<p>** [2012/12/26 このFIXに関するまとめを書きました](<a class="reference internal" href="http://kyrt.in/2012/12/26/asc2_dot_0asyncbug.html"><span class="doc">Azure Storage Client 2.0 CompletedSynchronously FIX</span></a>) **</p>
<p>非同期でガンガンリクエストが飛ぶのかと思ったのですが、それほどでもなかったので、今回のコードは複数スレッド（Task）をあげて、それぞれのスレッド内で非同期呼び出しを使って処理を行うようになっています。Taskの起動には、Parallel.ForEach を使っています。</p>
<p>さらに、上限に挑戦するためにEntity Group Transactionを使います。TableBatchOperation のインスタンスを作って操作を追加していってCloudTableのExecuteBatchAsync()で実行します。この辺りは以前の使い方とだいぶ違っています。今回は時間を測っているだけですが、resultにはEntityのリストが帰ってきて、それぞれにtimestampとetagがセットされています。</p>
<script src="https://gist.github.com/takekazuomi/4238661.js">&amp;amp;nbsp;</script><p>—</p>
</div>
</div>
<div class="section" id="id3">
<h2>結果</h2>
<p>いくつかパラメータを調整して実行し、スロットリングが起きる前後を探して4回測定しました。ピークe/sは、もっとも時間当たりのエンティティの挿入数が大きかった時の数字で秒間のエンティティ挿入数を表しています。単一プロセスでスレッドを増やしていく方法では頭打ちになってしまうので、複数のプロセスを起動して測定ています。（このあたりも少しオカシイです）下記の表の最初のカラムは起動するプロセス数です。</p>
<p>失敗が無かったケースで6,684、 6,932 エンティティ/秒で処理できており、Gen2で挙げられているパフォーマンスターゲットは十分達成できているようです。</p>
<p>測定時間の、Table Metricsを見るとThrottlingErrorと同時に、ClientTimeoutErrorも出ているのでプロセスを3つ上げているケースではクライアント側でサーバからの戻りが受けきれずにエラーになっている場合も含まれているようです。</p>
<table border="1" class="colwidths-given docutils" id="id6">
<caption><span class="caption-text">表1 条件：エンティティサイズ 1KByte、単一パーテーション、スレッド数12、バッチサイズ100</span></caption>
<colgroup>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
<col width="9%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">プロセス数</th>
<th class="head">最少</th>
<th class="head">中央値</th>
<th class="head">平均</th>
<th class="head">最大</th>
<th class="head">90%点</th>
<th class="head">95%点</th>
<th class="head">99%点</th>
<th class="head">ピークe/s</th>
<th class="head">成功数</th>
<th class="head">失敗数</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2</td>
<td>97.27</td>
<td>166.6</td>
<td>258</td>
<td>14,800</td>
<td>359.578</td>
<td>472.373</td>
<td>1,106.28</td>
<td>6,684</td>
<td>40,000</td>
<td>0</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>94.17</td>
<td>260.5</td>
<td>333.7</td>
<td>5,320</td>
<td>564.774</td>
<td>723.272</td>
<td>1,339.03</td>
<td>6,932</td>
<td>40,000</td>
<td>0</td>
</tr>
<tr class="row-even"><td>3</td>
<td>90.13</td>
<td>174.8</td>
<td>734.1</td>
<td>21,270</td>
<td>1,621.49</td>
<td>1,845.90</td>
<td>3,434.26</td>
<td>7,218</td>
<td>59,377</td>
<td>623</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>90.35</td>
<td>341.6</td>
<td>610.1</td>
<td>27,490</td>
<td>1,064.59</td>
<td>1,380.42</td>
<td>4,431.79</td>
<td>8,005</td>
<td>59,740</td>
<td>260</td>
</tr>
</tbody>
</table>
</div>
<hr class="docutils"/>
<div class="section" id="id4">
<h2>最後に</h2>
<p>今回、第一世代（Gen 1）の単一パーテーションで500 エンティティ/秒というパフォーマンスターゲットに比べ10倍近いパフォーマンスを出しているのが測定できました。測定時間が短かったので、継続してこのパフォーマンスがでるのかどうかなど検証の余地はありますが、劇的に向上していると言えます。<a class="reference external" href="https://github.com/takekazuomi/WAAC201202">takekazuomi/WAAC201202のレポジトリ</a>に計測に使ったコードをいれてあります。</p>
<p>12/2の担当でしたが、JSTでは日付も変わってだいぶ遅くなってしました。データの解析に最近お気に入りの（慣れない）「R」を使ったのですが、いろいろ手間取ってしまいました。最初はRで出した図なども入れたいと思ったのですが、軸や凡例の設定がうまくできずに時間切れで断念です。</p>
<p>レポジトリには、なんかずいぶん古い履歴まで上がってしましたが、手元のコードを使いまわしたら出てしまいました。スルーでお願いします。</p>
</div>
<hr class="docutils"/>
<div class="section" id="id5">
<h2>おまけ</h2>
<p>数時間振り回してみると、エンティティ/秒の中央値は2000から3000エンティティ/秒程度になりそうです。負荷がかかり始めると、Gen １ではスロットリングをかけてエラーにしてしまうという動きでしたが、Gen 2 ではスロットリングを随時掛けつつ2000から3000エンティティ/秒程度に絞っていくという動きになったようです。`</p>
</div>
]]></description>
            <category><![CDATA[ Azure Table ]]></category>
            <category><![CDATA[ Azure ]]></category>
             <pubDate>Sat, 08 Dec 2012 00:00:00 +0900</pubDate>
        </item>
    
    </channel>
</rss>