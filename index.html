<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="もろもろの備忘録、C#とAzureなど">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; Kyrt Blog</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/flat.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/webfont.css" type="text/css">
        <link rel="stylesheet" href="_static/style.css" type="text/css" /><link rel="shortcut icon" href="_static/favicon.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script><script type="text/javascript" src="_static/google_analytics.js"></script><meta property="og:type" content="article" />
<meta property="og:title" content="Home &mdash; Kyrt Blog" />
<meta property="og:description" content="もろもろの備忘録、C#とAzureなど" />
<meta property="og:url" content="http://kyrt.in/index.html" />
</head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header>
            <hgroup>
              <h1><a href="#">Kyrt Blog</a></h1><h2>もろもろの備忘録、C#とAzureなど</h2></hgroup>
          </header>
      <nav>
      <ul>
        <li class="main-nav">
          <a href="#">Home</a>
        </li>
        <li class="main-nav">
          <a href="pages/about_me.html">About Kyrt</a>
        </li>
        <li class="logo-nav">
	  <a href="pages/about_me.html" >
            <img id="kyrt_logo" alt="kyrt logo" src="_static/kyrt_logo.png" width = 200 height = 106 />
	  </a>
        </li><li class="quicklink"><div class="rss">
        <a href="rss.html" title="Subscribe via RSS"><span class="webfont">B</span></a>
    </div></li></ul>
    </nav><div class="main-container"><div class="main wrapper clearfix"><article><div class="timestamp postmeta">
            <span>January 06, 2014</span>
        </div>
        <div class="section" id="windows-azure-storage-3-0-2-hotfix">
<h1><a href="2014/01/06/windows_azure_storage_3_0_2_hotfix.html">Windows Azure Storage 3.0.2 Hotfix</a></h1>
<p>2014/1/4 <a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.2">Windows Azure Storage 3.0.2</a> がリリースされました。
2013/11/27 3.0のリリース 「 <a class="reference internal" href="2013/11/28/cors_json_minute_metrics_and_more.html"><em>Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介</em></a> 」、2013/12/11 の 3.0.1 hotfix 「 <a class="reference internal" href="2013/12/11/windows_azure_storage_client_3_0_1.html"><em>Windows Azure Storage Client 3.0.1</em></a> 」 に続く３回めのリリースです。</p>
<a class="reference external image-reference" href="http://flic.kr/p/iSAtsB"><img alt="zenko-ji by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3665/11730616035_d5730064f3.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>修正点</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/changelog.txt#L184">Issues fixed in 3.0.2.0 :</a> :</p>
<ol class="arabic simple">
<li>All (WP): 多くのAPIで ArgumentOutOfRangeException になる問題の修正</li>
<li>Queues: 存在するqueueの再度作成で、NullReferenceException になる問題を修正</li>
<li>Tables: レスポンスがparseできなかったときに、TableServiceContext が NullReferenceException になる問題を修正</li>
<li>Tables (RT): JSON形式がまだRT library でサポートされていないため、ユーザーは、RTで RequestOptions に JsonFullMetadata formart を設定することはできません</li>
</ol>
<p>コードを確認したところ、最初のやつが興味深いものでした。</p>
</div>
<div class="section" id="all-wp-api-argumentoutofrangeexception">
<h2>1. All (WP): 多くのAPIで ArgumentOutOfRangeException になる問題の修正</h2>
<p>対象は、Windows Phone プラットフォームだけで特定のAPIでなく全般的に発生します。
関連する Issue として 、 <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/issues/16">System.ArgumentOutOfRangeException in Microsoft.WindowsAzure.Storage.Table.CloudTable.EndExecute</a> が出ています。</p>
<p>共通で使っている、API内のパラメータのバウンダリー検査関数（ <span class="docutils literal"><span class="pre">AssertInBounds</span></span> ）が動いていなくてあちこちで問題が発生するということになっていたようです。（そうは言っても、テストはしているので、そうそう起きるわけでは無いとは思います）</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17">Storage Client Library 3.0.2 のPR</a> でdiffを見みると、WINDOWS_PHONEだけで下記のように修正されていました。</p>
<img alt="../../../_images/2014-01-06-github001.png" src="_images/2014-01-06-github001.png"/>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17/files#diff-546e2cf76676e7cafc795f6d4d105fefR160">https://github.com/WindowsAzure/azure-storage-net/pull/17/files#diff-546e2cf76676e7cafc795f6d4d105fefR160</a></p>
<p>#if WINDOWS_PHONE で AssertInBounds に、 <span class="docutils literal"><span class="pre">[System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoOptimization)]</span></span>  を指定しています。この指定は、JITやNGENでのコード最適化を抑制するもので、 <a class="footnote-reference" href="#r1" id="id2">[1]</a> Windows Phone の場合だけ native code 生成に問題があったので抑制するオプションを付けたということです。</p>
<p>Windows Phone というだけで、どのような場合に発生する問題かなどわかりませんが、WP アプリのコードが挙動不審の場合は試してみると良いかもしれません。Storage Clinet Library内では、この方法で修正されているようなので問題は無いのですが、普通に書いたコードでも起きるとすると、ちょっと困りますね。もう少し詳しい情報が欲しいところです。 <a class="footnote-reference" href="#r2" id="id3">[2]</a></p>
<p>これ以外は、あまり気になる点はありませんでした。互換性の問題も無さそうなので、3系のStorage Clinetは 3.0.2 を使うのがお勧めです。</p>
</div>
<div class="section" id="windows-phone">
<span id="scl302-more-info"/><h2>2014/1/11 追記 Windows Phoneの問題</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17#issuecomment-31639331">PR に質問</a> に返事を貰いました。</p>
<blockquote>
<div><div class="line-block">
<div class="line">この問題は、Windows Phone でだけ起き、assemblyに、AssertInBoundsとAssertInBounds 両方が存在する場合に、最適化で実行時にAssertInBoundsの間違ったインスタンス化を選択することによって引き起こされる</div>
</div>
</div></blockquote>
<p><span class="docutils literal"><span class="pre">internal</span> <span class="pre">static</span> <span class="pre">void</span> <span class="pre">AssertInBounds&lt;T&gt;(string</span> <span class="pre">paramName,</span> <span class="pre">T</span> <span class="pre">val,</span> <span class="pre">T</span> <span class="pre">min,</span> <span class="pre">T</span> <span class="pre">max)</span> <span class="pre">where</span> <span class="pre">T</span> <span class="pre">:</span> <span class="pre">IComparable</span></span> と、 <span class="docutils literal"><span class="pre">internal</span> <span class="pre">static</span> <span class="pre">void</span> <span class="pre">AssertInBounds&lt;T&gt;(string</span> <span class="pre">paramName,</span> <span class="pre">T</span> <span class="pre">val,</span> <span class="pre">T</span> <span class="pre">min)</span> <span class="pre">where</span> <span class="pre">T</span> <span class="pre">:</span> <span class="pre">IComparable</span></span> の両方が同一 assembly にあるのが問題のようです。 必ず起きるというわけでも無さそうなので、Windows Phone で嵌ったら思い出してみるという程度で良さそうです。</p>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://msdn.microsoft.com/ja-jp/library/system.runtime.compilerservices.methodimploptions(v=vs.110).aspx">About System.Runtime.CompilerServices.MethodImplOptions</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/pull/17#issuecomment-31676932">We escalated this internally ...</a></td></tr>
</tbody>
</table>
</div>
</div>
        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure_storage.html">Azure Storage</a>, <a href="categories/azure.html">Azure</a>, <a href="categories/github観察記.html">GitHub観察記</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure_table.html">Azure Table</a>, <a href="tags/table.html">Table</a>, <a href="tags/storage.html">Storage</a>, <a href="tags/hotfix.html">Hotfix</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2014/01/06/windows_azure_storage_3_0_2_hotfix.html#disqus_thread" data-disqus-identifier="2014/01/06/windows_azure_storage_3_0_2_hotfix">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 27, 2013</span>
        </div>
        <div class="section" id="resolved-windows-azure-storage-known-issues-2013-11">
<h1><a href="2013/12/27/azure_storage_known_issues_november_2013_resolved.html">[Resolved] Windows Azure Storage Known Issues 2013/11</a></h1>
<p><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html"><em>Windows Azure Storage Known Issues 2013/11</em></a> の既知の問題が解決されたとアナウンスがありました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">Windows Azure Storage Known Issues (November 2013) [Resolved]</a> どんな感じになったのかを確認しました。</p>
<div class="section" id="id1">
<h2>引用</h2>
<blockquote>
<div><div class="line-block">
<div class="line">更新 [2013/12/10] : <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/23/windows-azure-storage-known-issues-november-2013.aspx">このBlog に記述されている問題</a> <a class="footnote-reference" href="#r1" id="id2">[1]</a> は、service と client library の更新で解決されました。issue 2 の client table の件は、 <a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage/2.1.0.4">2.1.0.4</a>  <a class="footnote-reference" href="#r2" id="id4">[2]</a> と  <a class="reference external" href="https://www.nuget.org/packages/WindowsAzure.Storage">3.x</a> <a class="footnote-reference" href="#r3" id="id5">[3]</a> の client library の releases で解決されています。</div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br/></div>
</div>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9742159560"><img alt="matuyama by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7416/9742159560_500e7d6301.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
</div>
<div class="section" id="id6">
<h2>問題点の確認</h2>
<p>問題点は下記の3つが有りました。「3」は、既に、 <a class="reference internal" href="2013/11/30/fixed_storage_client_cast_problem_in_2013_08_15_version.html"><em>Storage Client 2.1.0.4 以降での Cast問題の修正</em></a> で、Client Library 2.1.0.4、3.xで修正確認ができているので、ここでは1と2を確認します。</p>
<ol class="arabic simple">
<li><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><em>SASとコンテナの前の// 問題</em></a></li>
<li><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><em>TableのDataServiceContext.ResolveName 指定 問題</em></a></li>
<li><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-201311"><em>Table Query での Cast 問題</em></a></li>
</ol>
</div>
<div class="section" id="sas">
<h2><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><em>SASとコンテナの前の “//” 問題</em></a></h2>
<p>下記のようなプログラムで確認しました。Signitureの生成結果を確認しやすいように、2013/12/01から一年有効なREADのSASにしています。
Storage Client 2.1.0.4 では、2012-02-12 versionが使われて、コンテナの前が <span class="docutils literal"><span class="pre">&quot;//&quot;</span></span> になっていても動きましたが、3.0.1だと、2013-08-15 versionが使われ、400 のエラーで弾かれるという結果になりました。もともと、 <span class="docutils literal"><span class="pre">&quot;//&quot;</span></span> と書いたら <span class="docutils literal"><span class="pre">&quot;/&quot;</span></span> と解釈されるというのはあまりイケてない動きなので、古いバージョンのみ互換性を持つように変更して新しいものでは動作変更ということにしたのは妥当な落とし所かと思います。Storage Versionによって動作が違うようです。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetSASUrl</span><span class="p">(</span><span class="n">CloudStorageAccount</span> <span class="n">storageAccount</span><span class="p">,</span> <span class="kt">string</span> <span class="n">containerName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">blobName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">blobClient</span> <span class="p">=</span> <span class="n">storageAccount</span><span class="p">.</span><span class="n">CreateCloudBlobClient</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">blobClient</span><span class="p">.</span><span class="n">GetContainerReference</span><span class="p">(</span><span class="n">containerName</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">blockBlob</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetBlockBlobReference</span><span class="p">(</span><span class="n">blobName</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">startDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="s">&quot;2013/12/01&quot;</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">sas</span> <span class="p">=</span> <span class="n">blockBlob</span><span class="p">.</span><span class="n">GetSharedAccessSignature</span><span class="p">(</span><span class="k">new</span> <span class="n">SharedAccessBlobPolicy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Permissions</span> <span class="p">=</span> <span class="n">SharedAccessBlobPermissions</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span>
        <span class="n">SharedAccessStartTime</span> <span class="p">=</span> <span class="n">startDate</span><span class="p">,</span>
        <span class="n">SharedAccessExpiryTime</span> <span class="p">=</span> <span class="n">startDate</span><span class="p">.</span><span class="n">AddYears</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">});</span>
    
    <span class="k">return</span> <span class="n">blockBlob</span><span class="p">.</span><span class="n">Uri</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="n">sas</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id7">
<h3>2.1.0.4での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span> <span class="pre">-Version</span> <span class="pre">2.1.0.4</span></span> で2.1.0.4を入れます。何度も、違うバージョンのライブラリを入れ替えて使っていて、混乱したので念のためpackage.configの内容を併記します。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;packages&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.Data.Edm&quot;</span> <span class="na">version=</span><span class="s">&quot;5.2.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.Data.OData&quot;</span> <span class="na">version=</span><span class="s">&quot;5.2.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.WindowsAzure.ConfigurationManager&quot;</span> <span class="na">version=</span><span class="s">&quot;1.8.0.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;System.Spatial&quot;</span> <span class="na">version=</span><span class="s">&quot;5.2.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;WindowsAzure.Storage&quot;</span> <span class="na">version=</span><span class="s">&quot;2.1.0.4&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<p>生成されたURLで成功を確認</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture">http://test.blob.core.windows.net/images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture</a>]</div>
</div>
</div></blockquote>
<p>コンテナの前に、 <span class="docutils literal"><span class="pre">&quot;/&quot;</span></span> を追加して確認、成功！</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture">http://test.blob.core.windows.net//images/photo.jpg?sv=2012-02-12&amp;se=2014-11-30T15%3A00%3A00Z&amp;sr=b&amp;sp=r&amp;sig=[signiture</a>]</div>
</div>
</div></blockquote>
<p><span class="docutils literal"><span class="pre">sv=2012-02-12</span></span> になっていて、versionがわかります。</p>
</div>
<div class="section" id="id8">
<h3>3.0.1での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span></span> で最新版、3.0.1で確認</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;packages&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.Data.Edm&quot;</span> <span class="na">version=</span><span class="s">&quot;5.6.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.Data.OData&quot;</span> <span class="na">version=</span><span class="s">&quot;5.6.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.Data.Services.Client&quot;</span> <span class="na">version=</span><span class="s">&quot;5.6.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Microsoft.WindowsAzure.ConfigurationManager&quot;</span> <span class="na">version=</span><span class="s">&quot;1.8.0.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;Newtonsoft.Json&quot;</span> <span class="na">version=</span><span class="s">&quot;5.0.8&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;System.Spatial&quot;</span> <span class="na">version=</span><span class="s">&quot;5.6.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;package</span> <span class="na">id=</span><span class="s">&quot;WindowsAzure.Storage&quot;</span> <span class="na">version=</span><span class="s">&quot;3.0.1.0&quot;</span> <span class="na">targetFramework=</span><span class="s">&quot;net451&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/packages&gt;</span>
</pre></div>
</div>
<p>生成されたURLで成功を確認</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r">http://test.blob.core.windows.net/images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r</a></div>
</div>
</div></blockquote>
<p>コンテナの前に、 <span class="docutils literal"><span class="pre">&quot;/&quot;</span></span> を追加。これは失敗します。</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="http://test.blob.core.windows.net/images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r">http://test.blob.core.windows.net//images/photo.jpg?sv=2013-08-15&amp;sr=b&amp;sig=[signiture]&amp;se=2014-11-30T15%3A00%3A00Z&amp;sp=r</a></div>
</div>
</div></blockquote>
<p>レスポンスを見ると下記のようになっていました。（XMLは整形してあります）</p>
<div class="highlight-none"><div class="highlight"><pre>HTTP/1.1 400 The requested URI does not represent any resource on the server.
Content-Length: 434
Content-Type: application/xml
Server: Microsoft-HTTPAPI/2.0
x-ms-request-id: a9275897-8810-48b2-bcd5-d45af85f6f14
Date: Fri, 27 Dec 2013 12:34:46 GMT

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;Error&gt;
  &lt;Code&gt;InvalidUri&lt;/Code&gt;
  &lt;Message&gt;
    The requested URI does not represent any resource on the server.
    RequestId:a9275897-8810-48b2-bcd5-d45af85f6f14
    Time:2013-12-27T12:34:46.6851586Z
  &lt;/Message&gt;
  &lt;UriPath&gt;
  http://test.blob.core.windows.net//images/photo.jpg?sv=2013-08-15&amp;amp;sr=b&amp;amp;sig=[signiture]&amp;amp;se=2014-11-30T15:00:00Z&amp;amp;sp=r
  &lt;/UriPath&gt;
&lt;/Error&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="tabledataservicecontext-resolvename">
<h2><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><em>TableのDataServiceContext.ResolveName 指定 問題</em></a></h2>
<p>同様に、下記のようなコードを使って、2.1.0.4と、3.0.1で確認しました。 2.1.0.4 では、動作しましたが 3.0.1 では動きませんでした。結果はSASと似ているのですが、service側では処理が成功しているのでちょっと違った感じを受けます。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ResolveName</span><span class="p">(</span><span class="n">CloudStorageAccount</span> <span class="n">storageAccount</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">cloudTableClient</span> <span class="p">=</span> <span class="n">storageAccount</span><span class="p">.</span><span class="n">CreateCloudTableClient</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">table</span> <span class="p">=</span> <span class="n">cloudTableClient</span><span class="p">.</span><span class="n">GetTableReference</span><span class="p">(</span><span class="s">&quot;sometable&quot;</span><span class="p">);</span>
    <span class="n">table</span><span class="p">.</span><span class="n">CreateIfNotExists</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">tableServiceContext</span> <span class="p">=</span> <span class="n">cloudTableClient</span><span class="p">.</span><span class="n">GetTableServiceContext</span><span class="p">();</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">ResolveName</span> <span class="p">=</span> <span class="n">entityType</span> <span class="p">=&gt;</span> <span class="n">entityType</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleEntity</span><span class="p">(</span><span class="s">&quot;somePK&quot;</span><span class="p">,</span> <span class="s">&quot;someRK2&quot;</span><span class="p">);</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">AddObject</span><span class="p">(</span><span class="s">&quot;sometable&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>
    <span class="n">tableServiceContext</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id9">
<h3>2.1.0.4での確認結果</h3>
<p>普通に動いて成功しました。リクエストを見ると、categoryの属性に、 <span class="docutils literal"><span class="pre">term=&quot;StorageIssue201311.SimpleEntity&quot;</span></span> と有りますが、正常に処理されてレスポンスが帰ってきているのがわかります。</p>
<p>参考までに、リクエストとレスポンスを貼っておきます</p>
<p>リクエスト</p>
<div class="highlight-none"><div class="highlight"><pre>POST http://test.table.core.windows.net/sometable HTTP/1.1
User-Agent: Microsoft ADO.NET Data Services
DataServiceVersion: 1.0;NetFx
MaxDataServiceVersion: 2.0;NetFx
x-ms-date: Fri, 27 Dec 2013 13:30:17 GMT
Authorization: SharedKeyLite [signiture]
x-ms-version: 2012-02-12
Accept: application/atom+xml,application/xml
Accept-Charset: UTF-8
Content-Type: application/atom+xml
Host: test.table.core.windows.net
Content-Length: 735

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot;?&gt;
&lt;entry xmlns:d=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices&quot; xmlns:m=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/metadata&quot; xmlns=&quot;http://www.w3.org/2005/Atom&quot;&gt;
  &lt;category scheme=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/scheme&quot; term=&quot;StorageIssue201311.SimpleEntity&quot; /&gt;
  &lt;title /&gt;
  &lt;author&gt;
    &lt;name /&gt;
  &lt;/author&gt;
  &lt;updated&gt;2013-12-27T13:30:17.8428287Z&lt;/updated&gt;
  &lt;id /&gt;
  &lt;content type=&quot;application/xml&quot;&gt;
    &lt;m:properties&gt;
      &lt;d:PartitionKey&gt;somePK&lt;/d:PartitionKey&gt;
      &lt;d:RowKey&gt;someRK7&lt;/d:RowKey&gt;
      &lt;d:Timestamp m:type=&quot;Edm.DateTime&quot;&gt;0001-01-01T00:00:00&lt;/d:Timestamp&gt;
    &lt;/m:properties&gt;
  &lt;/content&gt;
&lt;/entry&gt;
</pre></div>
</div>
<p>レスポンス</p>
<div class="highlight-none"><div class="highlight"><pre>HTTP/1.1 201 Created
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/atom+xml;type=entry;charset=utf-8
ETag: W/&quot;datetime'2013-12-27T13%3A30%3A08.6638521Z'&quot;
Location: http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK7')
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 765ae397-974c-4f3c-9d3a-d4e99bdcf9f5
x-ms-version: 2012-02-12
X-Content-Type-Options: nosniff
Date: Fri, 27 Dec 2013 13:30:08 GMT

3AE
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;entry xml:base=&quot;http://test.table.core.windows.net/&quot; xmlns=&quot;http://www.w3.org/2005/Atom&quot; xmlns:d=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices&quot; xmlns:m=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/metadata&quot; m:etag=&quot;W/&amp;quot;datetime'2013-12-27T13%3A30%3A08.6638521Z'&amp;quot;&quot;&gt;&lt;id&gt;http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK7')&lt;/id&gt;&lt;category term=&quot;test.sometable&quot; scheme=&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/scheme&quot; /&gt;&lt;link rel=&quot;edit&quot; title=&quot;sometable&quot; href=&quot;sometable(PartitionKey='somePK',RowKey='someRK7')&quot; /&gt;&lt;title /&gt;&lt;updated&gt;2013-12-27T13:30:08Z&lt;/updated&gt;&lt;author&gt;&lt;name /&gt;&lt;/author&gt;&lt;content type=&quot;application/xml&quot;&gt;&lt;m:properties&gt;&lt;d:PartitionKey&gt;somePK&lt;/d:PartitionKey&gt;&lt;d:RowKey&gt;someRK7&lt;/d:RowKey&gt;&lt;d:Timestamp m:type=&quot;Edm.DateTime&quot;&gt;2013-12-27T13:30:08.6638521Z&lt;/d:Timestamp&gt;&lt;/m:properties&gt;&lt;/content&gt;&lt;/entry&gt;
0
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
</div>
<div class="section" id="id10">
<h3>3.0.1での確認結果</h3>
<p><span class="docutils literal"><span class="pre">Install-Package</span> <span class="pre">WindowsAzure.Storage</span></span> として最新版、3.0.1で確認したところ、下記のようにエラーになりました。データ自体は、Tableに入っており正常終了していますが、レスポンスを読み込んでエンティティを更新するのに失敗しているようです。</p>
<div class="highlight-none"><div class="highlight"><pre>ハンドルされていない例外: System.Data.Services.Client.DataServiceRequestException: この要求の処理中にエラーが発生しました。 ---&gt; System.InvalidOperationException: メタデータ URI 'http://fooomiimg001.table.core.windows.net/$metadata#sometable/@Element' は 'fooomiimg001.sometable' という名前のエンティティ型を参照していますが、予期されたエンティティ型の名前は 'StorageIssue201311.SimpleEntity' で、'fooomiimg001.sometable' という名前のエンティティ型と互換性がありません。 ---&gt; Microsoft.Data.OData.ODataException: メタデータ URI 'http://fooomiimg001.table.core.windows.net/$metadata#sometable/@Element' は 'fooomiimg001.sometable' という名前のエンティティ型を参照していますが、予期されたエンティティ型の名前は 'StorageIssue201311.SimpleEntity' で、'fooomiimg001.sometable' という名前のエンティティ型と互換性がありません。
   場所 Microsoft.Data.OData.ReaderValidationUtils.ValidateFeedOrEntryMetadataUri(ODataJsonLightMetadataUriParseResult metadataUriParseResult, Scope scope)
   場所 Microsoft.Data.OData.JsonLight.ODataJsonLightReader.ReadAtStartImplementationSynchronously(DuplicatePropertyNamesChecker duplicatePropertyNamesChecker)
   場所 Microsoft.Data.OData.JsonLight.ODataJsonLightReader.ReadAtStartImplementation()
   場所 Microsoft.Data.OData.ODataReaderCore.ReadImplementation()
   場所 Microsoft.Data.OData.ODataReaderCore.ReadSynchronously()
   場所 Microsoft.Data.OData.ODataReaderCore.InterceptException[T](Func`1 action)
   場所 Microsoft.Data.OData.ODataReaderCore.Read()
   場所 System.Data.Services.Client.Materialization.ODataReaderWrapper.Read()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryRead()
   --- 内部例外スタック トレースの終わり ---
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryRead()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryStartReadFeedOrEntry()
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.TryReadFeedOrEntry(Boolean lazy, ODataFeed&amp; feed, MaterializerEntry&amp; entry)
   場所 System.Data.Services.Client.Materialization.FeedAndEntryMaterializerAdapter.Read()
   場所 System.Data.Services.Client.Materialization.ODataReaderEntityMaterializer.ParseSingleEntityPayload(IODataResponseMessage message, ResponseInfo responseInfo, Type expectedType)
   場所 System.Data.Services.Client.SaveResult.HandleOperationResponseData(IODataResponseMessage responseMsg, Stream responseStream)
   --- 内部例外スタック トレースの終わり ---
   場所 System.Data.Services.Client.SaveResult.HandleResponse()
   場所 System.Data.Services.Client.BaseSaveResult.EndRequest()
   場所 System.Data.Services.Client.DataServiceContext.SaveChanges(SaveChangesOptions options)
   場所 System.Data.Services.Client.DataServiceContext.SaveChanges()
   場所 StorageIssue201311.Program.ResolveName(CloudStorageAccount storageAccount) 場所 c:\Users\Takekazu\Documents\GitHub\sandbox\csharp\StorageIssue201311\StorageIssue201311\Program.cs:行 52
   場所 StorageIssue201311.Program.Main(String[] args) 場所 c:\Users\Takekazu\Documents\GitHub\sandbox\csharp\StorageIssue201311\StorageIssue201311\Program.cs:行 59
</pre></div>
</div>
<p>参考までに、リクエストとレスポンスを貼っておきます。これを見ると、x-ms-version: 2013-08-15 で、payloadは、 <span class="docutils literal"><span class="pre">Content-Type:</span> <span class="pre">application/json;odata=minimalmetadata</span></span> になっていますが、 <span class="docutils literal"><span class="pre">Prefer:</span> <span class="pre">return-no-content</span></span> が指定されておらず、レスポンスのBodyにechoが帰ってきているのがわかります。</p>
<p>リクエスト</p>
<div class="highlight-none"><div class="highlight"><pre>POST http://test.table.core.windows.net/sometable HTTP/1.1
DataServiceVersion: 3.0;NetFx
MaxDataServiceVersion: 3.0;NetFx
Accept: application/json;odata=minimalmetadata
Accept-Charset: UTF-8
User-Agent: Microsoft ADO.NET Data Services
x-ms-date: Fri, 27 Dec 2013 13:07:55 GMT
Authorization: SharedKeyLite [signiture]
x-ms-version: 2013-08-15
Content-Type: application/json;odata=minimalmetadata
Host: test.table.core.windows.net
Content-Length: 125

{&quot;odata.type&quot;:&quot;StorageIssue201311.SimpleEntity&quot;,&quot;PartitionKey&quot;:&quot;somePK&quot;,&quot;RowKey&quot;:&quot;someRK6&quot;,&quot;Timestamp&quot;:&quot;0001-01-01T00:00:00&quot;}
</pre></div>
</div>
<p>レスポンス</p>
<div class="highlight-none"><div class="highlight"><pre>HTTP/1.1 201 Created
Cache-Control: no-cache
Transfer-Encoding: chunked
Content-Type: application/json;odata=minimalmetadata;streaming=true;charset=utf-8
ETag: W/&quot;datetime'2013-12-27T13%3A07%3A45.3753816Z'&quot;
Location: http://test.table.core.windows.net/sometable(PartitionKey='somePK',RowKey='someRK6')
Server: Windows-Azure-Table/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: b1797f33-1888-487a-a0cb-0a454fca1356
x-ms-version: 2013-08-15
X-Content-Type-Options: nosniff
Date: Fri, 27 Dec 2013 13:07:45 GMT

B2
{&quot;odata.metadata&quot;:&quot;http://test.table.core.windows.net/$metadata#sometable/@Element&quot;,&quot;PartitionKey&quot;:&quot;somePK&quot;,&quot;RowKey&quot;:&quot;someRK6&quot;,&quot;Timestamp&quot;:&quot;2013-12-27T13:07:45.3753816Z&quot;}
0
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h2>まとめ</h2>
<p><a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html"><em>Windows Azure Storage Known Issues 2013/11</em></a> で報告されている既知の Braking Change は、2.1.0.4 の修正と、サーバー側(service)の修正でFIXされました。
ただし、<a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131101"><em>SASとコンテナの前の “//” 問題</em></a> は、2013-08-15 version では仕様となり、<a class="reference internal" href="2013/11/24/windows_azure_storage_known_issues_2013_11.html#known-issue-20131102"><em>TableのDataServiceContext.ResolveName 指定 問題</em></a> も、Storage Client 3.0.1 では、ResolveNameの指定をすると動作しません。 最新のライブラリを使う場合はコードを直して欲しいということだと思います。</p>
<p>2.1系のライブラリを使う場合は上記3点の問題がFIXされた 2.1.0.4 がお勧めです。
3.x系は、幾つかのBraking Changeが含まれるので既存のコードは移行が必要ですが、2013-08-15 versionのパフォーマンス向上策がちゃんと活用できるのが大きな利点だと言えます。</p>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>日本語訳 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/11/29/blog-windows-azure-storage-known-issues.aspx">Windows Azure ストレージの既知の問題</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>gitbugの <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">WindowsAzure/azure-sdk-for-net</a>  レポジトリのmasterには、Storage Clientのコードは既にありません。2.1.0.4を確認するには、 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/tree/v2.1.0.4/microsoft-azure-api/Services/Storage">tag:v2.1.0.4 Storage</a> を見て下さい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">3.x github</a></td></tr>
</tbody>
</table>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure_table.html">Azure Table</a>, <a href="categories/azure.html">Azure</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure_table.html">Azure Table</a>, <a href="tags/table.html">Table</a>, <a href="tags/storage.html">Storage</a>, <a href="tags/issue.html">Issue</a>, <a href="tags/fixed.html">Fixed</a>, <a href="tags/azure_blob.html">Azure Blob</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/27/azure_storage_known_issues_november_2013_resolved.html#disqus_thread" data-disqus-identifier="2013/12/27/azure_storage_known_issues_november_2013_resolved">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 22, 2013</span>
        </div>
        <div class="section" id="windows-azure-powershell-0-7-2-1">
<h1><a href="2013/12/22/azure_posh_2012_12_19_version_0_7_2_1.html">Windows Azure Powershell 0.7.2.1 リリース</a></h1>
<p>Windows Azure Powershello 0.7.2.1 Hotfix がリリースされました。 <a class="reference internal" href="2013/12/11/windows_azure_powershel_0_7_2_release.html"><em>Windows Azure Powershell 0.7.2 リリース</em></a> のHotfix です。</p>
<blockquote>
<div><div class="line-block">
<div class="line">修正: Hive query “%” が含まれた場合のエンコーディングの問題をFIX <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/blob/master/ChangeLog.txt#L1">ChangeLog.txt</a></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br/></div>
</div>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/11233678353"><img alt="beans persimmon by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7405/11233678353_a8e7a8b12f_c.jpg"/></a>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="section" id="id1">
<h2>インストール</h2>
<p>Web Platform Installer を使うと最新版が入ります。12/18 リリースのWindows Azure Poershell を選択してください。</p>
<img alt="../../../_images/2013_12_22_webpi001.png" src="_images/2013_12_22_webpi001.png"/>
<p>インストールしたら念のためバージョンを確認します。Azureの所が、0.7.2 のママです orz....</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>Get-Module | ft name,version

Name                                                        Version
----                                                        -------
Autoload                                                    0.0
Azure                                                       0.7.2
Microsoft.PowerShell.Management                             3.1.0.0
Microsoft.PowerShell.Utility                                3.1.0.0
posh-git                                                    0.0
PsEnv                                                       0.0
PSReadline                                                  1.0.0.1
</pre></div>
</div>
<p>今回のリリースでは、ModuleVersion が変更されていません。<a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/blob/master/WindowsAzurePowershell/src/Commands.Utilities/Azure.psd1#L15">Azure.psd1#L15</a> 要注意です。</p>
<p>確認のためインストール先のアセンブリを見ます。</p>
<p>手元の環境では、 <cite>C:Program Files (x86)Microsoft SDKsWindows AzurePowerShellAzure</cite> にインストールされています。 Explorer で、 <cite>Microsoft.WindowsAzure.Commands.dll</cite> のプロパティを確認したら下記のようになっていました。0.7.2.1になっているようです。</p>
<img alt="../../../_images/2013_12_22_asm001.png" class="align-center" src="_images/2013_12_22_asm001.png"/>
</div>
<div class="section" id="id2">
<h2>最後に</h2>
<p>更新だけする場合は、Web Platform Installer を起動して新しいものが出ているかどうかを確認するのが一番簡単です。</p>
<p>この方法だと、現在入っているバージョンは分からないので、現在入っているバージョンを知りたければ、 <cite>Get-Module | ft name,version</cite> して、0.7.2 だったら、アセンプリのバージョンを見て0.7.2.1かどうかの確認をするということになります。</p>
<p>ちょっと面倒ですね。</p>
</div>
<div class="section" id="id3">
<h2>2013/12/23 追加</h2>
<p>ModuleVersionが更新されていない件について、GitHubに <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/issues/2189">Issue</a> を上げました。</p>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_powershell.html">Azure Powershell</a>, <a href="categories/github観察記.html">GitHub観察記</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure.html">Azure</a>, <a href="tags/azure_powershell.html">Azure Powershell</a>, <a href="tags/powershell.html">Powershell</a>, <a href="tags/posh.html">posh</a>, <a href="tags/hotfix.html">Hotfix</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/22/azure_posh_2012_12_19_version_0_7_2_1.html#disqus_thread" data-disqus-identifier="2013/12/22/azure_posh_2012_12_19_version_0_7_2_1">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 21, 2013</span>
        </div>
        <div class="section" id="windows-azure-storage-client-library-for-c-preview">
<h1><a href="2013/12/21/windows_azure_storage_client_library_for_c_preview.html">Windows Azure Storage Client Library for C++ Preview</a></h1>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/20/windows-azure-storage-client-library-for-cplusplus-preview.aspx">Windows Azure Storage Client Library for C++ Preview がリリースされました</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/12/27 Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/27/windows-azure-storage-client-library-for-c-preview.aspx">C++ 用 Windows Azure ストレージ クライアント ライブラリのプレビュー版をリリース</a></div>
</div>
</div></blockquote>
<p>待望のC++用のライブラリです。</p>
<p>以下にざっくりと訳します。</p>
<div class="section" id="id2">
<h2>抄訳 Windows Azure Storage Client Library for C++ Preview</h2>
<p>これは、Preview release です、まだ puroduction codeでは使用しないでください（should not be used in your production code）。 その代わり、ざっと目を通して試してみて、あなたがGAに必要だと考える拡張・変更のフィードバックを下さい。</p>
<p>Windows Azure Storage に付いての詳しい情報は、SOSP Paper <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2011/11/20/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency.aspx">Windows Azure Storage: A Highly Available Cloud Storage Service with Strong Consistency</a>  <a class="footnote-reference" href="#r1" id="id3">[1]</a> を参照してください。</p>
<div class="section" id="emulator-guidance">
<h3>Emulator Guidance</h3>
<p>このライブラリが使う  <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">2013-08-15 REST</a> は、現在のAzure SDK(2.2)のStorage Emulatorでサポートされていません。これらの全ての機能をサポートしたAzure Storage Emulatorのアップデートを来月には出せる見込みです。(An updated Windows Azure Storage Emulator is expected to ship with full support of these new features in the next month)
Storage Emulatorの現在のバージョンを使って開発しようとすると不正な要求エラーを受け取ることになります。アップデートが出るまでは、新機能を使用したいユーザーは、Windows Azure Storage Account (本番環境）を使ってテストをして下さい。 <a class="footnote-reference" href="#r2" id="id4">[2]</a></p>
</div>
<div class="section" id="id5">
<h3>サポートされるプラットフォーム</h3>
<p>今回のリリースでは、Visual Studio 2012 (v110) と Visual Studio 2013 (v120) platform toolsets 用ライブラリの x64およびx86バージョンを提供します。パッケージには、8 build flavors が含まれます。</p>
<ol class="arabic simple">
<li>Release, x64, v120</li>
<li>Debug, x64, v120</li>
<li>Release, Win32, v120</li>
<li>Debug, Win32, v120</li>
<li>Release, x64, v110</li>
<li>Debug, x64, v110</li>
<li>Release, Win32, v110</li>
<li>Debug, Win32, v110</li>
</ol>
</div>
<div class="section" id="id6">
<h3>入手方法</h3>
<p>ライブラリは、 <a class="reference external" href="http://www.nuget.org/packages/wastorage">NuGet</a>  から、完全なソースコードは  <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">GitHub</a>  からダウンロードできます。NuGet packageは、 <a class="reference external" href="http://coapp.org">CoApp tools</a> を使って作成され、3つのpackage として構成されています。</p>
<ul class="simple">
<li>wastorage.0.2.0-preview.nupkg：このパッケージには、アプリケーションの開発に必要なヘッダーとLIBファイルが含まれています。これは、再配布（redist） package に依存します。NuGet は、自動的にredist packageのインストールを行います。</li>
<li>wastorage.redist.0.2.0-preview.nupkg：このパッケージを実行し、アプリケーションを再配布するために必要なDLLファイルが含まれています。</li>
<li>wastorage.symbols.0.2.0-preview.nupkg：このパッケージには、それぞれのDLLファイルのシンボルが含まれています。オプションのパッケージです。</li>
</ul>
<p>パッケージは、 <a class="reference external" href="https://www.nuget.org/packages/cpprestsdk">C++ REST SDK</a>  に依存しており、それもNuGetで自動的にインストールされます。
<a class="reference external" href="http://casablanca.codeplex.com">C++ REST SDK (codename “Casablanca”)</a>  は、native code の cloud-based client-server communication のための Microsoft のプロジェクトです。
これは、native code の REST services アクセスを、multiple platforms で非同期な HTTP, JSON, URIs の C++ bindings として提供します。
Windows Azure Storage Client Library では、このライブラリを Windows Azure Storage Blob, Queue, Table services との通信で利用しています。</p>
</div>
<div class="section" id="id7">
<h3>できること</h3>
<p>ここでは、REST API に付いて話をする代わりに、Windows Azure Storage Client Library の概要を説明します。</p>
<ul class="simple">
<li>Windows Azure Storage REST API version <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">2013-08-15</a> 全体を簡単に使えるようにする実装</li>
<li>Retry policies: リクエストが失敗した場合の再試行ロジックとして、exponential や linear back off algorithm を実装</li>
<li>Streamlined authentication model: 共有鍵と共有認証署名の両方をサポート</li>
<li>操作コンテキストとETWのログを使用して要求の詳細と結果に潜り込む能力</li>
<li>サイズや、Blob typeに関係の無い、ユーザー設定による、parallel block/page アップロード</li>
<li>特定のupload/download APIに対応しなくても、読み取りまたはBLOBへの書き込みを許可するBLOB Stream</li>
<li>すべてのBlob uploadおよびdownload での完全なMD5のサポート</li>
<li>Table layerでは、 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Azure Storage Table の新しいJSON サポート</a> を利用</li>
<li>Table service の、Entity Group Transaction サポート。（Entity Group Transactionでは、単一トランザクションで複数操作が可能）</li>
</ul>
</div>
<div class="section" id="read-access-geo-redundant-storage-ra-grs">
<h3>Read Access Geo Redundant Storage (RA-GRS) サポート</h3>
<p>このリリースでは、storage account のsecondary region データへの読込アクセスをフルサポートしています。　この機能は、Portalで有効にしないと利用できません、詳しくは、 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/11/introducing-read-access-geo-replicated-storage-ra-grs-for-windows-azure-storage.aspx">RA-GRS</a>  を参照 <a class="footnote-reference" href="#r3" id="id9">[3]</a> して下さい。</p>
</div>
<div class="section" id="how-to-use-it">
<h3>How to use it?</h3>
<p>NuGet package を入れると、 <cite>was</cite> (Windows Azure Storageの略) のフォルダーに全てのヘッダー が入ります。  このディレクトリでは下記のheader ファイルが重要です。</p>
<ul class="simple">
<li>blob.h: Blob service 関連の全ての宣言</li>
<li>queue.h: Queue service 関連の全ての宣言</li>
<li>table.h: Table service 関連の全ての宣言</li>
<li>storage_account.h: account の name/key 、あるいは connection string から、service client のオブジェクトを簡単に作成するための cloud_storage_account type の宣言</li>
<li>retry_policies.h: 全ての操作で使われる、幾つかの retry policies の宣言</li>
</ul>
<p>下記のように使います</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;was/storage_account.h&quot;</span>
<span class="cp">#include &quot;was/queue.h&quot;</span>
<span class="cp">#include &quot;was/table.h&quot;</span>
<span class="cp">#include &quot;was/blob.h&quot;</span>
</pre></div>
</div>
<p>その後、我々は作成されますcloud_storage_accountコードの後半でサービス·クライアント·オブジェクトを作成するために私達を可能にするオブジェクトを、。
私たちは安全な接続のために以下のHTTPSを使用しているが、アプリケーションをデバッグするときに、HTTPは非常に便利であることに注意してください。</p>
<p>その後、下記のコードでcloud_storage_account オブジェクトを作成します。 ここでは、セキュアな接続のため https を使っていますが、デバックする場合は http が非常に便利です。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_storage_account</span> <span class="n">storage_account</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_storage_account</span><span class="o">::</span><span class="n">parse</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;AccountName=&lt;account_name&gt;;AccountKey=&lt;account_key&gt;;DefaultEndpointsProtocol=https&quot;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="blobs">
<h3>Blobs</h3>
<p>ここでは、blob container を作成し、<cite>“some text</cite>” と入ったblobを作って、それを download 、そして container 内のblobをリストします。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Create a blob container</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_blob_client</span> <span class="n">blob_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_blob_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_blob_container</span> <span class="n">container</span> <span class="o">=</span> <span class="n">blob_client</span><span class="p">.</span><span class="n">get_container_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;mycontainer&quot;</span><span class="p">));</span>
<span class="n">container</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Upload a blob</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_block_blob</span> <span class="n">blob1</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">get_block_blob_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;myblob&quot;</span><span class="p">));</span>
<span class="n">blob1</span><span class="p">.</span><span class="n">upload_text</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;some text&quot;</span><span class="p">));</span>

<span class="c1">// Download a blob</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_block_blob</span> <span class="n">blob2</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">get_block_blob_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;myblob&quot;</span><span class="p">));</span>
<span class="n">utility</span><span class="o">::</span><span class="kt">string_t</span> <span class="n">text</span> <span class="o">=</span> <span class="n">blob2</span><span class="p">.</span><span class="n">download_text</span><span class="p">();</span>

<span class="c1">// List blobs</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_result_segment</span> <span class="n">blobs</span> <span class="o">=</span> <span class="n">container</span><span class="p">.</span><span class="n">list_blobs_segmented</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_continuation_token</span><span class="p">());</span>
</pre></div>
</div>
</div>
<div class="section" id="tables">
<h3>Tables</h3>
<p>以下のサンプルでは、 Tableを作成し、様々な型のプロパティの組をエンティティに挿入し、最終的にはその指定したエンティティを取得します。最初の検索操作では、ポイント·クエリを実行し、特定のエンティティを取得します。一方クエリ操作では、PartitionKeyが <cite>“partition”</cite> に等しく、かつ、RowKey が、 <cite>“m”</cite> より大きいすべてのエンティティを照会します。これは、結果的にinsertした全てのエンティティになります。</p>
<p>Windows Azure Tables に関する詳しい情報は、 <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179338.aspx">Understanding the Table Service Data Model</a> の記事と、 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/11/06/how-to-get-most-out-of-windows-azure-tables.aspx">How to get most out of Windows Azure Tables</a> の blog post を見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Create a table</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_table_client</span> <span class="n">table_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_table_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table_client</span><span class="p">.</span><span class="n">get_table_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;mytable&quot;</span><span class="p">));</span>
<span class="n">table</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Insert a table entity</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span> <span class="n">entity</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;partition&quot;</span><span class="p">),</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;row&quot;</span><span class="p">));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;PropertyA&quot;</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;some string&quot;</span><span class="p">))));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;PropertyB&quot;</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">utility</span><span class="o">::</span><span class="n">datetime</span><span class="o">::</span><span class="n">utc_now</span><span class="p">())));</span>
<span class="n">entity</span><span class="p">.</span><span class="n">properties</span><span class="p">().</span><span class="n">insert</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">::</span><span class="n">property_type</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;PropertyC&quot;</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity_property</span><span class="p">(</span><span class="n">utility</span><span class="o">::</span><span class="n">new_uuid</span><span class="p">())));</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span> <span class="n">operation1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span><span class="o">::</span><span class="n">insert_or_replace_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_result</span> <span class="n">table_result</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation1</span><span class="p">);</span>

<span class="c1">// Retrieve a table entity</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span> <span class="n">operation2</span> <span class="o">=</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_operation</span><span class="o">::</span><span class="n">retrieve_entity</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;partition&quot;</span><span class="p">),</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;row&quot;</span><span class="p">));</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation2</span><span class="p">);</span>

<span class="c1">// Query table entities</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span> <span class="n">query</span><span class="p">;</span>
<span class="n">query</span><span class="p">.</span><span class="n">set_filter_string</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">combine_filter_conditions</span><span class="p">(</span>
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">generate_filter_condition</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;PartitionKey&quot;</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_comparison_operator</span><span class="o">::</span><span class="n">equal</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;partition&quot;</span><span class="p">)),</span> 
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_logical_operator</span><span class="o">::</span><span class="n">and</span><span class="p">,</span> 
    <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_query</span><span class="o">::</span><span class="n">generate_filter_condition</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;RowKey&quot;</span><span class="p">),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">query_comparison_operator</span><span class="o">::</span><span class="n">greater_than_or_equal</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;m&quot;</span><span class="p">))));</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">table_entity</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="queues">
<h3>Queues</h3>
<p>最後の例では、Queueを作成します、それにmessageを追加、同じmessageを取得し、最終的にそれを更新します。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Create a queue</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_client</span> <span class="n">queue_client</span> <span class="o">=</span> <span class="n">storage_account</span><span class="p">.</span><span class="n">create_cloud_queue_client</span><span class="p">();</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">queue_client</span><span class="p">.</span><span class="n">get_queue_reference</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;myqueue&quot;</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">create_if_not_exists</span><span class="p">();</span>

<span class="c1">// Add a queue message</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_message</span> <span class="n">message1</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;mymessage&quot;</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">message1</span><span class="p">);</span>

<span class="c1">// Get a queue message</span>
<span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">cloud_queue_message</span> <span class="n">message2</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">get_message</span><span class="p">();</span>

<span class="c1">// Update a queue message</span>
<span class="n">message2</span><span class="p">.</span><span class="n">set_content</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">&quot;changedmessage&quot;</span><span class="p">));</span>
<span class="n">queue</span><span class="p">.</span><span class="n">update_message</span><span class="p">(</span><span class="n">message2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>デバック方法</h3>
<p>なにか上手く行っていない場合、exception で帰ってきます。この exception は、wa::storage::storage_exception の型で、なにか問題なのかの詳細な情報を含んでいます。次のコードを見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">try</span>
<span class="p">{</span>
    <span class="n">blob1</span><span class="p">.</span><span class="n">download_attributes</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">storage_exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exception: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;The request that started at &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">start_time</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot; and ended at &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">end_time</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot; resulted in HTTP status code &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">http_status_code</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot; and the request ID reported by the server was &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">result</span><span class="p">().</span><span class="n">service_request_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>blobが存在しない場合, このコードは下記のような結果になります。</p>
<div class="highlight-none"><div class="highlight"><pre>Exception: The specified blob does not exist.

The request that started at Fri, 13 Dec 2013 18:31:11 GMT and ended at Fri, 13 Dec 2013 18:31:11 GMT resulted in HTTP status code 404 and the request ID reported by the server was 5de65ae4-9a71-4b1d-9c99-cc4225e714c6
</pre></div>
</div>
<p>ライブラリでは、type wa::storage::operation_context を提供しています。これは、全てのAPIでサポートされ、操作中に行われていることについてより多くの情報を取得するために使います。次のコードを見て下さい。</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span> <span class="n">context</span><span class="p">;</span> 

<span class="n">context</span><span class="p">.</span><span class="n">set_sending_request</span><span class="p">([]</span> <span class="p">(</span><span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_request</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">,</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;The request is being sent to &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">request</span><span class="p">.</span><span class="n">request_uri</span><span class="p">().</span><span class="n">to_string</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">});</span>

<span class="n">context</span><span class="p">.</span><span class="n">set_response_received</span><span class="p">([]</span> <span class="p">(</span><span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_request</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">http_response</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">,</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">operation_context</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;The reason phrase is &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">response</span><span class="p">.</span><span class="n">reason_phrase</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">});</span>

<span class="n">try</span> 
<span class="p">{</span> 
  <span class="n">blob1</span><span class="p">.</span><span class="n">download_attributes</span><span class="p">(</span><span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">access_condition</span><span class="p">(),</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">blob_request_options</span><span class="p">(),</span> <span class="n">context</span><span class="p">);</span> 
<span class="p">}</span> 
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">wa</span><span class="o">::</span><span class="n">storage</span><span class="o">::</span><span class="n">storage_exception</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exception: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> 
<span class="p">}</span> 

<span class="n">ucout</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot;Executed &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">context</span><span class="p">.</span><span class="n">request_results</span><span class="p">().</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">U</span><span class="p">(</span><span class="s">&quot; request(s) to perform this operation and the last request's status code was &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">context</span><span class="p">.</span><span class="n">request_results</span><span class="p">().</span><span class="n">back</span><span class="p">().</span><span class="n">http_status_code</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>もう一度、blobが存在しない状況で動かします。すると下記のような結果になります。</p>
<div class="highlight-none"><div class="highlight"><pre>wa::storage::operation_context context; 

context.set_sending_request([] (web::http::http_request&amp; request, wa::storage::operation_context) 
{ 
  ucout &lt;&lt; U(&quot;The request is being sent to &quot;) &lt;&lt; request.request_uri().to_string() &lt;&lt; std::endl; 
});

context.set_response_received([] (web::http::http_request&amp;, const web::http::http_response&amp; response, wa::storage::operation_context) 
{ 
  ucout &lt;&lt; U(&quot;The reason phrase is &quot;) &lt;&lt; response.reason_phrase() &lt;&lt; std::endl; 
});

try 
{ 
  blob1.download_attributes(wa::storage::access_condition(), wa::storage::blob_request_options(), context); 
} 
catch (const wa::storage::storage_exception&amp; e) 
{ 
  std::cout &lt;&lt; &quot;Exception: &quot; &lt;&lt; e.what() &lt;&lt; std::endl; 
} 

ucout &lt;&lt; U(&quot;Executed &quot;) &lt;&lt; context.request_results().size() &lt;&lt; U(&quot; request(s) to perform this operation and the last request's status code was &quot;) &lt;&lt; context.request_results().back().http_status_code() &lt;&lt; std::endl;
</pre></div>
</div>
</div>
<div class="section" id="samples">
<h3>Samples</h3>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp/tree/master/Microsoft.WindowsAzure.Storage/samples">github 上のプロジェクトのサンプル</a> フォルダの中に、幾つかの重要なシナリを説明する コードがあります。</p>
<p>Visual Studioで「Microsoft.WindowsAzure.Storage.Samples.sln」という名前のサンプルのソリューションファイルを開きます。Microsoft.WindowsAzure.Storage.SamplesCommonプロジェクトの下samples_common.hファイルの、ストレージのアカウント情報を更新します。Solution Explorer のウィンドウに移動し、（例えば、Microsoft.WindowsAzure.Storage.BlobsGettingStarted）実行したいサンプルプロジェクトを選択してStartUp Projectにするか、コンテキストメニューから実行します。</p>
</div>
<div class="section" id="summary">
<h3>Summary</h3>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/20/windows-azure-storage-client-library-for-cplusplus-preview.aspx">コメント欄 （原文）</a>  、フォーラム、あるいは <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">GitHub</a> でのフィードバックをお待ちしています。BUGに当たった場合、GitHubに上げてもらえると、その後の解決策などをトラックすることができるようになります。</p>
<p>Serdar Ozler, Mike Fisher, and Joe Giardino</p>
</div>
<div class="section" id="resources">
<h3>Resources</h3>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-cpp">Source (GitHub)</a></div>
<div class="line"><a class="reference external" href="http://www.nuget.org/packages/wastorage">Binaries (NuGet)</a></div>
<div class="line"><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></div>
<div class="line"><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h2>まとめ</h2>
<p>C++用のクライアントは良いですね、やっぱり欲しい。</p>
<p>その他に、今回 <a class="reference external" href="http://coapp.org">CoApp tools</a> が気になりました。native code をnugetでpackege化して配布するプロジェクトです。 Windows にapt-getみたいな位置づけに機能を盛り込むのを狙っているようで、期待できます。 <a class="footnote-reference" href="#r4" id="id16">[4]</a> これで、python、ruby、node.js で Windows パッケージのバイナリコードのビルドに引っかかる問題も、このレポジトリを参照することで解決できると良いなあと思いますが、今のところプロジェクトのターゲットに入っていないようで、そこはちょっと残念です。</p>
<p>もう一つ、 <a class="reference external" href="http://casablanca.codeplex.com">http://casablanca.codeplex.com/</a>  は、 <a class="reference external" href="http://msdn.microsoft.com/library/jj969455(v=vs.120).aspx">MSDN C++ REST SDK (Codename “Casablanca”)</a>  に割りとしっかりしたドキュメントが上がっていて、nugetでは、production 扱いなので、使っても良さそうな感じです。 <a class="reference external" href="http://www.nuget.org/packages/cpprestsdk">C++ REST SDK 1.4.0</a> 今年の４月からパッケージとしては上がっていたようですが、気が付きませんでした。</p>
<p>nugetを見てみたところ、C++ REST SDK も、SDK、 Redist、Symbols の３本立てになってました。でも、SDKが1.4.0なのに他が1.3.1のままですね。</p>
<ul class="simple">
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk">C++ REST SDK 1.4.0</a></li>
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk.redist">C++ REST SDK Redist 1.3.1</a></li>
<li><a class="reference external" href="http://www.nuget.org/packages/cpprestsdk.symbols">C++ REST SDK Symbols 1.3.1</a></li>
</ul>
<p>パッケージマネージャー関連は、nuget を中心に、整備が進んでいるようで、いろいろ期待できますね。</p>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>日本語訳 <a class="reference external" href="http://download.microsoft.com/download/C/0/2/C02C4D26-0472-4688-AC13-199EA321135E/23rdACM_SOSP_WindowsAzureStorage_201110_jpn.pdf">SOSP 論文 Windows Azure ストレージ: 高可用性と強い一貫を両立する クラウド ストレージ サービス</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Windows Azure Storage Client Library for Java v. 0.5.0</a> では、 <cite>An updated Windows Azure Storage Emulator is expected to ship with full support of these new features in the next couple of months.</cite> になっていました。数ヶ月先って話だったので、来月だとすると良い知らせですね。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[3]</a></td><td>日本語訳 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/19/blog-windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage.aspx">Windows Azure ストレージの冗長オプションと読み取りアクセス地理冗長ストレージ</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[4]</a></td><td><a class="reference external" href="http://coapp.org/news/2013-10-02-State-of-CoApp.html">The State of CoApp</a></td></tr>
</tbody>
</table>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_sdk.html">Azure SDK</a>, <a href="categories/azure_storage.html">Azure Storage</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/2013_08_15.html">2013-08-15</a>, <a href="tags/azure.html">Azure</a>, <a href="tags/c.html">C++</a>, <a href="tags/release.html">Release</a>, <a href="tags/azure_storage.html">Azure Storage</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/21/windows_azure_storage_client_library_for_c_preview.html#disqus_thread" data-disqus-identifier="2013/12/21/windows_azure_storage_client_library_for_c_preview">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 20, 2013</span>
        </div>
        <div class="section" id="windows-azure-storage-client-library-for-java-v-0-5-0">
<h1><a href="2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0.html">Windows Azure Storage Client Library for Java v. 0.5.0</a></h1>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Windows Azure Storage Client Library for Java v. 0.5.0 がリリースされました</a></p>
<blockquote>
<div><div class="line-block">
<div class="line">2013/12/27  Windows Azure Japan Team Blog 公式 谷訳出ました。 <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/27/blog-windows-azure-storage-client-library-for-java-v-0-5-0.aspx">Java v. 0.5.0 用 Windows Azure ストレージ クライアント ライブラリ</a></div>
</div>
</div></blockquote>
<p>以下にざっくりと訳します。</p>
<div class="section" id="windows-azure-storage-team-blog-windows-azure-storage-client-library-for-java-v-0-5-0">
<h2>抄訳 Windows Azure Storage Team Blog - Windows Azure Storage Client Library for Java v. 0.5.0</h2>
<p>このリリースでは、logging support, 新しい API overloads、そして 2013-08-15 REST <a class="footnote-reference" href="#r1" id="id2">[1]</a>  が完全にサポートされています。今までのようにソースコードは、 <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">github Windows Azure Storage libraries for Java</a> で公開されています。 <a class="footnote-reference" href="#r2" id="id3">[2]</a> 従来のようにmaven のレポジトリに登録されています。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>  
     <span class="nt">&lt;groupId&gt;</span>com.microsoft.windowsazure.storage<span class="nt">&lt;/groupId&gt;</span>
     <span class="nt">&lt;artifactId&gt;</span>microsoft-windowsazure-storage-sdk<span class="nt">&lt;/artifactId&gt;</span>
     <span class="nt">&lt;version&gt;</span>0.5.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="section" id="id4">
<h3>エミュレータ ガイダンス</h3>
<p>現在のAzure SDK(2.2)のエミュレータは、 <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">2013-08-15 REST</a>  をサポートしていません。今後数ヶ月以内にサポートしたものを出す予定です。</p>
</div>
<div class="section" id="samples">
<h3>Samples</h3>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">github</a> のソースのなかに、幾つかの重要なシナリを説明する <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/19/windows-azure-storage-client-library-for-java-v-0-5-0.aspx">サンプル</a> があります。
指定されたサンプルを実行するには、サンプルプロジェクトをロードし、ストレージの資格情報を提供するために、Utility.javaの次の行を更新します。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">storageConnectionString</span> <span class="o">=</span> <span class="s">&quot;DefaultEndpointsProtocol=http;AccountName=[ACCOUNT_NAME];AccountKey=[ACCOUNT_KEY]&quot;</span><span class="o">;</span>
</pre></div>
</div>
<p>fiddler を使ってサンプル実行中の traffic を見たい場合は、Utility.java の下記の2行をコメントアウトを外してください。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// System.setProperty(&quot;http.proxyHost&quot;, &quot;localhost&quot;);</span>
<span class="c1">// System.setProperty(&quot;http.proxyPort&quot;, &quot;8888&quot;);</span>
</pre></div>
</div>
</div>
<div class="section" id="note-about-packaging-and-versioning">
<h3>Note about Packaging and Versioning</h3>
<p>このリリースで、大きな Windows Azure SDK for Java から、ストレージパッケージを独立させました。現在、既存のSDKを活用している開発者は、それに応じて依存関係を更新する必要があります。さらに、パッケージ名は、この新しい構造を反映するように変更されました：</p>
<ul class="simple">
<li>com.microsoft.windowsazure.storage - RetryPolicies、LocationMode、StorageException、StorageAccountなどサービス間で共通しているすべてのpublicクラス</li>
<li>com.microsoft.windowsazure.storage.blob -  Blob convenience implementation、Windows Azure Blobを利用しているアプリケーションは、importしてください。</li>
<li>com.microsoft.windowsazure.storage.queue - Queue convenience implementation、Windows Azure Queueを利用するアプリケーションは、importしてください。</li>
<li>com.microsoft.windowsazure.storage.table - Table convenience implementation、Windows Azure Tableを利用しているアプリケーションは、importしてください。</li>
</ul>
<p>さらに詳しい情報は、以下の Change Log &amp; Breaking Changes  のセクションを見て下さい。</p>
<p>また、Storage Client SDK componentでは、 <a class="reference external" href="http://semver.org">Semantic Versioning</a> を採用します。これは、SDKを活用する開発者に一貫した予測可能なバージョン管理指針を提供するのに役立ちます。</p>
</div>
</div>
<div class="section" id="whats-new">
<h2>Whats New</h2>
<p>Java client library の 0.5.0 では、2013-08-15 REST service version の全ての機能 <a class="footnote-reference" href="#r1" id="id6">[1]</a> をサポートします。</p>
<div class="section" id="support-for-read-access-geo-redundant-storage">
<h3>Support for Read Access Geo Redundant Storage</h3>
<p>このリリースでは、secondary region の storage account data の読み取りアクセス (RA-GRS) <a class="footnote-reference" href="#r3" id="id7">[3]</a> を完全にサポートしています。
クライアントオブジェクト上の位置モードを設定し、getServiceStatsを起動すると、以下の例に示されている。LocationModeもRequestOptionsオブジェクト上に設定することで、リクエストごとに設定することができます。</p>
<p>下記の例では、client objectの location mode を設定して getServiceStats を呼び出すことで、 replication の状態を取得しています。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">CloudStorageAccount</span> <span class="n">httpAcc</span> <span class="o">=</span> <span class="n">CloudStorageAccount</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">connectionString</span><span class="o">);</span>
<span class="n">CloudTableClient</span> <span class="n">tClient</span> <span class="o">=</span> <span class="n">httpAcc</span><span class="o">.</span><span class="na">createCloudTableClient</span><span class="o">();</span>

<span class="c1">// Set the LocationMode to SECONDARY_ONLY since getServiceStats is supported only on the secondary endpoints.</span>
<span class="n">tClient</span><span class="o">.</span><span class="na">setLocationMode</span><span class="o">(</span><span class="n">LocationMode</span><span class="o">.</span><span class="na">SECONDARY_ONLY</span><span class="o">);</span>
<span class="n">ServiceStats</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">tClient</span><span class="o">.</span><span class="na">getServiceStats</span><span class="o">();</span>
<span class="n">Date</span> <span class="n">lastSyncTime</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="na">getGeoReplication</span><span class="o">().</span><span class="na">getLastSyncTime</span><span class="o">();</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Replication status = %s and LastSyncTime = %s&quot;</span><span class="o">,</span><span class="n">stats</span><span class="o">.</span><span class="na">getGeoReplication</span><span class="o">().</span><span class="na">getStatus</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">lastSyncTime</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">lastSyncTime</span><span class="o">.</span><span class="na">toString</span><span class="o">():</span> <span class="s">&quot;empty&quot;</span><span class="o">));</span>
</pre></div>
</div>
</div>
<div class="section" id="expanded-table-protocol-support-json">
<h3>Expanded Table Protocol Support (JSON)</h3>
<blockquote>
<div>table traffic で、JSONがサポートされました。TableClient の setTablePayloadFormat() で、TablePayloadFormatを指定することでJSONformatを使うことができます。</div></blockquote>
<div class="highlight-java"><div class="highlight"><pre><span class="n">CloudStorageAccount</span> <span class="n">httpAcc</span> <span class="o">=</span> <span class="n">CloudStorageAccount</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">connectionString</span><span class="o">);</span>
<span class="n">CloudTableClient</span> <span class="n">tableClient</span> <span class="o">=</span> <span class="n">httpAcc</span><span class="o">.</span><span class="na">createCloudTableClient</span><span class="o">();</span>

<span class="c1">// Set the payload format to JsonNoMetadata.</span>
<span class="n">tableClient</span><span class="o">.</span><span class="na">setTablePayloadFormat</span><span class="o">(</span><span class="n">TablePayloadFormat</span><span class="o">.</span><span class="na">JsonNoMetadata</span><span class="o">);</span>
</pre></div>
</div>
<p>JsonNoMetadataを指定した場合メタデータがpayloadに有りません、その場合プロパティの型はpropertyResolver を用意して下記のようにコードで解釈します。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Class1</span> <span class="kd">extends</span> <span class="n">TableServiceEntity</span> <span class="kd">implements</span> <span class="n">PropertyResolver</span> <span class="o">{</span>    
    <span class="kd">private</span> <span class="n">String</span> <span class="n">A</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">B</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getA</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">A</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getB</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">B</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setA</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">A</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setB</span><span class="o">(</span><span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">B</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">EdmType</span> <span class="nf">propertyResolver</span><span class="o">(</span><span class="n">String</span> <span class="n">pk</span><span class="o">,</span> <span class="n">String</span> <span class="n">rk</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;A&quot;</span><span class="o">))</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">EdmType</span><span class="o">.</span><span class="na">STRING</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;B&quot;</span><span class="o">))</span> <span class="o">{</span>
	    <span class="k">return</span> <span class="n">EdmType</span><span class="o">.</span><span class="na">BINARY</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>
</pre></div>
</div>
<p>この、propertyResolver は、TableRequestOptions にセットします。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Class1</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class1</span><span class="o">();</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setA</span><span class="o">(</span><span class="s">&quot;myPropVal&quot;</span><span class="o">);</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setB</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span> <span class="o">});</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setPartitionKey</span><span class="o">(</span><span class="s">&quot;testKey&quot;</span><span class="o">);</span>
<span class="n">ref</span><span class="o">.</span><span class="na">setRowKey</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

<span class="n">options</span><span class="o">.</span><span class="na">setPropertyResolver</span><span class="o">(</span><span class="n">ref</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="table-insert-optimizations">
<h3>Table Insert Optimizations</h3>
<p>以前のバージョンでは、Table Insertのレスポンスでentity全体が返されていましたが、このバージョンから inserts が成功したときは 204 (no-content) でbodyは空がかえるようになりました。
従来と同じように動作させるには、insert(TableEntity, boolean) method に true を指定します。</p>
</div>
<div class="section" id="table-reflection-optimizations">
<h3>Table Reflection Optimizations</h3>
<p>clients が、POJOを永続化するときに、繰り返しの reflection calls を無くすために、type や property information をcacheするようにしました。この最適化の結果劇的にCPU時間が削減されます。このCache機能を無効にするには、TableServiceEntity.setReflectedEntityCacheDisabled(true) を使って下さい。</p>
</div>
<div class="section" id="new-apis-and-overloads">
<h3>New APIs and overloads</h3>
<p>customer feedback から下記のAPIを追加しました、</p>
<ul class="simple">
<li>CloudBlob.downloadRange</li>
<li>CloudBlob.downloadToByteArray</li>
<li>CloudBlob.downloadRangeToByteArray</li>
<li>CloudBlob.uploadFromByteArray</li>
<li>CloudBlob.uploadFromByteArray</li>
<li>CloudBlob.downloadToFile</li>
<li>CloudBlob.uploadFromFile</li>
<li>CloudBlockBlob.uploadText</li>
<li>CloudBlockBlob.downloadText</li>
</ul>
</div>
<div class="section" id="logging">
<h3>Logging</h3>
<p>0.5.0 リリースでは、 <a class="reference external" href="http://www.slf4j.org">SLF4J</a> logging facade をサポートしています。</p>
<p>詳細省略</p>
</div>
</div>
<div class="section" id="change-log-breaking-changes">
<h2>Change Log &amp; Breaking Changes</h2>
<p>このリリースには、 2013-08-15 REST <a class="footnote-reference" href="#r1" id="id8">[1]</a> のサポート以外にも幾つかの重要な変更があります。要点を下記にまとめます。</p>
<div class="section" id="common">
<h3>Common</h3>
<ul class="simple">
<li>Package の再構築</li>
<li>RetryResultが追加機能を提供しRetryInfoに置き換えられています</li>
<li>request中に起きるevent operations (event firingを含む) は、同期では無くなりました。 (thread safety は、event listenersのCopyOnWriteArrayList で保証されます)</li>
<li>OperationContext.sendingRequest eventは、 headerを変更することができるように connection が established されるまえに fireされます</li>
</ul>
</div>
<div class="section" id="blob">
<h3>Blob</h3>
<ul class="simple">
<li>BlobdownloadRangeはStreamにダウンロードします。以前のdownloadRangeはdownloadRangeToByteArrayに変更されました</li>
<li>sparse page blob feature は削除されました</li>
<li>CloudBlobContainer.createIfNotExistはCloudBlobContainer.createIfNotExistに改名されました</li>
<li>CloudBlobClient.streamMinimumReadSizeInBytesは削除されました。この機能は、はCloudBlob.streamMinimumReadSizeInBytesで提供さえます（これは、Client毎のではなくBlob毎の設定です）</li>
<li>CloudBlobClient.pageBlobStreamWriteSizeInBytesとCloudBlobClient.writeBlockSizeInBytesは削除されました。この機能は、CloudBlob.streamWriteSizeInBytesで提供されます</li>
</ul>
</div>
<div class="section" id="table">
<h3>Table</h3>
<ul class="simple">
<li>TableResultから id field が削除されました（getId、setIdも）</li>
<li>CloudTable.createIfNotExistはCloudTable.createIfNotExistに名前が変更されました</li>
<li>Insert 操作はcontents echoをしません。</li>
<li>デフォルトのPayload形式は、JsonMinimalMetadataになりました。CloudTableClient.setTablePayloadFormatで全てのリクエスト、あるいは個々のリクエストでTableRequestOptions.setTablePayloadFormatを使ってpayload formatを変更することができます</li>
</ul>
</div>
<div class="section" id="queue">
<h3>Queue</h3>
<ul class="simple">
<li>CloudQueue.createIfNotExistはCloudQueue.createIfNotExistに名前が変更されました</li>
</ul>
</div>
</div>
<div class="section" id="resources">
<h2>Resources</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">Source (github)</a></p>
<p><a class="reference external" href="http://search.maven.org/windows_azure_storage_client_library_for_java_v_0_5_0.html#search%7Cga%7C1%7Cg%3A%22com.microsoft.windowsazure.storage%22">Maven</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/blob/master/BreakingChanges.txt">BreakingChanges</a></p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/blob/master/ChangeLog.txt">ChangeLog</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">Windows Azure Storage Release - Introducing CORS, JSON, Minute Metrics, and More</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a></p>
<p><a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/11/introducing-read-access-geo-replicated-storage-ra-grs-for-windows-azure-storage.aspx">Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage</a></p>
<p><a class="reference external" href="http://semver.org">SemVer Specification</a></p>
</div>
<div class="section" id="id9">
<h2>最後に</h2>
<p>0.4 にあった、<a class="reference internal" href="2013/10/17/azure_java_sdk_long_value_filtering_bug.html"><em>Azure SDK for Java 0.4.6 long値のfilter BUG</em></a> は無事改修されているようです。<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java/commit/834daae4e23b51e16e65e5bbf13096075d1f47ca#diff-f8d410db4741b0e56a8050948b11115c">https://github.com/WindowsAzure/azure-storage-java/commit/834daae4e23b51e16e65e5bbf13096075d1f47ca#diff-f8d410db4741b0e56a8050948b11115c</a></p>
<div class="line-block">
<div class="line">互換性の問題などから、0.4を使い続ける場合は引き続き注意が必要です。</div>
</div>
<div class="line-block">
<div class="line"><br/></div>
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id6">2</a>, <a class="fn-backref" href="#id8">3</a>)</em> version 2013-08-15 storage <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/11/27/windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">英語</a>  <a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/03/blog-windows-azure-storage-release-introducing-cors-json-minute-metrics-and-more.aspx">日本語</a>  <a class="reference external" href="http://satonaoki.wordpress.com/2013/11/30/azure-storage-cors-json-metric">SATO NAOKI訳</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>0.4 までは、 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-java">azure-sdk-for-java</a> だったのですが、レポジトリが変わり。 0.5からは、<a class="reference external" href="https://github.com/WindowsAzure/azure-storage-java">azure-storage-java</a> になりました。.NETのStorage Clientと同じような名前変更がされたようです。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td><a class="reference external" href="http://blogs.msdn.com/b/windowsazurej/archive/2013/12/19/blog-windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage.aspx">Windows Azure ストレージの冗長オプションと読み取りアクセス地理冗長ストレージ</a></td></tr>
</tbody>
</table>
</div>
</div>
        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_sdk.html">Azure SDK</a>, <a href="categories/azure_storage.html">Azure Storage</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/2013_08_15.html">2013-08-15</a>, <a href="tags/azure.html">Azure</a>, <a href="tags/java.html">Java</a>, <a href="tags/release.html">Release</a>, <a href="tags/azure_storage.html">Azure Storage</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0.html#disqus_thread" data-disqus-identifier="2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 17, 2013</span>
        </div>
        <div class="section" id="owin-open-web-interface-for-net">
<h1><a href="2013/12/17/owin_azure_cache_session_middleware.html">OWIN - Open Web Interface for .NET を使う</a></h1>
<p><a class="reference external" href="http://owin.org">OWIN(Open Web Interface for .NET)</a> は、.NET Framework の WebサーバとWebアプリケーション接続するためのインタフェースであり、新しい HTTP Serverのプログラミング抽象化レイヤーを定義するものだ。
2010年の終わりのころに <a class="reference external" href="http://bvanderveen.com">Benjamin van der Veen 氏</a> が始め、 <a class="reference external" href="http://owin.org/spec/owin-1.0.0draft7.html">Draft 7 12 July 2012</a> では、Author: OWIN working group となっている。参照: <a class="reference external" href="http://owin.org/spec/history-1.0.html">http://owin.org/spec/history-1.0.html</a></p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/7814536388"><img alt="arch by Takekazu Omi, on Flickr" class="align-center" src="http://farm8.staticflickr.com/7126/7814536388_03ac4c1eba_c.jpg"/></a>
<p>.NETでは、HTTP Serverのプログラミング抽象化レイヤーは、ASP.NETの初期のことに構築されてその後ほぼ変らずに今まで来た、 <a class="reference external" href="http://www.asp.net/aspnet/overview/owin-and-katana/an-overview-of-project-katana">An Overview of Project Katana August 30, 2013 Howard Dierking</a>  に、初めのころの話としてASP.NET設計時のターゲットの話が書いあり実に面白い。</p>
<p>これによると、当時（ASP.NETの初期設計時）の主なターゲットは、「Classic ASPを使っている人」と、「VB6等でWindows で業務アプリを書いている人」にWebプラットフォームプログラミングを提供することで、
.NET Frameworkの一部としてリリースされるということもありあまり時間も無い中で作られたらしい。</p>
<p>その結果出来上がったのが、従来のVB6アプリの習慣に沿ったイベントモデルをベースにしたWeb Formsのアーキテクチャーと論理的に異なる HTTP ObjectとWeb Forms FrameworkがタイトにカップルされたSystem.Web.dll らしい。</p>
<p>昔を振り返ってみると、1993年の終わりころ <a class="footnote-reference" href="#r1" id="id2">[1]</a>  <a class="reference external" href="http://en.wikipedia.org/wiki/NCSA_HTTPd">UCSA HTTPd</a>  にCGI が現れ、1996年には Windows NT 4.0 Option Pack で ASPが登場、1997年には、Java Servlet が出ている。<a class="reference external" href="http://en.wikipedia.org/wiki/ASP.NET">ASP.NETのリリースは2002年</a> なので、ASPのリリースから6年たってほぼ同じモデルを踏襲した設計になっているということになる。
今は更に11年後、ASPから数えると17年経ってる、変わらないのは資産の継承という点では良い面もあるが、その間蓄積された知識が十分生かされているかどうかとかんがえるとちょっと期間が長すぎたような気もする。</p>
<p>その間Rubyを始めとする他のプラットフォームは新しいデザインを模索しており、OWINの発想のもとになっていると言われている <a class="reference external" href="http://rack.github.io">Rack: a Ruby Webserver Interface Feb 2007</a>  が生まれる。
こちらは（Ruby)は、.NET と事情が違って、標準的なWebサーバとWebアプリケーション接続するためのインタフェースが存在しない中数多くのWeb サーバー、フレームワークが存在する問題への解法としてRackが生まれている。</p>
<p>.NETでは最初に標準的なWeb Server（IIS）と、Framework（System.Web.dll）ありきで始まったため混乱は無かったが自由な発展が阻害され、一方Ruby/Pythonなど標準的なものが無い中では混沌のなかから優れた標準（Rack/WSGI)が生まれたというのは実に面白い。</p>
<div class="section" id="owin">
<h2>OWINの基本</h2>
<p>The Open Web Interface for .NET (OWIN) の主要なデータ構造は２つしか無い。ひとつは、環境を保持する  environment dictionary　これに、HTTP request and response を処理するのに必要なデータは保持される。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>２つ目は、application delegate　全てのコンポーネントの間は下記の function signature で呼ばれる。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="n">Func</span><span class="p">&lt;</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;,</span> <span class="n">Task</span><span class="p">&gt;;</span>
</pre></div>
</div>
<p>Headers、Request Body、Response Body などの抽象度の高いオブジェクトを、この上に構築している。ちょっと中を見てみた感じでは、OWIN自体は非常にシンプルな構成 <a class="footnote-reference" href="#r2" id="id3">[2]</a> でコンポーネント指向も高くいい感じで使えそうだ。とりあえずなにか、OWIN Middleware を作ってみようと思ったけどネタが思い付かない。どうしようかと思っていたら、 <a class="reference external" href="https://github.com/neuecc/Owin.RedisSession">neuecc/Owin.RedisSession</a> なんてものを見つけ「ああOWINだとSessionすら無いのか」と気が付いて Azure Cache 版を作ってみることにした。</p>
</div>
<div class="section" id="owin-middleware-azure-cache-session">
<h2>OWIN Middleware Azure Cache Session</h2>
<p>そんなわけで、Azure Cache に Session を保存するOWIN Middleware を作成した。コードはGitHubにある <a class="reference external" href="https://github.com/takekazuomi/OwinAzureCacheSessionMiddleware">OWIN Azure Cache Session Middleware</a> 手探りで作った習作だが、簡単に中身を説明する。
OWIN Middleware を使って下記のような構成にする。Azure CacheとSessionのMiddlewareはブラウザとアプリケーションの間にフィルタのように入る。この手のパターンは便利でWeb Application Frameworkでは随所に出てくる。今回、CacheとSessionで分ける必要があるか迷ったが、書いてみたら分けた方がシンプルになったので分けてある。</p>
<p class="seqdiag">
<a href="_images/seqdiag-8e39e78bf75324a787de834862440035baf46c04.png"><img alt="None" height="372.115384615" src="_images/seqdiag_thumb-8e39e78bf75324a787de834862440035baf46c04.png" width="600"/>
</a></p>
</div>
<div class="section" id="owin-selfhost-application">
<h2>OWIN SelfHost Applicationの作成</h2>
<p>まずは試しで、OWIN Selft Host環境を作って書いてみる。</p>
<div class="section" id="console-project">
<h3>Console Projectを作成して必要なパッケージを入れる</h3>
<p>nugetから必要なパッケージを入れる</p>
<div class="highlight-bash"><div class="highlight"><pre>install-package Microsoft.Owin.Hosting
install-package Microsoft.Owin.Host.HttpListener
install-package Microsoft.Owin.Diagnostics
install-Package Owin.Extensions
</pre></div>
</div>
</div>
<div class="section" id="program-csmain">
<h3>Program.csのmainを下記のようにする</h3>
<p><cite>WebApp.Start&lt;Startup&gt;(url)</cite> とするとlistnerを上げて、Startup Classにリクエストを回してくれる。今回の設定だと、Microsoft.Owin.Host.HttpListener が入っているのでHttpListnerを使ったSelfHostになる。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin.Hosting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">uri</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="s">&quot;http://localhost:8081/&quot;</span> <span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">WebApp</span><span class="p">.</span><span class="n">Start</span><span class="p">&lt;</span><span class="n">Startup</span><span class="p">&gt;(</span><span class="n">uri</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Started&quot;</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Stopping&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="startup">
<h3>Startup用のクラスを追加する</h3>
<p><cite>[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</cite> でアプリケーションのクラスを登録する。登録されたクラスのConfiguration MethodがWebApp.Start()で実行される。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>

<span class="na">[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseWelcomePage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>これで動かすとこんな感じになる</h3>
<p>このコードでは、<cite>app.UseWelcomePage();</cite> としているので、Welcomeページが表示される。このあたりの実装は、 <a class="reference external" href="http://katanaproject.codeplex.com/SourceControl/latest#src/Microsoft.Owin.Diagnostics/WelcomePageMiddleware.cs">katanaproject.codeplex.com WelcomePageMiddleware</a> 見ると非常に参考になる。</p>
<img alt="../../../_images/2013_12_08_scrn-001.png" src="_images/2013_12_08_scrn-001.png"/>
</div>
</div>
<div class="section" id="azure-cache-session-middleware">
<h2>Azure Cache Session Middleware</h2>
<p>ざっと手順を説明して、コード上のポイントを解説する。例外処理周りなどは検討の余地が多い。</p>
<div class="section" id="windows-azure-cache-client">
<h3>Windows Azure Cache Client を入れる</h3>
<div class="highlight-bash"><div class="highlight"><pre>Install-Package Microsoft.WindowsAzure.Caching
</pre></div>
</div>
</div>
<div class="section" id="app-configazure-cache">
<h3>App.config内のAzure Cacheの設定をする</h3>
<p>App.config 内の configuration/dataCacheClients/dataCacheClient/autoDiscover のidentifier属性をAzure CacheのEndpointにして、securityProperties/messageSecurityのauthorizationInfo属性にManage Access Keys を設定する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;dataCacheClients&quot;</span> <span class="na">type=</span><span class="s">&quot;Microsoft.ApplicationServer.Caching.DataCacheClientsSection, Microsoft.ApplicationServer.Caching.Core&quot;</span> <span class="na">allowLocation=</span><span class="s">&quot;true&quot;</span> <span class="na">allowDefinition=</span><span class="s">&quot;Everywhere&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;cacheDiagnostics&quot;</span> <span class="na">type=</span><span class="s">&quot;Microsoft.ApplicationServer.Caching.AzureCommon.DiagnosticsConfigurationSection, Microsoft.ApplicationServer.Caching.AzureCommon&quot;</span> <span class="na">allowLocation=</span><span class="s">&quot;true&quot;</span> <span class="na">allowDefinition=</span><span class="s">&quot;Everywhere&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>
  <span class="nt">&lt;startup&gt;</span> 
    <span class="nt">&lt;supportedRuntime</span> <span class="na">version=</span><span class="s">&quot;v4.0&quot;</span> <span class="na">sku=</span><span class="s">&quot;.NETFramework,Version=v4.5&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/startup&gt;</span>
  <span class="nt">&lt;dataCacheClients&gt;</span>
    <span class="nt">&lt;dataCacheClient</span> <span class="na">name=</span><span class="s">&quot;default&quot;</span><span class="nt">&gt;</span>
      <span class="c">&lt;!--To use the in-role flavor of Windows Azure Cache, set identifier to be the cache cluster role name --&gt;</span>
      <span class="c">&lt;!--To use the Windows Azure Cache Service, set identifier to be the endpoint of the cache cluster --&gt;</span>
      <span class="nt">&lt;autoDiscover</span> <span class="na">isEnabled=</span><span class="s">&quot;true&quot;</span> <span class="na">identifier=</span><span class="s">&quot;********.cache.windows.net&quot;</span> <span class="nt">/&gt;</span>

      <span class="c">&lt;!--&lt;localCache isEnabled=&quot;true&quot; sync=&quot;TimeoutBased&quot; objectCount=&quot;100000&quot; ttlValue=&quot;300&quot; /&gt;--&gt;</span>
      
      <span class="c">&lt;!--Use this section to specify security settings for connecting to your cache. This section is not required if your cache is hosted on a role that is a part of your cloud service. --&gt;</span>
      <span class="nt">&lt;securityProperties</span> <span class="na">mode=</span><span class="s">&quot;Message&quot;</span> <span class="na">sslEnabled=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;messageSecurity</span> <span class="na">authorizationInfo=</span><span class="s">&quot;*************************&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/securityProperties&gt;</span>
    <span class="nt">&lt;/dataCacheClient&gt;</span>
<span class="nt">&lt;/dataCacheClients&gt;&lt;/configuration&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="owin-middleware">
<h3>OWIN Middleware用のプロジェクトを追加する</h3>
<p>今回は、Owin.Middleware という名前で作成して、Azure CacheとSessnionのMiddlewareを作成する。 <a class="reference external" href="https://github.com/takekazuomi/OwinAzureCacheSessionMiddleware/tree/master/Owin.Middleware">Owin.Middleware project</a>
必要なパッケージを追加する。このプロジェクトではOWIN Hosting系のパッケージは入れない。</p>
<div class="highlight-bash"><div class="highlight"><pre>install-Package Microsoft.Owin
install-Package Microsoft.WindowsAzure.Caching
install-Package EnterpriseLibrary.TransientFaultHandling.Caching
</pre></div>
</div>
</div>
<div class="section" id="azrue-cache-middleware">
<h3>Azrue Cache Middleware</h3>
<p>OWIN Middleware 定番クラスを３つ追加する。Middleware が処理の本体、Optionsは、Middlewareのオプション、Extensionsは拡張メソッドが入っている。今回は、素のOwinではなく、Microsoft.Owin を使っている。Microsoft.Owin は、Microsoftが作成したOwinの薄いラッパである程度型割り当て済みのデータを渡してくれるのでコーディングが楽になる。 <a class="footnote-reference" href="#r3" id="id5">[3]</a></p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.ApplicationServer.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AzureCacheMiddleware</span> <span class="p">:</span> <span class="n">OwinMiddleware</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CacheKeyName</span> <span class="p">=</span> <span class="s">&quot;Kyrt.CacheKeyName&quot;</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">AzureCacheOptions</span> <span class="n">_options</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">AzureCacheMiddleware</span><span class="p">(</span><span class="n">OwinMiddleware</span> <span class="n">next</span><span class="p">,</span> <span class="n">AzureCacheOptions</span> <span class="n">options</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_options</span> <span class="p">=</span> <span class="n">options</span> <span class="p">??</span> <span class="k">new</span> <span class="n">AzureCacheOptions</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">object</span> <span class="n">cache</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">CacheKeyName</span><span class="p">,</span> <span class="k">out</span> <span class="n">cache</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">cache</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzureCacheClient</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">CacheName</span><span class="p">);</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">[</span><span class="n">CacheKeyName</span><span class="p">]</span> <span class="p">=</span> <span class="n">cache</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">DataCacheException</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                <span class="k">throw</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">Next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Middlewareの基本的な考えは非常に簡単で Invoke の処理内で次のInvokeの前後に割り込んで処理をするだけ。AzureCacheMiddlewareでは、AzureCacheClient（中身はDataCache）を作成してEnvironmentに追加している。このケースでは、Invokeの前に処理を入れただけで、Invoke後は何もしていない。</p>
<p>オプションや拡張メソッドのクラスはおまけのようになもので大したことはしていない。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AzureCacheOptions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">AzureCacheOptions</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">CacheName</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CacheName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AzureCacheExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">IAppBuilder</span> <span class="nf">UseAzureCache</span><span class="p">(</span><span class="k">this</span> <span class="n">IAppBuilder</span> <span class="n">builder</span><span class="p">,</span> <span class="n">AzureCacheOptions</span> <span class="n">options</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">builder</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;builder&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">Use</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">AzureCacheMiddleware</span><span class="p">),</span> <span class="n">options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">AzureCacheClient</span> <span class="nf">Cache</span><span class="p">(</span><span class="k">this</span> <span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;context&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Environment</span><span class="p">[</span><span class="n">AzureCacheMiddleware</span><span class="p">.</span><span class="n">CacheKeyName</span><span class="p">]</span> <span class="k">as</span> <span class="n">AzureCacheClient</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br/></div>
</div>
<p>Session Middlewareは、Invoke前処理でCacheからのSessionの復元とResponseのCookieへのセッションIDの設定、後処理でSessionの保存を行っている。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Owin.Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SessionMiddleware</span> <span class="p">:</span> <span class="n">OwinMiddleware</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">SessionKeyName</span> <span class="p">=</span> <span class="s">&quot;Kyrt.Session&quot;</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">SessionMiddleware</span><span class="p">(</span><span class="n">OwinMiddleware</span> <span class="n">next</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">next</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IOwinContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">sessionId</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">sessionId</span> <span class="p">=</span> <span class="n">AzureCacheSessionProvidor</span><span class="p">.</span><span class="n">PreInvoke</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">SessionKeyName</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">Next</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">ContinueWith</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">state</span> <span class="k">as</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="n">IOwinContext</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;;</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">!=</span><span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">p</span><span class="p">.</span><span class="n">Item2</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="n">AzureCacheSessionProvidor</span><span class="p">.</span><span class="n">PostInvoke</span><span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">SessionKeyName</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Item2</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
            <span class="p">},</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>アプリケーションの変更</h2>
<p>最後に、アプリケーションをCacheとSessionを使うように変更する。</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin.Middleware</span><span class="p">;</span>

<span class="na">[assembly: OwinStartup(typeof(SelfHostSample.Startup))]</span>

<span class="k">namespace</span> <span class="nn">SelfHostSample</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseAzureCache</span><span class="p">();</span>
            <span class="n">app</span><span class="p">.</span><span class="n">UseSession</span><span class="p">();</span>

            <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;start app.Run {0}&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">);</span>

                <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">&quot;text/html&quot;</span><span class="p">;</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">time</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Cache</span><span class="p">().</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="s">&quot;first time&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
                    <span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Cache</span><span class="p">().</span><span class="n">Increment</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="kt">int</span> <span class="n">sessionCount</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Session</span><span class="p">().</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;sessionCount&quot;</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
                    <span class="n">sessionCount</span><span class="p">++;</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">Session</span><span class="p">()[</span><span class="s">&quot;sessionCount&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">sessionCount</span><span class="p">;</span>

                    <span class="kt">var</span> <span class="n">msg</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Hello, World! {0} {1}/{2} {3}&lt;br&gt;&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">sessionCount</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">);</span>
                    <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>


                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">context</span><span class="p">.</span><span class="n">TraceOutput</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>まとめ</h2>
<p>OWINは、シンプルで柔軟なHTTP 抽象化レイヤーを提供してくれる。Middlewareのinvoke chain の仕組みと拡張可能なEnvironmetはシンプルだた強力だ。
<a class="reference external" href="http://katanaproject.codeplex.com">katanaproject.codeplex.com</a> を見ると認証系、View Engine、Compressionなどのmiddlewareが散見され、それぞれのコードは興味深い。ただ、現時点ではアプリケーションの構築プラットフォームとして使うには道具立てが足りないようだ。でも今回のようにAzure Cache Session Provider などを書いてみると、パフォーマンス的な問題や実装上の課題などが見えてきてなかなか勉強になるし、ブレイクスルーできるような点も見えてくる。少々フロンティア的な色が強いが挑戦する価値のある分野だと思う。</p>
<div class="line-block">
<div class="line"><br/></div>
</div>
<table class="docutils footnote" frame="void" id="r1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://en.wikipedia.org/wiki/Common_Gateway_Interface#cite_note-1">Server Scripts, by Rob McCool, www-talk mailing list, Sun, 14 Nov 1993</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Katana Project のコードを見ると重量級で途方にくれる。System.Web との相互運用性をもたせようとして難しいことになっているらしい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="r3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>生 Owin だと型の情報がほどんど無い( <cite>IDictionary&lt;string, object&gt;</cite> なので）ので日和ってしまった。</td></tr>
</tbody>
</table>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/owin.html">OWIN</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure.html">Azure</a>, <a href="tags/azure_cache.html">Azure Cache</a>, <a href="tags/cache.html">Cache</a>, <a href="tags/owin.html">OWIN</a>, <a href="tags/session.html">Session</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/17/owin_azure_cache_session_middleware.html#disqus_thread" data-disqus-identifier="2013/12/17/owin_azure_cache_session_middleware">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 11, 2013</span>
        </div>
        <div class="section" id="windows-azure-storage-client-3-0-1">
<h1><a href="2013/12/11/windows_azure_storage_client_3_0_1.html">Windows Azure Storage Client 3.0.1</a></h1>
<p>2013/12/11 Windows Azure Storage Client 3.0.1 がリリースされました。変更内容はBUG FIXのみです。 <a class="reference external" href="http://www.nuget.org/packages/WindowsAzure.Storage/3.0.1">nuget:Windows Azure Storage 3.0.1</a></p>
<div class="section" id="id2">
<h2><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/changelog.txt#L176">修正点 3.0.1.0:</a></h2>
<ul class="simple">
<li>All (WP): Get/SetACL で明示的に Accept type application/xml を設定</li>
<li>Blobs: Lease operations の後で、LastModified と ETag プロパティを設定</li>
<li>Tables: Nuget package に Microsoft.Data.Services.Client への明示的な参照を追加</li>
<li>Tables: Json .NET の bug に起因したtable query responseのパース時の問題を修正。Json .NET bugの詳細: <a class="reference external" href="http://james.newtonking.com/archive/2013/11/29/fixing-jarray-getenumerator-method-not-found-bug">http://james.newtonking.com/archive/2013/11/29/fixing-jarray-getenumerator-method-not-found-bug</a></li>
<li>Tables (RT): クエリーと列挙操作の継続トークンに関する問題を修正</li>
</ul>
</div>
<div class="section" id="id3">
<h2>メモ</h2>
<p>Json .NET の bug から発生している問題は、Json .NETの5.0.5 で JArray.GetEnumerator をpublicにした結果、IEnumerableを取った時に、今までIEnumerable&lt;JToken&gt;)が返ってたのがJArray.GetEnumerator になってしまったことに起因するようです。
５系の中で非互換な修正をしてしまったので、storageが使うJson .NETと他の部分で使うのが混在したときに両立出来ずにお手上げになってしまう可能性があったそうですが、このバージョンで解決されます。</p>
</div>
</div>
        <div class="postmeta">
        
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure_storage.html">Azure Storage</a>, <a href="categories/azure.html">Azure</a>, <a href="categories/github観察記.html">GitHub観察記</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure_table.html">Azure Table</a>, <a href="tags/table.html">Table</a>, <a href="tags/storage.html">Storage</a>, <a href="tags/hotfix.html">Hotfix</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/11/windows_azure_storage_client_3_0_1.html#disqus_thread" data-disqus-identifier="2013/12/11/windows_azure_storage_client_3_0_1">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 11, 2013</span>
        </div>
        <div class="section" id="windows-azure-powershell-0-7-2">
<h1><a href="2013/12/11/windows_azure_powershel_0_7_2_release.html">Windows Azure Powershell 0.7.2 リリース</a></h1>
<p>Windows Azure Powershell 0.7.2 がリリースされました。 10月の 0.7.0 、11月の 0.7.1 続く12月リリースです。最近毎月リリースされています。Azureに新機能が出ると追っかけでcmdletが追加されます。
| 主な変更は、HDInsight cmdletsの追加、Web Site、VM cmdletの改善、Virtual IP reservation、Cloud Service cmdletの Visual Studio 互換です。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9207001266"><img alt="IMG_0911 by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3700/9207001266_9084fa6fc2_z.jpg"/></a>
<div class="section" id="id1">
<h2>インストール</h2>
<p>最新版はWeb Platform Installer 経由で入れられます。12/10 リリースのWindows Azure Poershell を選択してください。</p>
<img alt="../../../_images/2013_12_11_webpi001.png" src="_images/2013_12_11_webpi001.png"/>
<p>インストールしたら念のためバージョンを確認します。Azureの所が、0.7.2ですね。</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>Get-Module | ft name,version

Name                                                        Version
----                                                        -------
Autoload                                                    0.0
Azure                                                       0.7.2
Microsoft.PowerShell.Management                             3.1.0.0
Microsoft.PowerShell.Utility                                3.1.0.0
posh-git                                                    0.0
PsEnv                                                       0.0
PSReadline                                                  1.0.0.1
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>変更点</h2>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-tools/tree/release-0.7.2">2013.12.10 Version 0.7.2</a></p>
<ul class="simple">
<li>HDInsight cmdlets<ul>
<li>Add-AzureHDInsightConfigValues</li>
<li>Add-AzureHDInsightMetastore</li>
<li>Add-AzureHDInsightStorage</li>
<li>Get-AzureHDInsightCluster</li>
<li>Get-AzureHDInsightJob</li>
<li>Get-AzureHDInsightJobOutput</li>
<li>Get-AzureHDInsightProperties</li>
<li>New-AzureHDInsightCluster</li>
<li>New-AzureHDInsightClusterConfig</li>
<li>New-AzureHDInsightHiveJobDefinition</li>
<li>New-AzureHDInsightMapReduceJobDefinition</li>
<li>New-AzureHDInsightPigJobDefinition</li>
<li>New-AzureHDInsightSqoopJobDefinition</li>
<li>New-AzureHDInsightStreamingMapReduceJobDefinition</li>
<li>Remove-AzureHDInsightCluster</li>
<li>Revoke-AzureHDInsightHttpServicesAccess</li>
<li>Set-AzureHDInsightDefaultStorage</li>
<li>Start-AzureHDInsightJob</li>
<li>Stop-AzureHDInsightJob</li>
<li>Use-AzureHDInsightCluster</li>
<li>Wait-AzureHDInsightJob</li>
<li>Grant-AzureHDInsightHttpServicesAccess</li>
<li>Invoke-AzureHDInsightHiveJob</li>
</ul>
</li>
<li>Web Site の WebSocket と managed pipe mode の設定<ul>
<li>Set-AzureWebsite -WebSocketEnabled -ManagedPipelineMode</li>
</ul>
</li>
<li>Web Site の remote debugging 設定<ul>
<li>Enable-AzureWebsiteDebug -Version</li>
<li>Disable-AzureWebsiteDebug</li>
</ul>
</li>
<li>VM を削除した時の VHD cleaning up オプション<ul>
<li>Remove-AzureVM -DeleteVHD</li>
<li>Remove-AzureService -DeleteAll</li>
<li>Remove-AzureDeployment -DeleteVHD</li>
</ul>
</li>
<li>仮想 IP 予約 (Virtual IP reservation) preview feature (in AzurePreview module)<ul>
<li>Get-AzureDeployment</li>
<li>Get-AzureReservedIP</li>
<li>New-AzureReservedIP</li>
<li>New-AzureVM</li>
<li>Remove-AzureReservedIP</li>
</ul>
</li>
<li>下記の cmdletsでの Visual Studio Cloud Service プロジェクトのサポート<ul>
<li>Start-AzureEmulator</li>
<li>Publish-AzureServiceProject</li>
<li>Save-AzureServiceProjectPackage</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id3">
<h2>最後に</h2>
<p>今回の目玉は、HDInsight cmdletsかなと思いますが、個人的にはVisual Studioで作ったプロジェクトが使えるようになったのが一番嬉しいですね。</p>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_powershell.html">Azure Powershell</a>, <a href="categories/github観察記.html">GitHub観察記</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure.html">Azure</a>, <a href="tags/azure_powershell.html">Azure Powershell</a>, <a href="tags/powershell.html">Powershell</a>, <a href="tags/posh.html">posh</a>, <a href="tags/release.html">Release</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/11/windows_azure_powershel_0_7_2_release.html#disqus_thread" data-disqus-identifier="2013/12/11/windows_azure_powershel_0_7_2_release">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 06, 2013</span>
        </div>
        <div class="section" id="windows-azure-table-json-payload">
<h1><a href="2013/12/06/azure_table_json_payload.html">Windows Azure Table の JSON payload</a></h1>
<p>2013/11/27 に公開された最新のWindows Azure Storageでは新しくJSON Payload Format が導入されました。変更点の詳細が Windows Azure Storage Team Blog の <a class="reference external" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2013/12/05/windows-azure-tables-introducing-json.aspx">Windows Azure Tables: Introducing JSON</a>  に出ています、興味深い内容です。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/11248464764"><img alt="mojya mojya by Takekazu Omi, on Flickr" class="align-center" src="http://farm4.staticflickr.com/3755/11248464764_54794780d3_z.jpg"/></a>
<p>翻訳は追々出ると思うので、拾い読みしながら気になったことを書きます。</p>
<blockquote>
<div><ul class="simple">
<li>[引用]JSON Payloadは、version “2013-08-15”の一部してリリースされました。JSONは従来の AtomPub <a class="footnote-reference" href="#f1" id="id1">[1]</a> フォーマットの OData payload format に比べて著しくサイズが小さくなり latency が低くなっています。また、payload size を削減するため、 insert の payload echo を Off にする方法を提供します。これらの新機能は、新しい  <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Client 3.0</a> ではデフォルトの機能として働きます。</li>
</ul>
</div></blockquote>
<p>従来の HTTP request/response を見ていると無駄が目立ったので、それが削減されるのは大歓迎です。ここには、version “2013-08-15”でのplayloadの削減が書いてありますが、2013年11月（先月）ぐらいから、version “2012-02-12” の AtomPub でも余計な改行や空白を削減するなどの変更が行われています。このあたりの変更については、<a class="reference internal" href="2013/11/24/windows_azure_tables_breaking_changes_2013_11.html"><em>Windows Azure Tables の Breaking Changes 2013/11</em></a> を見て下さい。</p>
<p>Insert の payload echo を Off にする話が出ていますが、version “2011-08-18” でサポートされた <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh452241.aspx">Insert Or Merge Entity (REST API)</a> ではレスポンスのBODYが空でステータスコードは204 (No Content) を返すようになっていました、これを insert でも同じように動作するモードを付けたということのようです。
Insertの時にサーバー側で付与される情報はETagとTimestampだけで、それ以外は送信した内容と同じです、レスポンスヘッダーにETagは返ってくるので、エンティティ全体が帰ってこなくても困ることはほとんど無いと思います。場合によっては、Timestamp を使う場合があるかもしれませんが、その場合は設計を見直すか、エンティティ全体を返すモードで使うかになります。</p>
<div class="section" id="what-is-json">
<h2>What is JSON</h2>
<blockquote>
<div><ul class="simple">
<li>[引用] <a class="reference external" href="http://json.org">JSON</a>  (JavaScript Object Notation) は、構造化データをシリアライズするための lightweight text format です。 <a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/atom-format">AtomPub</a> と同じように、 OData extends JSON formatでは、エンティティとプロパティの一般的な規則を定義します。AtomPubは異なり、OData JSON では response payload が一部がペイロードサイズを低減するために省略されます。そのため、受信側でlink, type と control dataなどのデータを再構成ための表現力が不足しています。OData には下記のような複数の JSON フォーマットがあります:</li>
</ul>
</div></blockquote>
<p>ちょっと分かりづらいです（訳が悪いのでしょうか）、この辺りの考えは、 <a class="reference external" href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/cos01/odata-json-format-v4.0-cos01.html#_Toc372793038">OData JSON Format Version 4.0 2 Candidate OASIS Standard 01 の 2.JSON Format Design</a> がわかりやすく考え方を説明してくれています。それによると、実際のpayloadからwire formatの予測可能な部分を取り除いて送信できるようにするという考えでデザインされているそうです。クライアントがデータに関するメタデータを持っているというシナリオでは毎回のpayloadに全メタ情報を載せて送る（以前のAtomPubのように）のは無駄なので省略できるようにしますという話です。どこまでメタデータを持たせるかは nometadata、minimalmetadata、fullmetadata の3段階用意しています。あとそれに伴って、name/valueのペアに順序の制約を付けています。順序の話は、Hashにそのまま読み込めなくなるので少々面倒な制約です。
IDLやXML Schema のようなメタ情報を定義する仕組みを持ち込まずに、受信側のクライアントのコードで実装もしくは、JSON内にメタ情報埋め込みという話にしたのは、JSONの手軽さを損なわないという点で評価できます。</p>
<p>nometadata、minimalmetadata、fullmetadata や、JSON payload の詳細については <a class="reference external" href="http://msdn.microsoft.com/en-us/library/windowsazure/dn535600.aspx">Payload Format for Table Service Operations</a> を見て下さい。</p>
</div>
<div class="section" id="atompub-vs-json-format">
<h2>AtomPub vs JSON format</h2>
<p>具体的に、AtomPubとJSONを比較してみます。JSONにすると、基本的に閉じタグが無くなるので、それだけでもかなりの削減になるのはすぐわかります。<a class="reference internal" href="2013/12/06/azure_table_json_payload.html#fullatompub"><em>AtomPub [引用]</em></a> と、<a class="reference internal" href="2013/12/06/azure_table_json_payload.html#json-nometadata"><em>JSON nometadata [引用]</em></a> を見ると一目瞭然です。<a class="reference internal" href="2013/12/06/azure_table_json_payload.html#fullatompub"><em>AtomPub [引用]</em></a> の方は、元々、<a class="reference external" href="http://ja.wikipedia.org/wiki/Atom#Atom_Publishing_Protocol">Atom Publishing Protocol</a> もので、インターネット上でのコンテンツの交換を目的として設計されたものです。Table Storageでは使われない、冗長なタグが散見されます。title、id、link、author あたりとか、namespace は不要なので、それも外してしまうと結構スッキリします。試しに、XMLで余計なタグを削った <a class="reference internal" href="2013/12/06/azure_table_json_payload.html#xml-nometadata"><em>XML nometadata （参考までに作ってみました）</em></a> というのを作ってみました。閉じタグだけはなんとも成らないですが、結構シンプルになります。これを見ると、XMLを選択した功罪というより AtomPub を選択した問題の方が大きかったことがわかります。OData/WCFの流れに拘りすぎてちょっと遠回りしてしまったようです。</p>
<p>Payloadの違いによる比較のテーブルが面白いので引用します</p>
<table border="1" class="docutils">
<caption>To compare JSON and AtomPub</caption>
<colgroup>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
<col width="14%"/>
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Format</th>
<th class="head">Request Header Size</th>
<th class="head">Request Body Size</th>
<th class="head">Response Header Size</th>
<th class="head">Response Body Size</th>
<th class="head">% Savings in HTTP Body Size only vs. AtomPub</th>
<th class="head">% Savings in total HTTP transfer vs. AtomPub</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AtomPub</td>
<td>3,611</td>
<td>2,861</td>
<td>3,211</td>
<td>8,535</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr class="row-odd"><td>JSON MinimalMetadata</td>
<td>3,462</td>
<td>771</td>
<td>3,360</td>
<td>2,529</td>
<td>71%</td>
<td>44%</td>
</tr>
<tr class="row-even"><td>JSON NoMetadata</td>
<td>3,432</td>
<td>771</td>
<td>3,330</td>
<td>1,805</td>
<td>77%</td>
<td>49%</td>
</tr>
</tbody>
</table>
<div class="section" id="fullatompub">
<span id="id2"/><h3>AtomPub [引用]</h3>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;feed</span> <span class="na">xml:base=</span><span class="s">&quot;http://someaccount.table.core.windows.net/&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/2005/Atom&quot;</span> <span class="na">xmlns:d=</span><span class="s">&quot;http://schemas.microsoft.com/ado/2007/08/dataservices&quot;</span> <span class="na">xmlns:m=</span><span class="s">&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/metadata&quot;</span> <span class="na">xmlns:georss=</span><span class="s">&quot;http://www.georss.org/georss&quot;</span> <span class="na">xmlns:gml=</span><span class="s">&quot;http://www.opengis.net/gml&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;title</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;</span>Customers<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;self&quot;</span> <span class="na">title=</span><span class="s">&quot;Customers&quot;</span> <span class="na">href=</span><span class="s">&quot;Customers&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">&quot;W/&amp;quot;datetime'2013-12-03T06%3A37%3A20.9709094Z'&amp;quot;&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Jonathan',RowKey='Foster')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">&quot;someaccount.Customers&quot;</span> <span class="na">scheme=</span><span class="s">&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/scheme&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;edit&quot;</span> <span class="na">title=</span><span class="s">&quot;Customers&quot;</span> <span class="na">href=</span><span class="s">&quot;Customers(PartitionKey='Jonathan',RowKey='Foster')&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Jonathan<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Foster<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2013-12-03T06:37:20.9709094Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>1234 SomeStreet St, Bellevue, WA 75001<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Jonathan@fourthcoffee.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2005-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">&quot;Edm.Int32&quot;</span><span class="nt">&gt;</span>3<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">&quot;W/&amp;quot;datetime'2013-12-03T06%3A37%3A21.1259249Z'&amp;quot;&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Lisa',RowKey='Miller')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">&quot;someaccount.Customers&quot;</span> <span class="na">scheme=</span><span class="s">&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/scheme&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;edit&quot;</span> <span class="na">title=</span><span class="s">&quot;Customers&quot;</span> <span class="na">href=</span><span class="s">&quot;Customers(PartitionKey='Lisa',RowKey='Miller')&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Lisa<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Miller<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2013-12-03T06:37:21.1259249Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>4567 NiceStreet St, Seattle, WA 54332<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Lisa@northwindtraders.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2003-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">&quot;Edm.Int32&quot;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
  <span class="nt">&lt;entry</span> <span class="na">m:etag=</span><span class="s">&quot;W/&amp;quot;datetime'2013-12-03T06%3A37%3A20.7628886Z'&amp;quot;&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id&gt;</span>http://someaccount.table.core.windows.net/Customers(PartitionKey='Walter',RowKey='Harp')<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">term=</span><span class="s">&quot;someaccount.Customers&quot;</span> <span class="na">scheme=</span><span class="s">&quot;http://schemas.microsoft.com/ado/2007/08/dataservices/scheme&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;edit&quot;</span> <span class="na">title=</span><span class="s">&quot;Customers&quot;</span> <span class="na">href=</span><span class="s">&quot;Customers(PartitionKey='Walter',RowKey='Harp')&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;updated&gt;</span>2013-12-03T06:37:21Z<span class="nt">&lt;/updated&gt;</span>
    <span class="nt">&lt;author&gt;</span>
      <span class="nt">&lt;name</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/author&gt;</span>
    <span class="nt">&lt;content</span> <span class="na">type=</span><span class="s">&quot;application/xml&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:properties&gt;</span>
        <span class="nt">&lt;d:PartitionKey&gt;</span>Walter<span class="nt">&lt;/d:PartitionKey&gt;</span>
        <span class="nt">&lt;d:RowKey&gt;</span>Harp<span class="nt">&lt;/d:RowKey&gt;</span>
        <span class="nt">&lt;d:Timestamp</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2013-12-03T06:37:20.7628886Z<span class="nt">&lt;/d:Timestamp&gt;</span>
        <span class="nt">&lt;d:Address&gt;</span>1345 Fictitious St, St Buffalo, NY 98052<span class="nt">&lt;/d:Address&gt;</span>
        <span class="nt">&lt;d:Email&gt;</span>Walter@contoso.com<span class="nt">&lt;/d:Email&gt;</span>
        <span class="nt">&lt;d:PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/d:PhoneNumber&gt;</span>
        <span class="nt">&lt;d:CustomerSince</span> <span class="na">m:type=</span><span class="s">&quot;Edm.DateTime&quot;</span><span class="nt">&gt;</span>2010-01-05T00:00:00Z<span class="nt">&lt;/d:CustomerSince&gt;</span>
        <span class="nt">&lt;d:Rating</span> <span class="na">m:type=</span><span class="s">&quot;Edm.Int32&quot;</span><span class="nt">&gt;</span>4<span class="nt">&lt;/d:Rating&gt;</span>
      <span class="nt">&lt;/m:properties&gt;</span>
    <span class="nt">&lt;/content&gt;</span>
  <span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/feed&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="json-minimalmetadata">
<span id="id3"/><h3>JSON minimalmetadata [引用]</h3>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;odata.metadata&quot;</span><span class="p">:</span><span class="s2">&quot;http://someaccount.table.core.windows.net/$metadata#Customers&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:[</span>
        <span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Jonathan&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Foster&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:39:56.6443475Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;1234 SomeStreet St, Bellevue, WA 75001&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Jonathan@fourthcoffee.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince@odata.type&quot;</span><span class="p">:</span><span class="s2">&quot;Edm.DateTime&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2005-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">3</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Lisa&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Miller&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:39:56.7943625Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;4567 NiceStreet St, Seattle, WA 54332&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Lisa@northwindtraders.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince@odata.type&quot;</span><span class="p">:</span><span class="s2">&quot;Edm.DateTime&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2003-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">2</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Walter&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Harp&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:39:56.4743305Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;1345 Fictitious St, St Buffalo, NY 98052&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Walter@contoso.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince@odata.type&quot;</span><span class="p">:</span><span class="s2">&quot;Edm.DateTime&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2010-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">4</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="json-nometadata">
<span id="id4"/><h3>JSON nometadata [引用]</h3>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:[</span>
	<span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Jonathan&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Foster&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:45:00.7254269Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;1234 SomeStreet St, Bellevue, WA 75001&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Jonathan@fourthcoffee.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2005-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">3</span>
	<span class="p">},</span>
	<span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Lisa&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Miller&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:45:00.8834427Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;4567 NiceStreet St, Seattle, WA 54332&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Lisa@northwindtraders.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2003-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">2</span>
	<span class="p">},</span>
	<span class="p">{</span>
            <span class="nt">&quot;PartitionKey&quot;</span><span class="p">:</span><span class="s2">&quot;Walter&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RowKey&quot;</span><span class="p">:</span><span class="s2">&quot;Harp&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2013-12-03T06:45:00.5384082Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Address&quot;</span><span class="p">:</span><span class="s2">&quot;1345 Fictitious St, St Buffalo, NY 98052&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Email&quot;</span><span class="p">:</span><span class="s2">&quot;Walter@contoso.com&quot;</span><span class="p">,</span>
            <span class="nt">&quot;PhoneNumber&quot;</span><span class="p">:</span><span class="s2">&quot;425-555-0101&quot;</span><span class="p">,</span>
            <span class="nt">&quot;CustomerSince&quot;</span><span class="p">:</span><span class="s2">&quot;2010-01-05T00:00:00Z&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Rating&quot;</span><span class="p">:</span><span class="mi">4</span>
	<span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="xml-nometadata">
<span id="id5"/><h3>XML nometadata （参考までに作ってみました）</h3>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="nt">&lt;Feed&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Jonathan<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Foster<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.6443475Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>1234 SomeStreet St, Bellevue, WA 75001<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Jonathan@fourthcoffee.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2005-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>3<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Lisa<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Miller<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.7943625Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>4567 NiceStreet St, Seattle, WA 54332<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Lisa@northwindtraders.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2003-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>2<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
  <span class="nt">&lt;Properties&gt;</span>
    <span class="nt">&lt;PartitionKey&gt;</span>Walter<span class="nt">&lt;/PartitionKey&gt;</span>
    <span class="nt">&lt;RowKey&gt;</span>Harp<span class="nt">&lt;/RowKey&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>2013-12-03T06:39:56.4743305Z<span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Address&gt;</span>1345 Fictitious St, St Buffalo, NY 98052<span class="nt">&lt;/Address&gt;</span>
    <span class="nt">&lt;Email&gt;</span>Walter@contoso.com<span class="nt">&lt;/Email&gt;</span>
    <span class="nt">&lt;PhoneNumber&gt;</span>425-555-0101<span class="nt">&lt;/PhoneNumber&gt;</span>
    <span class="nt">&lt;CustomerSince&gt;</span>2010-01-05T00:00:00Z<span class="nt">&lt;/CustomerSince&gt;</span>
    <span class="nt">&lt;Rating&gt;</span>4<span class="nt">&lt;/Rating&gt;</span>
  <span class="nt">&lt;/Properties&gt;</span>
<span class="nt">&lt;/Feed&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>最後に</h2>
<p>書き始めたら案外知らないことが多く。てっきり、OData V3 の JSON <a class="footnote-reference" href="#f2" id="id7">[2]</a>  、 <cite>Content-Type: application/json;odata=verbose</cite> 、 <cite>json light (content-type : application/json; odata=light)</cite> が使われているのかと思ったら、いつの間にかOData Version 4.0 JSON <a class="footnote-reference" href="#f3" id="id8">[3]</a> なんてものがあって、そっちが使われていたことに気が付いたり。</p>
<p><a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Client 3.0</a> で使っている、 <a class="reference external" href="http://www.nuget.org/packages/Microsoft.Data.OData/5.6.0">ODataLib 5.6.0</a> から OData V4をサポートしているらしい <a class="footnote-reference" href="#f4" id="id10">[4]</a> ということが分かったりということで手間取りました。</p>
<p>じゃあ、ODataLib 5.6.0 のコードちょっと見ておくかと思ったら、odata.codeplex.com の ODataLib は2011年から放置状態になっていて（これは知ってました）、 <a class="reference external" href="http://www.symbolsource.org/Public/Metadata/NuGet/Project/Microsoft.Data.Services/5.6.0">http://www.symbolsource.org/Public/Metadata/NuGet/Project/Microsoft.Data.Services/5.6.0</a> からコードが確認できるってことに気が付いたりで手間取りました。</p>
<p>今回は前半しか紹介できていないので、そのうち続きを書きたいと思います。</p>
<div class="section" id="resources">
<h3>Resources</h3>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/atom-format">AtomPub</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[2]</a></td><td><a class="reference external" href="http://www.odata.org/documentation/odata-v3-documentation/json-verbose-format">OData V3 JSON Verbose Format</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[3]</a></td><td><a class="reference external" href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/odata-json-format-v4.0.html">OData JSON Format Version 4.0 Candidate OASIS Standard 01 19 November 2013</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label"/><col/></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[4]</a></td><td>OData V4 のstackが、ODataLib として提供されることがコメントに書いてある <a class="reference external" href="http://blogs.msdn.com/b/astoriateam/archive/2013/08/26/wcf-data-services-5-6-0-release.aspx">WCF Data Services 5.6.0 Release</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_storage.html">Azure Storage</a>, <a href="categories/azure_sdk.html">Azure SDK</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/2013_08_15.html">2013-08-15</a>, <a href="tags/azure.html">Azure</a>, <a href="tags/json.html">JSON</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/06/azure_table_json_payload.html#disqus_thread" data-disqus-identifier="2013/12/06/azure_table_json_payload">Leave a comment</a>
        </div></div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>December 06, 2013</span>
        </div>
        <div class="section" id="github-windows-azure-storage-libraries-for-net-3-0-0">
<h1><a href="2013/12/06/github_windows_azure_storage_libraries_for_net_3_0.html">GitHub/Windows Azure Storage Libraries for .NET 3.0.0</a></h1>
<p>3.0.0では、GitHub上の Windows Azure Storage の .NET Client ライブラリの場所が変わりました。</p>
<a class="reference external image-reference" href="http://www.flickr.com/photos/takekazuomi/9269858396"><img alt="leaf by Takekazu Omi, on Flickr" class="align-center" src="http://farm6.staticflickr.com/5471/9269858396_5b59a95e64_z.jpg"/></a>
<p>Storage の .NET Client ライブラリは、2.1までは、 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET github:azure-sdk-for-net</a> にありましたが、3.0からは、Storageは独立して <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">Windows Azure Storage Libraries for .NET github:azure-storage-net</a> になりました。
2.1系は継続して、 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET github:azure-sdk-for-net</a> でメンテされるようです。
現在2.1系の最新は、 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net/tree/v2.1.0.4">2.1.0.4</a> です。</p>
<p>今後 <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-net">Windows Azure SDK for .NET</a> は、 <a class="reference external" href="http://www.nuget.org/packages/Microsoft.WindowsAzure.ConfigurationManager">Windows Azure Configuration Manager</a> や <a class="reference external" href="http://www.nuget.org/packages/Microsoft.WindowsAzure.Management.Libraries/0.9.2-preview">Windows Azure Management Libraries</a> の場所ということになりそうです。</p>
<p>最初は、Windows Azure SDK for .NET という名前で、中身がStorageのライブラリで始まって、そのうち Configuration Manager が追加、Management Libraries が追加され、Media関連はディレクトリはあるけど別レポジトリ、とだんだん膨れてわかり辛くなってきたところだったので整理するにはいいタイミングだった気がします。</p>
<div class="section" id="breaking-changes">
<h2>Breaking Changes</h2>
<p><a class="reference internal" href="2013/12/05/minute_metrics_storage_version_2013_08_15.html"><em>Windows Azure Storage 2013-08-15 の Minute Metrics</em></a> で、3.0の変更点が分からないと書きましたが、レポジトリの <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net/blob/master/BreakingChanges.txt#L33">BreakingChanges.txt</a> に記載がありました。</p>
<p>３つあります。簡単にまとめます。</p>
<ol class="arabic simple">
<li>テーブルの操作にDataServiceContextを使った場合、OperationContextのresponse received eventは no longer fired（もはや起こらない）</li>
<li>ContinuationToken の WriteXml()/ReadXml()が変更されました。詳細は原文を参照してください。</li>
<li>ServiceProperties では、uploadされたものだけが変更されます。例えば、CORSの設定だけをすると、Logging と Metering 関連の設定は変更されません。</li>
</ol>
<p>ServicePropertiesのプロパティが変更された件などは、上記 Breaking Changes に書いてありませんので互換性に関しては注意が必要だと思います。</p>
</div>
<div class="section" id="id3">
<h2>まとめ</h2>
<p>このレポジトリの移動に関して <a class="reference internal" href="2013/11/28/cors_json_minute_metrics_and_more.html"><em>Windows Azure Storage Release - CORS、JSON、Minute Metrics の紹介</em></a>  に下記のような記述があります。</p>
<blockquote>
<div><div class="line-block">
<div class="line">これらの機能に対応した、Windows Azure Storage Client Library を <a class="reference external" href="https://github.com/WindowsAzure/azure-storage-net">github:azure-storage-net</a> にリリースします。</div>
</div>
</div></blockquote>
<p>今までのレポジトリを見てソースが上がってこないので、3.0のソースは公開されないのかと思って困惑していましたが、無事ソースも確認できて安心しました。</p>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Takekazu Omi</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/azure.html">Azure</a>, <a href="categories/azure_sdk.html">Azure SDK</a>, <a href="categories/azure_storage.html">Azure Storage</a>, <a href="categories/github観察記.html">GitHub観察記</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/azure.html">Azure</a>, <a href="tags/storage.html">Storage</a>, <a href="tags/azure_sdk.html">Azure SDK</a></span>
        </div>
        <div class="comments">
            <a href="http://kyrt.in/2013/12/06/github_windows_azure_storage_libraries_for_net_3_0.html#disqus_thread" data-disqus-identifier="2013/12/06/github_windows_azure_storage_libraries_for_net_3_0">Leave a comment</a>
        </div></div><div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="2014/01/06/windows_azure_storage_3_0_2_hotfix.html">Windows Azure Storage 3.0.2 Hotfix</a>
        </li><li>
            <a href="2013/12/27/azure_storage_known_issues_november_2013_resolved.html">[Resolved] Windows Azure Storage Known Issues 2013/11</a>
        </li><li>
            <a href="2013/12/22/azure_posh_2012_12_19_version_0_7_2_1.html">Windows Azure Powershell 0.7.2.1 リリース</a>
        </li><li>
            <a href="2013/12/21/windows_azure_storage_client_library_for_c_preview.html">Windows Azure Storage Client Library for C++ Preview</a>
        </li><li>
            <a href="2013/12/20/windows_azure_storage_client_library_for_java_v_0_5_0.html">Windows Azure Storage Client Library for Java v. 0.5.0</a>
        </li><li>
            <a href="2013/12/17/owin_azure_cache_session_middleware.html">OWIN - Open Web Interface for .NET を使う</a>
        </li><li>
            <a href="2013/12/11/windows_azure_storage_client_3_0_1.html">Windows Azure Storage Client 3.0.1</a>
        </li><li>
            <a href="2013/12/11/windows_azure_powershel_0_7_2_release.html">Windows Azure Powershell 0.7.2 リリース</a>
        </li><li>
            <a href="2013/12/06/azure_table_json_payload.html">Windows Azure Table の JSON payload</a>
        </li><li>
            <a href="2013/12/06/github_windows_azure_storage_libraries_for_net_3_0.html">GitHub/Windows Azure Storage Libraries for .NET 3.0.0</a>
        </li></ul>
</div>
</section><section><div class="widget">
    <h1>Categories</h1>
    <ul><li><a href="categories/azure.html">Azure</a> (22)</li><li><a href="categories/azure_blob.html">Azure Blob</a> (1)</li><li><a href="categories/azure_powershell.html">Azure Powershell</a> (2)</li><li><a href="categories/azure_sdk.html">Azure SDK</a> (7)</li><li><a href="categories/azure_storage.html">Azure Storage</a> (8)</li><li><a href="categories/azure_table.html">Azure Table</a> (7)</li><li><a href="categories/github観察記.html">GitHub観察記</a> (7)</li><li><a href="categories/helios.html">Helios</a> (1)</li><li><a href="categories/java.html">Java</a> (1)</li><li><a href="categories/owin.html">OWIN</a> (1)</li><li><a href="categories/ruby.html">Ruby</a> (1)</li></ul>
</div></section><section><div class="widget">
    <h1>Tags</h1><a href="tags/2013_08_15.html">2013-08-15</a> (5), <a href="tags/async.html">Async</a> (5), <a href="tags/azure.html">Azure</a> (10), <a href="tags/azure_blob.html">Azure Blob</a> (2), <a href="tags/azure_cache.html">Azure Cache</a> (1), <a href="tags/azure_powershell.html">Azure Powershell</a> (2), <a href="tags/azure_sdk.html">Azure SDK</a> (2), <a href="tags/azure_sdk_for_java.html">Azure SDK for Java</a> (1), <a href="tags/azure_storage.html">Azure Storage</a> (2), <a href="tags/azure_table.html">Azure Table</a> (10), <a href="tags/blob.html">Blob</a> (2), <a href="tags/bug.html">BUG</a> (1), <a href="tags/c.html">C#</a> (4), <a href="tags/c.html">C++</a> (1), <a href="tags/cache.html">Cache</a> (1), <a href="tags/cloud.html">Cloud</a> (4), <a href="tags/cloud_service.html">Cloud Service</a> (1), <a href="tags/deploy.html">Deploy</a> (1), <a href="tags/eclipse.html">Eclipse</a> (1), <a href="tags/emulator.html">Emulator</a> (1), <a href="tags/fixed.html">Fixed</a> (1), <a href="tags/hotfix.html">Hotfix</a> (3), <a href="tags/issue.html">Issue</a> (3), <a href="tags/java.html">Java</a> (2), <a href="tags/json.html">JSON</a> (1), <a href="tags/nosql.html">NoSQL</a> (4), <a href="tags/owin.html">OWIN</a> (2), <a href="tags/play_framework.html">Play Framework</a> (1), <a href="tags/posh.html">posh</a> (2), <a href="tags/powershell.html">Powershell</a> (2), <a href="tags/queue.html">Queue</a> (1), <a href="tags/release.html">Release</a> (4), <a href="tags/session.html">Session</a> (1), <a href="tags/step_by_step.html">Step By Step</a> (2), <a href="tags/storage.html">Storage</a> (12), <a href="tags/table.html">Table</a> (10), <a href="tags/translate_selected_passages.html">Translate Selected Passages</a> (3), <a href="tags/tutorial.html">Tutorial</a> (1), <a href="tags/webrole.html">WebRole</a> (1)</div></section><section><div class="widget" id="searchbox">
    <h1>Search</h1>
    <form action="search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="webfont">L</span></button>
    </form>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container"><footer class="wrapper">&copy; Copyright 2012-2013, Takekazu Omi. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "cloudmemo";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>